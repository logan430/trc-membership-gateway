# Milestone v1.0: MVP

**Status:** âœ… SHIPPED 2026-01-21
**Phases:** 1-25
**Total Plans:** 60

## Overview

This milestone delivers a production-ready Stripe-backed membership gateway for The Revenue Council Discord community. The system progresses from secure infrastructure (webhooks, database) through Discord integration, individual and company subscription flows, introduction enforcement, team seat management, billing failure handling, and operational hardening. Includes comprehensive admin system, email notifications, and member self-service portal. All phases passed security, data integrity, and operational readiness audits.

## Phases

### Phase 1: Foundation

**Goal**: Secure, reliable infrastructure is in place to receive Stripe events and persist membership data
**Depends on**: Nothing (first phase)
**Plans**: 3 plans

Plans:

- [x] 01-01: Project skeleton and environment configuration
- [x] 01-02: Database schema and Prisma setup
- [x] 01-03: Stripe webhook handler with signature verification and idempotency

**Details:**
Database schema captures all fields needed for CRM export. Webhook endpoint receives events with 200 OK, deduplicates via event ID, rejects invalid signatures with 400. Express 5.2.1 chosen for Stripe documentation alignment. Supabase pooler connection resolves IPv6 issues.

### Phase 2: Discord Integration

**Goal**: Users can link their Discord account and the bot can manage roles
**Depends on**: Phase 1
**Plans**: 4 plans

Plans:

- [x] 02-01: Session infrastructure with JWT tokens
- [x] 02-02: Discord bot with role management
- [x] 02-03: Discord OAuth flow implementation
- [x] 02-04: Magic link authentication

**Details:**
Medieval role theme (Squire, Knight, Lord, Debtor) matches "Revenue Council" branding. JWT with 15min access / 7-30d refresh tokens. Discord bot requires GuildMembers privileged intent for role operations. State cookie with 10-min expiry for CSRF protection. Magic link has 5-minute expiry with anti-enumeration protection.

### Phase 3: Individual Subscription

**Goal**: Individual users can pay, claim access, and receive their initial Discord role
**Depends on**: Phase 2
**Plans**: 3 plans

Plans:

- [x] 03-01: User registration (email+password) and Stripe Checkout flow
- [x] 03-02: Dashboard and Discord claim flow with Squire role assignment
- [x] 03-03: The Gatekeeper landing page with medieval theme

**Details:**
Argon2id with OWASP 2025 params for password hashing. Email unique constraint. Timing-safe password verification prevents timing attacks. The Gatekeeper uses Cinzel + Crimson Text fonts with dark (#1a1a2e) + gold (#d4af37) medieval palette. Async role assignment with p-retry for exponential backoff.

### Phase 4: Introduction Requirement

**Goal**: Users must introduce themselves before gaining full community access
**Depends on**: Phase 3
**Plans**: 3 plans

Plans:

- [x] 04-01: Message event infrastructure and introduction detection
- [x] 04-02: Introduction validation and role promotion logic
- [x] 04-03: Subscription cancellation handler with role removal and kick

**Details:**
Bot detects first message in #introductions (top-level only, not replies). MessageContent privileged intent required. MIN_INTRO_LENGTH = 100 characters (text-only, images don't count). Individual users promoted from Squire to Knight, company owners to Lord. Subscription cancellation fires at period end, not on cancel initiation. Farewell DM sent before kick. introCompleted reset allows re-introduction on resubscribe.

### Phase 5: Team Management

**Goal**: Companies can purchase plans and manage team seats
**Depends on**: Phase 4
**Plans**: 6 plans

Plans:

- [x] 05-01: Schema updates, env config, and company checkout flow
- [x] 05-02: Team dashboard with seat view
- [x] 05-03: Invite token generation and management
- [x] 05-04: Invite claim flow with Discord OAuth
- [x] 05-05: Seat revocation with immediate kick
- [x] 05-06: Mid-subscription seat additions

**Details:**
Team created before checkout session to prevent webhook race. subscription_data.metadata routes individual vs company checkouts. isPrimaryOwner field prevents revocation of purchaser. crypto.randomBytes (256 bits) for invite tokens with base64url encoding. Prisma $transaction for atomic seat claim. always_invoice proration for immediate charge on seat additions. Webhook-driven database sync keeps Stripe as source of truth.

### Phase 6: Billing Failure

**Goal**: Payment failures restrict access gracefully; recovery restores access
**Depends on**: Phase 5
**Plans**: 4 plans

Plans:

- [x] 06-01: Schema updates and #billing-support channel creation
- [x] 06-02: Payment failure detection and grace period start
- [x] 06-03: Debtor state transition and billing scheduler
- [x] 06-04: Payment recovery and role restoration

**Details:**
String array sentBillingNotifications tracks notification keys to prevent duplicates. Only subscription_cycle billing_reason triggers grace period (not checkout failures). 48-hour grace period before Debtor role assignment. Previous role stored BEFORE role changes for restoration. 5-minute polling interval (database-backed, survives restarts). Notification marked sent even if DM fails (user may have DMs disabled). invoice.paid triggers recovery, defaults to Knight if previousRole is null.

### Phase 7: Email Notifications

**Goal**: Users receive transactional emails for all key lifecycle events
**Depends on**: Phase 5, Phase 6
**Plans**: 4 plans

Plans:

- [x] 07-01: Email infrastructure with provider abstraction
- [x] 07-02: Welcome and claim reminder emails
- [x] 07-03: Billing failure and recovery emails
- [x] 07-04: Team seat invite emails

**Details:**
EMAIL_PROVIDER env var switch allows development without API keys (console provider). Provider pattern enables testing and swappable delivery. Claim reminder schedule: 48h, 7d, 30d, then monthly for 6 months. Cheeky tone at 30+ days expressing gratitude. Fire-and-forget email pattern with .catch() to not block webhooks. Fresh Stripe billing portal URL generated per email. Optional email field on invites (admin can share link manually).

### Phase 8: Operations

**Goal**: System detects and corrects drift between Stripe and Discord state
**Depends on**: Phase 6
**Plans**: 2 plans

Plans:

- [x] 08-01: Reconciliation infrastructure (schema, env vars, module scaffold)
- [x] 08-02: Drift detection and auto-fix logic

**Details:**
node-cron for reconciliation (lightweight, timezone-aware). Three-way comparison: Stripe vs Database vs Discord. Batch 5 fixes with 2s delays to respect Discord rate limits (10 role ops per 10s). Verification re-run 1 hour after fixes confirms application. Daily execution at configured hour.

### Phase 9: Frontend Pages

**Goal**: Users can complete the full signup -> login -> dashboard -> claim flow through the browser
**Depends on**: Phase 8
**Plans**: 2 plans

Plans:

- [x] 09-01: Auth pages (signup, login) with form styles
- [x] 09-02: Dashboard and claim pages

**Details:**
CSP allows unsafe-inline for scripts/styles (matches team-dashboard pattern). localStorage for accessToken storage. Magic link token support in login.html via URL hash fragment. /app/dashboard distinct from /dashboard API to avoid route conflicts. Status badge color coding: active=green, past_due=yellow, canceled=red, none=gray.

### Phase 10: Admin System

**Goal**: Admins can view members, manage access, configure feature flags, and review audit logs
**Depends on**: Phase 9
**Plans**: 5 plans

Plans:

- [x] 10-01: Schema updates and admin auth infrastructure
- [x] 10-02: Member management and access control APIs
- [x] 10-03: Feature flags, audit log, and template APIs
- [x] 10-04: Admin account management API
- [x] 10-05: Admin UI pages

**Details:**
Reuse JWT_SECRET with isAdmin:true flag. 30-day admin refresh tokens. Separate cookie path /admin/auth/refresh avoids member cookie conflicts. Case-insensitive admin email lookup. Anti-enumeration on admin login. 1-minute feature flag cache TTL with immediate invalidation on update. Cursor-based pagination for audit logs (scalable for large datasets). Zod v4 uses .issues not .errors. Admin login creates audit log entry. Password reset excludes password from audit for security.

### Phase 11: Frontend Cleanup

**Goal**: Complete frontend coverage with team routes, checkout success, and error handling
**Depends on**: Phase 10
**Plans**: 1 plan

Plans:

- [x] 11-01: Team routes, checkout success, 404 page

**Details:**
Medieval theme for 404 messaging (consistent branding). Catch-all 404 handler at end of routes. /app/* pattern for authenticated pages provides clean URLs.

### Phase 12: Route Restructure

**Goal**: Consolidate all routes under /app/* for consistent URL structure
**Depends on**: Phase 11
**Plans**: 2 plans

Plans:

- [x] 12-01: Auth page routes migration (/auth/* to /app/auth/*)
- [x] 12-02: Admin page routes migration (/admin/* to /app/admin/*)

**Details:**
Auth page routes at /app/auth/* while API routes remain at /auth/* (no breaking changes to fetch calls). Admin page routes at /app/admin/* while admin API routes unchanged (/admin/auth/*, /api/admin/*). Old routes return 404 (no redirects - pre-launch simplicity).

### Phase 13: Billing Portal

**Goal**: Users can access Stripe billing portal to manage their subscription
**Depends on**: Phase 12
**Plans**: 1 plan

Plans:

- [x] 13-01: Stripe billing portal endpoint

**Details:**
Gap closure from audit - missing /billing/portal endpoint. Team members use team.stripeCustomerId (team owns subscription). Return URL /app/dashboard matches Phase 12 route restructure. POST endpoint requires authentication.

### Phase 14: Admin Filter Fix

**Goal**: Admin subscription status filter works correctly
**Depends on**: Phase 13
**Plans**: 1 plan

Plans:

- [x] 14-01: Admin filter parameter alignment

**Details:**
Gap closure from audit - parameter mismatch between frontend and backend. Backend now expects subscriptionStatus parameter matching database field. All filter states work: active, past_due, canceled, none.

### Phase 15: Security Audit

**Goal**: Verify all security controls are properly implemented and fix identified gaps
**Depends on**: Phase 14
**Category**: Audit (Critical - blocks production)
**Plans**: 2 plans

Plans:

- [x] 15-01: Add rate limiting to authentication endpoints
- [x] 15-02: Fix security issues and complete audit verification

**Details:**
Rate limiting on auth endpoints: 5 attempts / 15 min on login/signup/magic-link/admin-login. CORS restricts to APP_URL in production (allow all in dev). credentials: true for CORS supports cookie-based authentication. JWT tokens use secure expiry and httpOnly cookies. Argon2id with OWASP params. All user input validated with Zod schemas. Stripe webhook signatures verified. No hardcoded secrets. CSRF protection on OAuth flows.

### Phase 16: Data Integrity Audit

**Goal**: Verify data constraints and transaction safety through documentation audit
**Depends on**: Phase 15
**Category**: Audit (High - prevents data corruption)
**Plans**: 3 plans

Plans:

- [x] 16-01: Schema and constraint verification audit
- [x] 16-02: Transaction and idempotency verification audit
- [x] 16-03: Backup procedure documentation

**Details:**
Prisma default cascade behavior acceptable (SetNull/Restrict align with app requirements). All 10 unique constraints verified (prevent duplicate Discord/email/Stripe/events). Transaction boundaries verified (seat claim, team payment failure correctly wrapped). Record-before-process pattern for Stripe webhook deduplication. Stripe source of truth verified (DB mirrors via webhooks, never leads). Supabase managed backups adequate. Pro tier recommended for production PITR.

### Phase 17: Code Quality Audit

**Goal**: Identify and document technical debt (audit only, no fixes)
**Depends on**: Phase 16
**Category**: Audit (Medium)
**Plans**: 1 plan

Plans:

- [x] 17-01: Run audit tools and produce prioritized report

**Details:**
Document only, no fixes applied per CONTEXT.md. Script files not dead code (development utilities). Empty catch blocks intentional (JWT verification, Discord DMs - expected failure handling). Circular dependencies acceptable (module initialization and factory patterns). Tech debt tracked: 10 unused exports, 31 circular dependency chains, 7 npm vulnerabilities in transitive deps.

### Phase 18: Performance Audit

**Goal**: Ensure acceptable performance under load
**Depends on**: Phase 17
**Category**: Audit (Medium)
**Plans**: 1 plan

Plans:

- [x] 18-01: Static performance analysis and audit report

**Details:**
PASSED WITH NOTES status. All critical patterns correct. No N+1 database queries. Connection pooling configured. Discord rate limits respected (batch delays). Memory gap is observability enhancement (not production blocker) - memory not exposed in /health endpoint.

### Phase 19: Testing Coverage Audit

**Goal**: Identify gaps in automated testing and document test coverage needs
**Depends on**: Phase 18
**Category**: Audit (Medium)
**Plans**: 1 plan

Plans:

- [x] 19-01: Testing coverage audit report

**Details:**
PASSED WITH GAPS status - documenting gaps is the goal. 0% automated test coverage. 90+ manual test cases documented but not automated. Wave-based test priority recommended: Unit tests first (10-15h), integration (12-18h), bot/reconciliation (8-12h). 70% critical path coverage is industry standard target.

### Phase 20: Accessibility Audit

**Goal**: Ensure WCAG AA compliance
**Depends on**: Phase 19
**Category**: Audit (Medium)
**Plans**: 1 plan

Plans:

- [x] 20-01: WCAG 2.1 AA compliance audit across all HTML pages

**Details:**
PASSED WITH ISSUES status - 47 issues documented; fixes are enhancement work. 3 critical issues (error live regions block screen reader users). 21 major issues (focus indicators - keyboard users cannot see current focus). 23 minor issues. Gold/cream/text colors pass AA contrast requirements. Primary palette has excellent contrast ratios.

### Phase 21: Documentation Audit

**Goal**: Ensure handoff readiness
**Depends on**: Phase 20
**Category**: Audit (Low)
**Plans**: 3 plans

Plans:

- [x] 21-01: README.md and .env.example completion
- [x] 21-02: API documentation (docs/API.md)
- [x] 21-03: Deployment guide and setup verification

**Details:**
README.md with 5-command quick start (minimum friction). .env.example has 31 variables (complete template). Fixed DISCORD_ADMIN_CHANNEL_ID naming to match env.ts. PM2 recommended for process management. Supabase Pro tier recommended (PITR backups). 64+ character JWT_SECRET documented for production security.

### Phase 22: Operational Readiness

**Goal**: Production deployment readiness
**Depends on**: Phase 21
**Category**: Audit (High)
**Plans**: 4 plans

Plans:

- [x] 22-01: Graceful shutdown implementation
- [x] 22-02: Sentry error monitoring integration
- [x] 22-03: Incident runbook and rollback documentation
- [x] 22-04: Operational readiness verification audit

**Details:**
All 8 operational readiness items PASS (100% verification). 10-second app timeout, 15-second PM2 kill_timeout (PM2 needs longer for graceful completion). HTTP -> Discord -> Prisma shutdown order. isShuttingDown flag prevents signal handling race conditions. SENTRY_DSN optional (app runs without for graceful degradation). 10% tracesSampleRate for cost efficiency. Symptom-based runbook organization. 7 incident scenarios. 6-item pre-deployment checklist.

### Phase 23: Email Templates Dashboard

**Goal**: Wire database email templates to actual email sending and enhance admin UI
**Depends on**: Phase 22
**Category**: Enhancement (Medium)
**Plans**: 2 plans

Plans:

- [x] 23-01: Backend template integration and reset endpoint
- [x] 23-02: Frontend UI with categories and dedicated edit page

**Details:**
Single source of truth for DEFAULT_TEMPLATES moved to template-fetcher.ts. Non-blocking variable validation warns but allows save. All admins can edit templates. EMAIL_TEMPLATE_RESET audit action tracks reset operations. Categories: Welcome, Billing, Team, Reminders. Client-side preview with form values (no database fetch). Sample data hardcoded in frontend matches backend.

### Phase 24: Seed Data Testing

**Goal**: Provide comprehensive seed data for testing all application flows
**Depends on**: Phase 23
**Category**: Development (Medium)
**Plans**: 1 plan

Plans:

- [x] 24-01: Comprehensive seed script for all test scenarios

**Details:**
Wipe-and-recreate seed pattern (idempotent, simpler than upsert). @test.example.com domain for test data (easy identification). test_ prefix for team stripeCustomerId (teams need alternate identifier). Non-test admins preserved (cleanup only affects test accounts). Covers edge cases: billing failures, unclaimed, various subscription states.

### Phase 25: Member Self-Service Dashboard

**Goal**: Transform minimal status page into full self-managed membership portal
**Depends on**: Phase 24
**Category**: Enhancement (High - Core UX improvement)
**Plans**: 3 plans

Plans:

- [x] 25-01: Backend account and billing endpoints
- [x] 25-02: Token auto-refresh and admin login validation
- [x] 25-03: Member dashboard frontend with navigation, account, and billing pages

**Details:**
Password required for email changes (magic-link users must set password first). Stripe-first email updates (update Stripe, then DB - atomic failure handling). Team members get managedBy billing response (TEAM_MEMBER seatTier gets limited billing info). Activity timeline from member fields (createdAt, updatedAt, introCompletedAt). Token expiry check before redirect prevents infinite loops with expired admin tokens. Silent refresh attempt for expired tokens (better UX). Navigation header duplicated in each page (self-contained, no shared JS injection). Token refresh 10min interval, 2min threshold (proactive without excessive network calls). Logout button in navigation header. Team info in seat tier display (TEAM_MEMBER shows "Team Member at [Team Name]").

---

## Milestone Summary

**Decimal Phases:**

(None - all phases were planned work)

**Key Decisions:**

- Medieval role theme (Squire, Knight, Lord, Debtor) aligns with "Revenue Council" branding
- Stripe as source of truth with webhook-driven database sync provides clean separation of concerns
- Fire-and-forget Discord operations with p-retry handles rate limits gracefully
- Express 5.x chosen for Stripe documentation alignment (no friction with examples)
- Argon2id password hashing follows OWASP 2025 recommendations
- 15min access / 7-30d refresh tokens balance security with UX
- Admin system in v1 essential for production management with full audit trail
- Email template editing in database enables dynamic content without deploys
- Seed data infrastructure enables fast development iteration

**Issues Resolved:**

- Context overflow risk addressed through milestone archival workflow
- Missing /billing/portal endpoint (Phase 13 gap closure)
- Admin filter parameter mismatch (Phase 14 gap closure)
- Missing /app/account and /app/billing routes (Phase 25 integration gap)
- Security audit identified and closed rate limiting gaps
- Data integrity audit verified all transaction boundaries
- Accessibility audit identified 47 issues for future remediation

**Issues Deferred:**

- Automated test coverage (0% currently, 90+ manual test cases documented)
- 47 accessibility issues (3 critical, 21 major, 23 minor) - ~4.5-6h remediation
- 7 npm vulnerabilities in transitive dependencies
- Memory metrics not exposed in /health endpoint (observability enhancement)

**Technical Debt Incurred:**

- 10 unused exports (script utilities, intentional)
- 31 circular dependency chains (acceptable module patterns)
- TypeScript strict mode has 6 errors to fix (30 min effort)
- Manual testing required with live Stripe/Discord services for full E2E validation

---

_For current project status, see .planning/PROJECT.md_
_Archive created: 2026-01-22 as part of v1.0 milestone completion_
