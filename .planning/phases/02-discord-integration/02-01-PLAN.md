---
phase: 02-discord-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/auth/session.ts
  - src/middleware/session.ts
  - src/routes/auth.ts
  - src/config/env.ts
  - src/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "User session persists across browser refresh"
    - "Short-lived access tokens expire after 15 minutes"
    - "Refresh tokens last 30 days (or 7 without remember-me)"
    - "Invalid/expired tokens return 401"
  artifacts:
    - path: "src/auth/session.ts"
      provides: "JWT creation and verification with jose"
      exports: ["createAccessToken", "createRefreshToken", "verifyToken"]
    - path: "src/middleware/session.ts"
      provides: "Express middleware for protected routes"
      exports: ["requireAuth"]
    - path: "src/routes/auth.ts"
      provides: "Auth routes including refresh"
      exports: ["authRouter"]
  key_links:
    - from: "src/routes/auth.ts"
      to: "src/auth/session.ts"
      via: "verifyToken for refresh endpoint"
      pattern: "verifyToken|createAccessToken"
    - from: "src/middleware/session.ts"
      to: "src/auth/session.ts"
      via: "verifyToken for auth middleware"
      pattern: "verifyToken"
---

<objective>
Create JWT-based session infrastructure for persistent user authentication.

Purpose: Enable users to maintain logged-in state across browser sessions. This is the foundation for OAuth and magic link flows (Plans 02-03 and 02-04).

Output: Session utilities (token creation/verification), auth middleware, and refresh endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-discord-integration/02-CONTEXT.md
@.planning/phases/02-discord-integration/02-RESEARCH.md
@src/index.ts
@src/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session token utilities</name>
  <files>
    src/auth/session.ts
    src/config/env.ts
    package.json
  </files>
  <action>
    Install the cookie package:
    ```bash
    npm install cookie
    npm install -D @types/cookie
    ```

    Update src/config/env.ts to add JWT_SECRET as required string (no prefix validation needed, just non-empty).

    Create src/auth/session.ts with:

    1. Import jose (SignJWT, jwtVerify) and cookie
    2. Create secret from env.JWT_SECRET using TextEncoder
    3. Token types:
       - Access token: 15 minute expiry, payload { sub: memberId }
       - Refresh token: 30 days (rememberMe=true) or 7 days (rememberMe=false), payload { sub: memberId, type: 'refresh' }
    4. Functions:
       - createAccessToken(memberId: string): Promise<string>
       - createRefreshToken(memberId: string, rememberMe: boolean): Promise<string>
       - verifyToken(token: string): Promise<{ sub: string; type?: string } | null>
         (returns null on any error - expired, invalid, etc.)
    5. Cookie config constants:
       - REFRESH_COOKIE_OPTIONS (httpOnly, secure in prod, sameSite: 'strict', path: '/auth/refresh', maxAge 30 days)
       - REFRESH_COOKIE_NAME = 'trc_refresh'

    Use 'HS256' algorithm for all JWTs. Pattern from RESEARCH.md.
  </action>
  <verify>
    File exists: src/auth/session.ts
    TypeScript compiles: npx tsc --noEmit
    Exports are correct: grep for "export.*createAccessToken|createRefreshToken|verifyToken"
  </verify>
  <done>
    Session utilities exist with createAccessToken, createRefreshToken, verifyToken functions and cookie config.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth middleware and routes</name>
  <files>
    src/middleware/session.ts
    src/routes/auth.ts
    src/index.ts
  </files>
  <action>
    Create src/middleware/session.ts:

    1. Define AuthenticatedRequest interface extending Express Request with optional memberId: string
    2. Create requireAuth middleware:
       - Extract Bearer token from Authorization header
       - If missing or malformed, return 401 { error: 'Missing authorization header' }
       - Verify token using verifyToken from session.ts
       - If invalid/expired, return 401 { error: 'Invalid or expired token' }
       - Set req.memberId = payload.sub
       - Call next()

    Create src/routes/auth.ts:

    1. Create Express Router
    2. POST /refresh endpoint:
       - Read refresh token from cookie (using cookie.parse)
       - If missing, return 401 { error: 'No refresh token' }
       - Verify token, check payload.type === 'refresh'
       - If invalid, return 401 { error: 'Invalid refresh token' }
       - Lookup member in database by payload.sub (return 401 if not found)
       - Create new access token
       - Create new refresh token (rotation - issue new one)
       - Set new refresh cookie
       - Return { accessToken, expiresIn: 900 } (900 seconds = 15 min)
    3. POST /logout endpoint:
       - Clear refresh cookie
       - Return 200 { success: true }

    Update src/index.ts:
    - Import authRouter from routes/auth.ts
    - Mount at /auth (after express.json())
  </action>
  <verify>
    TypeScript compiles: npx tsc --noEmit
    Server starts: npm run dev (verify no crash)
    Test refresh without cookie: curl -X POST http://localhost:3000/auth/refresh -> 401
    Test logout: curl -X POST http://localhost:3000/auth/logout -> 200
  </verify>
  <done>
    Auth middleware requireAuth protects routes, /auth/refresh rotates tokens, /auth/logout clears session.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. `curl http://localhost:3000/health` returns 200
3. `curl -X POST http://localhost:3000/auth/refresh` returns 401 (no cookie)
4. `curl -X POST http://localhost:3000/auth/logout` returns 200
5. `npx tsc --noEmit` compiles without errors
</verification>

<success_criteria>
- Session token utilities exist and compile
- Middleware can verify Bearer tokens
- Refresh endpoint rotates tokens
- Logout clears cookies
- JWT_SECRET environment variable is required in config
</success_criteria>

<output>
After completion, create `.planning/phases/02-discord-integration/02-01-SUMMARY.md`
</output>
