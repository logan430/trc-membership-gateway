---
phase: 02-discord-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/bot/client.ts
  - src/bot/roles.ts
  - src/config/env.ts
  - src/config/discord.ts
  - src/index.ts
  - package.json
autonomous: true
user_setup:
  - service: discord
    why: "Bot needs to be created in Discord Developer Portal and invited to server"
    env_vars:
      - name: DISCORD_BOT_TOKEN
        source: "Discord Developer Portal -> Your App -> Bot -> Token -> Reset Token"
      - name: DISCORD_CLIENT_ID
        source: "Discord Developer Portal -> Your App -> General Information -> Application ID"
      - name: DISCORD_CLIENT_SECRET
        source: "Discord Developer Portal -> Your App -> OAuth2 -> Client Secret"
      - name: DISCORD_GUILD_ID
        source: "Discord -> Server Settings -> Widget -> Server ID (or right-click server with dev mode)"
    dashboard_config:
      - task: "Create bot application"
        location: "Discord Developer Portal -> Applications -> New Application"
      - task: "Enable Server Members Intent"
        location: "Discord Developer Portal -> Your App -> Bot -> Privileged Gateway Intents -> Server Members Intent"
      - task: "Invite bot to server with Manage Roles permission"
        location: "Discord Developer Portal -> Your App -> OAuth2 -> URL Generator -> Select bot scope + Manage Roles permission"

must_haves:
  truths:
    - "Bot is online and connected to Discord gateway"
    - "Bot can create roles if they don't exist"
    - "Bot can add roles to members"
    - "Bot can remove roles from members"
    - "Bot alerts admin when role operations fail"
  artifacts:
    - path: "src/bot/client.ts"
      provides: "Discord.js client initialization and startup"
      exports: ["discordClient", "startBot"]
    - path: "src/bot/roles.ts"
      provides: "Role management functions"
      exports: ["addRoleToMember", "removeRoleFromMember", "syncRoles"]
    - path: "src/config/discord.ts"
      provides: "Role configuration and constants"
      exports: ["ROLE_CONFIG", "MANAGED_ROLES"]
  key_links:
    - from: "src/index.ts"
      to: "src/bot/client.ts"
      via: "startBot call on server startup"
      pattern: "startBot\\(\\)"
    - from: "src/bot/client.ts"
      to: "src/bot/roles.ts"
      via: "syncRoles on ClientReady event"
      pattern: "syncRoles"
    - from: "src/bot/roles.ts"
      to: "src/config/discord.ts"
      via: "ROLE_CONFIG for role definitions"
      pattern: "ROLE_CONFIG"
---

<objective>
Create Discord bot with role management capabilities.

Purpose: The bot manages Discord roles based on subscription status. It auto-creates missing roles on startup and provides functions to add/remove roles from members. This enables Phase 3+ to assign roles when users complete subscription flows.

Output: Running Discord bot that can create and manage roles on the configured server.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-discord-integration/02-CONTEXT.md
@.planning/phases/02-discord-integration/02-RESEARCH.md
@src/index.ts
@src/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install discord.js and create Discord config</name>
  <files>
    package.json
    src/config/env.ts
    src/config/discord.ts
  </files>
  <action>
    Install discord.js:
    ```bash
    npm install discord.js
    ```

    Update src/config/env.ts:
    - Change DISCORD_CLIENT_ID from optional to required string
    - Change DISCORD_CLIENT_SECRET from optional to required string
    - Change DISCORD_BOT_TOKEN from optional to required string
    - Change DISCORD_GUILD_ID from optional to required string
    - Add DISCORD_ADMIN_CHANNEL_ID as optional string (for admin alerts)

    Create src/config/discord.ts with role configuration:

    ```typescript
    // Medieval/Council-themed roles per CONTEXT.md
    export const ROLE_CONFIG = {
      SQUIRE: {
        name: 'Squire',
        color: 0x808080,  // Gray - unintroduced
        description: 'Paid but unintroduced member',
      },
      KNIGHT: {
        name: 'Knight',
        color: 0x3498db,  // Blue - active member
        description: 'Introduced individual member',
      },
      LORD: {
        name: 'Lord',
        color: 0xf1c40f,  // Gold - company owner
        description: 'Company owner with full access',
      },
      DEBTOR: {
        name: 'Debtor',
        color: 0xe74c3c,  // Red - billing issue
        description: 'Member with billing issue',
      },
    } as const;

    export const MANAGED_ROLES = Object.values(ROLE_CONFIG).map(r => r.name);

    export type RoleKey = keyof typeof ROLE_CONFIG;
    ```
  </action>
  <verify>
    npm install succeeds
    TypeScript compiles: npx tsc --noEmit
    discord.js in package.json dependencies
  </verify>
  <done>
    discord.js installed, Discord env vars required, role configuration defined with medieval theme.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Discord bot client and role management</name>
  <files>
    src/bot/client.ts
    src/bot/roles.ts
    src/index.ts
  </files>
  <action>
    Create src/bot/client.ts:

    1. Import Client, GatewayIntentBits, Events from discord.js
    2. Import env, logger, and role functions
    3. Create client with intents: Guilds, GuildMembers (privileged - per RESEARCH.md pitfall)
    4. Set up Events.ClientReady handler:
       - Log successful login with bot tag
       - Get guild from cache using env.DISCORD_GUILD_ID
       - If guild not found, log error and return
       - Call syncRoles(guild) to ensure all managed roles exist
       - Set presence: "Managing memberships" (per RESEARCH.md recommendation)
    5. Export startBot() async function:
       - Call client.login(env.DISCORD_BOT_TOKEN)
       - Log that bot is starting
    6. Export discordClient for use in role management

    Create src/bot/roles.ts:

    1. Import discordClient
    2. Import ROLE_CONFIG, MANAGED_ROLES from config/discord.ts
    3. Import logger

    4. alertAdmin(message: string) async function:
       - If env.DISCORD_ADMIN_CHANNEL_ID is set, try to send to that channel
       - If not set or fails, try to DM guild owner
       - Log the alert message regardless
       - Don't throw on failure (alerting is best-effort)

    5. syncRoles(guild: Guild) async function:
       - For each role in ROLE_CONFIG:
         - Check if role exists by name in guild.roles.cache
         - If not, create it with guild.roles.create({ name, color, reason })
         - Log created roles
         - On error, log and call alertAdmin with failure message

    6. addRoleToMember(discordId: string, roleName: string): Promise<boolean>:
       - Get guild from client cache
       - Fetch member by discordId (handle not found)
       - Find role by name
       - Add role to member
       - Return true on success
       - On error, log, alertAdmin, return false

    7. removeRoleFromMember(discordId: string, roleName: string): Promise<boolean>:
       - Same pattern as addRoleToMember but with roles.remove

    Update src/index.ts:
    - Import { startBot } from './bot/client.js'
    - Call startBot() after app.listen() callback
    - This starts the bot after the HTTP server is ready
  </action>
  <verify>
    TypeScript compiles: npx tsc --noEmit
    Server starts: npm run dev (will fail to connect without valid bot token, but should not crash on import)
    With valid token and bot in server: Bot appears online, roles are synced
  </verify>
  <done>
    Discord bot starts on server startup, syncs roles on ready, can add/remove roles from members, alerts admin on failures.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. `npm run dev` starts (bot may fail to connect if token not configured - that's expected)
3. With valid .env configuration and bot invited to server:
   - Bot shows online status
   - Log shows "Bot logged in" and role sync messages
   - Missing roles are auto-created
4. Role functions can be tested manually in a REPL or via a test endpoint
</verification>

<success_criteria>
- discord.js is installed
- Discord env vars are required in config
- Bot client starts on server startup
- Role sync creates missing roles
- addRoleToMember and removeRoleFromMember functions work
- Admin is alerted on role operation failures
</success_criteria>

<output>
After completion, create `.planning/phases/02-discord-integration/02-02-SUMMARY.md`
</output>
