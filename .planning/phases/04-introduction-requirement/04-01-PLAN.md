---
phase: 04-introduction-requirement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/bot/client.ts
  - src/config/env.ts
  - prisma/schema.prisma
  - src/bot/events/introduction.ts
autonomous: true

must_haves:
  truths:
    - "Bot receives messageCreate events from #introductions channel"
    - "Bot receives messageUpdate events for edited messages"
    - "Message content is accessible (not empty string)"
  artifacts:
    - path: "src/bot/client.ts"
      provides: "Discord client with MessageContent and GuildMessages intents"
      contains: "GatewayIntentBits.MessageContent"
    - path: "src/config/env.ts"
      provides: "Introductions channel ID configuration"
      contains: "DISCORD_INTRODUCTIONS_CHANNEL_ID"
    - path: "prisma/schema.prisma"
      provides: "Rate-limiting field for guidance DMs"
      contains: "lastGuidanceDmAt"
    - path: "src/bot/events/introduction.ts"
      provides: "Message event handlers for introduction detection"
      exports: ["setupIntroductionHandlers"]
  key_links:
    - from: "src/bot/events/introduction.ts"
      to: "src/bot/client.ts"
      via: "discordClient event listeners"
      pattern: "discordClient\\.on\\(Events\\.Message"
    - from: "src/bot/client.ts"
      to: "src/bot/events/introduction.ts"
      via: "setupIntroductionHandlers call in ready event"
      pattern: "setupIntroductionHandlers"
---

<objective>
Set up Discord message event infrastructure for introduction detection.

Purpose: Enable the bot to detect when users post messages in the #introductions channel, which is the foundation for the introduction requirement workflow.

Output:
- Bot client with MessageContent privileged intent enabled
- Environment configuration for introductions channel ID
- Message event handlers (messageCreate and messageUpdate)
- Database field for rate-limiting guidance DMs
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-introduction-requirement/04-CONTEXT.md
@.planning/phases/04-introduction-requirement/04-RESEARCH.md
@src/bot/client.ts
@src/config/env.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Message Intents and Channel Config</name>
  <files>src/bot/client.ts, src/config/env.ts</files>
  <action>
1. Update src/bot/client.ts:
   - Add GatewayIntentBits.GuildMessages to the intents array
   - Add GatewayIntentBits.MessageContent to the intents array (privileged intent)
   - Import setupIntroductionHandlers from './events/introduction.js'
   - Call setupIntroductionHandlers() after syncRoles() in the ClientReady event handler

2. Update src/config/env.ts:
   - Add DISCORD_INTRODUCTIONS_CHANNEL_ID to the schema as z.string()
   - This is required since introduction detection is a core feature

Note: MessageContent is a privileged intent. User must enable "Message Content Intent" in Discord Developer Portal > Bot > Privileged Gateway Intents for this to work. The bot already has GuildMembers intent enabled there.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Bot client configured with GuildMessages and MessageContent intents, env schema includes DISCORD_INTRODUCTIONS_CHANNEL_ID</done>
</task>

<task type="auto">
  <name>Task 2: Add Database Field and Create Event Handler</name>
  <files>prisma/schema.prisma, src/bot/events/introduction.ts</files>
  <action>
1. Update prisma/schema.prisma:
   - Add `lastGuidanceDmAt DateTime?` field to Member model (for rate-limiting guidance DMs)
   - Place it after introMessageId field in the "Onboarding state" section

2. Create src/bot/events/introduction.ts with:
   - Import { Events, Message, MessageType, PartialMessage } from 'discord.js'
   - Import discordClient from '../client.js'
   - Import env from '../../config/env.js'
   - Import logger from '../../index.js'
   - Import prisma from '../../lib/prisma.js'

   - Define MIN_INTRO_LENGTH = 100 constant

   - Export setupIntroductionHandlers function that:
     - Registers messageCreate handler: discordClient.on(Events.MessageCreate, handleMessage)
     - Registers messageUpdate handler: discordClient.on(Events.MessageUpdate, handleMessageUpdate)
     - Logs "Introduction handlers registered"

   - Create shouldProcess(message: Message): boolean function that returns false if:
     - message.author.bot is true
     - message.channel.id !== env.DISCORD_INTRODUCTIONS_CHANNEL_ID
     - message.type === MessageType.Reply (per CONTEXT.md: top-level only)
     - Otherwise returns true

   - Create async handleMessage(message: Message): Promise<void> that:
     - Calls shouldProcess, returns if false
     - Calls processIntroduction(message)

   - Create async handleMessageUpdate(oldMessage: Message | PartialMessage, newMessage: Message | PartialMessage): Promise<void> that:
     - If newMessage.partial, try to fetch() it, return on error
     - Calls shouldProcess on the full message, returns if false
     - Calls processIntroduction(newMessage as Message)

   - Create async processIntroduction(message: Message): Promise<void> stub that:
     - Logs { discordId: message.author.id, length: message.content.length } with "Introduction message detected"
     - TODO comment: "Role promotion logic in Plan 04-02"

3. Run prisma generate after schema update

Note: processIntroduction is a stub - actual promotion logic comes in Plan 04-02.
  </action>
  <verify>
- `npx prisma db push` succeeds
- `npx tsc --noEmit` passes
- Bot starts without errors: `npx tsx src/index.ts` (manual check)
  </verify>
  <done>
- Member model has lastGuidanceDmAt field
- Introduction event handlers registered on bot startup
- Messages in #introductions are detected and logged
- Bot messages, replies, and other channels are filtered out
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. TypeScript compiles: `npx tsc --noEmit`
2. Prisma schema valid: `npx prisma validate`
3. Database migrated: `npx prisma db push`
4. Manual test: Start bot, post a message in #introductions, verify log shows "Introduction message detected"

Note: User must first:
- Set DISCORD_INTRODUCTIONS_CHANNEL_ID in .env
- Enable "Message Content Intent" in Discord Developer Portal if not already enabled
</verification>

<success_criteria>
- Bot client has MessageContent and GuildMessages intents
- Env schema requires DISCORD_INTRODUCTIONS_CHANNEL_ID
- Member model has lastGuidanceDmAt field
- Introduction event handlers are registered on bot ready
- Messages in #introductions are detected (logged)
- Bot messages, replies, and other channels are filtered out
</success_criteria>

<output>
After completion, create `.planning/phases/04-introduction-requirement/04-01-SUMMARY.md`
</output>
