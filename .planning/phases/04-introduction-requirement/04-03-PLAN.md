---
phase: 04-introduction-requirement
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/webhooks/stripe.ts
  - src/lib/role-assignment.ts
  - src/bot/roles.ts
autonomous: true

must_haves:
  truths:
    - "customer.subscription.deleted webhook triggers role removal"
    - "User receives farewell DM before being kicked"
    - "All managed roles are removed from user"
    - "User is kicked from the server after role removal"
    - "Database subscription status updated to CANCELLED"
  artifacts:
    - path: "src/webhooks/stripe.ts"
      provides: "Subscription deletion handler"
      contains: "customer.subscription.deleted"
    - path: "src/lib/role-assignment.ts"
      provides: "Remove and kick function"
      exports: ["removeAndKickAsync"]
    - path: "src/bot/roles.ts"
      provides: "Remove all managed roles function"
      exports: ["removeAllManagedRoles"]
  key_links:
    - from: "src/webhooks/stripe.ts"
      to: "src/lib/role-assignment.ts"
      via: "removeAndKickAsync call"
      pattern: "removeAndKickAsync"
    - from: "src/lib/role-assignment.ts"
      to: "src/bot/roles.ts"
      via: "removeAllManagedRoles call"
      pattern: "removeAllManagedRoles"
    - from: "src/lib/role-assignment.ts"
      to: "GuildMember.kick"
      via: "discord.js kick with p-retry"
      pattern: "member\\.kick"
---

<objective>
Handle subscription cancellation by removing roles and kicking user from server.

Purpose: When a subscription actually ends (not just marked for cancellation), remove the user's access by revoking roles, sending a farewell message, and kicking them from the server.

Output:
- customer.subscription.deleted webhook handler
- Farewell DM with resubscribe link
- Role removal and server kick with retry logic
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-introduction-requirement/04-CONTEXT.md
@.planning/phases/04-introduction-requirement/04-RESEARCH.md
@src/webhooks/stripe.ts
@src/lib/role-assignment.ts
@src/bot/roles.ts
@src/config/discord.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Role Removal Functions</name>
  <files>src/bot/roles.ts, src/lib/role-assignment.ts</files>
  <action>
1. Update src/bot/roles.ts to add removeAllManagedRoles function:

   Add export async function removeAllManagedRoles(discordId: string): Promise<boolean>:
   - Get guild from cache using env.DISCORD_GUILD_ID
   - If no guild, log error and return false
   - Fetch member with guild.members.fetch(discordId)
   - Filter member.roles.cache to find roles where MANAGED_ROLES.includes(r.name)
   - If no managed roles found, return true (nothing to remove)
   - Call member.roles.remove(managedRoles, 'Subscription ended')
   - Log info: "Removed all managed roles from member" with discordId and roleNames
   - Return true
   - Catch errors: log error, call alertAdmin, return false

2. Update src/lib/role-assignment.ts to add removeAndKickAsync function:

   Add imports at top:
   - Import { discordClient } from '../bot/client.js'
   - Import { removeAllManagedRoles } from '../bot/roles.js'
   - Import { env } from '../config/env.js'
   - Import { prisma } from './prisma.js'

   Add export function removeAndKickAsync(discordId: string, memberId: string): void:
   - This is fire-and-forget, same pattern as assignRoleAsync
   - Inside: call an async IIFE that does the actual work

   The async work:
   a. Get guild from discordClient.guilds.cache.get(env.DISCORD_GUILD_ID)
      - If no guild, log error and return

   b. Try to fetch the member with guild.members.fetch(discordId)
      - Wrap in try/catch - member may have already left
      - If fetch fails, just update database and return

   c. Send farewell DM (best effort, before kick):
      ```
      try {
        await member.user.send({
          content: `Hail, valued member of The Revenue Council!\n\n` +
            `Your time with our guild has come to an end, but you shall always be remembered.\n\n` +
            `Should you wish to return to our halls, The Gatekeeper awaits: ${env.APP_URL}\n\n` +
            `Fare thee well on your journey!`,
        });
      } catch {
        logger.debug({ discordId }, 'Could not send farewell DM');
      }
      ```

   d. Remove all managed roles:
      - Call removeAllManagedRoles(discordId)

   e. Kick from server with pRetry:
      ```
      await pRetry(
        () => member.kick('Subscription ended'),
        {
          retries: 3,
          minTimeout: 1000,
          onFailedAttempt: (error) => {
            logger.warn({ discordId, attempt: error.attemptNumber }, 'Kick retry');
          },
        }
      );
      ```

   f. Update database:
      ```
      await prisma.member.update({
        where: { id: memberId },
        data: {
          subscriptionStatus: 'CANCELLED',
          introCompleted: false,  // Reset for potential future resub
        },
      });
      ```

   g. Log info: "Member removed from server" with discordId, memberId

   h. Catch outer errors: log error and continue (don't throw from fire-and-forget)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>removeAllManagedRoles removes Squire/Knight/Lord/Debtor roles, removeAndKickAsync sends farewell DM then kicks with retry</done>
</task>

<task type="auto">
  <name>Task 2: Implement Subscription Deleted Webhook Handler</name>
  <files>src/webhooks/stripe.ts</files>
  <action>
Update src/webhooks/stripe.ts to handle customer.subscription.deleted:

1. Add import at top:
   - Import { removeAndKickAsync } from '../lib/role-assignment.js'

2. Replace the existing customer.subscription.deleted case (currently just logs TBD) with:
   ```
   case 'customer.subscription.deleted': {
     const subscription = event.data.object as Stripe.Subscription;

     // Find member by Stripe customer ID
     const member = await prisma.member.findFirst({
       where: { stripeCustomerId: subscription.customer as string },
     });

     if (!member) {
       logger.warn(
         { customerId: subscription.customer },
         'No member found for deleted subscription'
       );
       break;
     }

     if (!member.discordId) {
       // Member never linked Discord - just update status
       await prisma.member.update({
         where: { id: member.id },
         data: { subscriptionStatus: 'CANCELLED' },
       });
       logger.info(
         { memberId: member.id },
         'Subscription cancelled (no Discord linked)'
       );
       break;
     }

     // Remove roles and kick (async with retry)
     removeAndKickAsync(member.discordId, member.id);

     logger.info(
       { memberId: member.id, discordId: member.discordId },
       'Subscription ended, member will be removed from server'
     );
     break;
   }
   ```

Key behaviors per CONTEXT.md:
- customer.subscription.deleted fires when subscription ACTUALLY ENDS (at period end if cancel_at_period_end was set)
- NOT when user initiates cancellation (that's subscription.updated with cancel_at_period_end=true)
- This ensures users keep access until their paid period expires
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Manual test: Use Stripe CLI to trigger customer.subscription.deleted event
  </verify>
  <done>
- customer.subscription.deleted handler finds member and triggers removal
- If no Discord linked, just updates database status
- If Discord linked, calls removeAndKickAsync (farewell DM + kick)
- Subscription status updated to CANCELLED
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. TypeScript compiles: `npx tsc --noEmit`
2. Manual test with Stripe CLI:
   ```
   stripe trigger customer.subscription.deleted
   ```
   Or use Stripe Dashboard to delete a test subscription
3. Verify:
   - Farewell DM received (if DMs enabled)
   - All managed roles removed
   - User kicked from server
   - Database shows subscriptionStatus: 'CANCELLED'
   - Log shows "Subscription ended, member will be removed from server"
</verification>

<success_criteria>
- customer.subscription.deleted webhook triggers removal flow
- Farewell DM sent before kick (best effort)
- All managed roles (Squire, Knight, Lord, Debtor) removed
- User kicked from server with retry
- Database subscription status set to CANCELLED
- introCompleted reset to false for potential resubscription
</success_criteria>

<output>
After completion, create `.planning/phases/04-introduction-requirement/04-03-SUMMARY.md`
</output>
