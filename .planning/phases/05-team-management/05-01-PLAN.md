---
phase: 05-team-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/config/env.ts
  - src/routes/company-checkout.ts
  - src/webhooks/stripe.ts
  - src/index.ts
autonomous: true
user_setup:
  - service: stripe
    why: "Company plan pricing"
    env_vars:
      - name: STRIPE_OWNER_SEAT_PRICE_ID
        source: "Stripe Dashboard -> Products -> Create product 'Owner Seat' -> Add price (recurring monthly) -> Copy price ID"
      - name: STRIPE_TEAM_SEAT_PRICE_ID
        source: "Stripe Dashboard -> Products -> Create product 'Team Seat' -> Add price (recurring monthly) -> Copy price ID"

must_haves:
  truths:
    - "User can purchase Company plan with custom seat counts via Stripe Checkout"
    - "Company name is captured during checkout"
    - "Team record is created with correct seat counts after checkout completes"
    - "Purchaser becomes primary owner of the team"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "isPrimaryOwner field on Member, updated PendingInvite model"
      contains: "isPrimaryOwner"
    - path: "src/config/env.ts"
      provides: "Owner and team seat price ID environment variables"
      contains: "STRIPE_OWNER_SEAT_PRICE_ID"
    - path: "src/routes/company-checkout.ts"
      provides: "Company checkout route with multi-line_item session"
      exports: ["companyCheckoutRouter"]
    - path: "src/webhooks/stripe.ts"
      provides: "Extended webhook handler for company checkout completion"
      contains: "planType.*company"
  key_links:
    - from: "src/routes/company-checkout.ts"
      to: "stripe.checkout.sessions.create"
      via: "multi-line_item session with metadata"
      pattern: "line_items.*STRIPE_OWNER_SEAT_PRICE_ID"
    - from: "src/webhooks/stripe.ts"
      to: "prisma.team.create"
      via: "checkout.session.completed handler"
      pattern: "prisma\\.team\\.create"
---

<objective>
Implement schema updates and company checkout flow for team subscriptions.

Purpose: Enable companies to purchase plans with custom owner and team seat counts via Stripe Checkout, establishing the foundation for team management features.

Output: Updated Prisma schema with isPrimaryOwner field, company checkout route creating multi-line_item Stripe sessions, webhook handler creating Team records on checkout completion.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-team-management/05-CONTEXT.md
@.planning/phases/05-team-management/05-RESEARCH.md
@prisma/schema.prisma
@src/config/env.ts
@src/routes/checkout.ts
@src/webhooks/stripe.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema and environment updates</name>
  <files>
    prisma/schema.prisma
    src/config/env.ts
  </files>
  <action>
Update Prisma schema:
1. Add `isPrimaryOwner Boolean @default(false)` field to Member model (cannot be revoked by other org members)
2. Update PendingInvite model per RESEARCH.md:
   - Remove `email` field (invitees don't need email)
   - Remove `expiresAt` field (tokens never expire per CONTEXT.md)
   - Add `createdBy String` (Member ID who created the invite)
   - Keep: id, teamId, seatTier, token, acceptedAt, acceptedBy, createdAt
   - Keep: @@index on teamId and token

Update env.ts:
1. Add `STRIPE_OWNER_SEAT_PRICE_ID: z.string().startsWith('price_').optional()` (optional for non-company setups)
2. Add `STRIPE_TEAM_SEAT_PRICE_ID: z.string().startsWith('price_').optional()`

Run `npx prisma db push` to sync schema (development mode).
  </action>
  <verify>
`npx prisma db push` succeeds without errors.
`npx prisma generate` succeeds.
TypeScript compiles: `npx tsc --noEmit` passes.
  </verify>
  <done>
Schema has isPrimaryOwner on Member, PendingInvite has no email/expiresAt and has createdBy.
Env schema accepts STRIPE_OWNER_SEAT_PRICE_ID and STRIPE_TEAM_SEAT_PRICE_ID.
  </done>
</task>

<task type="auto">
  <name>Task 2: Company checkout route</name>
  <files>
    src/routes/company-checkout.ts
    src/index.ts
  </files>
  <action>
Create src/routes/company-checkout.ts:

1. Create new Router (companyCheckoutRouter)

2. POST /company/checkout endpoint:
   - Requires authentication (requireAuth middleware)
   - Request body: `{ ownerSeats: number, teamSeats: number, companyName: string }`
   - Validate with zod: ownerSeats >= 1, teamSeats >= 0, companyName non-empty (3-100 chars)
   - Check user doesn't already have active subscription (subscriptionStatus !== 'ACTIVE')
   - Check user doesn't already have a team (teamId is null)

3. Create Team record BEFORE checkout session (prevents webhook race condition per RESEARCH.md):
   ```typescript
   const team = await prisma.team.create({
     data: {
       name: companyName,
       stripeCustomerId: member.stripeCustomerId,
       ownerSeatCount: ownerSeats,
       teamSeatCount: teamSeats,
     },
   });
   ```

4. Create Stripe checkout session with:
   - mode: 'subscription'
   - customer: member.stripeCustomerId
   - client_reference_id: team.id (NOT member.id - team is the reference)
   - custom_fields: company_name (pre-filled, read-only for confirmation)
   - line_items: two items with owner and team seat prices and quantities
   - subscription_data.metadata: { teamId: team.id, planType: 'company', memberId: member.id }
   - success_url: `${env.APP_URL}/team/dashboard?checkout=success`
   - cancel_url: `${env.APP_URL}/company?checkout=cancel`

5. On checkout cancel/failure, the Team record will be orphaned (subscriptionStatus NONE). This is acceptable for MVP - dashboard hides teams without active subscriptions.

6. Return { checkoutUrl: session.url }

Register in src/index.ts:
- Import companyCheckoutRouter
- Mount at `/company` path: `app.use('/company', companyCheckoutRouter)`
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit` passes.
Route is registered: `grep -r "companyCheckoutRouter" src/index.ts` finds import and use.
  </verify>
  <done>
POST /company/checkout creates Team record and returns Stripe checkout URL with multi-seat line items.
  </done>
</task>

<task type="auto">
  <name>Task 3: Webhook handler for company checkout</name>
  <files>src/webhooks/stripe.ts</files>
  <action>
Extend checkout.session.completed handler in src/webhooks/stripe.ts:

1. After existing individual checkout handling, add company checkout detection:
   - Check subscription_data.metadata.planType === 'company'
   - Extract teamId and memberId from metadata

2. For company checkouts:
   - Retrieve subscription with expanded items to get subscription item IDs
   - Find owner and team seat subscription items by price ID matching
   - Update Team record:
     ```typescript
     await prisma.team.update({
       where: { id: teamId },
       data: {
         stripeSubscriptionId: subscription.id,
         subscriptionStatus: 'ACTIVE',
         // Sync seat counts from Stripe (source of truth)
         ownerSeatCount: ownerSeatItem?.quantity ?? 0,
         teamSeatCount: teamSeatItem?.quantity ?? 0,
       },
     });
     ```

3. Update purchaser Member record:
   - Link to team: teamId
   - Set as primary owner: isPrimaryOwner = true, isTeamAdmin = true
   - Set seat tier: seatTier = 'OWNER'
   - Set subscription status: subscriptionStatus = 'ACTIVE'
   - Extract currentPeriodEnd from subscription item

4. Log company checkout completion with teamId, memberId, seat counts.

Important: Use metadata.planType to distinguish from individual checkout (which has client_reference_id as memberId, not teamId).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit` passes.
Webhook handler contains company checkout logic: `grep "planType.*company" src/webhooks/stripe.ts` finds match.
  </verify>
  <done>
Webhook creates Team subscription, links purchaser as primary owner with OWNER seat tier.
  </done>
</task>

</tasks>

<verification>
1. Schema updates applied: `npx prisma db push` succeeds
2. TypeScript compiles: `npx tsc --noEmit` passes
3. Server starts: `npm run dev` starts without errors
4. Company checkout route exists: POST /company/checkout accepts request body
5. Webhook handler extended: Contains company checkout detection and Team/Member updates
</verification>

<success_criteria>
- Prisma schema has isPrimaryOwner field on Member
- PendingInvite model updated (no email/expiresAt, has createdBy)
- Environment accepts STRIPE_OWNER_SEAT_PRICE_ID and STRIPE_TEAM_SEAT_PRICE_ID
- POST /company/checkout creates Team and returns Stripe checkout URL
- checkout.session.completed webhook handles company checkouts differently from individual
- Purchaser becomes team's primary owner with OWNER seat tier
</success_criteria>

<output>
After completion, create `.planning/phases/05-team-management/05-01-SUMMARY.md`
</output>
