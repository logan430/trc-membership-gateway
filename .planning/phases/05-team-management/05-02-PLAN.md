---
phase: 05-team-management
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/routes/team-dashboard.ts
  - src/index.ts
  - public/team-dashboard.html
autonomous: true

must_haves:
  truths:
    - "Company admin can view all claimed seats grouped by type"
    - "Dashboard shows seat summary: Owner X/Y, Team X/Y"
    - "Only team owners can access the dashboard"
    - "Each seat shows member name, email, status, intro completion"
  artifacts:
    - path: "src/routes/team-dashboard.ts"
      provides: "Team dashboard API route"
      exports: ["teamDashboardRouter"]
    - path: "public/team-dashboard.html"
      provides: "Team dashboard UI page"
      contains: "Team Dashboard"
  key_links:
    - from: "src/routes/team-dashboard.ts"
      to: "prisma.team.findUnique"
      via: "Dashboard data query with members include"
      pattern: "prisma\\.team\\.findUnique.*include.*members"
    - from: "public/team-dashboard.html"
      to: "/api/team/dashboard"
      via: "fetch call to load dashboard data"
      pattern: "fetch.*team/dashboard"
---

<objective>
Build the team dashboard where company admins can view all claimed and available seats.

Purpose: Enable company owners to see their team's seat allocation at a glance, showing who has claimed which seats and their status.

Output: Team dashboard API endpoint returning seat data, HTML page displaying the dashboard with medieval theme.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-team-management/05-CONTEXT.md
@.planning/phases/05-team-management/05-RESEARCH.md
@.planning/phases/05-team-management/05-01-SUMMARY.md
@src/routes/dashboard.ts
@src/middleware/session.ts
@public/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Team dashboard API endpoint</name>
  <files>
    src/routes/team-dashboard.ts
    src/index.ts
  </files>
  <action>
Create src/routes/team-dashboard.ts:

1. Create new Router (teamDashboardRouter)

2. GET /team/dashboard endpoint:
   - Requires authentication (requireAuth middleware)
   - Look up member to get their teamId
   - If no teamId, return 404: "Not part of a team"
   - If member.seatTier !== 'OWNER', return 403: "Only team owners can access the dashboard"

3. Query team with all members:
   ```typescript
   const team = await prisma.team.findUnique({
     where: { id: member.teamId },
     include: {
       members: {
         select: {
           id: true,
           discordUsername: true,
           email: true,
           seatTier: true,
           introCompleted: true,
           isPrimaryOwner: true,
           discordId: true,
         },
         orderBy: [
           { isPrimaryOwner: 'desc' },
           { seatTier: 'asc' },
           { createdAt: 'asc' },
         ],
       },
     },
   });
   ```

4. Calculate seat counts:
   ```typescript
   const owners = team.members.filter(m => m.seatTier === 'OWNER');
   const teamMembers = team.members.filter(m => m.seatTier === 'TEAM_MEMBER');

   const seatSummary = {
     owner: { claimed: owners.length, total: team.ownerSeatCount },
     team: { claimed: teamMembers.length, total: team.teamSeatCount },
   };
   ```

5. Return structured response:
   ```typescript
   res.json({
     team: {
       id: team.id,
       name: team.name,
       subscriptionStatus: team.subscriptionStatus,
     },
     seats: seatSummary,
     members: {
       owners: owners.map(m => ({
         id: m.id,
         name: m.discordUsername ?? m.email ?? 'Unclaimed',
         email: m.email,
         status: m.discordId ? 'claimed' : 'pending',
         introCompleted: m.introCompleted,
         isPrimaryOwner: m.isPrimaryOwner,
       })),
       team: teamMembers.map(m => ({
         id: m.id,
         name: m.discordUsername ?? m.email ?? 'Unclaimed',
         email: m.email,
         status: m.discordId ? 'claimed' : 'pending',
         introCompleted: m.introCompleted,
       })),
     },
     currentUser: {
       id: member.id,
       isPrimaryOwner: member.isPrimaryOwner,
     },
   });
   ```

Register in src/index.ts:
- Import teamDashboardRouter
- Mount at `/team` path: `app.use('/team', teamDashboardRouter)`
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit` passes.
Route is registered: `grep -r "teamDashboardRouter" src/index.ts` finds import and use.
  </verify>
  <done>
GET /team/dashboard returns team seat data, accessible only to team owners.
  </done>
</task>

<task type="auto">
  <name>Task 2: Team dashboard HTML page</name>
  <files>public/team-dashboard.html</files>
  <action>
Create public/team-dashboard.html with medieval theme (matching existing Gatekeeper page):

1. Page structure:
   - Title: "Team Dashboard - The Revenue Council"
   - Header with team name
   - Seat summary section: "Owner Seats: 2/3 | Team Seats: 5/10"
   - Two sections: "Owners" and "Team Members"
   - Each member card shows: name, email, status badge (Claimed/Pending), intro status (Introduced/Awaiting)
   - Primary owner has crown icon or "Primary" badge

2. Styling (matching medieval theme from existing pages):
   - Dark background (#1a1a2e)
   - Gold accents (#d4af37)
   - Cinzel font for headers
   - Crimson Text for body
   - Card-based layout for members

3. JavaScript functionality:
   - On load, fetch /team/dashboard API
   - If 401/403/404, redirect to appropriate page with error message
   - Render team name, seat summary, member lists
   - Include action buttons placeholder (for future invite/revoke features)

4. Seat summary display:
   ```html
   <div class="seat-summary">
     <div class="seat-type">
       <span class="seat-icon">&#9813;</span> <!-- Crown for owners -->
       <span class="seat-label">Owner Seats:</span>
       <span class="seat-count">2/3</span>
     </div>
     <div class="seat-type">
       <span class="seat-icon">&#9816;</span> <!-- Knight for team -->
       <span class="seat-label">Team Seats:</span>
       <span class="seat-count">5/10</span>
     </div>
   </div>
   ```

5. Member card template:
   ```html
   <div class="member-card">
     <div class="member-name">John Smith</div>
     <div class="member-email">john@company.com</div>
     <div class="member-badges">
       <span class="badge claimed">Claimed</span>
       <span class="badge introduced">Introduced</span>
     </div>
   </div>
   ```

6. Empty state for each section when no members: "No owner seats claimed yet" / "No team seats claimed yet"
  </action>
  <verify>
File exists: `ls public/team-dashboard.html`
Page is accessible when server runs (requires auth).
  </verify>
  <done>
Team dashboard page displays seat summary and member lists with medieval styling.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit` passes
2. Server starts: `npm run dev` starts without errors
3. API returns data: GET /team/dashboard (with auth) returns JSON with team, seats, members
4. HTML page loads: Navigate to /team-dashboard.html in browser
5. Authorization works: Non-owners get 403, non-team-members get 404
</verification>

<success_criteria>
- GET /team/dashboard returns structured team data with seat counts
- Only team owners can access the dashboard (403 for non-owners)
- Dashboard shows claimed vs total seats for both owner and team tiers
- Each member shows name, status, and introduction completion
- Primary owner is visually distinguished
- Medieval theme consistent with existing pages
</success_criteria>

<output>
After completion, create `.planning/phases/05-team-management/05-02-SUMMARY.md`
</output>
