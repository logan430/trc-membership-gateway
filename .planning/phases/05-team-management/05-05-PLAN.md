---
phase: 05-team-management
plan: 05
type: execute
wave: 4
depends_on: ["05-04"]
files_modified:
  - src/routes/team-dashboard.ts
  - src/lib/role-assignment.ts
  - public/team-dashboard.html
autonomous: true

must_haves:
  truths:
    - "Company admin can revoke a seat from the dashboard"
    - "Revoked member is kicked from Discord server immediately"
    - "Revoked member receives generic farewell DM"
    - "Revoked seat becomes available for reallocation immediately"
    - "Primary owner cannot be revoked by other owners"
  artifacts:
    - path: "src/routes/team-dashboard.ts"
      provides: "Seat revocation endpoint"
      contains: "DELETE /team/members"
    - path: "src/lib/role-assignment.ts"
      provides: "Revocation removal function"
      exports: ["revokeAndKickAsync"]
  key_links:
    - from: "src/routes/team-dashboard.ts"
      to: "src/lib/role-assignment.ts"
      via: "Calling revoke function on member removal"
      pattern: "revokeAndKickAsync"
    - from: "public/team-dashboard.html"
      to: "DELETE /team/members/:id"
      via: "Revoke button click handler"
      pattern: "fetch.*DELETE.*team/members"
---

<objective>
Implement seat revocation allowing company admins to remove team members and free up seats.

Purpose: Enable company owners to manage their team by revoking seats from members who should no longer have access, immediately removing them from Discord and freeing the seat for reallocation.

Output: Revocation API endpoint, role removal and kick function, dashboard UI with revoke buttons.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-team-management/05-CONTEXT.md
@.planning/phases/05-team-management/05-RESEARCH.md
@.planning/phases/05-team-management/05-02-SUMMARY.md
@.planning/phases/05-team-management/05-04-SUMMARY.md
@src/routes/team-dashboard.ts
@src/lib/role-assignment.ts
@public/team-dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Revocation function in role-assignment</name>
  <files>src/lib/role-assignment.ts</files>
  <action>
Add revokeAndKickAsync function to src/lib/role-assignment.ts:

1. Create new exported function for seat revocation:
   ```typescript
   /**
    * Revoke seat and kick member from server asynchronously
    * Fire-and-forget: returns immediately, removal happens in background
    * Similar to removeAndKickAsync but with generic farewell message
    */
   export function revokeAndKickAsync(discordId: string, memberId: string): void {
     (async () => {
       try {
         const guild = discordClient.guilds.cache.get(env.DISCORD_GUILD_ID);
         if (!guild) {
           logger.error('Guild not found in cache');
           return;
         }

         // Try to fetch the member (may have already left)
         let member;
         try {
           member = await guild.members.fetch(discordId);
         } catch {
           // Member not in server - just update database
           logger.debug({ discordId }, 'Member not in server, updating database only');
           await updateRevokedMember(memberId);
           return;
         }

         // Send generic farewell DM (best effort, before kick)
         // Per CONTEXT.md: "Generic DM notification before kick: access ended, no blame assigned"
         try {
           await member.user.send({
             content: `Hail, former member of The Revenue Council!\n\n` +
               `Your access to our guild has ended.\n\n` +
               `We wish you well on your future endeavors.\n\n` +
               `Should circumstances change, The Gatekeeper awaits: ${env.APP_URL}`,
           });
         } catch {
           logger.debug({ discordId }, 'Could not send revocation DM');
         }

         // Remove all managed roles
         await removeAllManagedRoles(discordId);

         // Kick from server with retry
         await pRetry(
           () => member.kick('Seat revoked'),
           {
             retries: 3,
             minTimeout: 1000,
             onFailedAttempt: (error) => {
               logger.warn({ discordId, attempt: error.attemptNumber }, 'Revocation kick retry');
             },
           }
         );

         // Update database
         await updateRevokedMember(memberId);

         logger.info({ discordId, memberId }, 'Member revoked and removed from server');
       } catch (error) {
         logger.error({ discordId, memberId, error }, 'Failed to revoke and kick member');
         // Don't throw from fire-and-forget
       }
     })();
   }
   ```

2. Add helper function for database update:
   ```typescript
   async function updateRevokedMember(memberId: string): Promise<void> {
     await prisma.member.update({
       where: { id: memberId },
       data: {
         teamId: null,
         seatTier: null,
         subscriptionStatus: 'NONE',
         introCompleted: false,
         introCompletedAt: null,
         introMessageId: null,
       },
     });
   }
   ```

Note: Revoked members are unlinked from team but their Member record is preserved (keeps discordId, email for potential future individual subscription).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit` passes.
Function exported: `grep "export.*revokeAndKickAsync" src/lib/role-assignment.ts` finds match.
  </verify>
  <done>
revokeAndKickAsync function sends generic DM, removes roles, kicks member, updates database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Revocation API endpoint</name>
  <files>src/routes/team-dashboard.ts</files>
  <action>
Add DELETE endpoint to src/routes/team-dashboard.ts:

1. DELETE /team/members/:memberId endpoint:
   ```typescript
   teamDashboardRouter.delete('/team/members/:memberId', requireAuth, async (req: AuthenticatedRequest, res: Response): Promise<void> => {
     const { memberId: targetMemberId } = req.params;

     // Get requester
     const requester = await prisma.member.findUnique({
       where: { id: req.memberId },
     });

     if (!requester?.teamId) {
       res.status(404).json({ error: 'Not part of a team' });
       return;
     }

     if (requester.seatTier !== 'OWNER') {
       res.status(403).json({ error: 'Only team owners can revoke seats' });
       return;
     }

     // Get target member
     const targetMember = await prisma.member.findUnique({
       where: { id: targetMemberId },
     });

     if (!targetMember) {
       res.status(404).json({ error: 'Member not found' });
       return;
     }

     // Verify target is in same team
     if (targetMember.teamId !== requester.teamId) {
       res.status(403).json({ error: 'Cannot revoke member from another team' });
       return;
     }

     // Cannot revoke yourself
     if (targetMemberId === req.memberId) {
       res.status(400).json({ error: 'Cannot revoke your own seat' });
       return;
     }

     // Primary owner protection per CONTEXT.md
     if (targetMember.isPrimaryOwner) {
       res.status(403).json({ error: 'Primary owner cannot be revoked by other team members' });
       return;
     }

     // Perform revocation
     if (targetMember.discordId) {
       revokeAndKickAsync(targetMember.discordId, targetMemberId);
     } else {
       // Member never linked Discord, just update database
       await prisma.member.update({
         where: { id: targetMemberId },
         data: {
           teamId: null,
           seatTier: null,
           subscriptionStatus: 'NONE',
         },
       });
     }

     logger.info(
       { requesterId: req.memberId, targetMemberId, teamId: requester.teamId },
       'Seat revoked'
     );

     res.status(200).json({ success: true, message: 'Seat revoked successfully' });
   });
   ```

2. Import revokeAndKickAsync at top of file:
   ```typescript
   import { revokeAndKickAsync } from '../lib/role-assignment.js';
   ```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit` passes.
Endpoint exists: `grep "DELETE.*team/members" src/routes/team-dashboard.ts` finds match.
  </verify>
  <done>
DELETE /team/members/:memberId revokes seat with primary owner protection.
  </done>
</task>

<task type="auto">
  <name>Task 3: Dashboard UI revoke buttons</name>
  <files>public/team-dashboard.html</files>
  <action>
Update public/team-dashboard.html to add revoke functionality:

1. Add revoke button to each member card (except self and primary owner):
   ```html
   <div class="member-card" data-member-id="{id}">
     <div class="member-info">
       <div class="member-name">{name}</div>
       <div class="member-email">{email}</div>
       <div class="member-badges">
         <span class="badge claimed">Claimed</span>
         {if isPrimaryOwner}<span class="badge primary">Primary</span>{/if}
       </div>
     </div>
     {if !isPrimaryOwner && !isSelf}
     <button class="btn-revoke" onclick="revokeMember('{id}', '{name}')">
       Revoke
     </button>
     {/if}
   </div>
   ```

2. Add confirmation dialog:
   ```javascript
   async function revokeMember(memberId, memberName) {
     const confirmed = confirm(
       `Are you sure you want to revoke ${memberName}'s seat?\n\n` +
       `They will be immediately removed from the Discord server.`
     );

     if (!confirmed) return;

     try {
       const response = await fetch(`/team/members/${memberId}`, {
         method: 'DELETE',
         headers: {
           'Authorization': `Bearer ${getAccessToken()}`,
         },
       });

       if (!response.ok) {
         const error = await response.json();
         alert(`Failed to revoke: ${error.error}`);
         return;
       }

       // Refresh dashboard data
       loadDashboard();
       showNotification('Seat revoked successfully');
     } catch (error) {
       alert('Failed to revoke seat. Please try again.');
     }
   }
   ```

3. Add notification/toast component for success feedback:
   ```javascript
   function showNotification(message) {
     const notification = document.createElement('div');
     notification.className = 'notification';
     notification.textContent = message;
     document.body.appendChild(notification);

     setTimeout(() => notification.remove(), 3000);
   }
   ```

4. Style revoke button (red, warning color):
   ```css
   .btn-revoke {
     background: #8b0000; /* Dark red */
     color: #fff;
     border: none;
     padding: 8px 16px;
     cursor: pointer;
     font-family: 'Cinzel', serif;
   }

   .btn-revoke:hover {
     background: #a00000;
   }
   ```

5. Primary owner visual distinction (crown or special styling).

6. Self-member visual indication (e.g., "You" label, no revoke button).
  </action>
  <verify>
File updated: Revoke buttons visible in dashboard.
Primary owner does not have revoke button.
Current user does not have revoke button on their own card.
  </verify>
  <done>
Dashboard shows revoke buttons with confirmation dialog, primary owner protected, self-revocation prevented.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit` passes
2. Server starts: `npm run dev` starts without errors
3. Revoke endpoint works: DELETE /team/members/:id returns success
4. Primary owner protected: DELETE on primary owner returns 403
5. Self-revocation blocked: DELETE on self returns 400
6. Dashboard shows revoke buttons (except for self and primary owner)
7. Confirmation dialog appears before revocation
8. Revoked member kicked from Discord and database updated
</verification>

<success_criteria>
- DELETE /team/members/:id revokes seat and triggers Discord removal
- Generic farewell DM sent before kick (no blame)
- Revoked member's teamId and seatTier cleared (seat freed)
- Primary owner cannot be revoked by other owners
- Cannot revoke your own seat
- Dashboard shows revoke buttons with proper exclusions
- Confirmation required before revocation
- Seat count updates immediately (freed seat available)
</success_criteria>

<output>
After completion, create `.planning/phases/05-team-management/05-05-SUMMARY.md`
</output>
