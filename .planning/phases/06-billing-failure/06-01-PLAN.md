---
phase: 06-billing-failure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/bot/channels.ts
  - src/bot/client.ts
  - src/config/env.ts
autonomous: true

must_haves:
  truths:
    - "Member model has billing failure tracking fields"
    - "Team model has billing failure tracking fields"
    - "#billing-support channel exists with correct permissions"
    - "Debtor role can view but not send in #billing-support"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Billing failure state fields"
      contains: "paymentFailedAt"
    - path: "src/bot/channels.ts"
      provides: "Channel creation and management"
      exports: ["ensureBillingSupportChannel"]
    - path: "src/config/env.ts"
      provides: "Environment variable for billing channel"
      contains: "DISCORD_BILLING_SUPPORT_CHANNEL_ID"
  key_links:
    - from: "src/bot/channels.ts"
      to: "discord.js"
      via: "guild.channels.create"
      pattern: "guild\\.channels\\.create"
---

<objective>
Add database schema fields for billing failure tracking and create the #billing-support channel with Debtor-only read access.

Purpose: Foundation for billing failure handling - track state in database and have restricted channel ready for Debtors.
Output: Schema migration applied, channel creation utility, channel ensured on bot ready.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-billing-failure/06-CONTEXT.md
@.planning/phases/06-billing-failure/06-RESEARCH.md
@prisma/schema.prisma
@src/config/discord.ts
@src/bot/client.ts
@src/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add billing failure fields to schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add billing failure tracking fields to the Member model:
- paymentFailedAt: DateTime? - When first payment failure detected
- gracePeriodEndsAt: DateTime? - 48 hours after paymentFailedAt
- debtorStateEndsAt: DateTime? - 30 days after entering debtor state
- previousRole: String? - 'Knight' or 'Lord' for restoration
- isInDebtorState: Boolean @default(false)
- sentBillingNotifications: String[] @default([]) - Track which notifications sent

Add billing failure tracking fields to the Team model:
- paymentFailedAt: DateTime?
- gracePeriodEndsAt: DateTime?
- debtorStateEndsAt: DateTime?

Run `npx prisma db push` to apply schema changes.

Note: sentBillingNotifications is a String array (Prisma supports String[] for Postgres). This tracks notification keys like "immediate_sent", "24h_warning_sent" to prevent duplicate notifications.
  </action>
  <verify>
`npx prisma db push` completes without errors.
`npx prisma generate` regenerates client successfully.
  </verify>
  <done>
Member and Team models have all billing failure tracking fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create channel management utility</name>
  <files>src/bot/channels.ts, src/config/env.ts</files>
  <action>
Create src/bot/channels.ts with ensureBillingSupportChannel function:

1. Add DISCORD_BILLING_SUPPORT_CHANNEL_ID to env.ts (optional string - channel may not exist yet)

2. The ensureBillingSupportChannel function should:
   - Check if channel already exists (by name 'billing-support')
   - If exists, return early
   - If not, create the channel with these permission overwrites:
     * @everyone: Deny ViewChannel (hide from everyone by default)
     * Debtor role: Allow ViewChannel, ReadMessageHistory; Deny SendMessages
     * Bot: Allow ViewChannel, SendMessages, ManageMessages (for pinning)
   - After creation, send a pinned message with instructions:
     "Hail, member of The Revenue Council!\n\n" +
     "Thy payment hath encountered difficulties. Fear not - this matter can be resolved.\n\n" +
     "**To restore thy standing:**\n" +
     "1. Visit thy Stripe billing portal to update payment details\n" +
     "2. Once payment succeeds, thy access shall be restored automatically\n\n" +
     "The Treasury awaits thy resolution."
   - Pin the message
   - Log channel creation

3. Export ensureBillingSupportChannel for use in bot/client.ts

Use discord.js ChannelType.GuildText and PermissionFlagsBits for proper typing.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Function is exported from src/bot/channels.ts
  </verify>
  <done>
ensureBillingSupportChannel function exists and handles channel creation with correct permissions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Call channel setup on bot ready</name>
  <files>src/bot/client.ts</files>
  <action>
Update src/bot/client.ts to call ensureBillingSupportChannel when bot is ready:

1. Import ensureBillingSupportChannel from './channels.js'
2. In the 'ready' event handler, after the existing role verification:
   - Call ensureBillingSupportChannel(guild)
   - Wrap in try/catch to prevent bot startup failure if channel creation fails
   - Log success or error

The bot should ensure the #billing-support channel exists on every startup so it's ready when needed.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Bot startup logs show channel check (either exists or created)
  </verify>
  <done>
Bot ensures #billing-support channel exists on startup.
  </done>
</task>

</tasks>

<verification>
All tasks verified:
- Schema has billing failure fields for Member and Team
- Channel creation utility exists with correct permissions
- Bot startup ensures channel exists
</verification>

<success_criteria>
- `npx prisma db push` succeeds with new fields
- `npx tsc --noEmit` passes
- Bot can start and creates/verifies #billing-support channel
- Channel permissions: Debtor can view but not send, everyone else cannot see
</success_criteria>

<output>
After completion, create `.planning/phases/06-billing-failure/06-01-SUMMARY.md`
</output>
