---
phase: 06-billing-failure
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/billing/failure-handler.ts
  - src/billing/notifications.ts
  - src/webhooks/stripe.ts
autonomous: true

must_haves:
  truths:
    - "invoice.payment_failed webhook triggers failure handler"
    - "Only subscription_cycle failures are processed (not checkout failures)"
    - "Grace period starts on first failure only (not reset on retries)"
    - "Individual and team failures are detected and handled"
    - "Immediate DM notification sent on payment failure"
  artifacts:
    - path: "src/billing/failure-handler.ts"
      provides: "Payment failure detection and grace period logic"
      exports: ["handlePaymentFailure", "handleTeamPaymentFailure"]
    - path: "src/billing/notifications.ts"
      provides: "DM notification functions"
      exports: ["sendPaymentFailedDm"]
  key_links:
    - from: "src/webhooks/stripe.ts"
      to: "src/billing/failure-handler.ts"
      via: "handlePaymentFailure import and call"
      pattern: "handlePaymentFailure"
    - from: "src/billing/failure-handler.ts"
      to: "src/billing/notifications.ts"
      via: "sendPaymentFailedDm call"
      pattern: "sendPaymentFailedDm"
---

<objective>
Implement payment failure detection via webhook and start the grace period with immediate DM notification.

Purpose: Detect when payments fail, record the failure timestamp, and notify the user immediately while they still have full access during the 48-hour grace period.
Output: Webhook handler for invoice.payment_failed, grace period tracking, DM notifications.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-billing-failure/06-CONTEXT.md
@.planning/phases/06-billing-failure/06-RESEARCH.md
@.planning/phases/06-billing-failure/06-01-SUMMARY.md
@src/webhooks/stripe.ts
@src/lib/role-assignment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing notifications module</name>
  <files>src/billing/notifications.ts</files>
  <action>
Create src/billing/notifications.ts with DM notification functions.

Create sendPaymentFailedDm function:
- Takes memberId: string, type: 'immediate' | '24h_warning'
- Fetches member from database (needs discordId)
- Fetches Discord user via discordClient
- Sends DM with medieval-themed message

For 'immediate' type (payment just failed, grace period started):
"Hark! The Treasury reports a matter requiring thy attention.\n\n" +
"A payment for thy membership hath encountered difficulties. " +
"Fear not - thou hast 48 hours to resolve this matter whilst retaining full access.\n\n" +
"Visit thy Stripe billing portal to update thy payment details.\n\n" +
"The Council values thy presence and awaits thy resolution."

For '24h_warning' type (24 hours into grace period):
"A gentle reminder from The Treasury.\n\n" +
"Thy payment matter remaineth unresolved. In 24 hours, thy access shall be restricted " +
"until payment is restored.\n\n" +
"Visit thy Stripe billing portal to update thy payment details.\n\n" +
"The Council hopes to see this matter resolved swiftly."

Use try/catch - DMs can fail if user has DMs disabled. Log but don't throw.

Create sendTeamPaymentFailedDm function:
- Takes member: Member, isOwner: boolean
- For owner: Full billing details (same as individual)
- For team member (non-owner): Brief notice only
  "Hail, member of The Revenue Council!\n\n" +
  "Thy organization hath encountered a billing matter. " +
  "Please contact thy organization administrator for details.\n\n" +
  "Thy access may be affected if this matter is not resolved."

Export both functions.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Functions are exported from src/billing/notifications.ts
  </verify>
  <done>
sendPaymentFailedDm and sendTeamPaymentFailedDm functions send medieval-themed DMs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create payment failure handler</name>
  <files>src/billing/failure-handler.ts</files>
  <action>
Create src/billing/failure-handler.ts with payment failure logic.

Create handlePaymentFailure function:
- Takes invoice: Stripe.Invoice
- Check billing_reason === 'subscription_cycle' (renewal failures only, not checkout)
- If not subscription_cycle, return early (first-time payment failures handled differently)
- Find member by stripeCustomerId (invoice.customer)
- If no member found, log warning and return
- Check if member is in a team - if yes, delegate to handleTeamPaymentFailure
- Check if paymentFailedAt is already set (existing failure)
  - If already set: Don't reset grace period, just log
  - If not set: This is first failure, start grace period
- For first failure:
  - Set paymentFailedAt to now
  - Set gracePeriodEndsAt to now + 48 hours
  - Set subscriptionStatus to 'PAST_DUE'
  - Send immediate DM notification
  - Mark 'immediate' notification as sent in sentBillingNotifications array
- Log the payment failure

Create handleTeamPaymentFailure function:
- Takes team: Team (with members included), invoice: Stripe.Invoice
- Check if team.paymentFailedAt is already set
  - If set: Don't reset grace period
  - If not set: Start grace period for team
- For first failure:
  - Update Team: paymentFailedAt, gracePeriodEndsAt (48h), subscriptionStatus
  - For each team member with discordId:
    - Update member: paymentFailedAt, gracePeriodEndsAt, subscriptionStatus
    - Send DM (owner gets full details, others get brief notice)
    - Mark notification as sent
- Log team payment failure

Important:
- Use prisma.$transaction for atomic updates when updating multiple members
- Grace period is 48 * 60 * 60 * 1000 milliseconds
- Only the owner (isPrimaryOwner or isTeamAdmin) gets full billing details

Export handlePaymentFailure and handleTeamPaymentFailure.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Functions are exported from src/billing/failure-handler.ts
  </verify>
  <done>
handlePaymentFailure detects failures and starts grace period with DM notification.
handleTeamPaymentFailure handles team subscriptions, notifying all members.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire webhook to failure handler</name>
  <files>src/webhooks/stripe.ts</files>
  <action>
Update src/webhooks/stripe.ts to call the failure handler.

1. Import handlePaymentFailure from '../billing/failure-handler.js'

2. Replace the placeholder invoice.payment_failed case:
```typescript
case 'invoice.payment_failed': {
  const invoice = event.data.object as Stripe.Invoice;
  await handlePaymentFailure(invoice);
  break;
}
```

The handlePaymentFailure function handles all the logic including:
- Filtering for subscription_cycle only
- Finding individual vs team subscriptions
- Starting grace period
- Sending notifications

Keep the existing logger.info as a backup in case handlePaymentFailure returns early.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
invoice.payment_failed case calls handlePaymentFailure
  </verify>
  <done>
Webhook routes invoice.payment_failed to billing failure handler.
  </done>
</task>

</tasks>

<verification>
All tasks verified:
- Notification functions send medieval-themed DMs
- Failure handler processes individual and team failures
- Webhook routes to failure handler
- Grace period starts on first failure, not reset on retries
</verification>

<success_criteria>
- `npx tsc --noEmit` passes
- invoice.payment_failed webhook triggers handlePaymentFailure
- Grace period (48h) is recorded in database
- DM is sent to user on payment failure
- Team members all notified (owner full details, others brief)
</success_criteria>

<output>
After completion, create `.planning/phases/06-billing-failure/06-02-SUMMARY.md`
</output>
