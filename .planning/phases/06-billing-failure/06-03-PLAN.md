---
phase: 06-billing-failure
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - src/billing/debtor-state.ts
  - src/billing/scheduler.ts
  - src/billing/notifications.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "User transitions to Debtor state after 48-hour grace period expires"
    - "Previous role (Knight/Lord) is stored before role swap"
    - "Debtor role is assigned, replacing previous role"
    - "Scheduler polls every 5 minutes for state transitions"
    - "Notification cadence is followed (24h warning, 48h debtor, reminders)"
    - "User is kicked after 30 days in Debtor state"
  artifacts:
    - path: "src/billing/debtor-state.ts"
      provides: "Debtor state transition logic"
      exports: ["moveToDebtorState", "kickAfterDebtorExpiry"]
    - path: "src/billing/scheduler.ts"
      provides: "Polling scheduler for state transitions"
      exports: ["startBillingScheduler"]
  key_links:
    - from: "src/billing/scheduler.ts"
      to: "src/billing/debtor-state.ts"
      via: "moveToDebtorState call"
      pattern: "moveToDebtorState"
    - from: "src/index.ts"
      to: "src/billing/scheduler.ts"
      via: "startBillingScheduler import and call"
      pattern: "startBillingScheduler"
---

<objective>
Implement Debtor state transition after grace period expiry, notification cadence, and kick after 30-day Debtor limit.

Purpose: Move users to restricted Debtor role after grace period, send reminder notifications on schedule, and kick after maximum Debtor duration.
Output: Debtor state functions, billing scheduler with polling, extended notifications.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-billing-failure/06-CONTEXT.md
@.planning/phases/06-billing-failure/06-RESEARCH.md
@.planning/phases/06-billing-failure/06-01-SUMMARY.md
@.planning/phases/06-billing-failure/06-02-SUMMARY.md
@src/billing/notifications.ts
@src/lib/role-assignment.ts
@src/bot/roles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Debtor state transition functions</name>
  <files>src/billing/debtor-state.ts</files>
  <action>
Create src/billing/debtor-state.ts with Debtor state management.

Create moveToDebtorState function:
- Takes memberId: string
- Fetch member from database
- If no discordId, just update database state and return
- Fetch Discord guild and member
- CRITICAL: Determine previous role BEFORE any changes:
  - Check if member has 'Lord' role -> previousRole = 'Lord'
  - Otherwise -> previousRole = 'Knight'
- Update database FIRST (before role changes):
  - Set previousRole to captured value
  - Set isInDebtorState = true
  - Set debtorStateEndsAt = now + 30 days
- Remove all managed roles using removeAllManagedRoles
- Add Debtor role using addRoleToMember
- Send Debtor state notification DM
- Log the transition

Create moveTeamToDebtorState function:
- Takes teamId: string
- Fetch team with all members
- Update team: isInDebtorState conceptually tracked via paymentFailedAt
- For each team member with discordId:
  - Call moveToDebtorState(member.id)
- Log team transition

Create kickAfterDebtorExpiry function:
- Takes memberId: string
- Fetch member
- Similar to existing removeAndKickAsync pattern but with Debtor-specific message:
  "Hail, former member of The Revenue Council!\n\n" +
  "Thy billing matter hath remained unresolved for 30 days. " +
  "As such, thy access to the guild hath ended.\n\n" +
  "Should thy circumstances change, The Gatekeeper awaits: " + APP_URL + "\n\n" +
  "We hope to see thee return in better times."
- Remove all roles, kick from server
- Update database: clear all billing failure fields, set subscriptionStatus to CANCELLED
- For team members: also invalidate pending invites for the team

Create kickTeamAfterDebtorExpiry function:
- Takes teamId: string
- Kick all team members
- Invalidate all pending invites for team
- Update team subscriptionStatus to CANCELLED

Export all functions.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Functions are exported from src/billing/debtor-state.ts
  </verify>
  <done>
moveToDebtorState transitions user to Debtor role, storing previous role.
kickAfterDebtorExpiry removes user after 30-day limit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend notifications for full cadence</name>
  <files>src/billing/notifications.ts</files>
  <action>
Extend src/billing/notifications.ts with additional notification types.

Add to the existing sendPaymentFailedDm function - new notification types:
- 'debtor_transition': "Thy grace period hath expired.\n\nThy access to The Revenue Council is now restricted to the #billing-support channel until thy payment matter is resolved.\n\nVisit thy Stripe billing portal to update thy payment details.\n\nThe Council awaits thy return to full standing."

Create sendBillingReminderDm function:
- Takes memberId: string, daysRemaining: number
- For general reminders (7, 10, 15, 20, 25 days remaining):
  "A reminder from The Treasury.\n\nThy payment matter remaineth unresolved. Thou hast {daysRemaining} days remaining before thy access to the guild shall end entirely.\n\nVisit thy Stripe billing portal to resolve this matter.\n\nThe Council values thy membership."

Create sendFinalWarningDm function:
- Takes memberId: string, hoursRemaining: number
- For final warnings (48h, 24h, 12h before kick):
  "URGENT: Final Warning from The Treasury.\n\nThy payment matter must be resolved within {hoursRemaining} hours, or thy access to The Revenue Council shall end.\n\nVisit thy Stripe billing portal immediately to update thy payment details.\n\nThis is thy final notice."

Create sendKickNotificationDm function:
- Takes memberId: string
- "Thy time with The Revenue Council hath come to an end.\n\nDue to unresolved billing matters, thy access hath been revoked.\n\nShould thy circumstances change, The Gatekeeper awaits: {APP_URL}\n\nFare thee well."

Export all new functions.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
All notification functions exported
  </verify>
  <done>
Full notification cadence implemented with medieval-themed messages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create billing scheduler</name>
  <files>src/billing/scheduler.ts, src/index.ts</files>
  <action>
Create src/billing/scheduler.ts with polling-based scheduler.

Define NOTIFICATION_SCHEDULE constant array per CONTEXT.md:
```typescript
const NOTIFICATION_SCHEDULE = [
  { offsetHours: 0, key: 'immediate' },        // Handled in failure-handler
  { offsetHours: 24, key: '24h_warning' },
  { offsetHours: 48, key: 'debtor_transition' },
  // Days in debtor state (offset from paymentFailedAt, so add 48 hours base)
  { offsetHours: 48 + 7 * 24, key: '7d_reminder' },
  { offsetHours: 48 + 10 * 24, key: '10d_reminder' },
  { offsetHours: 48 + 15 * 24, key: '15d_reminder' },
  { offsetHours: 48 + 20 * 24, key: '20d_reminder' },
  { offsetHours: 48 + 25 * 24, key: '25d_reminder' },
  // Final warnings (relative to 30-day kick = 48h grace + 30 days debtor)
  { offsetHours: 48 + 28 * 24, key: '48h_before_kick' },
  { offsetHours: 48 + 29 * 24, key: '24h_before_kick' },
  { offsetHours: 48 + 29.5 * 24, key: '12h_before_kick' },
];
```

Create startBillingScheduler function:
- Sets up setInterval with 5-minute polling (5 * 60 * 1000)
- Each poll:
  1. Process grace period expirations:
     - Find members where gracePeriodEndsAt <= now AND isInDebtorState = false AND paymentFailedAt != null
     - For each, call moveToDebtorState
  2. Process debtor state expirations:
     - Find members where debtorStateEndsAt <= now AND isInDebtorState = true
     - For each, call kickAfterDebtorExpiry
  3. Process notification cadence:
     - Find members with paymentFailedAt != null
     - For each, calculate hours since failure
     - For each notification in schedule:
       - If hours >= offsetHours AND key not in sentBillingNotifications:
         - Send appropriate notification (DM function based on key)
         - Add key to sentBillingNotifications array
- Log each poll completion with counts
- Wrap in try/catch to prevent scheduler crash

Also handle teams:
- Find teams with paymentFailedAt != null
- Process team grace period and debtor expirations similarly
- Notifications go to individual members (already handled above)

Update src/index.ts:
- Import startBillingScheduler
- Call startBillingScheduler() after bot is ready and server is listening
- Log scheduler start

Export startBillingScheduler.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
startBillingScheduler is exported and called in index.ts
  </verify>
  <done>
Scheduler polls every 5 minutes, processes state transitions and notifications.
  </done>
</task>

</tasks>

<verification>
All tasks verified:
- Debtor state transition stores previous role and swaps roles
- Notifications cover full cadence per CONTEXT.md
- Scheduler polls and processes all state transitions
- Kick happens after 30-day debtor limit
</verification>

<success_criteria>
- `npx tsc --noEmit` passes
- Grace period expiry moves user to Debtor state
- Previous role captured before swap
- Notification cadence followed
- 30-day limit enforced with kick
- Pending invites invalidated on team kick
</success_criteria>

<output>
After completion, create `.planning/phases/06-billing-failure/06-03-SUMMARY.md`
</output>
