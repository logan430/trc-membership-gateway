---
phase: 06-billing-failure
plan: 04
type: execute
wave: 4
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - src/billing/recovery-handler.ts
  - src/billing/notifications.ts
  - src/webhooks/stripe.ts
  - public/team-dashboard.html
autonomous: true

must_haves:
  truths:
    - "invoice.paid webhook triggers recovery handler"
    - "Recovery during grace period clears failure state, confirms via DM"
    - "Recovery from Debtor state restores previous role (Knight/Lord)"
    - "Team recovery restores all team members together"
    - "Team dashboard shows billing status banner when in failure state"
  artifacts:
    - path: "src/billing/recovery-handler.ts"
      provides: "Payment recovery detection and role restoration"
      exports: ["handlePaymentRecovery", "handleTeamPaymentRecovery"]
    - path: "public/team-dashboard.html"
      provides: "Billing status banner for team dashboard"
      contains: "billing-banner"
  key_links:
    - from: "src/webhooks/stripe.ts"
      to: "src/billing/recovery-handler.ts"
      via: "handlePaymentRecovery import and call"
      pattern: "handlePaymentRecovery"
    - from: "src/billing/recovery-handler.ts"
      to: "src/bot/roles.ts"
      via: "addRoleToMember call"
      pattern: "addRoleToMember"
---

<objective>
Implement payment recovery detection via webhook, restore previous roles, and add billing status banner to team dashboard.

Purpose: When payment succeeds after failure, immediately restore user access and celebrate their return. Show billing status on dashboard so owners know their team's situation.
Output: Recovery webhook handler, role restoration, dashboard billing banner.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-billing-failure/06-CONTEXT.md
@.planning/phases/06-billing-failure/06-RESEARCH.md
@.planning/phases/06-billing-failure/06-01-SUMMARY.md
@.planning/phases/06-billing-failure/06-02-SUMMARY.md
@.planning/phases/06-billing-failure/06-03-SUMMARY.md
@src/billing/notifications.ts
@src/webhooks/stripe.ts
@src/bot/roles.ts
@public/team-dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add recovery notification functions</name>
  <files>src/billing/notifications.ts</files>
  <action>
Add recovery notification functions to src/billing/notifications.ts.

Create sendGracePeriodRecoveryDm function:
- Takes memberId: string
- "Huzzah! The Treasury brings glad tidings!\n\n" +
  "Thy payment hath been received and thy standing with The Revenue Council remaineth intact.\n\n" +
  "We thank thee for thy swift attention to this matter.\n\n" +
  "The Council celebrates thy continued membership!"

Create sendDebtorRecoveryDm function:
- Takes memberId: string, restoredRole: string
- "Welcome back to The Revenue Council!\n\n" +
  "Thy payment hath been received and thy full access is now restored.\n\n" +
  "Thou hast been restored to the rank of {restoredRole}.\n\n" +
  "The Council celebrates thy return! May thy continued membership bring prosperity."

Create sendTeamRecoveryDm function:
- Takes memberId: string, isOwner: boolean
- For owner: Same as sendDebtorRecoveryDm with additional "Thy team hath been restored."
- For team member: "Huzzah! Thy organization's payment matter hath been resolved.\n\n" +
  "Thy access to The Revenue Council is fully restored.\n\n" +
  "The Council welcomes thee back!"

Export all new functions.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
All recovery notification functions exported
  </verify>
  <done>
Recovery DM functions send celebratory medieval-themed messages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create payment recovery handler</name>
  <files>src/billing/recovery-handler.ts</files>
  <action>
Create src/billing/recovery-handler.ts with payment recovery logic.

Create handlePaymentRecovery function:
- Takes invoice: Stripe.Invoice
- Check billing_reason === 'subscription_cycle' (only renewal payments)
- Find member by stripeCustomerId (invoice.customer)
- If no member or no paymentFailedAt, return (wasn't in failure state)
- Check if member is in team - if yes, delegate to handleTeamPaymentRecovery

For individual recovery:
- If isInDebtorState === true:
  - Restore from Debtor state:
    - Get previousRole (default to 'Knight' if null)
    - Remove Debtor role using removeRoleFromMember
    - Add previous role using addRoleToMember
    - Send sendDebtorRecoveryDm with restored role
- Else (in grace period):
  - Send sendGracePeriodRecoveryDm (no role changes needed)

- Clear all billing failure state in database:
  - paymentFailedAt = null
  - gracePeriodEndsAt = null
  - debtorStateEndsAt = null
  - previousRole = null
  - isInDebtorState = false
  - sentBillingNotifications = []
  - subscriptionStatus = 'ACTIVE'
- Log recovery

Create handleTeamPaymentRecovery function:
- Takes team: Team (with members), invoice: Stripe.Invoice
- Clear team billing failure state
- For each team member:
  - If isInDebtorState:
    - Restore their previous role
    - Send team recovery DM (owner gets full message, others get brief)
  - Else:
    - Send grace period recovery DM
  - Clear member billing failure state
- Log team recovery

Create restoreFromDebtorState helper function:
- Takes member: Member
- Fetches Discord member
- previousRole = member.previousRole ?? 'Knight'
- Remove Debtor role
- Add previousRole
- Return previousRole for notification

Export handlePaymentRecovery and handleTeamPaymentRecovery.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Functions are exported from src/billing/recovery-handler.ts
  </verify>
  <done>
handlePaymentRecovery restores access and sends recovery notifications.
Debtor state recovery restores previous role (Knight/Lord).
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire webhook and update dashboard</name>
  <files>src/webhooks/stripe.ts, public/team-dashboard.html, src/routes/team-dashboard.ts</files>
  <action>
Update src/webhooks/stripe.ts:
1. Import handlePaymentRecovery from '../billing/recovery-handler.js'
2. Update invoice.payment_succeeded case:
```typescript
case 'invoice.paid': {
  const invoice = event.data.object as Stripe.Invoice;
  await handlePaymentRecovery(invoice);
  break;
}
```
Note: Use 'invoice.paid' not 'invoice.payment_succeeded' - they're equivalent but 'invoice.paid' is more commonly used.

Update src/routes/team-dashboard.ts:
- Add paymentFailedAt and subscriptionStatus to the team data returned by GET /team/dashboard
- The dashboard can use this to show billing status

Update public/team-dashboard.html:
- Add billing status banner at top of dashboard content (after header, before seat summary)
- Show banner when team has paymentFailedAt or subscriptionStatus is 'PAST_DUE':

```html
<div id="billing-banner" class="billing-banner" style="display: none;">
  <div class="banner-icon">!</div>
  <div class="banner-content">
    <strong>Billing Issue</strong>
    <p>There is an issue with your subscription payment. Please update your payment method in the Stripe billing portal to restore full access for your team.</p>
  </div>
</div>
```

Style the banner:
- Background: rgba(231, 76, 60, 0.1) - subtle red tint
- Border: 2px solid #e74c3c (red to match Debtor role color)
- Padding, margin, flex layout
- Warning icon styling

JavaScript:
- Check if team.paymentFailedAt exists or team.subscriptionStatus === 'PAST_DUE'
- If yes, show the billing-banner div
- Keep all other dashboard functionality intact (owners can still manage team per CONTEXT.md)
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
invoice.paid case calls handlePaymentRecovery
Dashboard shows billing banner when appropriate
  </verify>
  <done>
Webhook routes invoice.paid to recovery handler.
Team dashboard shows billing status banner when in failure state.
  </done>
</task>

</tasks>

<verification>
All tasks verified:
- Recovery notifications are celebratory and medieval-themed
- Recovery handler restores previous role from Debtor state
- Grace period recovery clears state without role changes
- Team recovery handles all members together
- Dashboard shows billing status banner
</verification>

<success_criteria>
- `npx tsc --noEmit` passes
- invoice.paid webhook triggers handlePaymentRecovery
- Grace period recovery sends confirmation DM
- Debtor state recovery restores previous role (Knight or Lord)
- Team dashboard shows billing banner when paymentFailedAt exists
- All billing failure state cleared on recovery
</success_criteria>

<output>
After completion, create `.planning/phases/06-billing-failure/06-04-SUMMARY.md`
</output>
