---
phase: 07-email-notifications
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/email/templates.ts
  - src/email/send.ts
  - src/webhooks/stripe.ts
  - src/billing/scheduler.ts
autonomous: true

must_haves:
  truths:
    - "Welcome email is sent after successful checkout"
    - "Claim reminder emails are sent at 48h, 7d, 30d, then monthly"
    - "Members who have claimed Discord do not receive claim reminders"
    - "Each reminder is sent only once (tracked in sentBillingNotifications)"
  artifacts:
    - path: "src/email/templates.ts"
      provides: "Plain text email templates"
      exports: ["welcomeEmailTemplate", "claimReminderEmailTemplate"]
    - path: "src/email/send.ts"
      provides: "High-level send functions"
      exports: ["sendWelcomeEmail", "sendClaimReminderEmail"]
  key_links:
    - from: "src/webhooks/stripe.ts"
      to: "src/email/send.ts"
      via: "sendWelcomeEmail call after checkout"
      pattern: "sendWelcomeEmail\\("
    - from: "src/billing/scheduler.ts"
      to: "src/email/send.ts"
      via: "sendClaimReminderEmail in poll loop"
      pattern: "sendClaimReminderEmail\\("
---

<objective>
Implement welcome and claim reminder emails.

Purpose: New members receive a welcome email after payment with instructions to claim their Discord access. Members who haven't claimed receive reminder emails at 48h, 7d, 30d, and monthly thereafter until they claim.

Output: Welcome email fires on checkout; claim reminder scheduler integrated into billing poll.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-notifications/07-RESEARCH.md
@.planning/phases/07-email-notifications/07-01-SUMMARY.md

@src/email/send.ts
@src/webhooks/stripe.ts
@src/billing/scheduler.ts
@src/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email templates for welcome and claim reminders</name>
  <files>
    src/email/templates.ts
  </files>
  <action>
    Create `src/email/templates.ts` with medieval-themed plain text templates:

    1. welcomeEmailTemplate({ claimUrl: string }):
       - Subject: "Welcome to The Revenue Council"
       - Body: Medieval greeting, confirmation of payment, clear CTA to claim Discord access via claimUrl
       - Include signature from "The Gatekeeper" with reply-to reminder

    2. claimReminderEmailTemplate({ claimUrl: string, daysSincePurchase: number }):
       - Subject varies by timing:
         - <= 7d: "Thy Discord access awaits"
         - > 30d: "We miss thee at The Revenue Council" (cheeky tone per CONTEXT.md)
       - Body for cheeky version (30d+): Express gratitude for subscription, note they haven't claimed, emphasize desire to have them in the group
       - Body for standard reminders: Gentle nudge with claim link
       - Both include The Gatekeeper signature

    All templates return { subject: string, text: string }.
    Use TypeScript string template literals for variable interpolation.
    Plain text only - no HTML.
  </action>
  <verify>
    `npm run build` compiles without errors.
    Templates export correctly typed functions.
  </verify>
  <done>
    Welcome and claim reminder templates ready with medieval theme and appropriate tone variations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add send functions and wire welcome email to checkout webhook</name>
  <files>
    src/email/send.ts
    src/webhooks/stripe.ts
  </files>
  <action>
    1. Extend `src/email/send.ts` with:
       - sendWelcomeEmail(email: string, claimUrl: string): Promise<EmailResult>
         - Uses welcomeEmailTemplate to get subject/text
         - Calls emailProvider.send()
         - Logs success/failure
       - sendClaimReminderEmail(email: string, claimUrl: string, daysSincePurchase: number): Promise<EmailResult>
         - Uses claimReminderEmailTemplate
         - Calls emailProvider.send()
         - Logs success/failure with daysSincePurchase

    2. Modify `src/webhooks/stripe.ts` checkout.session.completed handler:
       - After INDIVIDUAL checkout member update, add welcome email:
         ```typescript
         // Send welcome email (fire and forget)
         if (member.email) {
           const claimUrl = `${env.APP_URL}/claim`;
           sendWelcomeEmail(member.email, claimUrl).catch(err => {
             logger.error({ memberId, err }, 'Failed to send welcome email');
           });
         }
         ```
       - For COMPANY checkout, send to purchaser:
         ```typescript
         // Send welcome email to company purchaser
         const purchaser = await prisma.member.findUnique({ where: { id: memberId } });
         if (purchaser?.email) {
           const claimUrl = `${env.APP_URL}/claim`;
           sendWelcomeEmail(purchaser.email, claimUrl).catch(err => {
             logger.error({ memberId, err }, 'Failed to send company welcome email');
           });
         }
         ```

    Import sendWelcomeEmail from '../email/send.js' at top of stripe.ts.
    Fire-and-forget pattern: don't await, use .catch() to log errors.
  </action>
  <verify>
    `npm run build` compiles without errors.
    Test with EMAIL_PROVIDER=console: trigger checkout webhook, see welcome email logged.
  </verify>
  <done>
    Welcome email fires after both individual and company checkout completion.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend billing scheduler with claim reminder cadence</name>
  <files>
    src/billing/scheduler.ts
  </files>
  <action>
    Extend `src/billing/scheduler.ts` to process claim reminders:

    1. Add claim reminder schedule constant (per CONTEXT.md and RESEARCH.md):
       ```typescript
       const CLAIM_REMINDER_SCHEDULE = [
         { offsetHours: 48, key: 'claim_48h' },
         { offsetHours: 7 * 24, key: 'claim_7d' },
         { offsetHours: 30 * 24, key: 'claim_30d' },
         { offsetHours: 60 * 24, key: 'claim_60d' },
         { offsetHours: 90 * 24, key: 'claim_90d' },
         { offsetHours: 120 * 24, key: 'claim_120d' },
         { offsetHours: 150 * 24, key: 'claim_150d' },
         { offsetHours: 180 * 24, key: 'claim_180d' },
       ] as const;
       ```

    2. Add processClaimReminders() function:
       - Query members with: subscriptionStatus='ACTIVE', email not null, discordId IS null
       - For each member, calculate elapsed hours since createdAt
       - Check each reminder in schedule: if elapsed >= offsetHours AND key not in sentBillingNotifications
       - Send claim reminder email with daysSincePurchase = Math.floor(offsetHours / 24)
       - Mark sent by pushing key to sentBillingNotifications (use prisma.member.update)
       - Return count of reminders sent

    3. Call processClaimReminders() at end of processBillingPoll():
       ```typescript
       // 6. Process claim reminders for unclaimed Discord members
       const claimRemindersSent = await processClaimReminders();
       ```
       Update return type and logging to include claimRemindersSent.

    Import sendClaimReminderEmail from '../email/send.js'.
    Re-check discordId right before sending (prevent race with claim).
  </action>
  <verify>
    `npm run build` compiles without errors.
    Test: Create member with ACTIVE status, no discordId, createdAt > 48h ago.
    Run poll, verify claim_48h email logged (with EMAIL_PROVIDER=console).
  </verify>
  <done>
    Claim reminder scheduler sends emails at 48h, 7d, 30d, then monthly up to 6 months.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes
2. Welcome email fires on checkout.session.completed (both individual and company)
3. Claim reminders fire from scheduler for members without discordId
4. Each reminder key tracked in sentBillingNotifications (no duplicates)
5. EMAIL_PROVIDER=console shows all emails in logs
</verification>

<success_criteria>
- EMAIL-02 (Welcome email after payment) - COMPLETE
- EMAIL-03 (Claim reminder at 24h+) - COMPLETE (48h, 7d, 30d, monthly)
- Templates use medieval theme consistent with existing DM notifications
- Fire-and-forget pattern for all email sends (no blocking)
- Claim reminders stop once member has discordId
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-notifications/07-02-SUMMARY.md`
</output>
