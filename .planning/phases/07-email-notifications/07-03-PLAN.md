---
phase: 07-email-notifications
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/email/templates.ts
  - src/email/send.ts
  - src/billing/failure-handler.ts
  - src/billing/recovery-handler.ts
autonomous: true

must_haves:
  truths:
    - "Payment failure email is sent when invoice.payment_failed fires"
    - "Payment failure email includes portal URL and grace period timeline"
    - "Payment recovered email is sent when invoice.paid fires after failure"
    - "Email tone matches existing Discord DM notifications"
  artifacts:
    - path: "src/email/templates.ts"
      provides: "Billing email templates"
      exports: ["paymentFailureEmailTemplate", "paymentRecoveredEmailTemplate"]
    - path: "src/email/send.ts"
      provides: "Billing send functions"
      exports: ["sendPaymentFailureEmail", "sendPaymentRecoveredEmail"]
  key_links:
    - from: "src/billing/failure-handler.ts"
      to: "src/email/send.ts"
      via: "sendPaymentFailureEmail after DM"
      pattern: "sendPaymentFailureEmail\\("
    - from: "src/billing/recovery-handler.ts"
      to: "src/email/send.ts"
      via: "sendPaymentRecoveredEmail after recovery"
      pattern: "sendPaymentRecoveredEmail\\("
---

<objective>
Implement payment failure and recovery emails.

Purpose: Members receive email notification when their payment fails (with portal URL and timeline) and when payment recovers (confirmation of restored access). This complements the existing Discord DM notifications.

Output: Billing failure and recovery emails wired to existing webhook handlers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-notifications/07-RESEARCH.md
@.planning/phases/07-email-notifications/07-01-SUMMARY.md

@src/email/send.ts
@src/email/templates.ts
@src/billing/failure-handler.ts
@src/billing/recovery-handler.ts
@src/billing/notifications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing email templates</name>
  <files>
    src/email/templates.ts
  </files>
  <action>
    Extend `src/email/templates.ts` with billing email templates:

    1. paymentFailureEmailTemplate({ portalUrl: string, gracePeriodHours: number }):
       - Subject: "Action needed: Payment issue with The Revenue Council"
       - Body per CONTEXT.md requirements:
         - Medieval Treasury greeting
         - What happened: payment encountered difficulties
         - Timeline consequences (per CONTEXT.md - create urgency):
           - ${gracePeriodHours} hours grace period
           - After grace: restricted to #billing-support
           - After 30 days in restricted: membership ends
         - Clear CTA: Update payment at ${portalUrl}
         - Common causes: expired card, insufficient funds, bank decline
         - Signature from "The Treasury"
       - Include reply-to reminder

    2. paymentRecoveredEmailTemplate({ wasInDebtorState: boolean }):
       - Subject: "Payment received - Welcome back!"
       - Body varies by wasInDebtorState:
         - If true (was in debtor state): Celebrate full access restoration
         - If false (recovered during grace): Thank for swift resolution, standing intact
       - Medieval tone matching existing DM notifications
       - Signature from "The Treasury"

    Plain text only. Medieval theme consistent with notifications.ts DMs.
  </action>
  <verify>
    `npm run build` compiles without errors.
    Templates export correctly typed functions.
  </verify>
  <done>
    Payment failure and recovery templates ready with urgency indicators and restoration celebration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add send functions and wire to billing handlers</name>
  <files>
    src/email/send.ts
    src/billing/failure-handler.ts
    src/billing/recovery-handler.ts
  </files>
  <action>
    1. Extend `src/email/send.ts` with:
       - sendPaymentFailureEmail(email: string, portalUrl: string, gracePeriodHours = 48): Promise<EmailResult>
         - Uses paymentFailureEmailTemplate
         - Logs with email and success status
       - sendPaymentRecoveredEmail(email: string, wasInDebtorState: boolean): Promise<EmailResult>
         - Uses paymentRecoveredEmailTemplate
         - Logs with email, wasInDebtorState, and success status

    2. Modify `src/billing/failure-handler.ts`:
       - Import sendPaymentFailureEmail from '../email/send.js'
       - Import Stripe for billing portal URL generation
       - In handlePaymentFailure(), after sending DM (sendPaymentFailedDm call):
         ```typescript
         // Send payment failure email (fire and forget)
         if (member.email) {
           // Generate billing portal URL
           const stripe = new Stripe(env.STRIPE_SECRET_KEY);
           const portalSession = await stripe.billingPortal.sessions.create({
             customer: member.stripeCustomerId!,
             return_url: `${env.APP_URL}/dashboard`,
           });
           sendPaymentFailureEmail(member.email, portalSession.url, 48).catch(err => {
             logger.error({ memberId: member.id, err }, 'Failed to send payment failure email');
           });
         }
         ```
       - Same pattern for handleTeamPaymentFailure() - send to team owner only

    3. Modify `src/billing/recovery-handler.ts`:
       - Import sendPaymentRecoveredEmail from '../email/send.js'
       - In handlePaymentRecovery(), after sending recovery DM:
         ```typescript
         // Send payment recovered email (fire and forget)
         if (member.email) {
           const wasInDebtorState = member.isInDebtorState;
           sendPaymentRecoveredEmail(member.email, wasInDebtorState).catch(err => {
             logger.error({ memberId: member.id, err }, 'Failed to send payment recovered email');
           });
         }
         ```
       - Same for team recovery - send to owner only

    Fire-and-forget pattern for all emails. Don't block webhook processing.
  </action>
  <verify>
    `npm run build` compiles without errors.
    Test with EMAIL_PROVIDER=console:
    - Trigger invoice.payment_failed webhook, see failure email logged
    - Trigger invoice.paid webhook after failure, see recovery email logged
  </verify>
  <done>
    Payment failure and recovery emails fire alongside existing DM notifications.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes
2. Payment failure email fires on invoice.payment_failed (with portal URL)
3. Payment recovered email fires on invoice.paid (with appropriate message based on debtor state)
4. Emails complement (not replace) existing Discord DM notifications
5. EMAIL_PROVIDER=console shows all emails in logs
</verification>

<success_criteria>
- EMAIL-04 (Payment failure email) - COMPLETE
- EMAIL-05 (Payment recovered email) - COMPLETE
- Portal URL included in failure email for easy payment update
- Timeline/consequences clearly communicated per CONTEXT.md
- Medieval Treasury theme consistent with DM notifications
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-notifications/07-03-SUMMARY.md`
</output>
