---
phase: 07-email-notifications
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - prisma/schema.prisma
  - src/email/templates.ts
  - src/email/send.ts
  - src/routes/team-invites.ts
autonomous: true

must_haves:
  truths:
    - "Team invite email can be sent when creating invite with email address"
    - "Invite email includes team name, seat tier, claim URL, and context about The Revenue Council"
    - "Email field on invite is optional - admin can still share link manually"
    - "Invite email explains what the recipient is being invited to"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "PendingInvite.inviteeEmail field"
      contains: "inviteeEmail"
    - path: "src/email/templates.ts"
      provides: "Seat invite template"
      exports: ["seatInviteEmailTemplate"]
    - path: "src/email/send.ts"
      provides: "Seat invite send function"
      exports: ["sendSeatInviteEmail"]
  key_links:
    - from: "src/routes/team-invites.ts"
      to: "src/email/send.ts"
      via: "sendSeatInviteEmail when email provided"
      pattern: "sendSeatInviteEmail\\("
---

<objective>
Implement team seat invite emails.

Purpose: When a team owner creates an invite and provides an email address, the invitee receives an email explaining what The Revenue Council is, what access they'll get, and how to claim their seat. Per CONTEXT.md, recipients may never have heard of The Revenue Council, so the email provides full context.

Output: Seat invite emails sent when email provided during invite creation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-notifications/07-RESEARCH.md
@.planning/phases/07-email-notifications/07-01-SUMMARY.md

@src/email/send.ts
@src/email/templates.ts
@src/routes/team-invites.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add inviteeEmail field to PendingInvite schema</name>
  <files>
    prisma/schema.prisma
  </files>
  <action>
    Extend PendingInvite model in `prisma/schema.prisma`:

    ```prisma
    model PendingInvite {
      id          String    @id @default(cuid())

      // Team relationship
      team        Team      @relation(fields: [teamId], references: [id])
      teamId      String

      // Invite details
      seatTier    SeatTier  // OWNER or TEAM_MEMBER
      token       String    @unique
      createdBy   String    // Member ID who created the invite
      inviteeEmail String?  // Optional: email to send invite to

      // Tracking
      acceptedAt  DateTime?
      acceptedBy  String?   // Member ID who accepted

      // Audit timestamps
      createdAt   DateTime  @default(now())

      @@index([teamId])
      @@index([token])
    }
    ```

    Add `inviteeEmail String?` field - optional because admin can still share link manually.

    Run migrations:
    ```bash
    npx prisma db push
    npx prisma generate
    ```
  </action>
  <verify>
    `npx prisma db push` succeeds.
    `npx prisma generate` succeeds.
    PendingInvite type in generated client includes inviteeEmail.
  </verify>
  <done>
    Schema updated with optional inviteeEmail field on PendingInvite.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create seat invite email template and send function</name>
  <files>
    src/email/templates.ts
    src/email/send.ts
  </files>
  <action>
    1. Add to `src/email/templates.ts`:

       seatInviteEmailTemplate({ teamName: string, seatTier: 'OWNER' | 'TEAM_MEMBER', claimUrl: string }):
       - Subject: "You're invited to join ${teamName} at The Revenue Council"
       - Body per CONTEXT.md (full context for recipients who may not know The Revenue Council):
         - Greeting
         - WHAT IS THE REVENUE COUNCIL? section explaining it's a professional community of entrepreneurs for networking, referrals, collaboration via Discord
         - THY INVITATION section: invited by ${teamName}, seat tier description:
           - OWNER: "an Owner seat (with access to exclusive owner-only channels)"
           - TEAM_MEMBER: "a Team Member seat"
         - TO CLAIM THY SEAT steps:
           1. Visit: ${claimUrl}
           2. Connect thy Discord account
           3. Join our Discord server
           4. Introduce thyself in #introductions
         - Note: "Once introduced, thou shalt have full access to the guild"
         - Note: "This invitation doth not expire. Claim it when thou art ready."
         - Signature from "The Gatekeeper"
         - Footer: Questions about invitation -> contact organization admin. Questions about TRC -> reply to email.

    2. Add to `src/email/send.ts`:

       sendSeatInviteEmail(email: string, teamName: string, seatTier: 'OWNER' | 'TEAM_MEMBER', claimUrl: string): Promise<EmailResult>
       - Uses seatInviteEmailTemplate
       - Logs with email, teamName, seatTier, success status
  </action>
  <verify>
    `npm run build` compiles without errors.
    Templates export seatInviteEmailTemplate.
    send.ts exports sendSeatInviteEmail.
  </verify>
  <done>
    Seat invite template provides full context about The Revenue Council and claim process.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire invite email to team-invites endpoint</name>
  <files>
    src/routes/team-invites.ts
  </files>
  <action>
    Modify `src/routes/team-invites.ts`:

    1. Update validation schema to accept optional email:
       ```typescript
       const createInviteSchema = z.object({
         seatTier: z.enum(['OWNER', 'TEAM_MEMBER']),
         email: z.string().email().optional(),
       });
       ```

    2. Import sendSeatInviteEmail from '../email/send.js'

    3. In POST /team/invites handler, after creating invite:
       - Store inviteeEmail in create data if provided
       - If email provided, send invite email:
         ```typescript
         // Send invite email if email provided
         if (parsed.data.email) {
           const inviteUrl = `${env.APP_URL}/team/claim?token=${invite.token}`;
           sendSeatInviteEmail(
             parsed.data.email,
             team.name,
             seatTier,
             inviteUrl
           ).catch(err => {
             logger.error({ inviteId: invite.id, err }, 'Failed to send invite email');
           });
         }
         ```

    4. Include emailSent status in response:
       ```typescript
       res.status(201).json({
         invite: {
           id: invite.id,
           seatTier: invite.seatTier,
           token: invite.token,
           inviteUrl: `${env.APP_URL}/team/claim?token=${invite.token}`,
           inviteeEmail: invite.inviteeEmail,
           emailSent: !!parsed.data.email,
           createdAt: invite.createdAt,
         },
       });
       ```

    Fire-and-forget for email send - don't fail invite creation if email fails.
  </action>
  <verify>
    `npm run build` compiles without errors.
    Test with EMAIL_PROVIDER=console:
    - POST /team/invites with { seatTier: "TEAM_MEMBER", email: "test@example.com" }
    - See invite email logged to console
    - Response includes emailSent: true
    - POST without email field still works (emailSent: false)
  </verify>
  <done>
    Team invites optionally send email with full context about The Revenue Council.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes
2. `npx prisma db push` succeeds (schema migrated)
3. POST /team/invites accepts optional email field
4. When email provided, invite email is sent with full TRC context
5. When email not provided, invite created without email (manual sharing)
6. EMAIL_PROVIDER=console shows invite email in logs
</verification>

<success_criteria>
- EMAIL-06 (Seat invite email with claim link) - COMPLETE
- Email explains what The Revenue Council is (for recipients who don't know)
- Email includes team name, seat tier description, and claim steps
- Email field is optional - doesn't break existing invite flow
- Invite token link works regardless of whether email was sent
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-notifications/07-04-SUMMARY.md`
</output>
