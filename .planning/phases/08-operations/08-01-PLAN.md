---
phase: 08-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/config/env.ts
  - src/reconciliation/types.ts
  - src/reconciliation/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "ReconciliationRun model exists in database"
    - "Environment variables for reconciliation are configurable"
    - "node-cron is installed and typed"
    - "Reconciliation scheduler can be started on app boot"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "ReconciliationRun model"
      contains: "model ReconciliationRun"
    - path: "src/config/env.ts"
      provides: "Reconciliation env vars"
      contains: "RECONCILIATION_AUTO_FIX"
    - path: "src/reconciliation/types.ts"
      provides: "DriftIssue, ReconciliationResult types"
      exports: ["DriftIssue", "ReconciliationResult"]
    - path: "src/reconciliation/index.ts"
      provides: "Scheduler entry point"
      exports: ["startReconciliationScheduler"]
  key_links:
    - from: "src/reconciliation/index.ts"
      to: "src/config/env.ts"
      via: "imports env for config"
      pattern: "import.*env.*from.*config/env"
---

<objective>
Set up reconciliation infrastructure: database model, environment configuration, and module scaffolding.

Purpose: Provides the foundation for drift detection and auto-fix - the ReconciliationRun model stores audit trail, env vars control behavior, and types define the data structures.

Output: ReconciliationRun table, configured env vars, type definitions, and scheduler entry point ready for logic implementation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-operations/08-RESEARCH.md
@prisma/schema.prisma
@src/config/env.ts
@src/billing/scheduler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ReconciliationRun model and install node-cron</name>
  <files>
    - prisma/schema.prisma
    - package.json
  </files>
  <action>
1. Add ReconciliationRun model to prisma/schema.prisma after AuditLog:
```prisma
model ReconciliationRun {
  id                String   @id @default(cuid())
  startedAt         DateTime @default(now())
  completedAt       DateTime?

  // Counts
  membersChecked    Int      @default(0)
  teamsChecked      Int      @default(0)
  issuesFound       Int      @default(0)
  issuesFixed       Int      @default(0)

  // Mode
  autoFixEnabled    Boolean  @default(false)
  isVerificationRun Boolean  @default(false)
  triggeredBy       String   // 'scheduled' | 'manual' | 'verification'

  // Results stored as JSON
  issues            Json     @default("[]")

  @@index([startedAt])
}
```

2. Install node-cron:
```bash
npm install node-cron
npm install -D @types/node-cron
```

3. Run prisma db push to create the table:
```bash
npx prisma db push
```
  </action>
  <verify>
    - `npx prisma validate` passes
    - `npx prisma studio` shows ReconciliationRun table (or db push succeeded)
    - node-cron and @types/node-cron in package.json dependencies
  </verify>
  <done>ReconciliationRun table exists in database, node-cron installed</done>
</task>

<task type="auto">
  <name>Task 2: Add reconciliation env vars</name>
  <files>
    - src/config/env.ts
  </files>
  <action>
Add reconciliation configuration to the env schema in src/config/env.ts:

1. Add these fields to the envSchema object (before the .refine() call):
```typescript
// Reconciliation
RECONCILIATION_AUTO_FIX: z.enum(['true', 'false']).default('false'),
RECONCILIATION_PAUSED: z.enum(['true', 'false']).default('false'),
RECONCILIATION_TIMEZONE: z.string().default('America/New_York'),
RECONCILIATION_HOUR: z.coerce.number().min(0).max(23).default(3), // 3 AM
ADMIN_EMAIL: z.string().email().optional(), // For reconciliation reports
```

Note: Use z.enum(['true', 'false']) for boolean-like env vars (consistent with existing pattern), with string comparison in code (env.X === 'true').
  </action>
  <verify>
    - `npm run build` succeeds (TypeScript compiles)
    - App starts without error (env vars have defaults)
  </verify>
  <done>RECONCILIATION_AUTO_FIX, RECONCILIATION_PAUSED, RECONCILIATION_TIMEZONE, RECONCILIATION_HOUR, ADMIN_EMAIL available in env</done>
</task>

<task type="auto">
  <name>Task 3: Create reconciliation types and scheduler scaffold</name>
  <files>
    - src/reconciliation/types.ts
    - src/reconciliation/index.ts
  </files>
  <action>
1. Create src/reconciliation/types.ts:
```typescript
/**
 * Types for reconciliation system
 */

export type DriftType =
  | 'MISSING_ACCESS'      // Stripe active but Discord has no role
  | 'UNAUTHORIZED_ACCESS' // Discord has role but Stripe inactive
  | 'ROLE_MISMATCH'       // Wrong role for tier (Knight vs Lord)
  | 'DEBTOR_MISMATCH';    // Debtor state doesn't match Debtor role

export type DriftSeverity = 'HIGH' | 'MEDIUM' | 'LOW';

export interface DriftIssue {
  type: DriftType;
  memberId: string;
  discordId: string | null;
  description: string;
  stripeStatus: string | null;
  databaseStatus: string | null;
  discordRoles: string[] | null;
  severity: DriftSeverity;
}

export interface ReconciliationResult {
  runId: string;
  issuesFound: number;
  issuesFixed: number;
  issues: DriftIssue[];
  autoFixEnabled: boolean;
}

export interface ReconciliationOptions {
  isVerificationRerun?: boolean;
  triggeredBy?: 'scheduled' | 'manual' | 'verification';
}
```

2. Create src/reconciliation/index.ts:
```typescript
import cron from 'node-cron';
import { env } from '../config/env.js';
import { logger } from '../index.js';

/**
 * Start the reconciliation scheduler
 * Runs daily at configured hour in configured timezone
 * Can be paused via RECONCILIATION_PAUSED env var
 */
export function startReconciliationScheduler(): void {
  const hour = env.RECONCILIATION_HOUR;
  const timezone = env.RECONCILIATION_TIMEZONE;
  const cronExpression = `0 ${hour} * * *`; // Daily at specified hour

  logger.info(
    { hour, timezone, cronExpression },
    'Starting reconciliation scheduler'
  );

  cron.schedule(
    cronExpression,
    async () => {
      // Check pause flag
      if (env.RECONCILIATION_PAUSED === 'true') {
        logger.info('Reconciliation paused via RECONCILIATION_PAUSED env var');
        return;
      }

      logger.info('Reconciliation job starting (scheduled)');

      try {
        // TODO: runReconciliation() will be implemented in 08-02
        logger.info('Reconciliation job placeholder - implementation in 08-02');
      } catch (error) {
        logger.error({ error }, 'Reconciliation job failed');
      }
    },
    { timezone }
  );

  logger.info('Reconciliation scheduler started');
}

// Re-export types for consumers
export type { DriftIssue, ReconciliationResult, ReconciliationOptions } from './types.js';
```

Note: The actual runReconciliation() implementation will be added in Plan 08-02. This scaffold ensures the scheduler infrastructure is in place and can be wired into app startup.
  </action>
  <verify>
    - `npm run build` succeeds
    - Files exist at src/reconciliation/types.ts and src/reconciliation/index.ts
    - Types are exported correctly (TypeScript can import them)
  </verify>
  <done>DriftIssue, ReconciliationResult types defined; startReconciliationScheduler exports from src/reconciliation/index.ts</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Database verification:
   - `npx prisma db push` succeeded
   - ReconciliationRun model exists in schema

2. Dependency verification:
   - node-cron in dependencies
   - @types/node-cron in devDependencies

3. Build verification:
   - `npm run build` passes
   - No TypeScript errors

4. Module structure:
   - src/reconciliation/types.ts exports types
   - src/reconciliation/index.ts exports startReconciliationScheduler
</verification>

<success_criteria>
- ReconciliationRun table can store audit trail of reconciliation runs
- RECONCILIATION_AUTO_FIX, RECONCILIATION_PAUSED, RECONCILIATION_TIMEZONE, RECONCILIATION_HOUR, ADMIN_EMAIL env vars available
- node-cron installed for daily scheduling
- Reconciliation module scaffold ready for implementation
</success_criteria>

<output>
After completion, create `.planning/phases/08-operations/08-01-SUMMARY.md`
</output>
