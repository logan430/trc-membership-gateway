---
phase: 09-frontend-pages
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - public/dashboard.html
  - public/claim.html
  - src/routes/public.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated user can access /app/dashboard and see subscription status"
    - "User without token is redirected to /auth/login"
    - "User can initiate checkout from dashboard"
    - "User can initiate Discord claim from dashboard"
    - "Claim page shows Discord link button"
    - "Pages follow medieval theme (gold, dark bg, Cinzel/Crimson fonts)"
  artifacts:
    - path: "public/dashboard.html"
      provides: "Dashboard showing subscription status and actions"
      min_lines: 150
    - path: "public/claim.html"
      provides: "Discord claim page with link button"
      min_lines: 80
    - path: "src/routes/public.ts"
      provides: "Routes for /app/dashboard and /app/claim"
      contains: "/app/dashboard"
  key_links:
    - from: "public/dashboard.html"
      to: "/dashboard"
      via: "fetch GET with Bearer token"
      pattern: "fetch.*dashboard.*Authorization"
    - from: "public/dashboard.html"
      to: "/checkout"
      via: "fetch POST for checkout URL"
      pattern: "fetch.*checkout.*POST"
    - from: "public/claim.html"
      to: "/claim/discord"
      via: "window.location redirect"
      pattern: "location.*claim/discord"
    - from: "src/routes/public.ts"
      to: "public/dashboard.html"
      via: "res.sendFile"
      pattern: "sendFile.*dashboard\\.html"
---

<objective>
Create dashboard and claim HTML pages so authenticated users can view subscription status, initiate checkout, and link their Discord account.

Purpose: Provides the member-facing dashboard showing subscription state and actions. Uses `/app/dashboard` and `/app/claim` paths to avoid conflicts with existing API routes at `/dashboard` and `/claim`.

Output: Two HTML pages (dashboard.html, claim.html) with routes in public.ts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-frontend-pages/09-RESEARCH.md

# Existing patterns to follow:
@public/team-dashboard.html (lines 1-100 for structure, 600-800 for JS patterns)
@public/styles.css
@src/routes/public.ts
@src/routes/dashboard.ts (for API response format)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard HTML page with subscription status and actions</name>
  <files>public/dashboard.html</files>
  <action>
    Create public/dashboard.html following team-dashboard.html patterns exactly.

    **Page structure:**
    - Head: meta, title "Dashboard - The Revenue Council", link to styles.css, Google Fonts
    - Inline `<style>` for dashboard-specific styles (status cards, action buttons)
    - Loading state div (shown initially)
    - Error state div (hidden initially)
    - Dashboard content div (hidden initially)
    - Inline `<script>` at end of body

    **Dashboard content sections:**

    1. **Header:** "Your Membership" title, user email display

    2. **Status Card:** Based on subscriptionStatus from API:
       - NONE: "Not Subscribed" - show Subscribe button
       - ACTIVE: "Active Member" - show currentPeriodEnd, Discord status
       - PAST_DUE: "Billing Issue" - show warning banner with link to billing portal
       - CANCELED: "Canceled" - show resubscribe button

    3. **Discord Status:** Based on claim.hasClaimed:
       - Not claimed: "Link Discord" button -> /app/claim
       - Claimed: Show discordUsername, introCompleted status

    4. **Actions:**
       - Logout button (clears localStorage, redirects to /)

    **JavaScript behavior:**

    ```javascript
    // Get access token from localStorage
    function getAccessToken() {
      return localStorage.getItem('accessToken');
    }

    // On page load
    async function loadDashboard() {
      const token = getAccessToken();
      if (!token) {
        window.location.href = '/auth/login?redirect=/app/dashboard';
        return;
      }

      try {
        const response = await fetch('/dashboard', {
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });

        if (response.status === 401) {
          localStorage.removeItem('accessToken');
          window.location.href = '/auth/login?redirect=/app/dashboard';
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to load dashboard');
        }

        const data = await response.json();
        renderDashboard(data);
      } catch (error) {
        showError(error.message);
      }
    }

    // Render dashboard based on API response
    function renderDashboard(data) {
      // Hide loading, show content
      document.getElementById('loading').style.display = 'none';
      document.getElementById('dashboard-content').style.display = 'block';

      // Set email
      document.getElementById('user-email').textContent = data.member.email;

      // Render status based on subscriptionStatus
      const statusContainer = document.getElementById('status-container');
      // ... render based on data.member.subscriptionStatus

      // Render Discord status based on claim
      const discordContainer = document.getElementById('discord-container');
      // ... render based on data.claim.hasClaimed
    }

    // Initiate checkout
    async function initiateCheckout() {
      const response = await fetch('/checkout', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${getAccessToken()}`,
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        const error = await response.json();
        alert(error.error || 'Failed to start checkout');
        return;
      }

      const { checkoutUrl } = await response.json();
      window.location.href = checkoutUrl;
    }

    // Logout
    function logout() {
      localStorage.removeItem('accessToken');
      window.location.href = '/';
    }

    // Initialize on load
    loadDashboard();
    ```

    **API response format (from dashboard.ts):**
    ```json
    {
      "member": {
        "id": "uuid",
        "email": "user@example.com",
        "subscriptionStatus": "NONE" | "ACTIVE" | "PAST_DUE" | "CANCELED",
        "seatTier": "INDIVIDUAL" | "OWNER" | "TEAM",
        "currentPeriodEnd": "2026-02-19T00:00:00.000Z",
        "discordUsername": "User#1234" | null,
        "introCompleted": false
      },
      "claim": {
        "canClaim": true,
        "hasClaimed": false,
        "discordInviteUrl": "https://discord.gg/..."
      }
    }
    ```

    **Inline styles to add (extend team-dashboard.html patterns):**
    - .status-card: Similar to team-dashboard seat-summary
    - .status-badge: Green for active, yellow for past_due, gray for none
    - .action-button: Gold CTA button matching existing cta-button
    - .billing-warning: Red-tinted warning banner for past_due
  </action>
  <verify>
    1. Run `npx tsc --noEmit` - no errors (file is HTML, no TS check needed)
    2. Start server with `npm run dev`
    3. Navigate to http://localhost:3000/app/dashboard without token - redirects to login
    4. Login, navigate to /app/dashboard - shows dashboard with status
    5. Console shows no errors
    6. Page styling matches medieval theme
  </verify>
  <done>
    - dashboard.html created with subscription status display
    - Loading, error, and content states implemented
    - Auth redirect on missing/invalid token
    - Checkout initiation button wired to /checkout API
    - Logout button clears token and redirects
  </done>
</task>

<task type="auto">
  <name>Task 2: Create claim page and add routes</name>
  <files>public/claim.html, src/routes/public.ts</files>
  <action>
    **2a. Create public/claim.html:**

    Follow team-dashboard.html patterns. Simpler page focused on Discord linking.

    **Page structure:**
    - Head: meta, title "Link Discord - The Revenue Council", link to styles.css, Google Fonts
    - Loading state div
    - Error state div
    - Claim content div

    **Claim content sections:**

    1. **Header:** "Link Your Discord Account"

    2. **Status display:**
       - If already claimed: Show Discord username, success message, link back to dashboard
       - If not claimed: Show instructions and "Link Discord Account" button

    3. **Link button:** Redirects to /claim/discord (which starts OAuth flow)

    **JavaScript behavior:**

    ```javascript
    function getAccessToken() {
      return localStorage.getItem('accessToken');
    }

    async function loadClaimStatus() {
      const token = getAccessToken();
      if (!token) {
        window.location.href = '/auth/login?redirect=/app/claim';
        return;
      }

      try {
        const response = await fetch('/dashboard', {
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });

        if (response.status === 401) {
          localStorage.removeItem('accessToken');
          window.location.href = '/auth/login?redirect=/app/claim';
          return;
        }

        const data = await response.json();
        renderClaimPage(data);
      } catch (error) {
        showError(error.message);
      }
    }

    function renderClaimPage(data) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('claim-content').style.display = 'block';

      if (data.claim.hasClaimed) {
        // Show success state
        document.getElementById('already-claimed').style.display = 'block';
        document.getElementById('discord-username').textContent = data.member.discordUsername;
      } else if (data.claim.canClaim) {
        // Show claim button
        document.getElementById('claim-action').style.display = 'block';
      } else {
        // Cannot claim - show message (not subscribed)
        document.getElementById('cannot-claim').style.display = 'block';
      }
    }

    function linkDiscord() {
      // Redirect to Discord OAuth flow
      window.location.href = '/claim/discord';
    }

    loadClaimStatus();
    ```

    **Inline styles:**
    - .claim-container: Centered card similar to auth-container
    - .claim-card: Similar to auth-card
    - .discord-button: Purple-ish button for Discord branding (or keep gold for consistency)
    - .success-state: Green check icon, success message

    **2b. Add routes to src/routes/public.ts:**

    Add BEFORE the root `/` route but AFTER the /auth routes:

    ```typescript
    // App routes (serve HTML pages)
    publicRouter.get('/app/dashboard', (_req: Request, res: Response): void => {
      res.sendFile(join(__dirname, '../../public/dashboard.html'));
    });

    publicRouter.get('/app/claim', (_req: Request, res: Response): void => {
      res.sendFile(join(__dirname, '../../public/claim.html'));
    });
    ```

    **Important:** These routes use `/app/` prefix to avoid conflicts with:
    - `/dashboard` API route (returns JSON, requires auth header)
    - `/claim` API routes (handles Discord OAuth callbacks)
  </action>
  <verify>
    1. Run `npx tsc --noEmit` - no TypeScript errors
    2. Start server with `npm run dev`
    3. Navigate to http://localhost:3000/app/claim without token - redirects to login
    4. Login, navigate to /app/claim - shows claim page
    5. If not subscribed, shows "cannot claim" message
    6. If subscribed, shows "Link Discord Account" button
    7. Click button - redirects to Discord OAuth (will fail if Discord not configured, that's expected)
    8. Routes don't conflict with API endpoints:
       - GET /dashboard still returns JSON with auth header
       - GET /app/dashboard serves HTML
  </verify>
  <done>
    - claim.html created with Discord link flow
    - Routes added for /app/dashboard and /app/claim
    - No route conflicts with existing API endpoints
    - Auth redirect on missing/invalid token
    - Claim button redirects to /claim/discord OAuth flow
  </done>
</task>

</tasks>

<verification>
1. http://localhost:3000/app/dashboard shows subscription status for authenticated user
2. http://localhost:3000/app/claim shows Discord claim page for authenticated user
3. Unauthenticated access redirects to /auth/login with ?redirect param
4. Dashboard shows correct state based on subscription status
5. Checkout button initiates Stripe checkout (redirects to Stripe)
6. Claim button initiates Discord OAuth (redirects to Discord)
7. No route conflicts - /dashboard API still works with Authorization header
8. Pages follow medieval theme styling
</verification>

<success_criteria>
- Authenticated user sees dashboard with subscription status
- User without token is redirected to login
- User can initiate checkout from dashboard (Subscribe button)
- User can initiate Discord claim from dashboard (Link Discord button)
- Claim page shows Link Discord Account button
- No CSP errors in browser console
- Pages follow established team-dashboard.html patterns
</success_criteria>

<output>
After completion, create `.planning/phases/09-frontend-pages/09-02-SUMMARY.md`
</output>
