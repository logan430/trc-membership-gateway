---
phase: 10-admin-system
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/routes/admin/members.ts
  - src/routes/admin/access.ts
  - src/lib/audit.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can list all members with pagination"
    - "Admin can search members by email or Discord username"
    - "Admin can filter members by subscription status"
    - "Admin can view individual member details including history"
    - "Admin can revoke Discord access (remove roles, keep subscription)"
    - "Admin can reset claim (unlink Discord, keep subscription)"
    - "Admin can grant any role directly"
    - "All destructive actions require a reason and are logged to AuditLog"
  artifacts:
    - path: "src/routes/admin/members.ts"
      provides: "Member listing and detail endpoints"
      exports: ["adminMembersRouter"]
    - path: "src/routes/admin/access.ts"
      provides: "Access control action endpoints"
      exports: ["adminAccessRouter"]
    - path: "src/lib/audit.ts"
      provides: "Audit logging helper"
      exports: ["logAuditEvent"]
  key_links:
    - from: "src/routes/admin/access.ts"
      to: "src/lib/audit.ts"
      via: "action logging"
      pattern: "logAuditEvent"
    - from: "src/routes/admin/access.ts"
      to: "src/bot/roles.ts"
      via: "role operations"
      pattern: "removeRole|assignRole"
---

<objective>
Build member management and access control APIs for admin dashboard.

Purpose: Admins need to view all members, search/filter them, and perform access control actions (revoke, reset claim, grant role) with full audit logging.

Output: REST APIs for member listing, detail view, and access control actions with required reason logging.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-admin-system/10-CONTEXT.md
@.planning/phases/10-admin-system/10-RESEARCH.md
@.planning/phases/10-admin-system/10-01-SUMMARY.md

# Existing role operations
@src/bot/roles.ts
@src/lib/role-assignment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit logging helper</name>
  <files>src/lib/audit.ts</files>
  <action>
1. Create src/lib/audit.ts:
   - Import prisma from './prisma.js'

   - Define AuditAction enum/type:
     - ADMIN_LOGIN
     - ADMIN_CREATED
     - ADMIN_DELETED
     - ADMIN_ROLE_CHANGED
     - MEMBER_ACCESS_REVOKED
     - MEMBER_CLAIM_RESET
     - MEMBER_ROLE_GRANTED
     - FEATURE_FLAG_TOGGLED
     - EMAIL_TEMPLATE_UPDATED
     - BULK_ACTION_PERFORMED

   - Define logAuditEvent function:
     ```typescript
     export async function logAuditEvent(params: {
       action: string;
       entityType: 'Admin' | 'Member' | 'Team' | 'FeatureFlag' | 'EmailTemplate';
       entityId: string;
       details?: Record<string, unknown>;
       performedBy: string; // Admin ID or 'system'
       reason?: string; // Required for destructive actions
     }): Promise<void> {
       await prisma.auditLog.create({
         data: {
           action: params.action,
           entityType: params.entityType,
           entityId: params.entityId,
           details: {
             ...params.details,
             ...(params.reason ? { reason: params.reason } : {}),
           },
           performedBy: params.performedBy,
         },
       });
     }
     ```

   - Helper to get recent audit logs for an entity:
     ```typescript
     export async function getEntityAuditLogs(
       entityType: string,
       entityId: string,
       limit = 50
     ) {
       return prisma.auditLog.findMany({
         where: { entityType, entityId },
         orderBy: { createdAt: 'desc' },
         take: limit,
       });
     }
     ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Audit helper exports logAuditEvent and getEntityAuditLogs
  </verify>
  <done>
    - Centralized audit logging ready for use across admin routes
    - Reason field captured in details JSON
  </done>
</task>

<task type="auto">
  <name>Task 2: Member management API</name>
  <files>src/routes/admin/members.ts, src/index.ts</files>
  <action>
1. Create src/routes/admin/members.ts:
   - Import Router from 'express'
   - Import z from 'zod'
   - Import prisma
   - Import requireAdmin from admin/middleware.js
   - Import getEntityAuditLogs from lib/audit.js

   - Define listQuerySchema with Zod:
     - cursor: z.string().optional()
     - limit: z.coerce.number().min(1).max(100).default(50)
     - search: z.string().optional() (searches email AND discordUsername)
     - status: z.enum(['NONE', 'TRIALING', 'ACTIVE', 'PAST_DUE', 'CANCELLED']).optional()
     - seatTier: z.enum(['INDIVIDUAL', 'OWNER', 'TEAM_MEMBER']).optional()
     - hasDiscord: z.enum(['true', 'false']).optional() (filter by discordId null/not null)
     - introCompleted: z.enum(['true', 'false']).optional()

   - GET / (list members):
     - Use requireAdmin middleware
     - Parse query with listQuerySchema
     - Build Prisma where clause with AND conditions for all filters
     - Search uses OR on email/discordUsername with contains + mode: 'insensitive'
     - Use cursor-based pagination (per RESEARCH.md):
       - take: limit + 1
       - skip: cursor ? 1 : 0
       - cursor: cursor ? { id: cursor } : undefined
     - orderBy: { createdAt: 'desc' }
     - Select minimal fields for list view:
       - id, email, discordId, discordUsername, subscriptionStatus
       - seatTier, introCompleted, createdAt, teamId
     - Calculate hasMore and nextCursor
     - Return { members, nextCursor, hasMore, total } (total via count query)

   - GET /:id (member detail):
     - Use requireAdmin middleware
     - Find member by ID with full fields
     - Include team relation if teamId exists
     - Get recent audit logs for this member via getEntityAuditLogs
     - Return { member, team, auditLogs }
     - If not found: 404 { error: 'Member not found' }

2. Update src/index.ts:
   - Import adminMembersRouter
   - Mount at /admin/members with requireAdmin applied
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - GET /admin/members returns paginated list with test data
    - GET /admin/members?search=test filters by email/username
    - GET /admin/members/:id returns full member detail
  </verify>
  <done>
    - Member listing with cursor pagination
    - Search by email or Discord username
    - Filter by status, seatTier, hasDiscord, introCompleted
    - Detail view includes audit history
  </done>
</task>

<task type="auto">
  <name>Task 3: Access control actions API</name>
  <files>src/routes/admin/access.ts, src/index.ts</files>
  <action>
1. Create src/routes/admin/access.ts:
   - Import Router, z, prisma, requireAdmin
   - Import logAuditEvent from lib/audit.js
   - Import role functions from bot (removeRole, assignRole, etc.)
   - Import bot client to check if online

   - Define reasonSchema for all actions:
     - reason: z.string().min(10, 'Reason must be at least 10 characters')

   - POST /:id/revoke-access:
     - Middleware: requireAdmin
     - Parse body with reasonSchema
     - Find member by ID, verify has discordId
     - If no discordId: 400 { error: 'Member has no Discord linked' }
     - Remove all managed roles (Squire, Knight, Lord, Debtor) via bot
     - Do NOT kick from server per CONTEXT.md
     - Do NOT change subscription status
     - Log audit event with action: 'MEMBER_ACCESS_REVOKED'
     - Return { success: true, message: 'Discord access revoked' }

   - POST /:id/reset-claim:
     - Middleware: requireAdmin
     - Parse body with reasonSchema
     - Find member by ID
     - If no discordId: 400 { error: 'Member has no Discord linked' }
     - Remove Discord roles first (same as revoke)
     - Update member: discordId = null, discordUsername = null, discordAvatar = null
     - Keep introCompleted as-is per CONTEXT.md
     - Log audit event with action: 'MEMBER_CLAIM_RESET'
     - Return { success: true, message: 'Discord claim reset' }

   - POST /:id/grant-role:
     - Middleware: requireAdmin
     - Define grantRoleSchema:
       - role: z.enum(['Squire', 'Knight', 'Lord', 'Debtor'])
       - reason: z.string().min(10)
     - Find member, verify has discordId
     - Remove all managed roles first (clean slate)
     - Assign the requested role via bot
     - Log audit event with action: 'MEMBER_ROLE_GRANTED', include role in details
     - Return { success: true, message: `Granted ${role} role` }

   - POST /bulk-revoke:
     - Middleware: requireAdmin
     - Define bulkSchema:
       - memberIds: z.array(z.string()).min(1).max(50)
       - reason: z.string().min(10)
     - Fetch all members by IDs with discordId
     - Process in batches of 5 with 2-second delays (per RESEARCH.md rate limits)
     - For each: remove roles, log audit event
     - Return { success: true, processed: N, failed: M }

2. Update src/index.ts:
   - Import adminAccessRouter
   - Mount at /admin/members (same base path, different endpoints)
   - OR mount at /admin/access for clearer separation
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - POST /admin/members/:id/revoke-access with reason removes roles
    - POST /admin/members/:id/reset-claim unlinks Discord
    - POST /admin/members/:id/grant-role assigns specified role
    - All actions create AuditLog entries with reason
  </verify>
  <done>
    - Revoke access removes roles but keeps subscription
    - Reset claim unlinks Discord, preserves intro status
    - Grant role allows bypassing normal flow
    - All destructive actions require 10+ character reason
    - Bulk revoke respects Discord rate limits
  </done>
</task>

</tasks>

<verification>
1. Audit: logAuditEvent creates AuditLog entries with all details
2. List: GET /admin/members returns paginated, filterable member list
3. Search: ?search=john filters by email OR Discord username
4. Detail: GET /admin/members/:id includes full member + team + audit history
5. Revoke: POST /admin/members/:id/revoke-access removes roles, logs reason
6. Reset: POST /admin/members/:id/reset-claim unlinks Discord, logs reason
7. Grant: POST /admin/members/:id/grant-role assigns role, logs reason
8. Bulk: POST /admin/members/bulk-revoke processes multiple with rate limiting
</verification>

<success_criteria>
- Member list endpoint supports cursor pagination, search, and multiple filters
- Member detail endpoint returns full member data with audit history
- Revoke access removes Discord roles without affecting subscription
- Reset claim unlinks Discord while preserving introduction status
- Grant role allows direct role assignment bypassing normal flow
- All destructive actions require reason and create audit log entries
- Bulk actions respect Discord rate limits (5 per 2 seconds)
</success_criteria>

<output>
After completion, create `.planning/phases/10-admin-system/10-02-SUMMARY.md`
</output>
