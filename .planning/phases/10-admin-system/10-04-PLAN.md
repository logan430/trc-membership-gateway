---
phase: 10-admin-system
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/routes/admin/admins.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Super admin can list all admin accounts"
    - "Super admin can create new admin with specified role"
    - "Super admin can change another admin's role"
    - "Super admin cannot demote themselves if they are the only super admin"
    - "Super admin can delete other admin accounts"
    - "Admin cannot delete their own account"
    - "All admin management actions are logged to audit"
  artifacts:
    - path: "src/routes/admin/admins.ts"
      provides: "Admin account management endpoints"
      exports: ["adminAdminsRouter"]
  key_links:
    - from: "src/routes/admin/admins.ts"
      to: "src/lib/audit.ts"
      via: "action logging"
      pattern: "logAuditEvent"
    - from: "src/routes/admin/admins.ts"
      to: "src/lib/password.ts"
      via: "password hashing"
      pattern: "hashPassword"
---

<objective>
Build admin account management API for super admins.

Purpose: Super admins need to create other admin accounts, change roles, and remove admins. Per CONTEXT.md, first admin is seeded; subsequent admins are invited from UI.

Output: REST API for admin CRUD with role management and self-demotion protection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-admin-system/10-CONTEXT.md
@.planning/phases/10-admin-system/10-RESEARCH.md
@.planning/phases/10-admin-system/10-01-SUMMARY.md

# Password hashing
@src/lib/password.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin account management API</name>
  <files>src/routes/admin/admins.ts</files>
  <action>
1. Create src/routes/admin/admins.ts:
   - Import Router, z, prisma
   - Import requireAdmin, requireSuperAdmin from admin/middleware.js
   - Import hashPassword from lib/password.js
   - Import logAuditEvent from lib/audit.js

   - GET /:
     - Middleware: requireSuperAdmin
     - Fetch all admins (exclude passwordHash)
     - Select: id, email, role, lastLoginAt, createdAt, createdBy
     - Return { admins: [...] }

   - GET /:id:
     - Middleware: requireSuperAdmin
     - Find admin by ID (exclude passwordHash)
     - If not found: 404
     - Get audit logs where performedBy = admin ID (actions this admin performed)
     - Return { admin, actionsPerformed: [...] }

   - POST /:
     - Middleware: requireSuperAdmin
     - Define createSchema:
       - email: z.string().email()
       - password: z.string().min(8)
       - role: z.enum(['ADMIN', 'SUPER_ADMIN']).default('ADMIN')
     - Check if email already exists: 400 { error: 'Email already in use' }
     - Hash password with hashPassword
     - Create admin with createdBy = current admin ID
     - Log audit event: ADMIN_CREATED
     - Return { admin: { id, email, role } } (exclude passwordHash)

   - PATCH /:id/role:
     - Middleware: requireSuperAdmin
     - Define roleSchema: { role: z.enum(['ADMIN', 'SUPER_ADMIN']) }
     - Find admin by ID
     - If not found: 404

     - SELF-DEMOTION CHECK:
       - If admin ID === current admin ID AND new role is ADMIN (demotion):
         - Count super admins: prisma.admin.count({ where: { role: 'SUPER_ADMIN' } })
         - If count === 1: return 400 { error: 'Cannot demote the only super admin' }

     - Update admin role
     - Log audit event: ADMIN_ROLE_CHANGED with old/new role
     - Return { admin: { id, email, role } }

   - DELETE /:id:
     - Middleware: requireSuperAdmin
     - Find admin by ID
     - If not found: 404

     - SELF-DELETE CHECK:
       - If admin ID === current admin ID:
         - Return 400 { error: 'Cannot delete your own account' }

     - Delete admin
     - Log audit event: ADMIN_DELETED
     - Return { success: true }

   - POST /:id/reset-password:
     - Middleware: requireSuperAdmin
     - Define passwordSchema: { password: z.string().min(8) }
     - Find admin by ID
     - Hash new password
     - Update admin passwordHash
     - Log audit event (don't include password in log!)
     - Return { success: true }

   - Export adminAdminsRouter
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - GET /admin/admins returns list of admins (super admin only)
    - POST /admin/admins creates new admin
    - PATCH /admin/admins/:id/role changes role with self-demotion protection
    - DELETE /admin/admins/:id deletes admin with self-delete protection
  </verify>
  <done>
    - List/create/update/delete admin accounts
    - Only super admins can access these endpoints
    - Self-demotion blocked if only super admin
    - Self-deletion blocked
    - All actions logged to audit
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount admin routes and add login audit</name>
  <files>src/index.ts, src/routes/admin/auth.ts</files>
  <action>
1. Update src/routes/admin/auth.ts:
   - Import logAuditEvent from lib/audit.js
   - In POST /login handler, after successful authentication:
     - Call logAuditEvent with action: 'ADMIN_LOGIN'
     - entityType: 'Admin', entityId: admin.id
     - performedBy: admin.id

2. Update src/index.ts:
   - Import adminAdminsRouter from './routes/admin/admins.js'
   - Mount at /admin/admins

   - Ensure all admin routes are properly organized:
     - /admin/auth/* - Auth routes (no auth required for login)
     - /admin/members/* - Member management (requireAdmin)
     - /admin/config/* - Feature flags (requireAdmin, some requireSuperAdmin)
     - /admin/audit/* - Audit logs (requireAdmin)
     - /admin/templates/* - Email templates (requireAdmin, edit requireSuperAdmin)
     - /admin/admins/* - Admin management (requireSuperAdmin)

3. Add route documentation comment in src/index.ts explaining admin route structure
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Admin login creates audit log entry
    - All admin routes mounted and accessible with proper middleware
    - Route order doesn't cause conflicts
  </verify>
  <done>
    - Admin login tracked in audit log
    - All admin routes properly mounted
    - Clear route organization documented
  </done>
</task>

</tasks>

<verification>
1. List: GET /admin/admins returns all admins (super admin only)
2. Create: POST /admin/admins creates new admin with hashed password
3. Role change: PATCH /admin/admins/:id/role updates role
4. Self-demotion: Cannot demote if only super admin
5. Delete: DELETE /admin/admins/:id removes admin
6. Self-delete: Cannot delete own account
7. Login audit: Admin login creates audit log entry
8. Password reset: POST /admin/admins/:id/reset-password works
</verification>

<success_criteria>
- Only super admins can manage other admin accounts
- New admins created with hashed passwords and audit trail
- Role changes logged with old/new values
- Self-demotion blocked when only super admin exists
- Self-deletion blocked to prevent lockout
- Admin login events tracked in audit log
- All admin routes properly mounted and organized
</success_criteria>

<output>
After completion, create `.planning/phases/10-admin-system/10-04-SUMMARY.md`
</output>
