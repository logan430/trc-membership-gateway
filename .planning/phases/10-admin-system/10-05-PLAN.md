---
phase: 10-admin-system
plan: 05
type: execute
wave: 3
depends_on: ["10-02", "10-03", "10-04"]
files_modified:
  - public/admin/login.html
  - public/admin/dashboard.html
  - public/admin/members.html
  - public/admin/member-detail.html
  - public/admin/config.html
  - public/admin/audit.html
  - public/admin/admins.html
  - public/admin/templates.html
  - public/admin/styles.css
  - src/routes/public.ts
autonomous: false

must_haves:
  truths:
    - "Admin can login at /admin/login"
    - "Admin dashboard shows summary stats and quick links"
    - "Members page shows paginated, filterable, searchable table"
    - "Member detail page shows full info with action buttons"
    - "Confirmation dialogs require reason for destructive actions"
    - "Feature flags page shows toggles (super admin can edit)"
    - "Audit log page shows filterable, searchable logs"
    - "Admins page shows admin list (super admin only)"
    - "Templates page shows editable templates with preview"
  artifacts:
    - path: "public/admin/login.html"
      provides: "Admin login page"
      min_lines: 50
    - path: "public/admin/dashboard.html"
      provides: "Admin dashboard with stats"
      min_lines: 100
    - path: "public/admin/members.html"
      provides: "Member management table"
      min_lines: 200
    - path: "public/admin/member-detail.html"
      provides: "Individual member detail view"
      min_lines: 150
    - path: "public/admin/config.html"
      provides: "Feature flags management"
      min_lines: 100
    - path: "public/admin/audit.html"
      provides: "Audit log viewer"
      min_lines: 150
    - path: "public/admin/admins.html"
      provides: "Admin account management"
      min_lines: 100
    - path: "public/admin/templates.html"
      provides: "Email template editor"
      min_lines: 150
    - path: "public/admin/styles.css"
      provides: "Admin-specific styles"
      min_lines: 200
  key_links:
    - from: "public/admin/members.html"
      to: "/admin/members"
      via: "fetch API"
      pattern: "fetch.*admin/members"
    - from: "public/admin/members.html"
      to: "public/admin/member-detail.html"
      via: "row click navigation"
      pattern: "member-detail.html"
---

<objective>
Build complete admin UI with login, dashboard, member management, configuration, and audit views.

Purpose: Admins need a web interface to manage members, toggle features, review audit logs, and manage other admins. Following existing vanilla JS patterns from team-dashboard.html.

Output: Complete set of admin HTML pages with medieval theme styling, matching existing UI conventions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-admin-system/10-CONTEXT.md
@.planning/phases/10-admin-system/10-RESEARCH.md
@.planning/phases/10-admin-system/10-02-SUMMARY.md
@.planning/phases/10-admin-system/10-03-SUMMARY.md
@.planning/phases/10-admin-system/10-04-SUMMARY.md

# UI patterns to follow
@public/team-dashboard.html
@public/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin styles and login page</name>
  <files>public/admin/styles.css, public/admin/login.html, src/routes/public.ts</files>
  <action>
1. Create public/admin/styles.css:
   - Extend existing medieval theme (--bg-dark, --gold, --cream, etc.)
   - Add admin-specific styles:

   Admin layout:
   - .admin-container: max-width 1400px, margin auto, padding
   - .admin-header: flex between logo and nav/logout
   - .admin-nav: horizontal nav links with active state
   - .admin-sidebar: optional left sidebar for large screens

   Tables:
   - .data-table: full width, border-collapse
   - .data-table th: gold text, border-bottom, padding, text-left
   - .data-table td: cream text, padding, border-bottom subtle
   - .data-table tr:hover: subtle background highlight
   - .data-table .clickable-row: cursor pointer

   Filters/Search:
   - .filter-bar: flex, gap, align items, wrap
   - .filter-group: flex column, label + input
   - .search-input: styled input with search icon placeholder

   Bulk actions:
   - .bulk-action-bar: fixed bottom, hidden by default, gold border top
   - .bulk-action-bar.visible: display flex
   - .selected-count: badge style

   Confirmation dialog:
   - dialog::backdrop: dark overlay
   - .confirm-dialog: styled modal matching theme
   - .confirm-dialog h3: gold text
   - .confirm-dialog textarea: dark bg, gold border
   - .dialog-buttons: flex, gap, justify end

   Status badges (reuse from team-dashboard):
   - .badge variants: active, past_due, cancelled, pending, claimed

   Cards:
   - .stat-card: background card, border, padding, for dashboard stats
   - .detail-card: similar but for member detail sections

   Forms:
   - .admin-form: form styling for login, create admin
   - .form-group: label + input vertical layout
   - .btn-primary, .btn-danger, .btn-secondary: button variants

   Pagination:
   - .pagination: flex, gap, center
   - .pagination button: styled page buttons
   - .pagination .active: current page highlight

2. Create public/admin/login.html:
   - Include styles.css and admin/styles.css
   - Include Google Fonts (Cinzel, Crimson Text)
   - Simple centered login form:
     - Email input
     - Password input
     - Submit button "Enter the Council Chamber"
   - On submit:
     - POST /admin/auth/login
     - Store accessToken in localStorage (key: 'adminAccessToken')
     - Redirect to /admin/dashboard.html
   - Error handling: show error message below form
   - Footer with copyright

3. Update src/routes/public.ts:
   - Add routes for admin pages:
     - GET /admin/login -> public/admin/login.html
     - GET /admin/dashboard -> public/admin/dashboard.html (requires auth via client-side redirect)
     - GET /admin/members -> public/admin/members.html
     - GET /admin/members/:id -> public/admin/member-detail.html
     - GET /admin/config -> public/admin/config.html
     - GET /admin/audit -> public/admin/audit.html
     - GET /admin/admins -> public/admin/admins.html
     - GET /admin/templates -> public/admin/templates.html
   - Static file serving may handle this, but add explicit routes for clarity
  </action>
  <verify>
    - Files created in public/admin/
    - Login page loads at /admin/login
    - Login form submits and stores token on success
    - Redirect to dashboard after login
  </verify>
  <done>
    - Admin styles established matching medieval theme
    - Login page functional with token storage
    - Admin routes accessible
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard and members pages</name>
  <files>public/admin/dashboard.html, public/admin/members.html, public/admin/member-detail.html</files>
  <action>
1. Create public/admin/dashboard.html:
   - Include admin styles, check auth on load
   - Header with "Admin Dashboard" title, logout button
   - Navigation: Members | Config | Audit | Admins | Templates
   - Summary stats (fetch from API or derive from members):
     - Total members count
     - Active subscriptions
     - Members with billing issues
     - Pending claims (has subscription but no Discord)
   - Quick links section:
     - "View All Members" -> /admin/members
     - "Feature Flags" -> /admin/config
     - "Audit Log" -> /admin/audit
   - Recent activity (last 10 audit log entries)
   - Helper functions: getAdminToken(), checkAuth() -> redirect to login if no token

2. Create public/admin/members.html:
   - Auth check on load
   - Header with nav
   - Filter bar:
     - Search input (debounced, searches on typing)
     - Status dropdown (NONE, ACTIVE, PAST_DUE, CANCELLED)
     - Seat tier dropdown (INDIVIDUAL, OWNER, TEAM_MEMBER)
     - Has Discord toggle
     - Intro completed toggle
     - Clear filters button
   - Data table:
     - Columns: Checkbox, Email, Discord, Status, Tier, Intro, Joined
     - Clickable rows -> navigate to member-detail.html?id=xxx
     - Select all checkbox in header
   - Bulk action bar (appears when items selected):
     - Selected count
     - "Bulk Revoke Access" button
   - Pagination:
     - "Load More" button (cursor-based)
     - Or numbered pages if preferred
   - Confirmation dialog (using native <dialog>):
     - Title, message
     - Required reason textarea (minlength 10)
     - Cancel and Confirm buttons
   - Functions:
     - loadMembers(cursor?, filters) -> fetch, render table
     - toggleSelectAll(), toggleRow()
     - showConfirmDialog(title, message) -> Promise<reason | null>
     - bulkRevoke()

3. Create public/admin/member-detail.html:
   - Auth check on load
   - Parse member ID from URL query param
   - Fetch member detail from GET /admin/members/:id
   - Header with "Member Detail" and back link to members list
   - Member info card:
     - Email, Discord username, Discord ID
     - Subscription status (badge)
     - Seat tier
     - Intro completed (badge)
     - Team name (if applicable)
     - Created date, updated date
   - Action buttons:
     - "Revoke Discord Access" (if has Discord)
     - "Reset Claim" (if has Discord)
     - "Grant Role" dropdown (Squire, Knight, Lord, Debtor)
   - Audit history section:
     - Table of recent audit logs for this member
     - Columns: Date, Action, Performed By, Details
   - All action buttons trigger confirmation dialog with required reason
  </action>
  <verify>
    - Dashboard loads with stats and navigation
    - Members list shows paginated data with filters
    - Clicking row navigates to member detail
    - Bulk actions work with confirmation dialog
    - Member detail shows full info and audit history
    - Actions trigger confirmation and call API
  </verify>
  <done>
    - Dashboard shows summary stats and quick links
    - Members page has search, filters, pagination
    - Bulk select and bulk revoke functional
    - Member detail shows full info with action buttons
    - All destructive actions require reason via dialog
  </done>
</task>

<task type="auto">
  <name>Task 3: Config, audit, admins, and templates pages</name>
  <files>public/admin/config.html, public/admin/audit.html, public/admin/admins.html, public/admin/templates.html</files>
  <action>
1. Create public/admin/config.html:
   - Auth check on load
   - Header with nav
   - Feature Flags section:
     - Table of flags: Key, Description, Category, Status (toggle switch), Last Updated
     - Toggle switches call PATCH /admin/config/feature-flags/:key
     - Show loading state during toggle
     - Only enable toggles if user is super admin (check role from stored token or API)
   - Discord Channels section (read-only per CONTEXT.md):
     - Display current channel IDs from API
     - Note: "Channel IDs are configured via environment variables"
   - Seed buttons (super admin only):
     - "Seed Default Flags" button
     - "Seed Default Templates" button

2. Create public/admin/audit.html:
   - Auth check on load
   - Header with nav
   - Filter bar:
     - Action dropdown (populated from GET /admin/audit/actions)
     - Entity type dropdown (populated from GET /admin/audit/entity-types)
     - Entity ID input
     - Performed by input (admin ID)
     - Date range (start date, end date inputs)
     - Search input (searches in details)
     - Apply filters button
   - Audit log table:
     - Columns: Date, Action, Entity Type, Entity ID, Performed By, Details (truncated)
     - Click row to expand details JSON
   - Pagination: Load more button
   - Export button (optional): Download current results as CSV

3. Create public/admin/admins.html:
   - Auth check on load
   - Check if current user is super admin, show access denied if not
   - Header with nav
   - Admin list table:
     - Columns: Email, Role, Last Login, Created, Actions
     - Actions: Edit Role, Reset Password, Delete
   - Create Admin form:
     - Email input
     - Password input
     - Role dropdown (ADMIN, SUPER_ADMIN)
     - Create button
   - Edit role triggers confirmation (no reason needed, but confirms action)
   - Delete triggers confirmation with impact warning
   - Reset password triggers modal with new password input

4. Create public/admin/templates.html:
   - Auth check on load
   - Header with nav
   - Template list (left sidebar or tabs):
     - List of template names
     - Click to load template in editor
   - Editor section:
     - Subject input
     - Body textarea (large, monospace font)
     - Help text showing available variables for current template
     - Save button (super admin only)
   - Preview section:
     - Shows rendered template with sample data
     - Updates on button click or debounced from editor
   - Read-only mode for non-super admins (can view but not edit)
  </action>
  <verify>
    - Config page shows feature flags with working toggles
    - Toggles disabled for non-super admin
    - Audit page shows filterable, paginated logs
    - Admins page shows admin list (super admin only)
    - Create/delete admin works
    - Templates page shows editor with preview
    - Template save works (super admin only)
  </verify>
  <done>
    - Feature flags manageable via toggle switches
    - Audit logs viewable with comprehensive filters
    - Admin accounts manageable (super admin only)
    - Email templates editable with live preview
    - All pages follow medieval theme and UI patterns
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete admin UI with login, dashboard, member management, feature flags, audit logs, admin management, and email template editor.
  </what-built>
  <how-to-verify>
    1. Start the server: `npm run dev`
    2. Seed first admin: `npx prisma db seed` (requires ADMIN_SEED_EMAIL and ADMIN_SEED_PASSWORD env vars)
    3. Navigate to http://localhost:3000/admin/login
    4. Login with seeded admin credentials
    5. Verify dashboard shows stats and navigation
    6. Navigate to Members page:
       - Verify table loads with any existing members
       - Test search and filters
       - Click a row to view member detail
    7. Navigate to Config page:
       - Verify feature flags display
       - Test toggling a flag (should update)
    8. Navigate to Audit page:
       - Verify audit logs display
       - Test filters
    9. Navigate to Admins page:
       - Verify admin list shows seeded admin
       - Test creating a new admin
    10. Navigate to Templates page:
        - Seed templates if needed
        - Verify template list and editor
        - Test preview functionality
    11. Verify all pages follow medieval theme styling
    12. Test logout redirects to login page
  </how-to-verify>
  <resume-signal>Type "approved" if admin UI works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Login: Admin can login at /admin/login
2. Dashboard: Shows summary stats and quick navigation
3. Members: Paginated, searchable, filterable table with bulk actions
4. Member detail: Full info display with action buttons
5. Confirmation: All destructive actions require reason via dialog
6. Config: Feature flags toggleable (super admin), Discord channels view-only
7. Audit: Filterable, paginated audit log viewer
8. Admins: Admin CRUD (super admin only)
9. Templates: Editor with preview (super admin can edit)
10. Theme: All pages match medieval theme
</verification>

<success_criteria>
- Complete admin UI matching existing medieval theme
- Login flow stores admin token separately from member token
- Dashboard provides overview and navigation
- Member management supports search, filter, pagination, bulk actions
- All destructive actions require reason and use confirmation dialog
- Feature flags viewable by all admins, editable by super admins only
- Audit logs searchable and filterable
- Admin management accessible to super admins only
- Email templates viewable with editor and preview
- UI verified working by human reviewer
</success_criteria>

<output>
After completion, create `.planning/phases/10-admin-system/10-05-SUMMARY.md`
</output>
