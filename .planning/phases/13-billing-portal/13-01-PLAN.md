---
phase: 13-billing-portal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/billing.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated user can POST /billing/portal and receive a portal URL"
    - "Individual members use their own stripeCustomerId"
    - "Team members use their team's stripeCustomerId"
    - "Dashboard 'Manage Billing' button opens Stripe billing portal"
  artifacts:
    - path: "src/routes/billing.ts"
      provides: "Billing portal endpoint"
      exports: ["billingRouter"]
  key_links:
    - from: "src/routes/billing.ts"
      to: "src/index.ts"
      via: "app.use('/billing', billingRouter)"
      pattern: "billingRouter"
    - from: "public/dashboard.html"
      to: "/billing/portal"
      via: "fetch('/billing/portal')"
      pattern: "portalUrl"
---

<objective>
Create the POST `/billing/portal` endpoint that the dashboard frontend already calls.

Purpose: Close the critical integration gap where users clicking "Manage Billing" get a 404 error.
Output: Working billing portal endpoint that returns Stripe billing portal URL.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-billing-portal/13-RESEARCH.md

# Pattern sources
@src/routes/checkout.ts
@src/index.ts
@src/billing/failure-handler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing route with portal endpoint</name>
  <files>src/routes/billing.ts</files>
  <action>
Create `src/routes/billing.ts` with POST `/portal` endpoint.

Follow the exact pattern from `checkout.ts`:
1. Import Router, Response from 'express'
2. Import Stripe from 'stripe'
3. Import requireAuth, AuthenticatedRequest from '../middleware/session.js'
4. Import prisma from '../lib/prisma.js'
5. Import env from '../config/env.js'
6. Import logger from '../index.js'
7. Initialize Stripe client with env.STRIPE_SECRET_KEY
8. Export billingRouter = Router()

Implement POST '/portal' with requireAuth middleware:
1. Look up member with team included: `prisma.member.findUnique({ where: { id: req.memberId }, include: { team: true } })`
2. Determine stripeCustomerId:
   - If member has teamId AND team exists: use `member.team.stripeCustomerId`
   - Otherwise: use `member.stripeCustomerId`
3. If no stripeCustomerId found, return 400 with `{ error: 'No billing account configured' }`
4. Create billing portal session:
   ```typescript
   const session = await stripe.billingPortal.sessions.create({
     customer: stripeCustomerId,
     return_url: `${env.APP_URL}/app/dashboard`,
   });
   ```
5. Log success: `logger.info({ memberId: req.memberId }, 'Billing portal session created')`
6. Return `{ portalUrl: session.url }`

Handle errors with try/catch, log error, return 500.

Note: Use `/app/dashboard` for return_url (matches Phase 12 route restructure).
  </action>
  <verify>File exists at src/routes/billing.ts and exports billingRouter</verify>
  <done>Billing route file created with POST /portal endpoint</done>
</task>

<task type="auto">
  <name>Task 2: Register billing route in Express app</name>
  <files>src/index.ts</files>
  <action>
Update `src/index.ts` to register the billing router:

1. Add import at top with other route imports:
   ```typescript
   import { billingRouter } from './routes/billing.js';
   ```

2. Add route registration after the checkout routes section (around line 91):
   ```typescript
   // Billing routes (Stripe billing portal)
   app.use('/billing', billingRouter);
   ```

Place it logically near checkout routes since they're related billing functionality.
  </action>
  <verify>Run `npm run build` - TypeScript compiles without errors</verify>
  <done>billingRouter imported and registered at /billing path</done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build`
2. Server starts: `npm run dev` (check for no startup errors)
3. Endpoint exists: `curl -X POST http://localhost:3000/billing/portal` returns 401 (no auth)
4. With auth, endpoint returns valid response (requires Stripe portal config in dashboard)
</verification>

<success_criteria>
- POST `/billing/portal` endpoint exists and requires authentication
- Individual members use their own stripeCustomerId
- Team members use their team's stripeCustomerId
- Missing customer ID returns 400 with clear error message
- Successful call returns `{ portalUrl: string }`
- Dashboard "Manage Billing" button no longer returns 404
</success_criteria>

<output>
After completion, create `.planning/phases/13-billing-portal/13-01-SUMMARY.md`
</output>
