---
phase: 15-security-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/middleware/rate-limit.ts
  - src/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Login attempts are limited to 5 per 15 minutes per IP"
    - "Signup attempts are limited to 3 per hour per IP"
    - "Magic link requests are limited to 3 per 15 minutes per IP"
    - "Admin login attempts are limited to 5 per 15 minutes per IP"
    - "Rate limit exceeded returns 429 status with clear message"
  artifacts:
    - path: "src/middleware/rate-limit.ts"
      provides: "Rate limiting middleware configuration"
      exports: ["authLimiter", "signupLimiter", "magicLinkLimiter", "adminAuthLimiter"]
  key_links:
    - from: "src/index.ts"
      to: "src/middleware/rate-limit.ts"
      via: "middleware import and app.use()"
      pattern: "app\\.use.*authLimiter"
---

<objective>
Add rate limiting to authentication endpoints to prevent brute force attacks

Purpose: Critical security gap - auth endpoints currently have no rate limiting, making them vulnerable to brute force password attacks, credential stuffing, and email bombing via magic links.

Output: Rate limiting middleware protecting /auth/login, /auth/signup, /auth/magic-link/request, and /admin/auth/login endpoints
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-security-audit/15-RESEARCH.md

# Codebase context
@src/index.ts
@src/routes/auth.ts
@src/routes/admin/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install express-rate-limit and create rate limiting middleware</name>
  <files>
    - package.json
    - src/middleware/rate-limit.ts
  </files>
  <action>
1. Install express-rate-limit:
   ```
   npm install express-rate-limit
   ```

2. Create src/middleware/rate-limit.ts with the following limiters:

**authLimiter** (for /auth/login):
- windowMs: 15 * 60 * 1000 (15 minutes)
- max: 5 attempts
- message: { error: 'Too many login attempts. Please try again in 15 minutes.' }
- standardHeaders: true
- legacyHeaders: false

**signupLimiter** (for /auth/signup):
- windowMs: 60 * 60 * 1000 (1 hour)
- max: 3 attempts (stricter - prevents account spam)
- message: { error: 'Too many signup attempts. Please try again later.' }
- standardHeaders: true
- legacyHeaders: false

**magicLinkLimiter** (for /auth/magic-link/request):
- windowMs: 15 * 60 * 1000 (15 minutes)
- max: 3 attempts (prevents email bombing)
- message: { error: 'Too many magic link requests. Please try again in 15 minutes.' }
- standardHeaders: true
- legacyHeaders: false

**adminAuthLimiter** (for /admin/auth/login):
- windowMs: 15 * 60 * 1000 (15 minutes)
- max: 5 attempts
- message: { error: 'Too many admin login attempts. Please try again in 15 minutes.' }
- standardHeaders: true
- legacyHeaders: false

Export all four limiters for use in routes.
  </action>
  <verify>
  - `npm ls express-rate-limit` shows package installed
  - File exists: src/middleware/rate-limit.ts
  - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Rate limiting middleware file created with all four limiters exported</done>
</task>

<task type="auto">
  <name>Task 2: Apply rate limiters to authentication routes</name>
  <files>
    - src/index.ts
  </files>
  <action>
1. Import rate limiters at top of src/index.ts:
   ```typescript
   import { authLimiter, signupLimiter, magicLinkLimiter, adminAuthLimiter } from './middleware/rate-limit.js';
   ```

2. Apply limiters BEFORE the route handlers (order matters). Add these lines right after the CORS middleware and before existing route definitions:

   ```typescript
   // Rate limiting on auth endpoints (security - prevent brute force)
   app.use('/auth/login', authLimiter);
   app.use('/auth/signup', signupLimiter);
   app.use('/auth/magic-link/request', magicLinkLimiter);
   app.use('/admin/auth/login', adminAuthLimiter);
   ```

Place these AFTER express.json() but BEFORE the route mounts to ensure the limiter middleware runs first.

NOTE: The rate limiter must be applied to the specific path (e.g., '/auth/login') not the entire router path to avoid limiting non-auth endpoints.
  </action>
  <verify>
  - TypeScript compiles: `npx tsc --noEmit`
  - Server starts: `npm run dev` (check for startup errors)
  - Rate limit headers present: Test with curl:
    ```
    curl -i -X POST http://localhost:3000/auth/login -H "Content-Type: application/json" -d '{"email":"test@test.com","password":"test"}'
    ```
    Response should include `RateLimit-*` headers
  </verify>
  <done>Rate limiters applied to all four auth endpoints</done>
</task>

<task type="auto">
  <name>Task 3: Verify rate limiting behavior works</name>
  <files>None (verification only)</files>
  <action>
Test rate limiting by:

1. Start dev server: `npm run dev`

2. Test login rate limit (should block after 5 attempts):
   ```bash
   for i in {1..7}; do
     curl -s -o /dev/null -w "%{http_code}\n" -X POST http://localhost:3000/auth/login \
       -H "Content-Type: application/json" \
       -d '{"email":"test@test.com","password":"wrong"}'
   done
   ```
   Expected: First 5 return 401, attempts 6+ return 429

3. Verify 429 response body contains error message:
   ```bash
   curl -X POST http://localhost:3000/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email":"test@test.com","password":"wrong"}'
   ```
   (After exceeding limit) Should return: {"error":"Too many login attempts. Please try again in 15 minutes."}

4. Check RateLimit headers are present:
   - RateLimit-Limit: 5
   - RateLimit-Remaining: (decrements)
   - RateLimit-Reset: (epoch timestamp)
  </action>
  <verify>
  - Attempts 1-5 return 401 (wrong password)
  - Attempt 6+ returns 429 (rate limited)
  - 429 response includes error message JSON
  - RateLimit-* headers present on all responses
  </verify>
  <done>Rate limiting verified working on /auth/login endpoint</done>
</task>

</tasks>

<verification>
- [ ] express-rate-limit package installed
- [ ] src/middleware/rate-limit.ts exists with 4 exported limiters
- [ ] src/index.ts imports and applies all 4 limiters
- [ ] TypeScript compiles without errors
- [ ] Server starts without errors
- [ ] Rate limit headers present on auth responses
- [ ] 429 returned after exceeding limit
</verification>

<success_criteria>
- All authentication endpoints protected by rate limiting
- Brute force attacks on /auth/login limited to 5 attempts per 15 minutes
- Account creation spam limited to 3 signups per hour
- Magic link email bombing limited to 3 requests per 15 minutes
- Admin brute force attacks limited to 5 attempts per 15 minutes
- Clear error messages returned when rate limited
</success_criteria>

<output>
After completion, create `.planning/phases/15-security-audit/15-01-SUMMARY.md`
</output>
