---
phase: 15-security-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/admin/middleware.ts
  - src/index.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "No console.log statements in admin middleware"
    - "CORS restricts origins in production to APP_URL"
    - ".env.example documents all required environment variables"
    - "All Critical security items from AUDIT-CHECKLIST pass"
  artifacts:
    - path: "src/admin/middleware.ts"
      provides: "Admin authentication middleware without debug logging"
    - path: ".env.example"
      provides: "Complete environment variable documentation"
      contains: "APP_URL"
  key_links:
    - from: "src/index.ts"
      to: "cors configuration"
      via: "cors() with origin option"
      pattern: "cors\\(\\{[\\s\\S]*origin"
---

<objective>
Fix security issues and complete security audit verification

Purpose: Remove debug logging from production code, restrict CORS in production, document all environment variables, and verify all security controls are properly implemented.

Output: Clean admin middleware, production-ready CORS, complete .env.example, and verified security controls
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-security-audit/15-RESEARCH.md
@.planning/AUDIT-CHECKLIST.md

# Codebase context
@src/admin/middleware.ts
@src/index.ts
@src/config/env.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove debug console.log from admin middleware</name>
  <files>
    - src/admin/middleware.ts
  </files>
  <action>
Remove ALL console.log statements from src/admin/middleware.ts.

Current problematic lines (per RESEARCH.md):
- Line 24: `console.log('[requireAdmin] Path:', req.path, 'Auth header present:', !!authHeader);`
- Line 27: `console.log('[requireAdmin] No Bearer token found');`
- Line 33: `console.log('[requireAdmin] Token:', token.substring(0, 20) + '...');`
- Line 37: `console.log('[requireAdmin] Token verification failed');`
- Line 41: `console.log('[requireAdmin] Token verified, admin ID:', payload.sub);`

These leak security-sensitive information to logs:
- Token fragments (line 33)
- Admin IDs (line 41)
- Auth flow debugging info

Simply DELETE these lines. Do not replace with logger calls - the security information should not be logged at any level in production.

If debugging is needed in development, developers can add temporary logging. Production middleware should be silent on auth success/failure to prevent information leakage.
  </action>
  <verify>
  - `grep -n "console.log" src/admin/middleware.ts` returns no results
  - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Admin middleware contains no console.log statements</done>
</task>

<task type="auto">
  <name>Task 2: Restrict CORS to APP_URL in production</name>
  <files>
    - src/index.ts
    - src/config/env.ts
  </files>
  <action>
1. First, verify APP_URL exists in env.ts. If not, add it:
   ```typescript
   APP_URL: z.string().url().optional().default('http://localhost:3000'),
   ```

2. Update CORS configuration in src/index.ts (currently line 58):

Replace:
```typescript
app.use(cors());
```

With:
```typescript
app.use(cors({
  origin: env.NODE_ENV === 'production'
    ? env.APP_URL
    : true, // Allow all origins in development
  credentials: true, // Allow cookies to be sent
}));
```

This ensures:
- Development: All origins allowed (easier testing)
- Production: Only APP_URL origin allowed (security)
- Credentials enabled for cookie-based auth

Import env at the top if not already imported.
  </action>
  <verify>
  - `grep -A5 "app.use(cors" src/index.ts` shows origin configuration
  - TypeScript compiles: `npx tsc --noEmit`
  - Server starts: `npm run dev`
  </verify>
  <done>CORS configured to restrict origins in production</done>
</task>

<task type="auto">
  <name>Task 3: Complete .env.example documentation</name>
  <files>
    - .env.example
  </files>
  <action>
Update .env.example to document ALL required environment variables.

Based on RESEARCH.md, the following are missing:
- DISCORD_REDIRECT_URI
- DISCORD_INVITE_URL
- DISCORD_INTRODUCTIONS_CHANNEL_ID
- DISCORD_ADMIN_ALERT_CHANNEL_ID
- DISCORD_BILLING_SUPPORT_CHANNEL_ID
- STRIPE_INDIVIDUAL_PRICE_ID
- STRIPE_OWNER_SEAT_PRICE_ID
- STRIPE_TEAM_SEAT_PRICE_ID
- EMAIL_PROVIDER
- RESEND_API_KEY
- APP_URL
- ADMIN_SEED_EMAIL
- ADMIN_SEED_PASSWORD

Replace entire .env.example with comprehensive documentation:

```
# =============================================================================
# Server Configuration
# =============================================================================
NODE_ENV=development
PORT=3000
APP_URL=http://localhost:3000

# =============================================================================
# Database (Supabase)
# Get from: Supabase Dashboard -> Project Settings -> Database
# =============================================================================
DATABASE_URL=postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres?pgbouncer=true
DIRECT_URL=postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres

# =============================================================================
# JWT / Session
# Generate with: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
# =============================================================================
JWT_SECRET=

# =============================================================================
# Stripe
# Get from: Stripe Dashboard -> Developers -> API keys
# =============================================================================
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Price IDs - Get from: Stripe Dashboard -> Products -> Select product -> Pricing
STRIPE_INDIVIDUAL_PRICE_ID=price_...
STRIPE_OWNER_SEAT_PRICE_ID=price_...
STRIPE_TEAM_SEAT_PRICE_ID=price_...

# =============================================================================
# Discord Bot & OAuth
# Get from: Discord Developer Portal -> Your App
# =============================================================================
DISCORD_CLIENT_ID=
DISCORD_CLIENT_SECRET=
DISCORD_BOT_TOKEN=
DISCORD_GUILD_ID=
DISCORD_REDIRECT_URI=http://localhost:3000/auth/callback
DISCORD_INVITE_URL=https://discord.gg/your-invite-code

# Channel IDs - Get from: Discord -> Enable Developer Mode -> Right-click channel -> Copy ID
DISCORD_INTRODUCTIONS_CHANNEL_ID=
DISCORD_ADMIN_ALERT_CHANNEL_ID=
DISCORD_BILLING_SUPPORT_CHANNEL_ID=

# =============================================================================
# Email (Optional in development)
# =============================================================================
# Options: console (logs to console) or resend (sends real emails)
EMAIL_PROVIDER=console

# Required only if EMAIL_PROVIDER=resend
# Get from: Resend Dashboard -> API Keys
RESEND_API_KEY=

# =============================================================================
# Admin Seed (for prisma db seed)
# =============================================================================
ADMIN_SEED_EMAIL=admin@example.com
ADMIN_SEED_PASSWORD=
```
  </action>
  <verify>
  - File contains all environment variables used in the codebase
  - Each section has clear instructions for where to obtain values
  - `grep "APP_URL" .env.example` returns result
  - `grep "STRIPE_INDIVIDUAL_PRICE_ID" .env.example` returns result
  </verify>
  <done>.env.example contains complete documentation of all environment variables</done>
</task>

</tasks>

<verification>
Run security verification commands from RESEARCH.md:

```bash
# 1. Verify no debug logging in admin middleware
grep -n "console.log" src/admin/middleware.ts
# Expected: No output

# 2. Verify CORS is configured (not just cors())
grep -A5 "app.use(cors" src/index.ts
# Expected: Shows origin configuration

# 3. Verify .env.example is complete
grep -c "=" .env.example
# Expected: ~20+ variables documented

# 4. Verify no hardcoded secrets
grep -rn "sk_live\|whsec_\|sk_test" src/
# Expected: No output (only .env.example has placeholders)

# 5. TypeScript compiles
npx tsc --noEmit
# Expected: No errors

# 6. Server starts
npm run dev
# Expected: Server starts without errors
```
</verification>

<success_criteria>
- No console.log statements in src/admin/middleware.ts
- CORS restricts to APP_URL in production mode
- .env.example documents all 20+ environment variables
- No hardcoded secrets in source code
- TypeScript compiles without errors
- Server starts without errors
- All Critical security items from AUDIT-CHECKLIST verified as PASS
</success_criteria>

<output>
After completion, create `.planning/phases/15-security-audit/15-02-SUMMARY.md`

Include security verification results:
- JWT Token Security: PASS (15min access, httpOnly refresh)
- Password Hashing: PASS (Argon2id OWASP 2025)
- CSRF Protection: PASS (state cookies on OAuth)
- Stripe Webhook Signature: PASS (constructEvent with secret)
- Admin Authorization: PASS (requireAdmin/requireSuperAdmin)
- Input Validation: PASS (Zod schemas)
- Rate Limiting: PASS (after 15-01)
- Debug Logging: PASS (after this plan)
- CORS: PASS (after this plan)
- Secrets Management: PASS (.env only, validated at startup)
</output>
