---
phase: 16-data-integrity-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/16-data-integrity-audit/16-01-SCHEMA-AUDIT.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All unique constraints in Prisma schema are documented and verified"
    - "Foreign key relationships and default cascade behavior are documented"
    - "Missing or incorrect constraints are identified and logged"
  artifacts:
    - path: ".planning/phases/16-data-integrity-audit/16-01-SCHEMA-AUDIT.md"
      provides: "Schema constraint audit findings"
      contains: "## Unique Constraints"
  key_links: []
---

<objective>
Audit Prisma schema constraints to verify data integrity mechanisms

Purpose: Verify unique constraints prevent duplicate data, foreign key relationships have correct cascade behavior, and identify any missing constraints that could allow data corruption.

Output: Schema audit document (16-01-SCHEMA-AUDIT.md) with verified constraints and any gaps identified
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/AUDIT-CHECKLIST.md
@.planning/phases/16-data-integrity-audit/16-CONTEXT.md
@.planning/phases/16-data-integrity-audit/16-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit unique constraints</name>
  <files>.planning/phases/16-data-integrity-audit/16-01-SCHEMA-AUDIT.md</files>
  <action>
Review prisma/schema.prisma and verify all @unique constraints are correctly placed.

Create 16-01-SCHEMA-AUDIT.md with:

## Unique Constraints Audit

For each model, document:
| Model | Field | Constraint | Purpose | Status |
|-------|-------|------------|---------|--------|

Verify these constraints are present and correct:
- Member.discordId (@unique, optional) - Prevents duplicate Discord linking
- Member.stripeCustomerId (@unique, optional) - Prevents duplicate Stripe customers
- Member.email (@unique, optional) - Prevents duplicate emails
- Team.stripeCustomerId (@unique, required) - Required for billing
- Team.stripeSubscriptionId (@unique, optional) - One subscription per team
- StripeEvent.eventId (@unique, required) - Critical for webhook idempotency
- PendingInvite.token (@unique, required) - Token collision prevention
- Admin.email (@unique, required) - Admin email uniqueness
- FeatureFlag.key (@unique, required) - Flag key uniqueness
- EmailTemplate.name (@unique, required) - Template name uniqueness

For each constraint:
- Status: VERIFIED if present and correct
- Status: MISSING if should exist but doesn't
- Status: INCORRECT if wrong constraint type
- Add notes explaining purpose and any edge cases

Do NOT run queries against the database - this is schema-level verification only.
  </action>
  <verify>File 16-01-SCHEMA-AUDIT.md exists with Unique Constraints Audit section</verify>
  <done>All unique constraints documented with status (VERIFIED/MISSING/INCORRECT)</done>
</task>

<task type="auto">
  <name>Task 2: Audit foreign key relationships and cascade behavior</name>
  <files>.planning/phases/16-data-integrity-audit/16-01-SCHEMA-AUDIT.md</files>
  <action>
Add to 16-01-SCHEMA-AUDIT.md:

## Foreign Key Relationships Audit

Document all foreign key relationships and their cascade behavior:

| Relation | Field | Required | Default onDelete | Actual | Status |
|----------|-------|----------|------------------|--------|--------|

Per Prisma 7 documentation, defaults are:
- Optional relations: onDelete: SetNull
- Required relations: onDelete: Restrict

Verify these relationships:
1. Member -> Team (teamId, optional)
   - Expected: SetNull on Team delete (member's teamId becomes null)
   - Verify: Member record preserved, team link removed
   - Status: Document actual behavior

2. PendingInvite -> Team (teamId, required)
   - Expected: Restrict on Team delete (cannot delete team with pending invites)
   - Verify: Team deletion blocked if invites exist
   - Status: Document actual behavior

Add a section:

## Cascade Delete Analysis

Document what happens in these scenarios:
1. Team with members is deleted -> Member.teamId set to null (SetNull)
2. Team with pending invites exists -> Delete blocked (Restrict)
3. Member with no team is deleted -> Clean deletion, no cascades

Include assessment:
- Is current behavior acceptable for the application?
- Any risks identified?
- Recommendations (document only, no changes)
  </action>
  <verify>16-01-SCHEMA-AUDIT.md has Foreign Key Relationships Audit and Cascade Delete Analysis sections</verify>
  <done>All foreign key relationships documented with expected vs actual cascade behavior</done>
</task>

<task type="auto">
  <name>Task 3: Audit indexes and summarize findings</name>
  <files>.planning/phases/16-data-integrity-audit/16-01-SCHEMA-AUDIT.md</files>
  <action>
Add to 16-01-SCHEMA-AUDIT.md:

## Index Audit

Document all @@index declarations:
| Model | Index | Fields | Purpose | Status |
|-------|-------|--------|---------|--------|

Verify indexes exist for:
- Member: teamId (foreign key lookup), subscriptionStatus (filtering)
- PendingInvite: teamId (team lookup), token (token lookup)
- StripeEvent: eventId (idempotency), type (filtering), processedAt (time queries)
- AuditLog: entityType+entityId (entity lookup), action (filtering), createdAt (time queries)
- ReconciliationRun: startedAt (time queries)
- Admin: email (login lookup)
- FeatureFlag: key (lookup)

## Summary

Create summary table:
| Category | Items Checked | Passed | Issues |
|----------|---------------|--------|--------|
| Unique Constraints | X | Y | Z |
| Foreign Keys | X | Y | Z |
| Indexes | X | Y | Z |
| **Total** | X | Y | Z |

## Findings

List any issues found (or "No issues found"):
- Finding 1: [severity] Description
- Finding 2: [severity] Description

## Recommendations

List recommendations for future work (this is audit only, no changes):
- Recommendation 1
- Recommendation 2
  </action>
  <verify>16-01-SCHEMA-AUDIT.md has Index Audit, Summary, Findings, and Recommendations sections</verify>
  <done>Complete schema audit document with all sections and summary</done>
</task>

</tasks>

<verification>
- 16-01-SCHEMA-AUDIT.md exists in phase directory
- Document has sections: Unique Constraints, Foreign Keys, Cascade Delete, Indexes, Summary, Findings, Recommendations
- All constraints from schema.prisma are accounted for
- Each item has a status (VERIFIED/MISSING/INCORRECT)
</verification>

<success_criteria>
- Complete audit of Prisma schema constraints
- All unique constraints documented with status
- All foreign key relationships documented with cascade behavior
- All indexes documented
- Summary of findings with severity levels
- Recommendations documented (for future phases, not this one)
</success_criteria>

<output>
After completion, create `.planning/phases/16-data-integrity-audit/16-01-SUMMARY.md`
</output>
