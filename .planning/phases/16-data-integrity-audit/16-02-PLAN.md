---
phase: 16-data-integrity-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/16-data-integrity-audit/16-02-TRANSACTION-AUDIT.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All database transactions are verified for atomicity"
    - "Webhook idempotency mechanisms are verified working"
    - "Stripe source-of-truth pattern is verified (DB mirrors Stripe, never leads)"
    - "Discord events are verified idempotent via introCompleted flag"
  artifacts:
    - path: ".planning/phases/16-data-integrity-audit/16-02-TRANSACTION-AUDIT.md"
      provides: "Transaction and idempotency audit findings"
      contains: "## Transaction Boundary Audit"
  key_links: []
---

<objective>
Audit transaction safety, webhook idempotency, and Stripe synchronization patterns

Purpose: Verify database transactions are atomic, webhook handlers are idempotent, and Stripe remains the source of truth for subscription data. Document any gaps for future remediation.

Output: Transaction audit document (16-02-TRANSACTION-AUDIT.md) with verified patterns and any gaps identified
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/AUDIT-CHECKLIST.md
@.planning/phases/16-data-integrity-audit/16-CONTEXT.md
@.planning/phases/16-data-integrity-audit/16-RESEARCH.md
@src/webhooks/stripe.ts
@src/routes/team-claim.ts
@src/billing/failure-handler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit transaction boundaries</name>
  <files>.planning/phases/16-data-integrity-audit/16-02-TRANSACTION-AUDIT.md</files>
  <action>
Search codebase for all $transaction usages and audit each for correctness.

Create 16-02-TRANSACTION-AUDIT.md with:

## Transaction Boundary Audit

### Transaction 1: Seat Claim (src/routes/team-claim.ts)

Location: Search for prisma.$transaction in team-claim.ts
Pattern: Interactive transaction with read-modify-write

Document:
- Purpose: Atomic seat claiming to prevent race conditions
- Operations inside transaction:
  1. Re-fetch team members (read for consistency)
  2. Check seat availability (validate)
  3. Upsert member (write)
  4. Mark invite as used (write)
- Assessment: [CORRECT/INCORRECT]
- Notes: Why this transaction is needed, any edge cases

### Transaction 2: Team Payment Failure (src/billing/failure-handler.ts)

Location: Search for prisma.$transaction in failure-handler.ts
Pattern: Batch update

Document:
- Purpose: Atomic update of team and all team members
- Operations inside transaction:
  1. Update team billing state
  2. Update all team members billing state
- Assessment: [CORRECT/INCORRECT]
- Notes: Why batch update needs atomicity

### Fire-and-Forget Discord Pattern

Per CONTEXT.md, fire-and-forget Discord operations are intentional. Document but do NOT flag as issues:
- Role assignments after seat claim
- Role removals on cancellation
- Why acceptable: Reconciliation system catches drift
  </action>
  <verify>File 16-02-TRANSACTION-AUDIT.md exists with Transaction Boundary Audit section</verify>
  <done>All $transaction usages documented with assessment</done>
</task>

<task type="auto">
  <name>Task 2: Audit webhook idempotency</name>
  <files>.planning/phases/16-data-integrity-audit/16-02-TRANSACTION-AUDIT.md</files>
  <action>
Add to 16-02-TRANSACTION-AUDIT.md:

## Webhook Idempotency Audit

### Stripe Webhook Handler (src/webhooks/stripe.ts)

Verify the idempotency pattern:
1. Check for existing StripeEvent by eventId (findUnique)
2. Return 200 if duplicate found
3. Create StripeEvent BEFORE processing (record-before-process)
4. Process event asynchronously

Document:
| Step | Implementation | Status |
|------|----------------|--------|
| Duplicate check | findUnique on eventId | VERIFIED/MISSING |
| Early return | Return 200 on duplicate | VERIFIED/MISSING |
| Record first | Create before process | VERIFIED/MISSING |
| DB constraint | @unique on eventId | VERIFIED/MISSING |

Assessment: [CORRECT/INCORRECT]
Race condition protection: Explain how @unique constraint handles concurrent webhook delivery

### Individual Event Handler Idempotency

For each webhook event type, verify handler is safe for replay:
| Event Type | Handler Behavior | Idempotent? | Notes |
|------------|------------------|-------------|-------|
| checkout.session.completed | Update member status | Yes/No | Explain |
| customer.subscription.updated | Sync from Stripe | Yes/No | Explain |
| customer.subscription.deleted | Remove roles | Yes/No | Explain |
| invoice.payment_failed | Set billing state | Yes/No | Explain |
| invoice.paid | Clear billing state | Yes/No | Explain |

### Discord Event Idempotency

Verify introduction handler is idempotent:
- Location: src/bot/introduction-handler.ts (or similar)
- Check: introCompleted flag prevents duplicate role promotions
- Assessment: Document how double-processing is prevented
  </action>
  <verify>16-02-TRANSACTION-AUDIT.md has Webhook Idempotency Audit section with event table</verify>
  <done>All webhook handlers verified for idempotency with assessment table</done>
</task>

<task type="auto">
  <name>Task 3: Audit Stripe source of truth and summarize</name>
  <files>.planning/phases/16-data-integrity-audit/16-02-TRANSACTION-AUDIT.md</files>
  <action>
Add to 16-02-TRANSACTION-AUDIT.md:

## Stripe Source of Truth Audit

### Data Flow Direction

Verify data flows FROM Stripe TO database (never reverse):

| Data | Source | DB Field | Sync Mechanism | Status |
|------|--------|----------|----------------|--------|
| Subscription status | Stripe | subscriptionStatus | Webhook | CORRECT/INCORRECT |
| Seat counts | Stripe | ownerSeatCount, teamSeatCount | Webhook | CORRECT/INCORRECT |
| Period end | Stripe | currentPeriodEnd | Webhook | CORRECT/INCORRECT |
| Payment failure | Stripe | paymentFailedAt | Webhook | CORRECT/INCORRECT |

### Schema Alignment

Verify DB fields match what Stripe provides:
- SubscriptionStatus enum covers all Stripe statuses via mapStripeStatus()
- Seat counts are integers matching Stripe quantity
- Timestamps are DateTime matching Stripe epoch conversion

### Add Seats Operation

Document the add-seats flow:
1. API updates Stripe first (stripe.subscriptionItems.update)
2. Stripe sends customer.subscription.updated webhook
3. Webhook handler syncs new seat counts to DB
4. Source of truth: STRIPE - DB is cache

Assessment: [CORRECT - Stripe leads, DB follows]

## Scheduled Job Idempotency

### Billing Scheduler

Verify notification idempotency:
- Field: Member.sentBillingNotifications (String array)
- Pattern: Check if notification key in array before sending
- Assessment: Prevents duplicate notifications on scheduler restart

### Reconciliation Job

Verify job is safe for multiple runs:
- Detects drift, logs issues
- Auto-fix mode updates Discord to match DB
- DB is synced from Stripe, so chain is: Stripe -> DB -> Discord

## Summary

| Category | Items Checked | Passed | Issues |
|----------|---------------|--------|--------|
| Transactions | X | Y | Z |
| Webhook Idempotency | X | Y | Z |
| Stripe Source of Truth | X | Y | Z |
| Scheduled Jobs | X | Y | Z |
| **Total** | X | Y | Z |

## Findings

List any issues found (or "No issues found"):
- Finding 1: [severity] Description
- Finding 2: [severity] Description

## Recommendations

List recommendations for future work:
- Recommendation 1
- Recommendation 2
  </action>
  <verify>16-02-TRANSACTION-AUDIT.md has Stripe Source of Truth, Summary, Findings, and Recommendations sections</verify>
  <done>Complete transaction/idempotency audit with summary and recommendations</done>
</task>

</tasks>

<verification>
- 16-02-TRANSACTION-AUDIT.md exists in phase directory
- Document has sections: Transaction Boundary, Webhook Idempotency, Stripe Source of Truth, Scheduled Jobs, Summary, Findings, Recommendations
- All $transaction usages verified
- All webhook event types verified for idempotency
- Stripe source of truth pattern verified
</verification>

<success_criteria>
- Complete audit of transaction boundaries (2 transactions identified in RESEARCH.md)
- All webhook event handlers verified for idempotent behavior
- Stripe source of truth pattern verified
- Scheduled job idempotency verified
- Summary of findings with severity levels
- Recommendations documented (for future phases)
</success_criteria>

<output>
After completion, create `.planning/phases/16-data-integrity-audit/16-02-SUMMARY.md`
</output>
