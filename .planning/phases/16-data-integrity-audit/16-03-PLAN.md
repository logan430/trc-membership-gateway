---
phase: 16-data-integrity-audit
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/16-data-integrity-audit/16-03-BACKUP-AUDIT.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Backup procedures are documented"
    - "Backup schedule and retention policy are documented"
    - "Recovery procedures are documented"
  artifacts:
    - path: ".planning/phases/16-data-integrity-audit/16-03-BACKUP-AUDIT.md"
      provides: "Backup procedure documentation"
      min_lines: 50
      contains: "Recovery Procedures"
  key_links:
    - from: "16-03-BACKUP-AUDIT.md"
      to: "Supabase documentation"
      via: "Research verification"
      pattern: "backup|restore|point-in-time"
---

<objective>
Document Supabase backup procedures, schedule, retention policy, and recovery procedures.

Purpose: Close gap identified in Phase 16 verification - success criterion #6 "Backup procedures documented" was not addressed by plans 16-01 or 16-02.

Output: `.planning/phases/16-data-integrity-audit/16-03-BACKUP-AUDIT.md` containing complete backup documentation for the Supabase-hosted database.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-data-integrity-audit/16-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Research and document Supabase backup configuration</name>
  <files>.planning/phases/16-data-integrity-audit/16-03-BACKUP-AUDIT.md</files>
  <action>
Research Supabase's managed backup features and document:

1. **Backup Type**: Supabase provides automatic daily backups for all projects. Document that this is managed infrastructure - no user configuration required.

2. **Backup Schedule**:
   - Automatic daily backups (Supabase managed)
   - Point-in-time recovery (PITR) available on Pro plan and above
   - Note: Free tier has daily backups with 7-day retention

3. **Retention Policy**:
   - Free tier: 7-day retention
   - Pro tier: 7-day retention + PITR (up to 7 days)
   - Team/Enterprise: Extended PITR available

4. **What's backed up**:
   - Full database (all tables, indexes, constraints)
   - Auth users (Supabase auth)
   - Storage metadata (not files on free tier)

5. **What's NOT backed up** (important for this project):
   - Stripe subscription data (lives in Stripe - Stripe is source of truth per 16-02 audit)
   - Discord role assignments (live in Discord)
   - Note: These are external services, not database concerns

Create the audit document with these sections:
- Executive Summary
- Supabase Managed Backup Features
- Backup Schedule
- Retention Policy by Plan Tier
- Data Recovery Procedures
- External Service Data (Stripe, Discord)
- Recommendations
  </action>
  <verify>
File `.planning/phases/16-data-integrity-audit/16-03-BACKUP-AUDIT.md` exists and contains:
- Backup schedule section
- Retention policy section
- Recovery procedures section
- At least 50 lines of documentation
  </verify>
  <done>
Backup audit document created with all required sections documenting Supabase's managed backup features, schedule, retention policy, and recovery procedures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document recovery procedures and verification</name>
  <files>.planning/phases/16-data-integrity-audit/16-03-BACKUP-AUDIT.md</files>
  <action>
Add detailed recovery procedures section to the backup audit document:

1. **Recovery via Supabase Dashboard**:
   - Navigate to Settings > Database > Backups
   - Select backup date/time to restore from
   - Confirm restoration (creates new database or restores to existing)

2. **Point-in-time Recovery (PITR)** (if on Pro plan):
   - Available through Dashboard
   - Can restore to any point within retention window
   - Useful for recovering from accidental deletes or corrupted data

3. **Manual Backup Options**:
   - pg_dump via direct connection (document connection string pattern)
   - Prisma migrations serve as schema backup (already in git)
   - Database seed file provides reference data (prisma/seed.ts)

4. **Disaster Recovery Scenario Steps**:
   a. Identify incident scope (table corruption, full db loss, etc.)
   b. Choose recovery method (dashboard restore vs PITR vs manual)
   c. Notify team of potential downtime
   d. Execute restore
   e. Verify data integrity
   f. Restart application services
   g. Verify webhook connectivity

5. **Post-recovery Checklist**:
   - [ ] Prisma migrations match restored schema
   - [ ] Active subscriptions sync with Stripe
   - [ ] Discord roles reconciled (run reconciliation job)
   - [ ] Test key flows (login, checkout, claim)

Add a final "Audit Findings" section confirming:
- Supabase provides adequate backup coverage
- Stripe source-of-truth means subscription data is recoverable
- Discord reconciliation job handles role drift
  </action>
  <verify>
File `.planning/phases/16-data-integrity-audit/16-03-BACKUP-AUDIT.md` contains:
- "Recovery Procedures" section
- "Disaster Recovery" section
- Post-recovery checklist
- Audit findings confirmation
  </verify>
  <done>
Recovery procedures documented including dashboard restore, PITR, manual backup options, disaster recovery steps, and post-recovery verification checklist.
  </done>
</task>

</tasks>

<verification>
1. File exists: `.planning/phases/16-data-integrity-audit/16-03-BACKUP-AUDIT.md`
2. Document covers all required sections:
   - Backup schedule
   - Retention policy
   - Recovery procedures
   - Disaster recovery steps
3. Document is at least 50 lines
4. Document confirms Supabase backups are adequate for project needs
</verification>

<success_criteria>
- Backup procedures are fully documented
- Recovery procedures are actionable (step-by-step)
- Phase 16 success criterion #6 "Backup procedures documented" is now satisfied
- Document acknowledges that Stripe and Discord data lives outside database backups
</success_criteria>

<output>
After completion, create `.planning/phases/16-data-integrity-audit/16-03-SUMMARY.md`
</output>
