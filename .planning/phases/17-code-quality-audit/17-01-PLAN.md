---
phase: 17-code-quality-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/CODE-QUALITY-AUDIT.md
autonomous: true

must_haves:
  truths:
    - "All dead code (unused exports/functions) is documented with severity"
    - "All explicit any types are documented with file locations"
    - "All console.log statements are documented with context"
    - "npm audit results are captured and prioritized"
    - "Circular dependencies are detected and documented"
    - "Audit report exists with Critical/High/Medium/Low categorization"
  artifacts:
    - path: ".planning/CODE-QUALITY-AUDIT.md"
      provides: "Prioritized technical debt report"
      min_lines: 100
  key_links:
    - from: "Knip output"
      to: "CODE-QUALITY-AUDIT.md dead code section"
      via: "tool output analysis"
    - from: "npm audit output"
      to: "CODE-QUALITY-AUDIT.md dependencies section"
      via: "tool output analysis"
    - from: "dpdm output"
      to: "CODE-QUALITY-AUDIT.md circular deps section"
      via: "tool output analysis"
---

<objective>
Run comprehensive code quality audit tools and produce a prioritized technical debt report documenting all findings without making fixes.

Purpose: Document technical debt in a structured, actionable format for future cleanup phases.
Output: `.planning/CODE-QUALITY-AUDIT.md` with Critical/High/Medium/Low categorization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-code-quality-audit/17-CONTEXT.md
@.planning/phases/17-code-quality-audit/17-RESEARCH.md
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execute Code Quality Audit Tools</name>
  <files>None (tool outputs only)</files>
  <action>
Run all audit tools and capture their output. Execute these commands in sequence:

**1. Dead Code Analysis (Knip)**
```bash
npx knip
```
Capture the human-readable output. Note: No knip.json exists - use default configuration.
If Knip finds issues, they will be listed by category (unused files, exports, dependencies).

**2. Circular Dependency Check (dpdm)**
```bash
npx dpdm --no-warning --no-tree ./src/index.ts
```
This shows circular dependencies only. If none found, output will be empty.
Also try with TypeScript ignore for type-only imports:
```bash
npx dpdm -T --no-warning --no-tree ./src/index.ts
```

**3. Security Audit (npm)**
```bash
npm audit
npm audit --omit=dev
```
First shows all vulnerabilities, second focuses on production dependencies only.

**4. TypeScript Type Check**
```bash
npx tsc --noEmit
```
Note: tsconfig.json already has "strict": true, so implicit any will be caught.
Document any type errors found.

**5. Console Statement Search**
Use Grep tool to search for:
- Pattern: `console\.(log|warn|error|debug|info)`
- Path: src/
- Output mode: content (to see context)

Document which console statements are found and their context (startup, error handling, debug).

**6. Explicit `any` Type Search**
Use Grep tool to search for:
- Pattern: `: any`
- Path: src/
- Output mode: content

Also search for:
- Pattern: `as any`
- Path: src/

Document all explicit any usages with file:line references.

Record all tool outputs for the next task.
  </action>
  <verify>
All 6 audit categories have been executed:
- Knip output captured (or confirmed no issues)
- dpdm output captured (or confirmed no circular deps)
- npm audit output captured
- TypeScript check completed
- Console statement grep completed
- Explicit any grep completed
  </verify>
  <done>Tool outputs for all 6 audit categories are available for report generation</done>
</task>

<task type="auto">
  <name>Task 2: Produce Prioritized Audit Report</name>
  <files>.planning/CODE-QUALITY-AUDIT.md</files>
  <action>
Create `.planning/CODE-QUALITY-AUDIT.md` following this structure:

```markdown
# Code Quality Audit Report

**Date:** 2026-01-21
**Scope:** src/ directory, package.json dependencies
**Phase:** 17-code-quality-audit
**Status:** Document only (no fixes applied)

## Executive Summary
- X critical issues found
- Y high priority items
- Z medium/low items
- Overall assessment: [PASS/NEEDS_ATTENTION/CRITICAL]

## Findings by Severity

### Critical Issues
[Issues that pose security risk or data loss potential]
| ID | Type | Location | Description | Remediation |
|----|------|----------|-------------|-------------|

### High Priority Items
[Issues that block or degrade functionality]
| ID | Type | Location | Description | Remediation |

### Medium Priority Items
[Tech debt affecting maintainability]
| ID | Type | Location | Description | Remediation |

### Low Priority / Informational
[Cleanup items, informational only]
| ID | Type | Location | Description | Remediation |

## Detailed Tool Outputs

### Dead Code (Knip)
[Summary of Knip findings or "No unused exports/files detected"]

### Circular Dependencies (dpdm)
[List any found or "No circular dependencies detected"]

### Security Vulnerabilities (npm audit)
[Summary of npm audit results, production deps first]

### Type Safety
[Any TypeScript errors or "No type errors (strict mode enabled)"]
[List of explicit `any` usages if any]

### Console Statements
[List console.log/warn/error usages with context assessment]
[Categorize: intentional (startup/errors) vs debug (should remove)]

### Unused Dependencies
[If Knip detected any unused dependencies]

## Recommendations

### Immediate Actions (Critical/High)
1. [Prioritized list]

### Future Cleanup (Medium/Low)
1. [Prioritized list]

## Checklist Status
Based on ROADMAP Phase 17 success criteria:
- [ ] No dead code (unused exports/functions)
- [ ] No `any` types in production code
- [ ] Consistent error handling patterns
- [ ] No console.log in production paths
- [ ] Dependencies up to date (npm audit clean)
- [ ] No circular dependencies
```

**Severity Classification Rules (from RESEARCH.md):**
- **Critical:** Security vulnerabilities (npm audit critical), explicit `any` in auth/payment code
- **High:** Circular dependencies, dead exports in public API, high npm vulnerabilities
- **Medium:** Unused files, implicit `any` types, medium npm vulnerabilities
- **Low:** Unused devDependencies, informational console.log, low npm vulnerabilities

**Important:**
- Document only, do not fix
- Flag console.error/console.warn for awareness but mark as "intentional - keep"
- Check if console.log appears in startup sequences (intentional) vs debug paths (remove)
- Note the project uses Pino logger, so console statements may be minimal
  </action>
  <verify>
```bash
# Verify report exists and has content
wc -l .planning/CODE-QUALITY-AUDIT.md
```
Report should have 100+ lines with all sections populated.
  </verify>
  <done>
CODE-QUALITY-AUDIT.md exists with:
- Executive summary with issue counts
- All 6 audit categories documented
- Severity-based prioritization (Critical/High/Medium/Low)
- Checklist status for each Phase 17 success criterion
- Actionable recommendations for future cleanup
  </done>
</task>

</tasks>

<verification>
Phase 17 verification criteria:
1. CODE-QUALITY-AUDIT.md exists in .planning/
2. Report covers all 6 audit categories from ROADMAP success criteria
3. Each finding has severity classification
4. Recommendations are actionable for future cleanup phase
5. No code changes were made (audit only)
</verification>

<success_criteria>
Phase 17 is complete when:
- All code quality tools have been run
- All findings documented with severity in CODE-QUALITY-AUDIT.md
- Report follows template structure from RESEARCH.md
- Checklist maps findings to ROADMAP Phase 17 success criteria
- No fixes applied (documentation only per CONTEXT.md)
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-quality-audit/17-01-SUMMARY.md`
</output>
