---
phase: 19-testing-coverage-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/19-testing-coverage-audit/TESTING-COVERAGE-AUDIT.md
autonomous: true

must_haves:
  truths:
    - "Audit report documents current test coverage state (0%)"
    - "All 41 v1 requirements are mapped to test coverage needs"
    - "Critical user flows are identified with priority rankings"
    - "Webhook handlers are specifically analyzed for test needs"
    - "Auth flow test requirements are documented"
    - "Error scenarios and edge cases are catalogued"
  artifacts:
    - path: ".planning/phases/19-testing-coverage-audit/TESTING-COVERAGE-AUDIT.md"
      provides: "Complete testing coverage audit report"
      contains: "Priority Matrix"
      min_lines: 200
  key_links:
    - from: "TESTING-COVERAGE-AUDIT.md"
      to: "REQUIREMENTS.md"
      via: "requirement-to-test mapping table"
      pattern: "AUTH-01|PAY-01|BILL-01"
    - from: "TESTING-COVERAGE-AUDIT.md"
      to: "MANUAL-TESTING-GUIDE.md"
      via: "automation candidates from manual test cases"
      pattern: "Test Suite"
---

<objective>
Produce a comprehensive TESTING-COVERAGE-AUDIT.md report that assesses the current state of automated testing (0%), maps all v1 requirements to needed tests, prioritizes which tests would provide the most value, and documents edge cases requiring coverage.

Purpose: Enable informed decisions about test implementation by identifying the highest-value test targets based on risk and complexity
Output: TESTING-COVERAGE-AUDIT.md with coverage analysis, priority matrix, and implementation recommendations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/AUDIT-CHECKLIST.md
@.planning/MANUAL-TESTING-GUIDE.md
@.planning/phases/19-testing-coverage-audit/19-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze Current Test Infrastructure and Coverage</name>
  <files>.planning/phases/19-testing-coverage-audit/TESTING-COVERAGE-AUDIT.md</files>
  <action>
    Create the TESTING-COVERAGE-AUDIT.md report. Begin with an executive summary confirming zero test coverage exists despite Vitest 4.0.17 being installed.

    Document the current state:
    - Test framework: Vitest installed but unused
    - Test files: None in src/
    - Coverage tools: Not configured
    - Manual test documentation: MANUAL-TESTING-GUIDE.md exists with 90+ cases

    Scan the source files to identify testable units:
    - src/webhooks/stripe.ts (391 lines, CRITICAL)
    - src/billing/failure-handler.ts and recovery-handler.ts (CRITICAL)
    - src/auth/session.ts, magic-link.ts, discord-oauth.ts (HIGH)
    - src/routes/auth.ts, claim.ts, team-claim.ts (HIGH)
    - src/lib/role-assignment.ts (MEDIUM)
    - src/bot/events/introduction.ts (MEDIUM)
    - src/reconciliation/reconcile.ts (MEDIUM)

    Create a "Source Files Requiring Tests" table with columns: File, Lines of Code, Critical Operations, Risk Level, Recommended Test Type (Unit/Integration/Both).
  </action>
  <verify>
    TESTING-COVERAGE-AUDIT.md exists and contains:
    - Executive Summary section
    - Current State Assessment section
    - Source Files Requiring Tests table with at least 10 entries
  </verify>
  <done>
    First section of audit report complete with infrastructure analysis and source file inventory
  </done>
</task>

<task type="auto">
  <name>Task 2: Map Requirements to Test Coverage Needs</name>
  <files>.planning/phases/19-testing-coverage-audit/TESTING-COVERAGE-AUDIT.md</files>
  <action>
    Continue the audit report by mapping all 41 v1 requirements from REQUIREMENTS.md to their test coverage needs.

    Create a comprehensive Requirements Coverage Matrix with columns:
    - Requirement ID (AUTH-01 through OPS-04)
    - Description (brief)
    - Current Coverage (Manual/None)
    - Test Type Needed (Unit/Integration/E2E)
    - Priority (Critical/High/Medium/Low)
    - Estimated Effort (Small/Medium/Large)

    Group requirements by category and assign priorities based on:
    - CRITICAL: Payment processing, webhook handlers, billing state transitions
    - HIGH: Authentication flows, role assignments, seat management
    - MEDIUM: Email notifications, reconciliation, introduction detection
    - LOW: UI flows, empty states, edge cases

    Identify the "Critical Path" tests - the minimum viable test suite that covers the highest-risk functionality:
    1. Stripe webhook handler (checkout, subscription events)
    2. Payment failure/recovery state machine
    3. JWT token lifecycle (create, verify, refresh, expire)
    4. Role assignment logic (assignRoleAsync patterns)
    5. Seat claim transaction safety
  </action>
  <verify>
    TESTING-COVERAGE-AUDIT.md contains:
    - Requirements Coverage Matrix with all 41 requirements
    - Priority assignments for each requirement
    - Critical Path Tests section identifying top 5-10 test priorities
  </verify>
  <done>
    Requirements-to-test mapping complete with priority rankings
  </done>
</task>

<task type="auto">
  <name>Task 3: Document Edge Cases and Implementation Recommendations</name>
  <files>.planning/phases/19-testing-coverage-audit/TESTING-COVERAGE-AUDIT.md</files>
  <action>
    Complete the audit report with edge cases, error scenarios, and implementation recommendations.

    Create an Edge Cases Catalog documenting scenarios from MANUAL-TESTING-GUIDE.md that need automated coverage:
    - Duplicate webhook events (idempotency)
    - Expired magic links
    - Race conditions in seat claims
    - Grace period timing (48-hour boundary)
    - Multiple introduction attempts
    - Invalid Stripe signatures
    - Discord API failures (rate limits, bot offline)
    - Session token rotation edge cases

    Create an Error Scenarios section:
    - Invalid input validation (Zod schema rejections)
    - Database constraint violations
    - External service failures (Stripe, Discord, email provider)
    - Authentication failures (expired, invalid, missing tokens)

    Provide Implementation Recommendations:
    - Recommended test structure (from 19-RESEARCH.md)
    - Libraries to install (@vitest/coverage-v8, supertest, prismock, msw)
    - Patterns to follow (app/server separation, Prisma mocking, webhook testing)
    - Pitfalls to avoid (async fire-and-forget, token expiration, Discord bot state)

    Create a Priority Matrix Summary showing:
    - Wave 1: Unit tests for billing handlers, session functions (highest ROI)
    - Wave 2: Integration tests for webhook endpoints, auth routes
    - Wave 3: Bot event handler tests, reconciliation tests

    Add a Metrics section:
    - Current coverage: 0%
    - Target coverage recommendation: 70% for critical paths
    - Estimated implementation effort: ~20-30 hours for Wave 1+2

    End with an Audit Status: PASSED WITH GAPS (documenting current state, not failing for lack of tests)
  </action>
  <verify>
    TESTING-COVERAGE-AUDIT.md contains:
    - Edge Cases Catalog with at least 8 scenarios
    - Error Scenarios section
    - Implementation Recommendations with library list
    - Priority Matrix Summary with 3 waves
    - Audit Status conclusion
    - Total report is 200+ lines
  </verify>
  <done>
    Complete testing coverage audit report with edge cases, recommendations, and implementation roadmap
  </done>
</task>

</tasks>

<verification>
Run the following checks after all tasks complete:

1. Verify report exists and has required sections:
   - Check file exists: `.planning/phases/19-testing-coverage-audit/TESTING-COVERAGE-AUDIT.md`
   - Confirm sections: Executive Summary, Current State, Requirements Matrix, Edge Cases, Recommendations

2. Verify completeness:
   - Requirements Coverage Matrix includes all 41 v1 requirements
   - At least 10 source files analyzed
   - At least 8 edge cases documented
   - Implementation recommendations reference 19-RESEARCH.md findings

3. Verify audit checklist alignment:
   - Addresses all 8 items from AUDIT-CHECKLIST.md Section 7 (Testing Coverage)
</verification>

<success_criteria>
- [ ] TESTING-COVERAGE-AUDIT.md exists in phase directory
- [ ] Executive Summary confirms 0% current coverage
- [ ] All 41 v1 requirements mapped to test needs
- [ ] Critical paths identified (webhook, billing, auth, roles, seats)
- [ ] Edge cases catalogued from MANUAL-TESTING-GUIDE.md
- [ ] Error scenarios documented
- [ ] Implementation recommendations provided
- [ ] Priority matrix with waves defined
- [ ] Audit status: PASSED WITH GAPS
- [ ] Report is comprehensive (200+ lines)
</success_criteria>

<output>
After completion, create `.planning/phases/19-testing-coverage-audit/19-01-SUMMARY.md`
</output>
