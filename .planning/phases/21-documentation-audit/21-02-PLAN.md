---
phase: 21-documentation-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/API.md
autonomous: true

must_haves:
  truths:
    - "Developer can find any API endpoint by browsing docs/API.md"
    - "Each endpoint documents auth requirements, request format, and response format"
    - "Authentication methods (JWT, cookies, Stripe signature) are explained"
  artifacts:
    - path: "docs/API.md"
      provides: "Complete API reference for all 48 endpoints"
      min_lines: 500
      contains: "Authentication"
  key_links:
    - from: "docs/API.md"
      to: "src/routes/"
      via: "documents endpoints"
      pattern: "/auth/|/checkout/|/billing/"
---

<objective>
Create comprehensive API documentation covering all 48 endpoints

Purpose: Enable developers to understand and integrate with all API endpoints without reading source code
Output: docs/API.md with complete endpoint reference, authentication docs, and examples
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-documentation-audit/21-RESEARCH.md
@src/routes/auth.ts
@src/routes/checkout.ts
@src/routes/billing.ts
@src/routes/company.ts
@src/routes/dashboard.ts
@src/routes/claim.ts
@src/routes/team.ts
@src/routes/admin-auth.ts
@src/routes/admin.ts
@src/routes/webhooks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docs directory and API.md structure</name>
  <files>docs/API.md</files>
  <action>
Create docs/ directory if it does not exist.

Create docs/API.md with the following structure:

**Header:**
```markdown
# API Reference

The Revenue Council Membership Gateway API documentation.

**Base URL:** `http://localhost:3000` (development) or your production domain

**Version:** 1.0.0
```

**Authentication section:**
Document all three authentication methods:

1. **JWT Bearer Token (most endpoints)**
   - How to obtain: POST /auth/login or /auth/signup
   - Where to send: Authorization header `Bearer <token>`
   - Token expiry: 15 minutes (use refresh token to renew)

2. **Refresh Token Cookie (token renewal)**
   - Automatically set by login/signup
   - Used by POST /auth/refresh
   - Cookie name: refreshToken
   - httpOnly, secure in production

3. **Stripe Webhook Signature (webhooks only)**
   - Header: stripe-signature
   - Verified against STRIPE_WEBHOOK_SECRET

**Error Response Format:**
```json
{
  "error": "Error message here"
}
```

Common status codes:
- 200: Success
- 201: Created
- 400: Bad request (validation error)
- 401: Unauthorized (missing/invalid token)
- 403: Forbidden (insufficient permissions)
- 404: Not found
- 429: Rate limited
- 500: Server error

**Rate Limiting:**
- Auth endpoints: 5 requests per 15 minutes (login, signup, magic-link, admin-login)
- Other endpoints: No rate limiting
  </action>
  <verify>
    - docs/API.md exists
    - Contains "Authentication" section
    - Contains "Error Response Format" section
    - Contains "Rate Limiting" section
  </verify>
  <done>API.md created with structure, authentication docs, and error format</done>
</task>

<task type="auto">
  <name>Task 2: Document all API endpoints</name>
  <files>docs/API.md</files>
  <action>
Add endpoint documentation to docs/API.md for ALL 48 endpoints.

Use this format for each endpoint:
```markdown
### POST /auth/signup

Create a new member account.

**Authentication:** None

**Request Body:**
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| email | string | Yes | User email address |
| password | string | Yes | Password (min 8 chars) |

**Response (201):**
```json
{
  "member": {
    "id": "uuid",
    "email": "user@example.com"
  }
}
```

**Errors:**
- 400: Invalid email or password too short
- 409: Email already registered
```

**Organize endpoints by domain (from RESEARCH.md):**

1. **Authentication Routes (/auth/*)**
   - POST /auth/signup
   - POST /auth/login
   - POST /auth/refresh
   - POST /auth/logout
   - POST /auth/magic-link/request
   - GET /auth/magic-link/verify
   - GET /auth/discord
   - GET /auth/callback
   - GET /auth/error

2. **Checkout Routes (/checkout/*)**
   - POST /checkout

3. **Billing Routes (/billing/*)**
   - POST /billing/portal

4. **Company Routes (/company/*)**
   - POST /company/checkout

5. **Dashboard Routes (/dashboard/*)**
   - GET /dashboard

6. **Claim Routes (/claim/*)**
   - GET /claim/discord
   - GET /claim/callback

7. **Team Routes (/team/*)**
   - GET /team/dashboard
   - DELETE /team/members/:memberId
   - POST /team/seats
   - POST /team/invites
   - GET /team/invites
   - DELETE /team/invites/:inviteId
   - GET /team/claim/info
   - GET /team/claim
   - GET /team/claim/callback

8. **Admin Auth Routes (/admin/auth/*)**
   - POST /admin/auth/login
   - POST /admin/auth/refresh
   - POST /admin/auth/logout

9. **Admin API Routes (/api/admin/*)**
   - All 18 admin endpoints (members, config, audit, templates, admins)

10. **Webhook Routes (/webhooks/*)**
    - POST /webhooks/stripe

11. **Health Routes**
    - GET /health

For each endpoint, read the corresponding route file to determine:
- Request body schema (from Zod validation)
- Response format (from handler return)
- Authentication requirement (from middleware)
- Any role requirements (admin, super admin)
  </action>
  <verify>
    - grep -c "POST /auth/signup" docs/API.md returns 1
    - grep -c "POST /billing/portal" docs/API.md returns 1
    - grep -c "GET /api/admin/members" docs/API.md returns 1
    - grep -c "POST /webhooks/stripe" docs/API.md returns 1
    - wc -l docs/API.md shows at least 500 lines
  </verify>
  <done>docs/API.md contains complete documentation for all 48 API endpoints</done>
</task>

</tasks>

<verification>
- [ ] docs/API.md exists
- [ ] Authentication section documents JWT, cookies, and Stripe signature
- [ ] All 9 auth endpoints documented
- [ ] All team endpoints documented (9 endpoints)
- [ ] All admin endpoints documented (18 endpoints)
- [ ] Webhook endpoint documented
- [ ] Health endpoint documented
- [ ] Each endpoint shows auth requirement, request/response format
</verification>

<success_criteria>
- Developer can find any endpoint by browsing docs/API.md
- Developer understands authentication requirements without reading source
- Examples are copy-paste ready for testing
</success_criteria>

<output>
After completion, create `.planning/phases/21-documentation-audit/21-02-SUMMARY.md`
</output>
