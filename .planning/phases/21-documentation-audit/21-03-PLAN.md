---
phase: 21-documentation-audit
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/DEPLOYMENT.md
  - .planning/ENVIRONMENT-SETUP.md
autonomous: true

must_haves:
  truths:
    - "Developer can deploy to production following docs/DEPLOYMENT.md"
    - "All third-party service configurations are documented"
    - "Setup instructions in ENVIRONMENT-SETUP.md are verified accurate"
  artifacts:
    - path: "docs/DEPLOYMENT.md"
      provides: "Production deployment guide"
      min_lines: 200
      contains: "Production Checklist"
    - path: ".planning/ENVIRONMENT-SETUP.md"
      provides: "Local development setup (verified)"
      contains: "npm run build"
  key_links:
    - from: "docs/DEPLOYMENT.md"
      to: ".env.example"
      via: "environment configuration"
      pattern: "environment|.env"
---

<objective>
Create deployment guide and verify setup instructions accuracy

Purpose: Enable production deployment and ensure local setup works without errors
Output: docs/DEPLOYMENT.md with production guide, updated ENVIRONMENT-SETUP.md with verified steps
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-documentation-audit/21-RESEARCH.md
@.planning/ENVIRONMENT-SETUP.md
@package.json
@src/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docs/DEPLOYMENT.md</name>
  <files>docs/DEPLOYMENT.md</files>
  <action>
Create docs/DEPLOYMENT.md with comprehensive production deployment guide.

**Structure:**

## 1. Header
```markdown
# Deployment Guide

Production deployment guide for The Revenue Council Membership Gateway.

**Prerequisites:**
- Node.js 20+ runtime
- PostgreSQL database (Supabase recommended)
- Stripe account (live mode)
- Discord application with bot
- Resend account (for email)
- Domain with SSL certificate
```

## 2. Production Checklist
```markdown
## Production Checklist

Before deploying, verify:

- [ ] All environment variables set (see Section 3)
- [ ] Database migrated (`npx prisma db push`)
- [ ] Admin user seeded (`npx prisma db seed`)
- [ ] Stripe webhook endpoint configured (see Section 5)
- [ ] Discord bot invited to production guild
- [ ] Email domain verified in Resend
- [ ] CORS configured for production domain
- [ ] Rate limiting tested
```

## 3. Environment Variables
Document production-specific configuration:

- NODE_ENV=production
- APP_URL=https://yourdomain.com
- JWT_SECRET requirements (64+ chars, cryptographically random)
- Database URL (Supabase pooler connection)
- All Stripe keys (switch from sk_test_ to sk_live_)
- Discord production guild ID
- Email provider = resend with verified domain

## 4. Database Configuration
- Supabase project setup
- Connection pooling (pgbouncer)
- Pro tier recommendation for PITR backups
- Running migrations in production

## 5. Stripe Production Configuration
- Switching from test to live API keys
- Creating production webhook endpoint
- Events to subscribe:
  - checkout.session.completed
  - customer.subscription.created
  - customer.subscription.updated
  - customer.subscription.deleted
  - invoice.paid
  - invoice.payment_failed
- Testing webhook with stripe trigger

## 6. Discord Production Configuration
- OAuth redirect URI (https://yourdomain.com/auth/callback)
- Production guild setup
- Bot permissions review
- Privileged intents verification

## 7. Email Configuration
- Resend account setup
- Domain verification (DNS records)
- Sender address configuration
- Testing email delivery

## 8. Application Deployment
- Build command: `npm run build`
- Start command: `npm start`
- Health check endpoint: GET /health
- Process management options (PM2, systemd)
- Example PM2 ecosystem file

## 9. Security Checklist
- [ ] JWT_SECRET is 64+ characters
- [ ] NODE_ENV=production
- [ ] HTTPS enabled (SSL certificate)
- [ ] CORS restricts to APP_URL
- [ ] Rate limiting active on auth endpoints
- [ ] No console.log in production (use proper logging)
- [ ] Stripe webhook signature verification enabled
- [ ] httpOnly cookies for refresh tokens

## 10. Monitoring and Logging
- Health check endpoint usage
- Recommended: Sentry for error tracking
- Log aggregation suggestions
- Key events to monitor:
  - Webhook failures
  - Auth failures
  - Discord bot disconnections
  - Email delivery failures

## 11. Rollback Plan
- Database backup before deployment
- Keep previous build artifacts
- Rollback steps:
  1. Stop new deployment
  2. Restore previous build
  3. Verify health check
  4. (If schema changed) Restore database backup
  </action>
  <verify>
    - docs/DEPLOYMENT.md exists
    - grep -c "Production Checklist" docs/DEPLOYMENT.md returns 1
    - grep -c "Security Checklist" docs/DEPLOYMENT.md returns 1
    - grep -c "Stripe" docs/DEPLOYMENT.md returns at least 3
    - grep -c "Discord" docs/DEPLOYMENT.md returns at least 3
  </verify>
  <done>docs/DEPLOYMENT.md contains comprehensive production deployment guide</done>
</task>

<task type="auto">
  <name>Task 2: Verify and update ENVIRONMENT-SETUP.md</name>
  <files>.planning/ENVIRONMENT-SETUP.md</files>
  <action>
Review and update .planning/ENVIRONMENT-SETUP.md for accuracy.

**Verify and update:**

1. **Prerequisites section:**
   - Node.js 20+ (verify current)
   - Stripe CLI installation command (winget is current)

2. **Add missing npm scripts:**
   After Quick Start section, add:
   ```markdown
   ## Available Scripts

   | Script | Command | Description |
   |--------|---------|-------------|
   | dev | npm run dev | Start development server with watch mode |
   | build | npm run build | Compile TypeScript to dist/ |
   | start | npm start | Start production server |
   | lint | npm run lint | Run ESLint |
   | typecheck | npm run typecheck | Run TypeScript compiler check |
   ```

3. **Verify Quick Start commands:**
   ```bash
   npm install
   npx prisma db push
   npx prisma db seed
   stripe listen --forward-to localhost:3000/webhooks/stripe
   npm run dev
   ```
   These appear correct - no changes needed.

4. **Fix variable naming:**
   Update Section 3 Discord Setup:
   - Change `DISCORD_ADMIN_CHANNEL_ID` references to match env.ts (already correct)
   - Verify all variable names match env.ts exactly

5. **Add development workflow section:**
   After Quick Start, add:
   ```markdown
   ## Development Workflow

   For full local development with webhooks:

   **Terminal 1 - Stripe webhook forwarding:**
   ```bash
   stripe listen --forward-to localhost:3000/webhooks/stripe
   ```

   **Terminal 2 - Application:**
   ```bash
   npm run dev
   ```

   **Terminal 3 (optional) - Database GUI:**
   ```bash
   npx prisma studio
   ```
   ```

6. **Update last updated date:**
   Change to current date: 2026-01-21
  </action>
  <verify>
    - grep -c "npm run build" .planning/ENVIRONMENT-SETUP.md returns at least 1
    - grep -c "Available Scripts" .planning/ENVIRONMENT-SETUP.md returns 1
    - grep -c "Development Workflow" .planning/ENVIRONMENT-SETUP.md returns 1
    - grep -c "2026-01-21" .planning/ENVIRONMENT-SETUP.md returns 1
  </verify>
  <done>ENVIRONMENT-SETUP.md verified accurate and updated with missing sections</done>
</task>

</tasks>

<verification>
- [ ] docs/DEPLOYMENT.md exists with production checklist
- [ ] docs/DEPLOYMENT.md covers all services (Stripe, Discord, Supabase, Resend)
- [ ] docs/DEPLOYMENT.md includes security checklist
- [ ] .planning/ENVIRONMENT-SETUP.md includes Available Scripts section
- [ ] .planning/ENVIRONMENT-SETUP.md includes Development Workflow section
- [ ] All documentation dates updated to 2026-01-21
</verification>

<success_criteria>
- Developer can follow DEPLOYMENT.md to deploy to production without external research
- Developer can follow ENVIRONMENT-SETUP.md to set up local environment without errors
- Both guides cover all third-party service configurations
</success_criteria>

<output>
After completion, create `.planning/phases/21-documentation-audit/21-03-SUMMARY.md`
</output>
