---
phase: 22-operational-readiness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Application handles SIGTERM gracefully"
    - "Application handles SIGINT gracefully"
    - "In-flight requests complete before shutdown"
    - "Discord bot disconnects cleanly"
    - "Database connections close properly"
  artifacts:
    - path: "src/index.ts"
      provides: "Graceful shutdown handlers"
      contains: "process.on('SIGTERM'"
  key_links:
    - from: "process signal handlers"
      to: "server.close(), discordClient.destroy(), prisma.$disconnect()"
      via: "gracefulShutdown function"
      pattern: "gracefulShutdown"
---

<objective>
Implement graceful shutdown handling for production deployments

Purpose: Enable clean process termination during deployments, restarts, and scaling operations. PM2 and container orchestrators send SIGTERM before SIGKILL - the app must complete in-flight requests and clean up resources to prevent data corruption and connection leaks.

Output: Updated `src/index.ts` with SIGTERM/SIGINT handlers that properly close HTTP server, Discord bot, and Prisma connections in sequence with timeout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-operational-readiness/22-RESEARCH.md
@src/index.ts
@src/bot/client.ts
@src/lib/prisma.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement graceful shutdown in src/index.ts</name>
  <files>src/index.ts</files>
  <action>
Add graceful shutdown handling to src/index.ts:

1. Store the HTTP server reference from app.listen() in a variable (currently it's not captured):
   ```typescript
   const server = app.listen(env.PORT, () => { ... });
   ```

2. Create a gracefulShutdown function that:
   - Logs the signal received
   - Stops accepting new HTTP connections via server.close()
   - Waits for Discord client to be destroyed via discordClient.destroy()
   - Closes Prisma connections via prisma.$disconnect()
   - Exits with code 0 on success

3. Add a forced shutdown timeout of 10 seconds - if cleanup doesn't complete, force exit with code 1

4. Register handlers for both SIGTERM (PM2/containers) and SIGINT (Ctrl+C)

5. Prevent multiple shutdown triggers with a `isShuttingDown` flag

Required imports to add:
- Import `prisma` from './lib/prisma.js'
- Import `discordClient` from './bot/client.js' (already have startBot, need the client itself)

Key implementation notes from RESEARCH.md:
- Call server.close() FIRST to stop accepting new connections
- Use setTimeout to force exit after 10s (PM2 kill_timeout should be 15s)
- Log each step for debugging deployment issues
- The shutdown order is: HTTP -> Discord -> Prisma -> exit

Do NOT use process.exit() synchronously in the handler - let cleanup complete first.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles.
Review the shutdown handlers are properly structured with timeout.
Verify logger.info calls log signal received and each cleanup step.
  </verify>
  <done>
- SIGTERM handler registered and logs "Shutdown signal received"
- SIGINT handler registered
- server.close() called to stop new connections
- discordClient.destroy() called for Discord cleanup
- prisma.$disconnect() called for database cleanup
- 10-second forced shutdown timeout in place
- isShuttingDown flag prevents multiple triggers
- Build passes with no TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PM2 ecosystem config for graceful shutdown</name>
  <files>ecosystem.config.cjs</files>
  <action>
Create ecosystem.config.cjs (CommonJS format for PM2) at project root with production-ready settings:

```javascript
module.exports = {
  apps: [{
    name: 'trc-gateway',
    script: 'dist/index.js',
    instances: 1,
    exec_mode: 'fork',
    env_production: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    // Graceful shutdown settings
    kill_timeout: 15000,        // Wait 15s before SIGKILL (longer than app's 10s timeout)
    wait_ready: false,          // Don't wait for process.send('ready')
    listen_timeout: 10000,      // Timeout waiting for listen
    // Logging
    error_file: './logs/error.log',
    out_file: './logs/output.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    // Resource limits
    max_memory_restart: '500M',
  }]
};
```

Key settings explained:
- `kill_timeout: 15000` - Matches PM2 best practices; gives app 15s to clean up before SIGKILL
- `wait_ready: false` - App uses immediate startup, not process.send('ready')
- `max_memory_restart: '500M'` - Restart if memory exceeds 500MB (leak protection)
- `merge_logs: true` - Combine cluster logs into single files
  </action>
  <verify>
Run `pm2 start ecosystem.config.cjs --env production --no-daemon` (if PM2 installed) to verify config loads.
Otherwise, verify file exists and syntax is valid JavaScript.
  </verify>
  <done>
- ecosystem.config.cjs exists at project root
- kill_timeout is 15000 (15 seconds)
- Log files configured to ./logs/ directory
- max_memory_restart set to 500M
  </done>
</task>

</tasks>

<verification>
After completion:

1. Build verification:
   ```bash
   npm run build
   ```
   Should complete without TypeScript errors.

2. Code verification:
   - src/index.ts contains `process.on('SIGTERM'`
   - src/index.ts contains `process.on('SIGINT'`
   - gracefulShutdown function exists with server.close(), discordClient.destroy(), prisma.$disconnect()
   - 10-second timeout with forced exit

3. PM2 config verification:
   - ecosystem.config.cjs exists and is valid CommonJS
   - kill_timeout is 15000
</verification>

<success_criteria>
- SIGTERM/SIGINT handlers implemented in src/index.ts
- Shutdown sequence: HTTP server -> Discord -> Prisma -> exit
- 10-second forced shutdown timeout
- PM2 ecosystem config with 15s kill_timeout
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-operational-readiness/22-01-SUMMARY.md`
</output>
