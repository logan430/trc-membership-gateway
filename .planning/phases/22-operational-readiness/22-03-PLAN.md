---
phase: 22-operational-readiness
plan: 03
type: execute
wave: 2
depends_on:
  - "22-01"
  - "22-02"
files_modified:
  - docs/RUNBOOK.md
  - docs/DEPLOYMENT.md
autonomous: true

must_haves:
  truths:
    - "Operators can diagnose common issues using runbook"
    - "Rollback procedure is documented step-by-step"
    - "Stripe webhook recovery process is clear"
    - "Discord bot troubleshooting is documented"
  artifacts:
    - path: "docs/RUNBOOK.md"
      provides: "Incident response procedures"
      min_lines: 200
    - path: "docs/DEPLOYMENT.md"
      provides: "Enhanced rollback section"
      contains: "Pre-Deployment Checklist"
  key_links:
    - from: "docs/RUNBOOK.md"
      to: "Application components"
      via: "Troubleshooting sections"
      pattern: "Symptoms|Diagnosis|Recovery"
---

<objective>
Create incident runbook and enhance rollback documentation

Purpose: Operational knowledge is currently scattered across docs and code comments. A runbook consolidates troubleshooting procedures for common incidents (app won't start, webhook failures, Discord offline, email failing). This reduces incident response time and enables on-call rotation.

Output: Comprehensive docs/RUNBOOK.md with symptom-based troubleshooting and enhanced rollback procedures in docs/DEPLOYMENT.md.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-operational-readiness/22-RESEARCH.md
@docs/DEPLOYMENT.md
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create incident runbook</name>
  <files>docs/RUNBOOK.md</files>
  <action>
Create docs/RUNBOOK.md with comprehensive incident response procedures.

Structure the runbook with these sections:

# Incident Runbook

## Quick Reference
- Health check: GET /health
- PM2 status: pm2 status / pm2 logs trc-gateway
- Restart: pm2 restart trc-gateway

## Critical Incidents

### 1. Application Won't Start
**Symptoms:** PM2 shows error status, /health returns 503 or times out
**Diagnosis:**
1. Check PM2 logs: `pm2 logs trc-gateway --lines 100`
2. Look for: Database connection errors, missing env vars, syntax errors
3. Verify environment: `cat .env | grep -v PASSWORD`

**Common Causes & Fixes:**
- Missing DATABASE_URL: Set Supabase pooler connection string
- Invalid DISCORD_BOT_TOKEN: Regenerate in Discord Developer Portal
- Port already in use: Check for zombie processes
- TypeScript compilation failed: Run `npm run build` manually

**Recovery:**
1. Fix the identified issue
2. Rebuild if needed: `npm run build`
3. Restart: `pm2 restart trc-gateway`
4. Verify: `curl https://yourdomain.com/health`

### 2. Discord Bot Offline
**Symptoms:** Bot shows offline in server, role assignments failing
**Diagnosis:**
1. Check bot status in Discord server member list
2. Check logs for "Discord client error" or "Bot logged in"
3. Verify bot token: Discord Developer Portal > Bot > Token

**Common Causes & Fixes:**
- Bot token invalidated: Regenerate token, update env, restart
- Privileged intents disabled: Enable in Developer Portal > Bot
- Bot kicked from server: Re-invite using OAuth URL
- Rate limited: Wait for rate limit to reset (usually minutes)

**Recovery:**
1. Fix the identified issue
2. Restart application: `pm2 restart trc-gateway`
3. Verify bot appears online in Discord

### 3. Stripe Webhooks Failing
**Symptoms:** Payments succeed but members not created, Stripe Dashboard shows failed webhooks
**Diagnosis:**
1. Check Stripe Dashboard > Developers > Webhooks > Events
2. Look for: Signature verification failed, 500 errors, timeouts
3. Check app logs for webhook errors

**Common Causes & Fixes:**
- Signature verification failed: Verify STRIPE_WEBHOOK_SECRET matches endpoint
- App not running: Start app, Stripe will retry automatically
- Database error: Check connection, may need to replay events

**Recovery:**
1. Fix the underlying issue
2. Replay failed events from Stripe Dashboard:
   - Go to Developers > Webhooks > Select endpoint
   - View "Events" tab
   - Click "Resend" for each failed event (within 30 days)

### 4. Email Delivery Failing
**Symptoms:** Welcome emails not arriving, no claim reminder emails
**Diagnosis:**
1. Check Resend Dashboard for delivery status
2. Look for: Bounces, API errors, domain issues
3. Check app logs for email errors

**Common Causes & Fixes:**
- Invalid API key: Regenerate in Resend, update env
- Domain not verified: Complete DNS verification in Resend
- Rate limited: Check Resend quota
- Emails going to spam: Check SPF/DKIM records

**Recovery:**
1. Fix the identified issue
2. Resend dashboard shows recent sends - verify delivery
3. Welcome emails auto-send; claim reminders run on scheduler

### 5. Database Connection Issues
**Symptoms:** All requests fail with database errors
**Diagnosis:**
1. Check logs for Prisma connection errors
2. Verify Supabase project is not paused (free tier issue)
3. Test connection: `npx prisma db pull` (if you have local env)

**Common Causes & Fixes:**
- Supabase project paused: Unpause in Supabase Dashboard
- Connection string wrong: Use Pooler URL, not Direct
- Connection pool exhausted: Restart app to reset pool
- Network issues: Check Supabase status page

**Recovery:**
1. Fix the underlying issue
2. Restart application to reset connection pool
3. Verify with health check

## Degraded Service Scenarios

### 6. Reconciliation Job Not Running
**Symptoms:** Role mismatches not auto-fixed, no reconciliation logs
**Diagnosis:**
1. Check logs for "Starting reconciliation" at configured hour
2. Check RECONCILIATION_PAUSED env var
3. Verify scheduler is running (starts with bot)

**Recovery:**
1. Ensure RECONCILIATION_PAUSED=false
2. Restart app to restart scheduler
3. Manual run: Trigger via code if urgent (no CLI exposed)

### 7. High Memory Usage
**Symptoms:** PM2 shows high memory, app becomes slow
**Diagnosis:**
1. Check PM2 status: `pm2 monit`
2. Look for memory trends over time
3. Check for restart loops (memory leak indicator)

**Recovery:**
1. Restart application: `pm2 restart trc-gateway`
2. If recurring: Investigate memory leak, check recent changes
3. PM2 max_memory_restart (500M) should auto-restart

## Recovery Procedures

### Rollback Deployment
See docs/DEPLOYMENT.md Section 9 for detailed rollback steps.

Quick rollback (no schema changes):
```bash
pm2 stop trc-gateway
git checkout v1.0.X  # Previous known-good tag
npm install && npm run build
pm2 start trc-gateway
curl https://yourdomain.com/health
```

### Replay Stripe Events
When webhooks were missed during outage:
1. Stripe Dashboard > Developers > Webhooks
2. Select your endpoint
3. Go to "Events" tab
4. Filter by date range of outage
5. Click "Resend" for each event
6. Verify in app logs that events processed

### Database Restore (Emergency)
Only if data corruption occurred:
1. Stop application
2. Supabase Dashboard > Database > Backups
3. Point-in-Time Recovery > Select timestamp BEFORE issue
4. Wait for restore (creates new project or restores)
5. Update DATABASE_URL if project changed
6. Restart application

## Contacts and Escalation

### External Service Status Pages
- Supabase: status.supabase.com
- Stripe: status.stripe.com
- Discord: discordstatus.com
- Resend: status.resend.com

### When to Escalate
- Data corruption suspected: STOP writes, assess damage
- Security breach suspected: Rotate all secrets, investigate
- Extended outage (>30 min): Consider status page update

---

*Last updated: 2026-01-21*
  </action>
  <verify>
Check docs/RUNBOOK.md exists and has all 7 incident scenarios.
Verify each scenario has Symptoms, Diagnosis, Recovery sections.
  </verify>
  <done>
- docs/RUNBOOK.md created with 250+ lines
- 7 incident scenarios documented
- Each has Symptoms, Diagnosis, Common Causes, Recovery
- Rollback and Stripe replay procedures included
- External service status pages listed
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance rollback documentation in DEPLOYMENT.md</name>
  <files>docs/DEPLOYMENT.md</files>
  <action>
Update docs/DEPLOYMENT.md Section 9 (Rollback Plan) with comprehensive pre-deployment checklist and enhanced procedures.

Find the existing "## 9. Rollback Plan" section and replace/enhance it with:

```markdown
## 9. Rollback Plan

### Pre-Deployment Checklist

Before EVERY deployment, complete this checklist:

- [ ] **Tag current release**: `git tag v1.X.Y` (use semantic versioning)
- [ ] **Note current commit**: `git rev-parse HEAD` (save this hash)
- [ ] **Backup dist folder**: `cp -r dist dist.backup`
- [ ] **Note Supabase backup time**: Dashboard > Database > Backups (timestamp)
- [ ] **Check pending Stripe webhooks**: Dashboard > Developers > Webhooks (any pending?)
- [ ] **Verify health check works**: `curl https://yourdomain.com/health`

### Immediate Rollback (No Schema Changes)

Use when: New code has bugs but database schema unchanged.
Time: ~2 minutes

```bash
# 1. Stop current deployment
pm2 stop trc-gateway

# 2. Restore previous code
git checkout v1.X.Y  # Replace with your previous tag
npm install
npm run build

# 3. Start and verify
pm2 start trc-gateway
curl https://yourdomain.com/health
```

### Full Rollback (With Schema Changes)

Use when: Database migration caused issues.
Time: 5-15 minutes (depends on database size)

```bash
# 1. Stop application immediately
pm2 stop trc-gateway

# 2. Restore code
git checkout v1.X.Y
npm install
npm run build

# 3. Restore database (Supabase PITR)
# Dashboard > Database > Backups > Point in Time Recovery
# Select timestamp BEFORE deployment
# Wait for restore to complete

# 4. Push previous schema (if PITR not available)
npx prisma db push

# 5. Start and verify
pm2 start trc-gateway
curl https://yourdomain.com/health
```

### Post-Rollback Recovery

After rolling back:

1. **Replay Stripe webhooks** (if any occurred during outage):
   - Stripe Dashboard > Developers > Webhooks > Events
   - Resend events from outage window

2. **Check reconciliation** (next scheduled run or manual):
   - Verify Stripe/Discord/Database are in sync

3. **Notify affected users** (if applicable):
   - Payment issues: Check for failed webhooks
   - Access issues: Run manual role sync

### Zero-Downtime Deployment (Advanced)

For deployments that cannot have downtime:

1. Build new version on same server
2. Start on different port (e.g., 3001)
3. Verify health check: `curl http://localhost:3001/health`
4. Update load balancer/reverse proxy to new port
5. Stop old instance after traffic drains

Note: Requires load balancer or reverse proxy (nginx, Caddy).
```

Also update the deployment commands quick reference if it exists.
  </action>
  <verify>
Check docs/DEPLOYMENT.md Section 9 has Pre-Deployment Checklist.
Verify both Immediate and Full rollback procedures exist.
Check Post-Rollback Recovery section added.
  </verify>
  <done>
- Pre-deployment checklist added with 6 items
- Immediate rollback (no schema) procedure documented
- Full rollback (with schema) procedure documented
- Post-rollback recovery steps added
- Zero-downtime deployment option documented
  </done>
</task>

</tasks>

<verification>
After completion:

1. Runbook completeness:
   ```bash
   wc -l docs/RUNBOOK.md  # Should be 200+ lines
   ```
   - Contains: Application won't start, Discord offline, Webhooks failing, Email failing, Database issues
   - Each scenario has Symptoms, Diagnosis, Recovery

2. DEPLOYMENT.md enhancements:
   - Section 9 has "Pre-Deployment Checklist"
   - Immediate rollback procedure exists
   - Full rollback with PITR procedure exists
   - Post-rollback recovery section exists

3. Cross-reference:
   - RUNBOOK.md references DEPLOYMENT.md for rollback
   - Both documents are internally consistent
</verification>

<success_criteria>
- docs/RUNBOOK.md created with 7 incident scenarios
- Each scenario has symptom-based troubleshooting
- docs/DEPLOYMENT.md Section 9 enhanced with pre-deployment checklist
- Rollback procedures cover both code-only and schema changes
- Stripe webhook replay procedure documented
- Database restore procedure documented
</success_criteria>

<output>
After completion, create `.planning/phases/22-operational-readiness/22-03-SUMMARY.md`
</output>
