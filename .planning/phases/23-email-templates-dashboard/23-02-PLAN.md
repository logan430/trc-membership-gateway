---
phase: 23-email-templates-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - public/admin/templates.html
  - public/admin/template-edit.html
autonomous: true

must_haves:
  truths:
    - "Admin can see templates grouped by category (Welcome, Billing, Team, Reminders)"
    - "Admin can click variable chips to insert variables at cursor position"
    - "Admin sees warning when saving template with unknown variables"
    - "Admin can access dedicated edit page at /app/admin/templates/:name"
    - "Admin can reset template to default from edit page"
    - "Preview shows current form values (not just saved database values)"
  artifacts:
    - path: "public/admin/templates.html"
      provides: "Category-grouped template list with enhanced UX"
      contains: "<details"
    - path: "public/admin/template-edit.html"
      provides: "Dedicated full-page template editor"
      contains: "template-edit"
  key_links:
    - from: "public/admin/templates.html"
      to: "/app/admin/templates/:name"
      via: "navigation link"
      pattern: "href=.*templates/"
    - from: "public/admin/template-edit.html"
      to: "/api/admin/templates/:name"
      via: "fetch API calls"
      pattern: "fetch.*api/admin/templates"
    - from: "public/admin/template-edit.html"
      to: "/api/admin/templates/:name/reset"
      via: "reset button fetch"
      pattern: "fetch.*reset"
---

<objective>
Enhance the admin email templates UI with category grouping, click-to-insert variable chips, and a dedicated edit page.

Purpose: Implement the UX decisions from CONTEXT.md - admins need intuitive tools to manage email templates without needing to remember variable syntax or navigate a flat list.

Output: Enhanced templates list page with categories and new dedicated edit page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-email-templates-dashboard/23-CONTEXT.md
@.planning/phases/23-email-templates-dashboard/23-RESEARCH.md

# Prior plan summary for reset endpoint
@.planning/phases/23-email-templates-dashboard/23-01-SUMMARY.md

# Existing UI patterns
@public/admin/templates.html
@public/admin/member-detail.html
@public/admin/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance templates list page with categories and navigation</name>
  <files>public/admin/templates.html</files>
  <action>
Rewrite `public/admin/templates.html` with these enhancements:

**1. Category Grouping Structure**

Replace the flat `<ul>` list with category sections using native HTML5 `<details>/<summary>`:

```html
<div class="template-categories" id="template-categories">
  <!-- Categories will be rendered by JS -->
</div>
```

Define category mapping in JS:
```javascript
const TEMPLATE_CATEGORIES = {
  'Welcome': ['welcome'],
  'Billing': ['payment_failure', 'payment_recovered', 'payment_recovered_debtor'],
  'Team': ['seat_invite'],
  'Reminders': ['claim_reminder', 'claim_reminder_cheeky', 'reconciliation_report'],
};
```

Render each category as:
```html
<details class="template-category" open>
  <summary class="category-header">
    <span class="category-name">Welcome</span>
    <span class="category-count">(1 template)</span>
  </summary>
  <ul class="category-templates">
    <li class="template-item" onclick="navigateToEdit('welcome')">
      <span class="template-name">welcome</span>
      <span class="template-description">Welcome email after payment</span>
      <span class="template-updated">Updated: Jan 21, 2026</span>
    </li>
  </ul>
</details>
```

**2. Template Descriptions**

Add a mapping for human-readable descriptions:
```javascript
const TEMPLATE_DESCRIPTIONS = {
  welcome: 'Welcome email sent after successful payment',
  claim_reminder: 'Reminder to claim Discord access (standard)',
  claim_reminder_cheeky: 'Reminder to claim Discord access (30+ days)',
  payment_failure: 'Payment failure notification with grace period',
  payment_recovered: 'Payment recovered during grace period',
  payment_recovered_debtor: 'Payment recovered after Debtor state',
  seat_invite: 'Team seat invitation email',
  reconciliation_report: 'Admin reconciliation report',
};
```

**3. Navigation to Edit Page**

Replace inline editing with navigation:
```javascript
function navigateToEdit(templateName) {
  window.location.href = `/app/admin/templates/${templateName}`;
}
```

**4. Remove Inline Editor**

Remove the entire "Template Editor" and "Template Preview" divs. The list page now only shows the categorized list. Editing happens on the dedicated edit page.

**5. Simplified Layout**

Keep:
- Admin header with logout
- Admin nav with Templates active
- Seed button (super admin only, shown if templates empty)
- Loading state
- Category list

Remove:
- Editor panel
- Preview panel
- All inline editing JS (selectTemplate, saveTemplate, previewTemplate)

**6. CSS for Categories**

Add inline styles or add to existing CSS patterns:
```css
.template-category {
  margin-bottom: 1rem;
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: 8px;
}

.category-header {
  padding: 1rem;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: var(--font-heading);
  color: var(--gold);
}

.category-templates {
  list-style: none;
  padding: 0;
  margin: 0;
}

.template-item {
  padding: 1rem;
  border-top: 1px solid var(--border-subtle);
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.template-item:hover {
  background: var(--bg-hover);
}

.template-name {
  font-weight: 600;
  color: var(--cream);
}

.template-description {
  color: var(--text-muted);
  font-size: 0.9rem;
}

.template-updated {
  color: var(--text-muted);
  font-size: 0.85rem;
}
```

**7. Fetch and Render Logic**

Update loadTemplates() to:
1. Fetch all templates from `/api/admin/templates`
2. Group by category
3. Render category sections
4. Handle empty categories (don't show them)
  </action>
  <verify>
Page loads at `/app/admin/templates`
Templates are grouped under category headers
Clicking a template navigates to `/app/admin/templates/:name`
Seed button works for super admin
  </verify>
  <done>
Templates list page shows category-grouped templates with navigation to edit pages
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dedicated template edit page</name>
  <files>public/admin/template-edit.html</files>
  <action>
Create new file `public/admin/template-edit.html` following the pattern from `member-detail.html`:

**1. Page Structure**

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Template - The Revenue Council</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/admin/styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Admin header -->
  <!-- Admin nav with Templates active -->

  <main class="admin-container">
    <a href="/app/admin/templates" class="back-link">&larr; Back to Templates</a>

    <div id="loading">...</div>
    <div id="error-state" style="display: none;">...</div>

    <div id="template-content" style="display: none;">
      <h2 id="template-title">Template Name</h2>
      <p id="template-description" class="text-muted">Description</p>

      <!-- Editor Card -->
      <div class="detail-card">
        <h3>Edit Template</h3>

        <div class="form-group">
          <label for="template-subject">Subject</label>
          <input type="text" id="template-subject" placeholder="Email subject line">
        </div>

        <div class="form-group">
          <label for="template-body">Body</label>
          <div class="variable-chips" id="variable-chips">
            <!-- Click-to-insert variable buttons -->
          </div>
          <textarea id="template-body" rows="15" placeholder="Email body content..."></textarea>
        </div>

        <div id="validation-warning" class="warning-message" style="display: none;">
          Unknown variables detected: <span id="unknown-vars"></span>
        </div>

        <div class="button-group">
          <button class="btn-primary" onclick="saveTemplate()">Save Template</button>
          <button class="btn-secondary" onclick="previewTemplate()">Preview</button>
          <button class="btn-danger" onclick="resetTemplate()">Reset to Default</button>
        </div>
      </div>

      <!-- Preview Card -->
      <div class="detail-card" id="preview-card" style="display: none;">
        <h3>Preview</h3>
        <div class="preview-section">
          <strong>Subject:</strong>
          <span id="preview-subject"></span>
        </div>
        <div class="preview-section">
          <strong>Body:</strong>
          <pre id="preview-body" class="template-preview-content"></pre>
        </div>
      </div>
    </div>
  </main>

  <footer>...</footer>
</body>
</html>
```

**2. Variable Chips Implementation**

Load available variables from `/api/admin/templates/:name/variables` and render as clickable chips:

```javascript
async function loadVariables(templateName) {
  const response = await fetch(`/api/admin/templates/${templateName}/variables`, {
    headers: { 'Authorization': `Bearer ${getAdminToken()}` }
  });
  const { variables } = await response.json();

  const container = document.getElementById('variable-chips');
  container.innerHTML = variables.map(v =>
    `<button type="button" class="variable-chip" onclick="insertVariable('${v}')">\{\{${v}\}\}</button>`
  ).join('');
}

function insertVariable(varName) {
  const textarea = document.getElementById('template-body');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = `\{\{${varName}\}\}`;
  textarea.setRangeText(text, start, end, 'end');
  textarea.focus();
}
```

**3. CSS for Variable Chips**

```css
.variable-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.variable-chip {
  background: var(--bg-dark);
  border: 1px solid var(--gold);
  color: var(--gold);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  cursor: pointer;
  font-family: monospace;
  font-size: 0.85rem;
}

.variable-chip:hover {
  background: var(--gold);
  color: var(--bg-dark);
}

.warning-message {
  background: rgba(255, 193, 7, 0.1);
  border: 1px solid #ffc107;
  color: #ffc107;
  padding: 0.75rem;
  border-radius: 4px;
  margin-bottom: 1rem;
}
```

**4. Preview with Form Values**

Preview should use current form values, not fetch from database:

```javascript
function previewTemplate() {
  const subject = document.getElementById('template-subject').value;
  const body = document.getElementById('template-body').value;

  // Get sample data for this template
  const sampleData = SAMPLE_DATA[currentTemplateName] || {};

  // Substitute variables locally
  let previewSubject = subject;
  let previewBody = body;

  for (const [key, value] of Object.entries(sampleData)) {
    const regex = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
    previewSubject = previewSubject.replace(regex, value);
    previewBody = previewBody.replace(regex, value);
  }

  document.getElementById('preview-subject').textContent = previewSubject;
  document.getElementById('preview-body').textContent = previewBody;
  document.getElementById('preview-card').style.display = 'block';
}
```

Include SAMPLE_DATA in the page (copy from routes/admin/templates.ts).

**5. Save with Validation Warning**

```javascript
async function saveTemplate() {
  const subject = document.getElementById('template-subject').value;
  const body = document.getElementById('template-body').value;

  const response = await fetch(`/api/admin/templates/${currentTemplateName}`, {
    method: 'PUT',
    headers: {
      'Authorization': `Bearer ${getAdminToken()}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ subject, body }),
  });

  const data = await response.json();

  if (data.warning) {
    document.getElementById('unknown-vars').textContent = data.warning;
    document.getElementById('validation-warning').style.display = 'block';
  } else {
    document.getElementById('validation-warning').style.display = 'none';
  }

  if (data.success) {
    alert('Template saved successfully.');
  }
}
```

**6. Reset to Default**

```javascript
async function resetTemplate() {
  if (!confirm('Reset this template to its default content? This cannot be undone.')) {
    return;
  }

  const response = await fetch(`/api/admin/templates/${currentTemplateName}/reset`, {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${getAdminToken()}` },
  });

  if (!response.ok) {
    const data = await response.json();
    alert(`Error: ${data.error || 'Reset failed'}`);
    return;
  }

  alert('Template reset to default.');
  loadTemplate(); // Reload to show default values
}
```

**7. Route Registration**

The page is served as static HTML. Add route in Express to serve it:
- File location: `public/admin/template-edit.html`
- Route: `/app/admin/templates/:name` should serve this file

Check how member-detail.html is routed and follow the same pattern. The page reads the template name from `window.location.pathname`.

**8. Extract Template Name from URL**

```javascript
function getTemplateNameFromUrl() {
  const path = window.location.pathname;
  const match = path.match(/\/app\/admin\/templates\/([^/]+)/);
  return match ? match[1] : null;
}

document.addEventListener('DOMContentLoaded', () => {
  currentTemplateName = getTemplateNameFromUrl();
  if (!currentTemplateName) {
    showError('No template specified');
    return;
  }
  loadTemplate();
  loadVariables(currentTemplateName);
});
```
  </action>
  <verify>
Page loads at `/app/admin/templates/welcome`
Template name extracted from URL
Subject and body fields populated
Variable chips render and insert on click
Preview shows form values with substituted variables
Save works and shows validation warning if unknown variables
Reset button restores default content
  </verify>
  <done>
Dedicated template edit page exists with variable chips, preview, and reset functionality
  </done>
</task>

<task type="auto">
  <name>Task 3: Add route for template edit page</name>
  <files>src/index.ts</files>
  <action>
Add Express route to serve the template edit page. Look at how `/app/admin/members/:id` serves `member-detail.html` and follow the same pattern.

Find the section with admin page routes (likely near other `/app/admin/*` routes) and add:

```typescript
// Template edit page - must be before the static file catch-all
app.get('/app/admin/templates/:name', (req, res) => {
  res.sendFile('admin/template-edit.html', { root: 'public' });
});
```

This should be placed:
1. After authentication middleware check for admin pages (if any)
2. Before any catch-all static file serving
3. Near other `/app/admin/*` routes for consistency

The `:name` parameter is extracted client-side from the URL path, not passed to the template.
  </action>
  <verify>
Visiting `/app/admin/templates/welcome` serves template-edit.html (not 404)
Visiting `/app/admin/templates` serves templates.html (list page)
Both pages load correctly
  </verify>
  <done>
Template edit page route is registered and serves the correct HTML file
  </done>
</task>

</tasks>

<verification>
After all tasks:

1. **List page** at `/app/admin/templates`:
   - Shows categories: Welcome, Billing, Team, Reminders
   - Each category expandable/collapsible
   - Clicking template navigates to edit page

2. **Edit page** at `/app/admin/templates/:name`:
   - Shows template name and description
   - Subject and body fields populated
   - Variable chips listed above body textarea
   - Clicking chip inserts variable at cursor
   - Preview shows current form values with sample data substituted
   - Save shows success and validation warning if needed
   - Reset restores default content

3. **Navigation flow**:
   - List -> click template -> edit page
   - Edit page -> back link -> list page
   - Admin nav -> Templates -> list page
</verification>

<success_criteria>
- Templates grouped by category (Welcome, Billing, Team, Reminders)
- Click-to-insert variable chips work
- Preview shows current form values (not database values)
- Save shows warning for unknown variables
- Reset to default button works
- Dedicated edit page at `/app/admin/templates/:name`
- Navigation between list and edit pages works
</success_criteria>

<output>
After completion, create `.planning/phases/23-email-templates-dashboard/23-02-SUMMARY.md`
</output>
