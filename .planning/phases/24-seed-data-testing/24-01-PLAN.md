---
phase: 24-seed-data-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/seed.ts
autonomous: true

must_haves:
  truths:
    - "Running npx prisma db seed creates test data without errors"
    - "Test individuals exist with active, past_due, cancelled, unclaimed states"
    - "Test teams exist with mix of claimed, pending, and revoked members"
    - "Test admins exist for both SUPER_ADMIN and ADMIN roles"
    - "Running seed twice produces same result (idempotent wipe-and-recreate)"
    - "Non-test admins are preserved when seed runs"
  artifacts:
    - path: "prisma/seed.ts"
      provides: "Comprehensive seed script with cleanup and data generation"
      min_lines: 200
      exports: []
  key_links:
    - from: "prisma/seed.ts"
      to: "src/lib/password.ts"
      via: "hashPassword import"
      pattern: "import.*hashPassword.*from.*password"
    - from: "prisma/seed.ts"
      to: "src/lib/invite-tokens.ts"
      via: "generateInviteToken import"
      pattern: "import.*generateInviteToken.*from.*invite-tokens"
---

<objective>
Create comprehensive seed data for testing all application flows

Purpose: Enable development and QA testing of the admin dashboard, member management, team features, billing states, and email reminders without requiring real Stripe integration or manual data setup.

Output: A complete prisma/seed.ts that creates realistic test data covering all subscription states, team configurations, and edge cases.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-seed-data-testing/24-CONTEXT.md
@.planning/phases/24-seed-data-testing/24-RESEARCH.md

@prisma/schema.prisma
@prisma/seed.ts
@src/lib/password.ts
@src/lib/invite-tokens.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive seed script</name>
  <files>prisma/seed.ts</files>
  <action>
Replace the existing seed.ts with a comprehensive version that:

**1. Database Connection (keep existing pattern):**
- PrismaClient with PrismaPg adapter
- pg.Pool with DATABASE_URL
- Import hashPassword from '../src/lib/password.js'
- Import generateInviteToken from '../src/lib/invite-tokens.js'
- 'dotenv/config' for env vars

**2. Configuration Constants:**
```typescript
const TEST_EMAIL_DOMAIN = '@test.example.com';
const TEST_TEAM_PREFIX = 'test_';
const TEST_PASSWORD = 'TestPassword123!'; // All test accounts use same password
```

**3. Cleanup Function (cleanupTestData):**
Delete in dependency order to avoid FK violations:
1. PendingInvites where inviteeEmail contains @test.example.com OR team.stripeCustomerId starts with test_
2. Members where email contains @test.example.com
3. Teams where stripeCustomerId starts with test_
4. Admins where email contains @test.example.com (preserves non-test admins)

Log counts for each deletion.

**4. Test Admin Seeding (seedTestAdmins):**
Create two test admins with hashed passwords:
- admin@test.example.com - SUPER_ADMIN
- support@test.example.com - ADMIN

**5. Individual Member Seeding (seedIndividualMembers):**
Create members covering all states per CONTEXT.md:

| Email Pattern | Status | SeatTier | Intro | Discord | Notes |
|---------------|--------|----------|-------|---------|-------|
| test-active-ind-1 through 5 | ACTIVE | INDIVIDUAL | true | fake ID | Standard Lord |
| test-active-squire-1, 2 | ACTIVE | INDIVIDUAL | false | fake ID | Unclaimed (Squire) |
| test-unclaimed-1, 2 | ACTIVE | INDIVIDUAL | false | null | No Discord linked |
| test-grace-1, 2 | PAST_DUE | INDIVIDUAL | true | fake ID | In 48h grace period |
| test-debtor-1, 2 | PAST_DUE | INDIVIDUAL | true | fake ID | Past grace, in debtor state |
| test-cancelled-1, 2 | CANCELLED | INDIVIDUAL | true | null | Subscription ended |
| test-remind-48h | ACTIVE | INDIVIDUAL | false | null | Created 2 days ago |
| test-remind-7d | ACTIVE | INDIVIDUAL | false | null | Created 7 days ago |
| test-remind-30d | ACTIVE | INDIVIDUAL | false | null | Created 30 days ago |

For grace period members:
- paymentFailedAt: 24 hours ago
- gracePeriodEndsAt: 24 hours from now
- previousRole: 'Lord'

For debtor members:
- paymentFailedAt: 7 days ago
- gracePeriodEndsAt: 5 days ago
- isInDebtorState: true
- debtorStateEndsAt: 23 days from now
- previousRole: 'Lord'

For reminder members: Vary createdAt to match timing (use Prisma raw or update after create)

**6. Team Seeding (seedTeamsWithMembers):**

**Team 1: Acme Corp (Healthy)**
- stripeCustomerId: test_acme_corp
- subscriptionStatus: ACTIVE
- ownerSeatCount: 2, teamSeatCount: 3
- Members:
  - test-acme-owner@test.example.com - OWNER, isPrimaryOwner, isTeamAdmin, introduced
  - test-acme-owner2@test.example.com - OWNER, introduced
  - test-acme-member1@test.example.com - TEAM_MEMBER, introduced
  - test-acme-member2@test.example.com - TEAM_MEMBER, introduced
  - test-acme-squire@test.example.com - TEAM_MEMBER, NOT introduced (Squire)
- Pending invites:
  - TEAM_MEMBER tier, test-acme-pending@test.example.com

**Team 2: Beta Inc (Billing Failure)**
- stripeCustomerId: test_beta_inc
- subscriptionStatus: PAST_DUE
- ownerSeatCount: 1, teamSeatCount: 2
- paymentFailedAt: 3 days ago
- gracePeriodEndsAt: 1 day ago (debtor state)
- debtorStateEndsAt: 27 days from now
- Members (all isInDebtorState: true):
  - test-beta-owner@test.example.com - OWNER, isPrimaryOwner, isTeamAdmin, introduced
  - test-beta-member1@test.example.com - TEAM_MEMBER, introduced
  - test-beta-member2@test.example.com - TEAM_MEMBER, introduced

**Team 3: Gamma LLC (New Team)**
- stripeCustomerId: test_gamma_llc
- subscriptionStatus: ACTIVE
- ownerSeatCount: 1, teamSeatCount: 2
- Members:
  - test-gamma-owner@test.example.com - OWNER, isPrimaryOwner, isTeamAdmin, NOT introduced
- Pending invites:
  - OWNER tier, test-gamma-owner2@test.example.com
  - TEAM_MEMBER tier, test-gamma-member@test.example.com

**7. Main Function:**
- Run cleanup first
- Seed test admins
- Seed individual members
- Seed teams with members and invites
- Log summary counts
- Call pool.end() in finally block to prevent hanging

**Fake Discord IDs:** Use pattern `test_discord_XXXXX` where XXXXX is random 5 digits. These are placeholders that won't match real Discord users.

**currentPeriodEnd:** For ACTIVE and PAST_DUE, set to 30 days from now.
  </action>
  <verify>
Run `npx prisma db seed` and verify:
1. No errors during execution
2. Console shows cleanup counts and creation counts
3. Script exits cleanly (no hanging)
  </verify>
  <done>
Seed script creates complete test dataset covering all subscription states, team configurations, and edge cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify seed data in database</name>
  <files></files>
  <action>
After running seed, verify data was created correctly by running database queries:

1. Count test members: Should be ~25 members with @test.example.com emails
2. Count test teams: Should be 3 teams with test_ prefix stripeCustomerId
3. Count test admins: Should be 2 admins with @test.example.com emails
4. Count pending invites: Should be 3-4 invites linked to test teams
5. Verify idempotency: Run seed again and confirm same counts (wipe-and-recreate)

Use prisma studio or direct queries to verify.
  </action>
  <verify>
Run `npx prisma studio` and inspect:
- Member table has test members with various states
- Team table has 3 test teams
- Admin table has test admins without losing non-test admins
- PendingInvite table has test invites
  </verify>
  <done>
Database contains comprehensive test data and running seed twice produces consistent results.
  </done>
</task>

</tasks>

<verification>
1. `npx prisma db seed` runs without errors
2. Test data covers all subscription states (ACTIVE, PAST_DUE, CANCELLED, NONE)
3. Test teams have mix of member states (claimed, pending, introduced, unintroduced)
4. Test admins created for both roles
5. Running seed twice produces same result
6. Non-test admin accounts preserved
</verification>

<success_criteria>
- Seed script creates 20+ test members across all subscription states
- Seed script creates 3 test teams with varied configurations
- Seed script creates 2 test admin accounts
- Script is idempotent (wipe-and-recreate pattern)
- Script preserves non-test admin accounts
- Script exits cleanly without hanging
</success_criteria>

<output>
After completion, create `.planning/phases/24-seed-data-testing/24-01-SUMMARY.md`
</output>
