# 25-01: Backend Account and Billing Endpoints

---
phase: 25-member-self-service-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/auth.ts
  - src/routes/billing.ts
  - src/routes/dashboard.ts
autonomous: true

must_haves:
  truths:
    - "POST /auth/update-email changes email in DB and Stripe"
    - "POST /auth/update-password changes password after verification"
    - "GET /billing/details returns payment method, invoices, subscription info"
    - "GET /dashboard returns activity timeline with member events"
    - "Team members get managedBy response from billing details"
  artifacts:
    - path: "src/routes/auth.ts"
      provides: "update-email and update-password endpoints"
      exports: ["authRouter"]
    - path: "src/routes/billing.ts"
      provides: "billing details endpoint"
      exports: ["billingRouter"]
    - path: "src/routes/dashboard.ts"
      provides: "activity timeline in response"
      exports: ["dashboardRouter"]
  key_links:
    - from: "src/routes/auth.ts"
      to: "prisma.member"
      via: "update queries"
      pattern: "prisma\\.member\\.update"
    - from: "src/routes/billing.ts"
      to: "stripe.customers"
      via: "Stripe API"
      pattern: "stripe\\.customers\\.retrieve"
---

<objective>
Create backend API endpoints for account management (email/password changes) and billing details retrieval.

Purpose: Enable the self-service dashboard frontend to allow users to manage their account settings and view billing information without navigating to Stripe's portal for basic info.

Output:
- POST /auth/update-email endpoint
- POST /auth/update-password endpoint
- GET /billing/details endpoint
- Extended GET /dashboard with activity timeline
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-member-self-service-dashboard/25-RESEARCH.md

Key existing patterns:
- auth.ts uses Zod validation, requireAuth middleware exists in middleware/session.ts
- billing.ts already has /portal endpoint pattern
- Password hashing via lib/password.ts (hashPassword, verifyPassword)
- Stripe customer update via stripe.customers.update()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add account update endpoints to auth.ts</name>
  <files>src/routes/auth.ts</files>
  <action>
Add two new endpoints to the existing authRouter:

1. POST /auth/update-email
   - Import requireAuth, AuthenticatedRequest from '../middleware/session.js'
   - Zod schema: { newEmail: z.string().email(), currentPassword: z.string().min(1) }
   - Verify current password using verifyPassword before allowing change
   - Check new email not already in use (exclude current member)
   - Update Stripe customer email FIRST (if stripeCustomerId exists): stripe.customers.update(member.stripeCustomerId, { email: newEmail })
   - Then update database: prisma.member.update({ where: { id: req.memberId }, data: { email: newEmail } })
   - Return { success: true, email: newEmail }
   - Error cases: 400 (validation), 401 (wrong password), 409 (email in use)

2. POST /auth/update-password
   - Zod schema: { currentPassword: z.string().min(1), newPassword: z.string().min(8).max(128) }
   - Verify current password before allowing change
   - Hash new password with hashPassword()
   - Update database: prisma.member.update with new passwordHash
   - Return { success: true }
   - Error cases: 400 (validation), 401 (wrong password), 404 (no password set - magic link users)

Both endpoints require requireAuth middleware.
  </action>
  <verify>
Add to existing test or manually verify:
- `curl -X POST /auth/update-email` with valid token returns 200 or appropriate error
- `curl -X POST /auth/update-password` with valid token returns 200 or appropriate error
  </verify>
  <done>
Both /auth/update-email and /auth/update-password endpoints exist and handle all error cases correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add billing details endpoint to billing.ts</name>
  <files>src/routes/billing.ts</files>
  <action>
Add GET /billing/details endpoint to existing billingRouter:

1. Use requireAuth middleware
2. Fetch member with team included: prisma.member.findUnique({ where: { id: req.memberId }, include: { team: true } })

3. Handle team members (seatTier === 'TEAM_MEMBER'):
   - Return { managedBy: 'team', teamName: member.team?.name, canManageBilling: false }

4. For owners/individuals, determine stripeCustomerId:
   - If member.teamId and member.team: use member.team.stripeCustomerId
   - Else: use member.stripeCustomerId

5. If no stripeCustomerId: return { subscription: null, paymentMethod: null, invoices: [], canManageBilling: false }

6. Retrieve Stripe data:
   - const customer = await stripe.customers.retrieve(stripeCustomerId, { expand: ['invoice_settings.default_payment_method'] })
   - const subscriptions = await stripe.subscriptions.list({ customer: stripeCustomerId, limit: 1, status: 'all', expand: ['data.items.data.price'] })
   - const invoicesResponse = await stripe.invoices.list({ customer: stripeCustomerId, limit: 10 })

7. Extract payment method from customer.invoice_settings?.default_payment_method:
   - If exists and has card: { brand, last4, expMonth: exp_month, expYear: exp_year }
   - Else: null

8. Return JSON:
   {
     subscription: { status, currentPeriodEnd, cancelAtPeriodEnd, planName } or null,
     paymentMethod: { brand, last4, expMonth, expYear } or null,
     invoices: [{ id, date, amount (divide by 100), status, pdfUrl, hostedUrl }],
     canManageBilling: true
   }

Handle Stripe API errors with try/catch and 500 response.
  </action>
  <verify>
`curl -X GET /billing/details -H "Authorization: Bearer $TOKEN"` returns billing info or appropriate response for team members.
  </verify>
  <done>
GET /billing/details endpoint returns payment method (last 4 digits), subscription info, and invoice history for individuals/owners, and "managed by team" response for team members.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend dashboard endpoint with activity timeline and team info</name>
  <files>src/routes/dashboard.ts</files>
  <action>
Extend the existing GET /dashboard endpoint:

1. Update the prisma select to include additional fields:
   - Add: createdAt, introCompletedAt, updatedAt, teamId
   - Include team: { select: { id: true, name: true } }

2. Build activity timeline array from member fields:
   - Push { type: 'joined', date: member.createdAt, description: 'Account created' }
   - If subscriptionStatus is ACTIVE or PAST_DUE: push { type: 'subscribed', date: member.createdAt, description: 'Subscription activated' }
   - If discordId exists: push { type: 'discord_claimed', date: member.updatedAt, description: 'Discord linked: ' + discordUsername }
   - If introCompletedAt: push { type: 'introduced', date: member.introCompletedAt, description: 'Introduction posted' }
   - Sort timeline by date descending: timeline.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())

3. Add team info to response:
   - team: member.team ? { id: member.team.id, name: member.team.name, isOwner: member.seatTier === 'OWNER' } : null

4. Add timeline to response:
   - timeline: timeline

Response shape:
{
  member: { ... existing fields ... },
  claim: { ... existing fields ... },
  team: { id, name, isOwner } | null,
  timeline: [{ type, date, description }, ...]
}
  </action>
  <verify>
`curl -X GET /dashboard -H "Authorization: Bearer $TOKEN"` returns response with team and timeline fields.
  </verify>
  <done>
GET /dashboard returns activity timeline with joined/subscribed/claimed/introduced events, and team info for team members.
  </done>
</task>

</tasks>

<verification>
```bash
# Start server and verify endpoints respond
npm run dev &
sleep 3

# Test update-email validation (should return 400 without auth)
curl -s -X POST http://localhost:3000/auth/update-email -H "Content-Type: application/json" -d '{}' | grep -q "error"

# Test billing details (should return 401 without auth)
curl -s -X GET http://localhost:3000/billing/details | grep -q "Unauthorized\|error"

# Test dashboard (should return 401 without auth)
curl -s -X GET http://localhost:3000/dashboard | grep -q "Unauthorized\|error"

# TypeScript compilation
npx tsc --noEmit
```
</verification>

<success_criteria>
- POST /auth/update-email endpoint validates input, verifies password, updates Stripe then DB
- POST /auth/update-password endpoint validates input, verifies current password, hashes and saves new
- GET /billing/details returns payment method, subscription, invoices for owners/individuals
- GET /billing/details returns managedBy response for team members
- GET /dashboard returns team info and activity timeline
- All endpoints require authentication (401 without valid token)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/25-member-self-service-dashboard/25-01-SUMMARY.md`
</output>
