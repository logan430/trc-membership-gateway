# 25-02: Token Auto-Refresh and Admin Login Validation

---
phase: 25-member-self-service-dashboard
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - public/admin/login.html
autonomous: true

must_haves:
  truths:
    - "Admin login page checks token expiry before auto-redirect"
    - "Expired admin tokens trigger refresh attempt before clearing"
    - "Invalid or expired tokens without valid refresh result in staying on login page"
  artifacts:
    - path: "public/admin/login.html"
      provides: "Token expiry validation in checkAuth"
      contains: "payload.exp"
  key_links:
    - from: "public/admin/login.html"
      to: "/admin/auth/refresh"
      via: "fetch call for expired tokens"
      pattern: "fetch.*admin/auth/refresh"
---

<objective>
Fix admin login page to validate token expiry before auto-redirecting, preventing redirect loops when tokens are expired.

Purpose: Success criteria #9 requires "Admin login validates token expiry before auto-redirect". Currently, checkAuth() only checks if a token EXISTS, not if it's valid, causing redirect loops when tokens expire.

Output:
- Updated admin login.html with token expiry validation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/25-member-self-service-dashboard/25-RESEARCH.md

Current admin/login.html checkAuth function (lines 110-115):
```javascript
function checkAuth() {
  const token = localStorage.getItem('adminAccessToken');
  if (token) {
    window.location.href = '/app/admin/dashboard';
  }
}
```

Problem: Does not check if token is expired before redirecting.

Research solution from 25-RESEARCH.md shows:
1. Parse JWT to get exp claim
2. If exp < Date.now() / 1000, token is expired
3. Attempt silent refresh before clearing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update admin login checkAuth with token expiry validation</name>
  <files>public/admin/login.html</files>
  <action>
Replace the existing checkAuth() function and add supporting functions:

1. Add parseAdminToken function (if not already present, check if exists in file):
```javascript
function parseAdminToken(token) {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  } catch (e) {
    return null;
  }
}
```

2. Add tryRefreshAndRedirect function:
```javascript
async function tryRefreshAndRedirect() {
  try {
    const response = await fetch('/admin/auth/refresh', {
      method: 'POST',
      credentials: 'include',
    });
    if (response.ok) {
      const { accessToken } = await response.json();
      localStorage.setItem('adminAccessToken', accessToken);
      window.location.href = '/app/admin/dashboard';
    } else {
      // Refresh failed, clear token and stay on login
      localStorage.removeItem('adminAccessToken');
    }
  } catch (err) {
    // Network error, clear token and stay on login
    localStorage.removeItem('adminAccessToken');
  }
}
```

3. Replace checkAuth function:
```javascript
function checkAuth() {
  const token = localStorage.getItem('adminAccessToken');
  if (!token) return; // No token, stay on login

  // Parse and check expiry
  const payload = parseAdminToken(token);
  if (!payload || !payload.exp) {
    localStorage.removeItem('adminAccessToken');
    return;
  }

  // Check if expired
  if (payload.exp * 1000 < Date.now()) {
    // Token expired, try to refresh
    tryRefreshAndRedirect();
    return;
  }

  // Valid token, redirect
  window.location.href = '/app/admin/dashboard';
}
```

NOTE: The admin/login.html already has parseAdminToken defined elsewhere in the codebase for admin dashboard - check if it exists in the file. If parseAdminToken already exists in this file, don't duplicate it. The admin/dashboard.html has it at lines 155-166.
  </action>
  <verify>
Open /app/admin/login in browser:
1. Clear localStorage.adminAccessToken
2. Verify page stays on login (no redirect)
3. Set expired token: localStorage.setItem('adminAccessToken', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0IiwiZXhwIjoxMDAwMDAwMDAwfQ.test')
4. Refresh page - should attempt refresh then clear token (stay on login)
5. Valid login should still redirect to dashboard
  </verify>
  <done>
Admin login page validates token expiry before auto-redirect. Expired tokens trigger refresh attempt, and if refresh fails, user stays on login page with token cleared.
  </done>
</task>

</tasks>

<verification>
```bash
# Verify JavaScript syntax is valid
node -e "const fs = require('fs'); const html = fs.readFileSync('public/admin/login.html', 'utf8'); const script = html.match(/<script>([\s\S]*?)<\/script>/g); script.forEach(s => { try { new Function(s.replace(/<\/?script>/g, '')); console.log('Script syntax OK'); } catch(e) { console.error('Syntax error:', e.message); } });"

# Manual browser test:
# 1. Navigate to /app/admin/login
# 2. In console: localStorage.setItem('adminAccessToken', 'expired.token.here')
# 3. Refresh - should not redirect, should clear the invalid token
```
</verification>

<success_criteria>
- checkAuth() parses JWT and checks exp claim
- Expired tokens trigger refresh attempt via /admin/auth/refresh
- Failed refresh clears token and keeps user on login page
- Valid non-expired tokens still redirect to dashboard
- No JavaScript syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/25-member-self-service-dashboard/25-02-SUMMARY.md`
</output>
