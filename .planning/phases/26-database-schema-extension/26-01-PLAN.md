---
phase: 26-database-schema-extension
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/
autonomous: true

must_haves:
  truths:
    - "Prisma schema contains 5 new models (BenchmarkSubmission, Resource, ResourceDownload, PointTransaction, DiscordActivity)"
    - "Prisma schema contains 4 new enums (BenchmarkCategory, ResourceCategory, ResourceType, DiscordActivityType)"
    - "Member model has 3 new fields (totalPoints, currentStreak, lastActiveAt)"
    - "Prisma migrations folder is initialized with baseline"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Extended schema with v2.0 models"
      contains: "model BenchmarkSubmission"
    - path: "prisma/migrations/"
      provides: "Prisma migrations folder"
  key_links:
    - from: "prisma/schema.prisma"
      to: "Prisma client generation"
      via: "prisma generate"
      pattern: "generator client"
---

<objective>
Define v2.0 database schema in Prisma and initialize migration infrastructure.

Purpose: Establish the data model foundation for benchmarking, resources, gamification, and Discord activity tracking. The schema must be defined before migrations can be generated.

Output: Updated schema.prisma with all v2.0 models and enums, initialized migrations folder with baseline.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-database-schema-extension/26-RESEARCH.md

# Existing schema to extend
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add v2.0 enums and models to schema.prisma</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following to prisma/schema.prisma:

**Enums (after existing enums section):**
```prisma
enum BenchmarkCategory {
  COMPENSATION
  INFRASTRUCTURE
  BUSINESS
  OPERATIONAL
}

enum ResourceCategory {
  COLD_EMAIL
  SALES_GTM
  CUSTOMER_SERVICE
  OPERATIONS
  AGENCY_GROWTH
}

enum ResourceType {
  TEMPLATE
  SOP
  PLAYBOOK
  COURSE
  VIDEO
}

enum DiscordActivityType {
  MESSAGE
  REACTION_GIVEN
  REACTION_RECEIVED
}
```

**Member model extensions (add to existing Member model):**
```prisma
  // Gamification (v2.0 - DB-06)
  totalPoints           Int                    @default(0)
  currentStreak         Int                    @default(0)
  lastActiveAt          DateTime?

  // Relationships (v2.0)
  benchmarkSubmissions  BenchmarkSubmission[]
  resourceDownloads     ResourceDownload[]
  pointTransactions     PointTransaction[]
  discordActivities     DiscordActivity[]
```

Add index for leaderboard queries:
```prisma
  @@index([totalPoints(sort: Desc)])  // Leaderboard queries
```

**New models (after Member model):**
```prisma
// DB-01: BenchmarkSubmission
model BenchmarkSubmission {
  id          String            @id @default(cuid())
  memberId    String
  category    BenchmarkCategory
  data        Json              // JSONB for flexible schema per category
  isValid     Boolean           @default(true)
  submittedAt DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  member      Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, category])  // One submission per category per member
  @@index([category])
  @@index([memberId])
  @@index([data(ops: JsonbPathOps)], type: Gin)  // DB-08: GIN index for JSONB queries
}

// DB-02: Resource
model Resource {
  id            String           @id @default(cuid())
  title         String
  description   String
  category      ResourceCategory
  type          ResourceType
  fileUrl       String           // Supabase Storage path
  thumbnailUrl  String?
  isFeatured    Boolean          @default(false)
  downloadCount Int              @default(0)  // Denormalized for fast sorting
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  downloads     ResourceDownload[]

  @@index([category])
  @@index([type])
  @@index([isFeatured])
}

// DB-03: ResourceDownload
model ResourceDownload {
  id           String   @id @default(cuid())
  memberId     String
  resourceId   String
  downloadedAt DateTime @default(now())

  member       Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  resource     Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([resourceId])
  @@index([downloadedAt])
}

// DB-04: PointTransaction (immutable ledger)
model PointTransaction {
  id        String   @id @default(cuid())
  memberId  String
  action    String   // "benchmark_submission", "resource_download", "discord_activity", "intro_completed", "admin_adjustment"
  points    Int      // Can be negative for admin adjustments
  metadata  Json?    // Context: { category: "COMPENSATION" }, { resourceId: "..." }, { reason: "..." }
  createdAt DateTime @default(now())

  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([action])
  @@index([createdAt])
}

// DB-05: DiscordActivity
model DiscordActivity {
  id           String              @id @default(cuid())
  memberId     String
  discordId    String
  activityType DiscordActivityType
  xpDelta      Int?                // MEE6 XP gained since last sync
  xpTotal      Int?                // Total MEE6 XP at sync time
  syncedAt     DateTime            @default(now())

  member       Member              @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([discordId])
  @@index([syncedAt])
}
```

**Important:** Place models in the V2.0 MODELS section after the existing operational models.
  </action>
  <verify>
Run `npx prisma validate` - should pass with no errors.
Run `npx prisma format` - formats schema cleanly.
  </verify>
  <done>
Schema.prisma contains all 4 new enums, all 5 new models, Member has 3 new fields (totalPoints, currentStreak, lastActiveAt) and 4 new relations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Initialize Prisma migrations with baseline</name>
  <files>prisma/migrations/</files>
  <action>
The project has no existing migrations folder (schema was created directly). Initialize Prisma migrations:

1. Create migrations folder:
   ```bash
   mkdir -p prisma/migrations
   ```

2. Baseline the existing production schema (mark current state as applied without running):
   ```bash
   npx prisma migrate diff --from-empty --to-schema-datamodel prisma/schema.prisma --script > prisma/migrations/0_init/migration.sql
   ```

   Note: This may fail because schema now has v2.0 changes. If so, use this approach instead:

   a. Temporarily revert schema to v1.0 state (comment out v2.0 additions)
   b. Generate baseline: `npx prisma migrate diff --from-empty --to-schema-datamodel prisma/schema.prisma --script`
   c. Save to `prisma/migrations/0_init/migration.sql`
   d. Restore v2.0 schema changes

3. Mark baseline as applied (tells Prisma this migration already ran on the database):
   ```bash
   npx prisma migrate resolve --applied 0_init
   ```

**Alternative if baseline approach is complex:** Skip baseline for now. The first "real" migration will include v2.0 tables only. Prisma will detect existing tables match schema and handle gracefully.

For this project, since we're adding NEW tables only (not modifying existing), we can proceed directly to generating the v2.0 migration without a formal baseline. Prisma migrate deploy will only run migrations not yet applied.
  </action>
  <verify>
`ls prisma/migrations/` shows migrations folder exists.
If baseline created: `prisma/migrations/0_init/migration.sql` contains existing schema DDL.
  </verify>
  <done>
Prisma migrations infrastructure is ready. Either baseline migration exists, or migrations folder is initialized for v2.0 migration.
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate v2.0 migration with --create-only</name>
  <files>prisma/migrations/</files>
  <action>
Generate the migration SQL without applying it (allows manual editing in Plan 02):

```bash
npx prisma migrate dev --create-only --name add_v2_tables
```

This creates `prisma/migrations/YYYYMMDDHHMMSS_add_v2_tables/migration.sql` with:
- CREATE TYPE statements for new enums
- ALTER TABLE Member for new columns
- CREATE TABLE for 5 new tables
- CREATE INDEX statements
- Foreign key constraints

**Do NOT run the migration yet.** Plan 02 will edit this file for zero-downtime patterns.

Verify the migration file was created and contains expected content:
- All 4 enum types (BenchmarkCategory, ResourceCategory, ResourceType, DiscordActivityType)
- ALTER TABLE "Member" ADD COLUMN for totalPoints, currentStreak, lastActiveAt
- CREATE TABLE for BenchmarkSubmission, Resource, ResourceDownload, PointTransaction, DiscordActivity
- Foreign key constraints (will be edited to NOT VALID in Plan 02)
- Index statements (concurrent indexes will be separated in Plan 02)
  </action>
  <verify>
`ls prisma/migrations/` shows new migration folder.
`cat prisma/migrations/*_add_v2_tables/migration.sql | head -50` shows DDL statements.
Migration was NOT applied (no database changes yet).
  </verify>
  <done>
Migration SQL generated. File ready for zero-downtime editing in Plan 02. Prisma client NOT regenerated yet (waits for migration to run).
  </done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes
2. `ls prisma/migrations/` shows migration folder(s)
3. Migration SQL file contains all expected tables and columns
4. Database has NOT been modified yet (migrations not applied)
</verification>

<success_criteria>
- prisma/schema.prisma contains 4 new enums, 5 new models
- Member model has totalPoints (Int, default 0), currentStreak (Int, default 0), lastActiveAt (DateTime?)
- BenchmarkSubmission has GIN index definition on data field
- All new models have proper relations to Member
- Migration file generated but NOT applied
- No database changes made (zero-downtime prep)
</success_criteria>

<output>
After completion, create `.planning/phases/26-database-schema-extension/26-01-SUMMARY.md`
</output>
