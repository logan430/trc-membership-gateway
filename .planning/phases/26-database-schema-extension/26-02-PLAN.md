---
phase: 26-database-schema-extension
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - prisma/migrations/
autonomous: true

must_haves:
  truths:
    - "Foreign key constraints use NOT VALID for instant addition"
    - "Each concurrent index has its own single-statement migration file"
    - "FK validation is in a separate migration from FK creation"
    - "Migration files are ready for zero-downtime deployment"
  artifacts:
    - path: "prisma/migrations/*_add_v2_tables/migration.sql"
      provides: "Table creation + NOT VALID FKs"
    - path: "prisma/migrations/*_validate_fks/migration.sql"
      provides: "FK validation statements"
    - path: "prisma/migrations/*_idx_*/migration.sql"
      provides: "Concurrent index migrations"
  key_links:
    - from: "NOT VALID constraint"
      to: "VALIDATE CONSTRAINT"
      via: "separate migrations"
      pattern: "NOT VALID"
---

<objective>
Edit generated migration for zero-downtime patterns and create separate migrations for FK validation and concurrent indexes.

Purpose: Production database cannot have downtime. Standard Prisma migrations would lock tables during foreign key validation and index creation. This plan implements the two-phase FK pattern and single-statement concurrent indexes.

Output: Multiple migration files ready for safe production deployment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-database-schema-extension/26-RESEARCH.md
@.planning/phases/26-database-schema-extension/26-01-SUMMARY.md

# Migration file to edit
@prisma/migrations/*_add_v2_tables/migration.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Edit main migration for NOT VALID foreign keys</name>
  <files>prisma/migrations/*_add_v2_tables/migration.sql</files>
  <action>
Edit the generated migration file (prisma/migrations/YYYYMMDDHHMMSS_add_v2_tables/migration.sql):

**1. Find all FOREIGN KEY constraints and add NOT VALID:**

Change from:
```sql
ALTER TABLE "BenchmarkSubmission" ADD CONSTRAINT "BenchmarkSubmission_memberId_fkey" FOREIGN KEY ("memberId") REFERENCES "Member"("id") ON DELETE CASCADE ON UPDATE CASCADE;
```

To:
```sql
ALTER TABLE "BenchmarkSubmission" ADD CONSTRAINT "BenchmarkSubmission_memberId_fkey" FOREIGN KEY ("memberId") REFERENCES "Member"("id") ON DELETE CASCADE ON UPDATE CASCADE NOT VALID;
```

Apply NOT VALID to ALL foreign key constraints:
- BenchmarkSubmission_memberId_fkey
- ResourceDownload_memberId_fkey
- ResourceDownload_resourceId_fkey
- PointTransaction_memberId_fkey
- DiscordActivity_memberId_fkey

**2. Remove all CREATE INDEX statements (will be in separate concurrent migrations):**

Delete lines like:
```sql
CREATE INDEX "BenchmarkSubmission_category_idx" ON "BenchmarkSubmission"("category");
CREATE INDEX "BenchmarkSubmission_memberId_idx" ON "BenchmarkSubmission"("memberId");
-- ... all other CREATE INDEX statements
```

Keep:
- CREATE TYPE statements (enums)
- ALTER TABLE ... ADD COLUMN statements (Member extensions)
- CREATE TABLE statements (new tables)
- UNIQUE constraints (these are fast, no need for concurrent)
- Foreign key constraints with NOT VALID

**3. The edited migration should contain only:**
- Enum creation
- Member column additions
- Table creation (5 tables)
- Unique constraints
- Foreign keys with NOT VALID
  </action>
  <verify>
`grep "NOT VALID" prisma/migrations/*_add_v2_tables/migration.sql` returns 5 lines (one per FK).
`grep "CREATE INDEX" prisma/migrations/*_add_v2_tables/migration.sql` returns nothing (all indexes removed).
  </verify>
  <done>
Main migration file edited: FKs have NOT VALID, no CREATE INDEX statements remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FK validation migration</name>
  <files>prisma/migrations/</files>
  <action>
Create a new migration folder and file for validating all foreign keys.

**1. Create migration folder (use timestamp after main migration):**
```bash
# Get timestamp that's 1 second after the add_v2_tables migration
MAIN_TS=$(ls prisma/migrations/ | grep add_v2_tables | sed 's/_add_v2_tables//')
NEW_TS=$(echo $MAIN_TS | awk -F'' '{$14=$14+1; print}' OFS='')
mkdir -p "prisma/migrations/${NEW_TS}_validate_v2_fks"
```

Or manually: if main migration is 20260122190000_add_v2_tables, create 20260122190001_validate_v2_fks.

**2. Create migration.sql with ONLY validation statements:**
```sql
-- Validate all v2.0 foreign key constraints
-- This runs while allowing concurrent reads/writes

ALTER TABLE "BenchmarkSubmission" VALIDATE CONSTRAINT "BenchmarkSubmission_memberId_fkey";
ALTER TABLE "ResourceDownload" VALIDATE CONSTRAINT "ResourceDownload_memberId_fkey";
ALTER TABLE "ResourceDownload" VALIDATE CONSTRAINT "ResourceDownload_resourceId_fkey";
ALTER TABLE "PointTransaction" VALIDATE CONSTRAINT "PointTransaction_memberId_fkey";
ALTER TABLE "DiscordActivity" VALIDATE CONSTRAINT "DiscordActivity_memberId_fkey";
```

This migration CAN have multiple statements - VALIDATE CONSTRAINT doesn't require CONCURRENTLY and doesn't block writes significantly.
  </action>
  <verify>
`ls prisma/migrations/ | grep validate` shows the validation migration folder.
`cat prisma/migrations/*_validate_v2_fks/migration.sql` shows 5 VALIDATE CONSTRAINT statements.
  </verify>
  <done>
FK validation migration created. Will run after tables exist but allows concurrent database operations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create concurrent index migrations (one per file)</name>
  <files>prisma/migrations/</files>
  <action>
Create separate migration files for each index. Each file MUST contain only ONE statement (Prisma's single-statement detection).

**Required indexes (from schema):**

BenchmarkSubmission indexes:
1. category index
2. memberId index
3. data GIN index (DB-08)

Resource indexes:
4. category index
5. type index
6. isFeatured index

ResourceDownload indexes:
7. memberId index
8. resourceId index
9. downloadedAt index

PointTransaction indexes:
10. memberId index
11. action index
12. createdAt index

DiscordActivity indexes:
13. memberId index
14. discordId index
15. syncedAt index

Member new index:
16. totalPoints DESC index (leaderboard)

**Create 16 migration files:**

Use sequential timestamps after the validate migration. For example, if validate is 20260122190001, use 20260122190002, 20260122190003, etc.

Example for first index:
```bash
mkdir -p "prisma/migrations/20260122190002_idx_benchmark_category"
echo 'CREATE INDEX CONCURRENTLY "BenchmarkSubmission_category_idx" ON "BenchmarkSubmission"("category");' > "prisma/migrations/20260122190002_idx_benchmark_category/migration.sql"
```

**Complete list of migration files to create:**

```
20260122190002_idx_benchmark_category/migration.sql:
CREATE INDEX CONCURRENTLY "BenchmarkSubmission_category_idx" ON "BenchmarkSubmission"("category");

20260122190003_idx_benchmark_member/migration.sql:
CREATE INDEX CONCURRENTLY "BenchmarkSubmission_memberId_idx" ON "BenchmarkSubmission"("memberId");

20260122190004_idx_benchmark_data_gin/migration.sql:
CREATE INDEX CONCURRENTLY "BenchmarkSubmission_data_idx" ON "BenchmarkSubmission" USING GIN (data jsonb_path_ops);

20260122190005_idx_resource_category/migration.sql:
CREATE INDEX CONCURRENTLY "Resource_category_idx" ON "Resource"("category");

20260122190006_idx_resource_type/migration.sql:
CREATE INDEX CONCURRENTLY "Resource_type_idx" ON "Resource"("type");

20260122190007_idx_resource_featured/migration.sql:
CREATE INDEX CONCURRENTLY "Resource_isFeatured_idx" ON "Resource"("isFeatured");

20260122190008_idx_download_member/migration.sql:
CREATE INDEX CONCURRENTLY "ResourceDownload_memberId_idx" ON "ResourceDownload"("memberId");

20260122190009_idx_download_resource/migration.sql:
CREATE INDEX CONCURRENTLY "ResourceDownload_resourceId_idx" ON "ResourceDownload"("resourceId");

20260122190010_idx_download_date/migration.sql:
CREATE INDEX CONCURRENTLY "ResourceDownload_downloadedAt_idx" ON "ResourceDownload"("downloadedAt");

20260122190011_idx_points_member/migration.sql:
CREATE INDEX CONCURRENTLY "PointTransaction_memberId_idx" ON "PointTransaction"("memberId");

20260122190012_idx_points_action/migration.sql:
CREATE INDEX CONCURRENTLY "PointTransaction_action_idx" ON "PointTransaction"("action");

20260122190013_idx_points_created/migration.sql:
CREATE INDEX CONCURRENTLY "PointTransaction_createdAt_idx" ON "PointTransaction"("createdAt");

20260122190014_idx_discord_member/migration.sql:
CREATE INDEX CONCURRENTLY "DiscordActivity_memberId_idx" ON "DiscordActivity"("memberId");

20260122190015_idx_discord_id/migration.sql:
CREATE INDEX CONCURRENTLY "DiscordActivity_discordId_idx" ON "DiscordActivity"("discordId");

20260122190016_idx_discord_synced/migration.sql:
CREATE INDEX CONCURRENTLY "DiscordActivity_syncedAt_idx" ON "DiscordActivity"("syncedAt");

20260122190017_idx_member_points/migration.sql:
CREATE INDEX CONCURRENTLY "Member_totalPoints_idx" ON "Member"("totalPoints" DESC);
```

**CRITICAL:** Each file must have EXACTLY ONE statement with no semicolon-separated statements. The trailing semicolon is fine, but no other statements.
  </action>
  <verify>
`ls prisma/migrations/ | grep idx_ | wc -l` returns 16.
For each index migration: `wc -l prisma/migrations/*_idx_*/migration.sql` shows 1 line each.
`grep CONCURRENTLY prisma/migrations/*_idx_*/migration.sql | wc -l` returns 16.
  </verify>
  <done>
16 single-statement concurrent index migrations created. Each can run without blocking writes.
  </done>
</task>

</tasks>

<verification>
1. Main migration has 5 "NOT VALID" foreign keys, zero "CREATE INDEX" statements
2. Validate migration has 5 "VALIDATE CONSTRAINT" statements
3. 16 index migration folders exist, each with single CONCURRENTLY statement
4. `ls prisma/migrations/ | wc -l` shows 18+ migration folders (main + validate + 16 indexes)
</verification>

<success_criteria>
- DB-09 (foreign keys): All FKs use NOT VALID + separate VALIDATE migration
- DB-10 (zero-downtime): All indexes use CREATE INDEX CONCURRENTLY in single-statement files
- DB-08 (GIN index): BenchmarkSubmission_data_idx uses USING GIN (data jsonb_path_ops)
- Migration count: At least 18 migration files (1 main + 1 validate + 16 indexes)
- Ready for deployment: Migrations structured for zero-downtime production deploy
</success_criteria>

<output>
After completion, create `.planning/phases/26-database-schema-extension/26-02-SUMMARY.md`
</output>
