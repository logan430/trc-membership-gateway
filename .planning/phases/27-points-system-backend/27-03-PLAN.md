---
phase: 27-points-system-backend
plan: 03
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/routes/points.ts
  - src/routes/admin/points.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Member can view their point history (excludes admin adjustments)"
    - "Member can see point summary with breakdown by type"
    - "Member can view point values for all enabled actions"
    - "Admin can adjust member points with audit trail"
    - "Admin can view full point history including adjustments"
  artifacts:
    - path: "src/routes/points.ts"
      provides: "Member-facing points API"
      exports: ["pointsRouter"]
    - path: "src/routes/admin/points.ts"
      provides: "Admin points management API"
      exports: ["adminPointsRouter"]
  key_links:
    - from: "src/routes/points.ts"
      to: "prisma.pointTransaction"
      via: "filtered query excluding admin_adjustment"
      pattern: "action.*not.*admin_adjustment"
    - from: "src/routes/points.ts"
      to: "src/points/config.ts"
      via: "getAllPointConfigs for values endpoint"
      pattern: "getAllPointConfigs"
    - from: "src/routes/admin/points.ts"
      to: "src/points/service.ts"
      via: "adminAdjustPoints call"
      pattern: "adminAdjustPoints"
    - from: "src/index.ts"
      to: "src/routes/points.ts"
      via: "route mount"
      pattern: "pointsRouter"
---

<objective>
Create member and admin API endpoints for point history, values, and management

Purpose: Allow members to view their earned points, history, and point values (GAME-05, GAME-06). Allow admins to adjust points with audit trail (GAME-07). All APIs use cursor pagination matching existing patterns.

Output: Member endpoints at /api/points/*, Admin endpoints at /api/admin/members/:id/points/*
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-points-system-backend/27-RESEARCH.md
@.planning/phases/27-points-system-backend/27-CONTEXT.md

# Reference 27-01 SUMMARY for types
@.planning/phases/27-points-system-backend/27-01-SUMMARY.md

# Existing patterns
@src/routes/admin/audit.ts
@src/routes/admin/access.ts
@src/middleware/session.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create member points API routes</name>
  <files>src/routes/points.ts</files>
  <action>
Create `src/routes/points.ts` with member-facing endpoints:

**GET /api/points/history**
Query params (Zod schema):
- cursor: string (optional) - for pagination
- limit: number (1-100, default 50)
- type: string (optional) - filter by action type

Returns:
```typescript
{
  transactions: Array<{
    id: string;
    action: string;
    actionLabel: string;  // From PointActionLabels
    points: number;
    metadata: Record<string, unknown>;
    createdAt: Date;
  }>;
  nextCursor: string | null;
  hasMore: boolean;
}
```

CRITICAL: Filter WHERE action != 'admin_adjustment' per CONTEXT.md
- Admin adjustments hidden from member view
- This preserves the "earned" feeling

Use cursor pagination pattern from adminAuditRouter.

**GET /api/points/values**
Returns enabled point action values for transparency (GAME-05 requirement):
```typescript
{
  values: Array<{
    action: string;       // e.g., "benchmark_submission"
    label: string;        // e.g., "Benchmark Submission"
    points: number;       // e.g., 50
    description?: string; // Optional admin description
  }>;
}
```

Implementation:
- Import getAllPointConfigs from '../points/config.js'
- Filter to only enabled configs (enabled: true)
- Exclude admin_adjustment action (not relevant to members)
- Sort by points descending (highest value actions first)

This endpoint allows the frontend to display "How to earn points" with current values.

**GET /api/points/summary**
Returns:
```typescript
{
  totalPoints: number;  // Math.max(0, member.totalPoints) - floor at zero for display
  breakdown: Array<{
    action: string;
    actionLabel: string;
    points: number;  // Sum per action type
  }>;
}
```

Use groupBy query for breakdown, excluding admin_adjustment.

All three endpoints:
- Use requireAuth middleware from session.ts
- Access req.memberId for current user
- Handle Zod validation errors with 400 response
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- File exports pointsRouter
  </verify>
  <done>Member can query their point history, point values, and summary via authenticated API</done>
</task>

<task type="auto">
  <name>Task 2: Create admin points management API</name>
  <files>src/routes/admin/points.ts</files>
  <action>
Create `src/routes/admin/points.ts` with admin endpoints:

**POST /api/admin/members/:id/points/adjust**
Body (Zod schema):
```typescript
{
  points: number;       // Required, can be negative
  reason?: string;      // Optional reason
  notifyMember: boolean; // Default false
}
```

Process:
1. Validate member exists (404 if not)
2. Call adminAdjustPoints from service
3. Return { success: true, newTotal: number }

Follow patterns from adminAccessRouter:
- requireAdmin middleware
- Zod validation with error handling
- Return 400 for validation errors

**GET /api/admin/members/:id/points/history**
Query params:
- cursor: string (optional)
- limit: number (1-100, default 50)

Returns ALL transactions including admin_adjustment (unlike member endpoint).
Includes metadata showing admin info for adjustments.

This is for admin panel member detail page - shows complete history.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- File exports adminPointsRouter
  </verify>
  <done>Admin can adjust member points and view full history including adjustments</done>
</task>

<task type="auto">
  <name>Task 3: Mount routes in Express app</name>
  <files>src/index.ts</files>
  <action>
Update `src/index.ts` to mount both routers:

Add imports:
```typescript
import { pointsRouter } from './routes/points.js';
import { adminPointsRouter } from './routes/admin/points.js';
```

Mount member route (after dashboard routes, before health check):
```typescript
// Points routes (member-facing)
app.use('/api/points', pointsRouter);
```

Mount admin route (in admin routes section, after adminAccessRouter):
```typescript
app.use('/api/admin/members', adminPointsRouter);
```

Note: adminPointsRouter mounts at /api/admin/members because its routes are /:id/points/*
This follows the existing pattern where adminAccessRouter also mounts at /api/admin/members.
  </action>
  <verify>
- Server starts: `npm run dev`
- `curl http://localhost:4000/api/points/summary` returns 401 (auth required)
- `curl http://localhost:4000/api/points/values` returns 401 (auth required)
- `curl http://localhost:4000/api/admin/members/test/points/history` returns 401 (auth required)
  </verify>
  <done>Points APIs mounted and accessible at documented paths</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Member API tests (with valid member session):
   - GET /api/points/summary returns totalPoints and breakdown
   - GET /api/points/history returns paginated transactions
   - GET /api/points/history?type=intro_completed filters correctly
   - GET /api/points/values returns enabled action values
   - Response never includes admin_adjustment actions

2. Admin API tests (with valid admin session):
   - POST /api/admin/members/:id/points/adjust with {points: 10} succeeds
   - Member's totalPoints increases by 10 (check via prisma studio)
   - AuditLog shows POINTS_ADJUSTED entry
   - GET /api/admin/members/:id/points/history shows adjustment

3. Idempotency verification:
   - Member summary totalPoints matches after multiple page loads
   - No duplicate transactions created by API calls

4. Edge cases:
   - POST adjust with points: -1000 (negative) succeeds
   - Member with no transactions returns empty history
   - /api/points/values returns empty array if all actions disabled
</verification>

<success_criteria>
- [ ] Member /api/points/history endpoint works with cursor pagination
- [ ] Member /api/points/summary endpoint returns total and breakdown
- [ ] Member /api/points/values endpoint returns enabled action values
- [ ] Member endpoints filter out admin_adjustment
- [ ] Admin /api/admin/members/:id/points/adjust creates transaction
- [ ] Admin adjust logs to AuditLog
- [ ] Admin /api/admin/members/:id/points/history shows all including adjustments
- [ ] Routes mounted at correct paths
- [ ] All endpoints require appropriate auth
</success_criteria>

<output>
After completion, create `.planning/phases/27-points-system-backend/27-03-SUMMARY.md`
</output>
