---
phase: 30-mee6-discord-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mee6/types.ts
  - src/mee6/client.ts
  - src/config/env.ts
autonomous: true

must_haves:
  truths:
    - "MEE6 API can be called with retry logic and rate limit handling"
    - "API responses are validated with Zod before processing"
    - "401 errors (leaderboard not public) are detected and abort retries"
    - "Environment config supports MEE6 enable/disable toggle"
  artifacts:
    - path: "src/mee6/types.ts"
      provides: "MEE6 API response types and Zod schemas"
      exports: ["Mee6Player", "Mee6LeaderboardResponse", "mee6LeaderboardSchema"]
    - path: "src/mee6/client.ts"
      provides: "MEE6 API client with fetch + p-retry"
      exports: ["fetchLeaderboardPage", "fetchAllMemberXp"]
    - path: "src/config/env.ts"
      provides: "MEE6 environment variables"
      contains: "MEE6_SYNC_ENABLED"
  key_links:
    - from: "src/mee6/client.ts"
      to: "p-retry"
      via: "import"
      pattern: "import.*p-retry"
    - from: "src/mee6/client.ts"
      to: "src/mee6/types.ts"
      via: "Zod validation"
      pattern: "mee6LeaderboardSchema\\.parse"
---

<objective>
Create MEE6 API client with defensive error handling for the unofficial API.

Purpose: Foundation for MEE6 XP synchronization - fetch Discord activity data reliably with retry logic, rate limiting awareness, and response validation.

Output: MEE6 client module (src/mee6/) ready for use by sync job.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-mee6-discord-integration/30-CONTEXT.md
@.planning/phases/30-mee6-discord-integration/30-RESEARCH.md

# Existing patterns
@src/config/env.ts
@src/auth/discord-oauth.ts (fetch pattern)
@src/lib/role-assignment.ts (p-retry pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MEE6 types and Zod schemas</name>
  <files>src/mee6/types.ts</files>
  <action>
Create types for MEE6 API responses based on RESEARCH.md structure.

Include:
1. `Mee6Player` interface with: id (Discord user ID), username, xp (total), level, message_count, detailed_xp tuple
2. `Mee6LeaderboardResponse` interface with: players array, page number, guild info
3. Zod schemas for runtime validation:
   - `mee6PlayerSchema` validating all player fields
   - `mee6LeaderboardSchema` validating the full response
4. Export types for use by client and sync job

Follow existing type patterns in src/points/types.ts and src/benchmarks/types.ts.
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit src/mee6/types.ts`
  </verify>
  <done>
    Zod schemas exist that can validate real MEE6 API response structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MEE6 API client with p-retry</name>
  <files>src/mee6/client.ts</files>
  <action>
Create API client for fetching MEE6 leaderboard data.

Functions:
1. `fetchLeaderboardPage(guildId: string, page?: number, limit?: number)`:
   - Use native fetch (project pattern)
   - URL: `https://mee6.xyz/api/plugins/levels/leaderboard/${guildId}?page=${page}&limit=${limit}`
   - Wrap in p-retry with: 3 retries, 5s min timeout, 60s max timeout, onFailedAttempt logging
   - Handle 401 as AbortError (leaderboard not public - don't retry)
   - Handle 429 by extracting Retry-After header before throwing for retry
   - Validate response with Zod schema, log validation errors to Sentry
   - Return typed `Mee6LeaderboardResponse`

2. `fetchAllMemberXp(guildId: string, discordIds: string[])`:
   - Fetch pages until all provided discordIds are found or pages exhausted
   - Use limit=500 per page (per RESEARCH.md recommendation)
   - Add 2-second delay between page fetches (rate limit safety)
   - Return Map<discordId, { xp: number, level: number }> for found members
   - Members not found in MEE6 are omitted from map (caller handles)

Import logger from src/index.js. Use AbortError from p-retry.

DO NOT create environment variables here - use DISCORD_GUILD_ID from env.ts for now.
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit src/mee6/client.ts`
  </verify>
  <done>
    Client can fetch MEE6 leaderboard with retry logic and Zod validation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add MEE6 environment configuration</name>
  <files>src/config/env.ts</files>
  <action>
Add MEE6 configuration to the Zod env schema.

Add fields:
1. `MEE6_SYNC_ENABLED`: z.enum(['true', 'false']).default('false') - Master toggle for sync
2. `MEE6_GUILD_ID`: z.string().optional() - Override guild ID for MEE6 (defaults to DISCORD_GUILD_ID)

Place these at the end of the schema, grouped with a comment: `// MEE6 Integration`

Do NOT add .refine() validation for these - they're optional with defaults.
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit src/config/env.ts`
    Server starts: `npm run build`
  </verify>
  <done>
    Environment supports MEE6_SYNC_ENABLED toggle and optional guild ID override.
  </done>
</task>

</tasks>

<verification>
1. All files compile: `npm run build`
2. Types are properly exported: Check that imports resolve in a test file
3. Client function signatures match RESEARCH.md patterns
4. Zod schemas match documented MEE6 API response structure
</verification>

<success_criteria>
- src/mee6/types.ts exports Mee6Player, Mee6LeaderboardResponse, and Zod schemas
- src/mee6/client.ts exports fetchLeaderboardPage and fetchAllMemberXp
- Client uses p-retry with proper error handling (401 aborts, 429 retries)
- Response validation via Zod schema
- env.ts includes MEE6_SYNC_ENABLED with 'false' default
</success_criteria>

<output>
After completion, create `.planning/phases/30-mee6-discord-integration/30-01-SUMMARY.md`
</output>
