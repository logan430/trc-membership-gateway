---
phase: 30-mee6-discord-integration
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - src/jobs/mee6-sync.ts
  - src/jobs/types.ts
  - src/points/service.ts
autonomous: true

must_haves:
  truths:
    - "MEE6 XP syncs for all TRC members with linked Discord accounts"
    - "XP delta calculated correctly (current - last recorded)"
    - "First sync creates baseline record with zero points (no backfill)"
    - "Points awarded via existing awardDiscordPoints() with syncId idempotency"
    - "Members not found in MEE6 get zero-XP records"
    - "Leftover XP carries to next sync cycle"
    - "Consecutive failures trigger admin alert after 3 attempts"
  artifacts:
    - path: "src/jobs/mee6-sync.ts"
      provides: "MEE6 XP sync logic"
      exports: ["syncMee6Xp", "SyncStats"]
    - path: "src/jobs/types.ts"
      provides: "Job-related type definitions"
      exports: ["SyncResult", "SyncStats"]
    - path: "src/points/service.ts"
      provides: "Extended points service with negative delta support"
      contains: "xpDelta < 0"
  key_links:
    - from: "src/jobs/mee6-sync.ts"
      to: "src/mee6/client.ts"
      via: "fetchAllMemberXp"
      pattern: "import.*fetchAllMemberXp"
    - from: "src/jobs/mee6-sync.ts"
      to: "src/points/service.ts"
      via: "awardDiscordPoints"
      pattern: "awardDiscordPoints"
    - from: "src/jobs/mee6-sync.ts"
      to: "prisma.discordActivity"
      via: "database records"
      pattern: "prisma\\.discordActivity"
---

<objective>
Create MEE6 XP synchronization logic that converts Discord activity to points.

Purpose: Core sync job that fetches MEE6 XP, calculates deltas, records activity, and awards/deducts points - the heart of the Discord integration.

Output: Sync function ready to be scheduled (src/jobs/mee6-sync.ts).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-mee6-discord-integration/30-CONTEXT.md
@.planning/phases/30-mee6-discord-integration/30-RESEARCH.md
@.planning/phases/30-mee6-discord-integration/30-01-SUMMARY.md

# Critical existing code
@src/points/service.ts (awardDiscordPoints)
@prisma/schema.prisma (DiscordActivity model)
@src/reconciliation/index.ts (job pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create job types</name>
  <files>src/jobs/types.ts</files>
  <action>
Create types for background job results and statistics.

Define:
1. `SyncResult` interface:
   - memberId: string
   - discordId: string
   - xpBefore: number | null (null if first sync)
   - xpAfter: number
   - xpDelta: number
   - pointsAwarded: number
   - leftoverXp: number
   - isFirstSync: boolean

2. `SyncStats` interface:
   - totalMembers: number (TRC members with Discord linked)
   - membersInMee6: number (found in MEE6 leaderboard)
   - membersNotInMee6: number (not found, created zero-XP record)
   - pointsAwarded: number (total across all members)
   - pointsDeducted: number (total negative points)
   - firstSyncs: number (baseline records created)
   - errors: number (individual sync failures)
   - syncId: string
   - startedAt: Date
   - completedAt: Date

3. `StreakStats` interface (for Plan 03):
   - membersProcessed: number
   - streaksIncremented: number
   - streaksReset: number
   - errors: number
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit src/jobs/types.ts`
  </verify>
  <done>
    Job types defined for sync statistics and individual results.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend points service for negative deltas</name>
  <files>src/points/service.ts</files>
  <action>
Update awardDiscordPoints() to handle negative XP deltas per CONTEXT.md decision.

Modify behavior when xpDelta < 0:
1. Calculate negative points: floor(|xpDelta| / 100) * pointsPerUnit * -1
2. If calculated points < 0, create PointTransaction with negative value
3. Log negative delta for audit: logger.info with details
4. Return { awarded: true, points: negativeValue } to indicate deduction

Keep idempotency check unchanged - same syncId should not process twice.

Skip the "XP delta too small" early return when delta is negative (any negative delta should be processed if it rounds to at least -1 point).

Add comment explaining: "Per CONTEXT.md: Deduct points proportionally when XP decreases (admin removes XP = member loses points)"
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit src/points/service.ts`
  </verify>
  <done>
    awardDiscordPoints handles both positive and negative XP deltas correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create MEE6 sync function</name>
  <files>src/jobs/mee6-sync.ts</files>
  <action>
Create the core sync function that processes all TRC members.

Implement `syncMee6Xp()`:

1. **Early exit checks:**
   - Return early if MEE6_SYNC_ENABLED !== 'true'
   - Log info and return empty stats

2. **Generate sync context:**
   - Create unique syncId: `mee6-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`
   - Track failure count using module-level variable (reset on success)

3. **Fetch TRC members with Discord:**
   - Query: `prisma.member.findMany({ where: { discordId: { not: null } }, select: { id, discordId } })`

4. **Fetch MEE6 data:**
   - Use fetchAllMemberXp() with member Discord IDs
   - Wrap in try/catch, on error: increment failure count, log, return

5. **Process each member:**
   For each TRC member:
   a. Get latest DiscordActivity record (most recent syncedAt)
   b. Get current XP from MEE6 map (0 if not found)
   c. Calculate:
      - xpBefore = last record's xpTotal or null
      - xpDelta = xpAfter - (xpBefore ?? xpAfter) // First sync = 0 delta
      - leftoverXp = handle per CONTEXT.md (add to delta before dividing)
   d. Create DiscordActivity record:
      - activityType: 'MESSAGE' (MEE6 tracks messages)
      - xpDelta: calculated delta (null for first sync)
      - xpTotal: current XP
   e. Award points if xpDelta != 0:
      - Call awardDiscordPoints(memberId, xpDelta, syncId)
   f. Update Member.lastActiveAt if points awarded (positive only)
   g. Track in results array

6. **Handle missing members:**
   - For members not in MEE6: create DiscordActivity with xpTotal: 0, xpDelta: null
   - Per CONTEXT.md: "Create zero-XP DiscordActivity record for members not found"

7. **Admin alert on consecutive failures:**
   - If failure count >= 3: log error to Sentry with specific message
   - Reset failure count on successful sync

8. **Return SyncStats** with all metrics

Export function and SyncStats type.
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit src/jobs/mee6-sync.ts`
  </verify>
  <done>
    Sync function processes all members, calculates deltas, awards points, handles edge cases.
  </done>
</task>

</tasks>

<verification>
1. All files compile: `npm run build`
2. Sync function handles first-sync baseline correctly (zero delta, no points)
3. Sync function handles missing MEE6 members (zero-XP record)
4. Points service accepts negative deltas
5. SyncId provides idempotency via existing pattern
</verification>

<success_criteria>
- src/jobs/types.ts exports SyncResult, SyncStats, StreakStats
- src/points/service.ts handles negative xpDelta (deductions)
- src/jobs/mee6-sync.ts exports syncMee6Xp function
- Sync creates DiscordActivity records for all TRC members
- First sync = baseline (xpDelta null, no points)
- Subsequent syncs = delta calculation and point awards
- Failure count tracks consecutive API failures for admin alert
</success_criteria>

<output>
After completion, create `.planning/phases/30-mee6-discord-integration/30-02-SUMMARY.md`
</output>
