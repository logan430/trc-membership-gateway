---
phase: 30-mee6-discord-integration
plan: 03
type: execute
wave: 3
depends_on: ["30-02"]
files_modified:
  - src/jobs/streak-calculator.ts
  - src/jobs/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "MEE6 sync runs every 15 minutes (JOBS-01)"
    - "Streak calculation runs daily at 00:05 UTC (JOBS-02)"
    - "All background jobs log errors to Sentry (JOBS-04)"
    - "Background jobs shut down gracefully on SIGTERM (JOBS-05)"
    - "Streaks only count weekdays (Mon-Fri), weekends are grace days"
    - "Streak increments for any point-earning action, not just Discord"
  artifacts:
    - path: "src/jobs/streak-calculator.ts"
      provides: "Daily streak calculation logic"
      exports: ["calculateStreaks", "StreakStats"]
    - path: "src/jobs/index.ts"
      provides: "Job scheduler with graceful shutdown"
      exports: ["startJobScheduler", "stopJobScheduler"]
    - path: "src/index.ts"
      provides: "Main app with job integration"
      contains: "startJobScheduler"
  key_links:
    - from: "src/jobs/index.ts"
      to: "node-cron"
      via: "cron.schedule"
      pattern: "cron\\.schedule"
    - from: "src/jobs/index.ts"
      to: "src/jobs/mee6-sync.ts"
      via: "syncMee6Xp"
      pattern: "import.*syncMee6Xp"
    - from: "src/jobs/index.ts"
      to: "src/jobs/streak-calculator.ts"
      via: "calculateStreaks"
      pattern: "import.*calculateStreaks"
    - from: "src/index.ts"
      to: "src/jobs/index.ts"
      via: "scheduler lifecycle"
      pattern: "stopJobScheduler"
---

<objective>
Create streak calculation job and integrate all jobs with graceful shutdown.

Purpose: Complete the background job system - streak tracking for engagement consistency and proper job lifecycle management that shuts down cleanly on deployment.

Output: Fully integrated job scheduler running MEE6 sync (15min) and streak calculation (daily).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-mee6-discord-integration/30-CONTEXT.md
@.planning/phases/30-mee6-discord-integration/30-RESEARCH.md
@.planning/phases/30-mee6-discord-integration/30-01-SUMMARY.md
@.planning/phases/30-mee6-discord-integration/30-02-SUMMARY.md

# Critical existing code
@src/index.ts (graceful shutdown pattern)
@src/reconciliation/index.ts (node-cron pattern)
@prisma/schema.prisma (Member.currentStreak, lastActiveAt)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create streak calculation function</name>
  <files>src/jobs/streak-calculator.ts</files>
  <action>
Create daily streak calculation logic per CONTEXT.md decisions.

Implement `calculateStreaks()`:

1. **Determine reference date:**
   - Get current UTC date (today at 00:00 UTC)
   - Calculate "expected last active" date for streak continuation

2. **Weekday-only logic:**
   - Create helper `isWeekday(date: Date): boolean` (Mon=1 through Fri=5)
   - Streak continues if member was active on the previous weekday
   - Saturday/Sunday are automatic grace days (streak doesn't break over weekend)

3. **Process all members:**
   Query: `prisma.member.findMany({ where: { subscriptionStatus: { in: ['ACTIVE', 'TRIALING'] } }, select: { id, currentStreak, lastActiveAt } })`

   For each member:
   a. If lastActiveAt is null: streak = 0 (never active)
   b. Calculate expected active date (last weekday before today)
   c. Compare member's lastActiveAt to expected date:
      - If lastActiveAt >= expected date at midnight: streak continues
      - Otherwise: streak resets to 0

4. **Streak update logic:**
   Per CONTEXT.md: "Active day = any point-earning action"
   - Member.lastActiveAt is updated by points service when points awarded
   - Streak job just validates and resets if broken

   For members with valid streak continuation:
   - Increment: `currentStreak + 1`

   For members with broken streak:
   - Reset: `currentStreak = 0`

5. **Batch update with transaction:**
   - Group members by action (increment vs reset)
   - Use prisma.$transaction for atomic updates
   - Update in batches of 100 for performance

6. **Return StreakStats** from types.ts

Helper function `getExpectedActiveDate(today: Date): Date`:
- Start with yesterday
- Skip backwards over weekends to find last weekday
- Return that date at midnight UTC
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit src/jobs/streak-calculator.ts`
  </verify>
  <done>
    Streak calculation handles weekday-only logic and resets broken streaks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create job scheduler with graceful shutdown</name>
  <files>src/jobs/index.ts</files>
  <action>
Create centralized job scheduler following reconciliation/index.ts pattern.

Implement:

1. **Track scheduled tasks:**
   ```typescript
   import cron, { ScheduledTask } from 'node-cron';
   const scheduledTasks: ScheduledTask[] = [];
   ```

2. **startJobScheduler() function:**

   a. MEE6 sync job (every 15 minutes):
   ```typescript
   const mee6Job = cron.schedule('*/15 * * * *', async () => {
     try {
       const stats = await syncMee6Xp();
       logger.info({ stats }, 'MEE6 sync completed');
     } catch (error) {
       logger.error({ error }, 'MEE6 sync job failed');
       // Sentry captures via existing integration
     }
   });
   scheduledTasks.push(mee6Job);
   ```

   b. Streak calculation job (daily at 00:05 UTC):
   ```typescript
   const streakJob = cron.schedule('5 0 * * *', async () => {
     try {
       const stats = await calculateStreaks();
       logger.info({ stats }, 'Streak calculation completed');
     } catch (error) {
       logger.error({ error }, 'Streak calculation job failed');
     }
   }, { timezone: 'UTC' });
   scheduledTasks.push(streakJob);
   ```

   c. Log scheduler started

3. **stopJobScheduler() function:**
   - Iterate scheduledTasks and call task.stop() on each
   - Clear the array
   - Log scheduler stopped

Export both functions.
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit src/jobs/index.ts`
  </verify>
  <done>
    Job scheduler manages MEE6 sync (15min) and streak (daily) with stop capability.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate jobs into main app with graceful shutdown</name>
  <files>src/index.ts</files>
  <action>
Integrate job scheduler into the main application.

Changes:

1. **Import job scheduler:**
   ```typescript
   import { startJobScheduler, stopJobScheduler } from './jobs/index.js';
   ```

2. **Start jobs after bot is ready:**
   In the startBot().then() callback, add:
   ```typescript
   // Start job scheduler (MEE6 sync, streak calculation)
   startJobScheduler();
   ```
   Place AFTER startReconciliationScheduler() call.

3. **Stop jobs in graceful shutdown:**
   In gracefulShutdown() function, add BEFORE "Stop accepting new HTTP connections":
   ```typescript
   // Stop background jobs
   stopJobScheduler();
   logger.info('Background jobs stopped');
   ```

Maintain existing shutdown order:
1. Stop background jobs (NEW)
2. Stop HTTP server
3. Disconnect Discord
4. Close database
  </action>
  <verify>
    Server starts: `npm run build && npm start` (verify logs show job scheduler started)
    Server stops: Send SIGTERM and verify logs show jobs stopped
  </verify>
  <done>
    Jobs start on app startup, stop gracefully on SIGTERM.
  </done>
</task>

</tasks>

<verification>
1. All files compile: `npm run build`
2. Server startup logs show "Job scheduler started"
3. SIGTERM triggers "Background jobs stopped" before other shutdown steps
4. Cron expressions are correct:
   - MEE6 sync: `*/15 * * * *` (every 15 minutes)
   - Streak: `5 0 * * *` with timezone: 'UTC' (00:05 UTC daily)
5. Streak logic skips weekends correctly
</verification>

<success_criteria>
- src/jobs/streak-calculator.ts exports calculateStreaks with weekday-only logic
- src/jobs/index.ts exports startJobScheduler and stopJobScheduler
- Job scheduler starts 2 cron jobs: MEE6 sync (15min) and streak (daily 00:05 UTC)
- Graceful shutdown stops jobs before closing HTTP server
- Jobs log to Sentry on error via existing logger.error pattern
- JOBS-01, JOBS-02, JOBS-04, JOBS-05 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/30-mee6-discord-integration/30-03-SUMMARY.md`
</output>
