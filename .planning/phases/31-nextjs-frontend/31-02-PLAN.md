---
phase: 31-nextjs-frontend
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/index.ts
  - src/auth/session.ts
autonomous: true

must_haves:
  truths:
    - "Express proxies /dashboard/* requests to Next.js on port 3000"
    - "httpOnly cookies are forwarded through the proxy"
    - "Refresh token cookie path changed to '/' for cross-app access"
  artifacts:
    - path: "src/index.ts"
      provides: "Proxy middleware mounting"
      contains: "createProxyMiddleware"
    - path: "src/auth/session.ts"
      provides: "Updated cookie path configuration"
      contains: "path: '/'"
  key_links:
    - from: "src/index.ts"
      to: "http://localhost:3000"
      via: "http-proxy-middleware target"
      pattern: "target.*3000"
---

<objective>
Add http-proxy-middleware to Express to forward /dashboard/* requests to Next.js, and modify cookie configuration for cross-app authentication.

Purpose: Enable Express (port 4000) to serve as the single entry point, proxying dashboard requests to Next.js (port 3000) while preserving authentication cookies.

Output: Express forwards dashboard requests with cookies intact, enabling shared session between apps.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-nextjs-frontend/31-RESEARCH.md
@src/index.ts
@src/auth/session.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install http-proxy-middleware and add proxy to Express</name>
  <files>
    package.json
    src/index.ts
  </files>
  <action>
1. Install http-proxy-middleware in the root Express app:
```bash
npm install http-proxy-middleware
```

2. Add type declarations import at top of `src/index.ts`:
```typescript
import { createProxyMiddleware } from 'http-proxy-middleware';
```

3. Mount the proxy middleware BEFORE the existing `/dashboard` route in `src/index.ts`. Find this line:
```typescript
// Dashboard routes (subscription status, claim availability)
app.use('/dashboard', dashboardRouter);
```

Insert the proxy middleware ABOVE it (the proxy handles /dashboard/* for Next.js, existing dashboardRouter handles API-like /dashboard routes):

```typescript
// =============================================================================
// NEXT.JS DASHBOARD PROXY
// =============================================================================
// Proxy /dashboard/* requests to Next.js app running on port 3000
// Must be mounted BEFORE other /dashboard routes
// =============================================================================

// Only enable proxy in development or when NEXT_APP_URL is set
if (env.NODE_ENV === 'development' || process.env.NEXT_APP_URL) {
  const nextAppUrl = process.env.NEXT_APP_URL || 'http://localhost:3000';

  app.use('/dashboard', createProxyMiddleware({
    target: nextAppUrl,
    changeOrigin: true,
    ws: true, // WebSocket support for HMR in dev
    // Forward cookies for authentication
    on: {
      proxyReq: (proxyReq, req) => {
        // Forward all cookies to Next.js
        const cookies = req.headers.cookie;
        if (cookies) {
          proxyReq.setHeader('Cookie', cookies);
        }
      },
      proxyRes: (proxyRes, req, res) => {
        // Log proxy requests in development
        if (env.NODE_ENV === 'development') {
          logger.debug({
            path: req.url,
            status: proxyRes.statusCode
          }, 'Dashboard proxy request');
        }
      },
    },
  }));

  logger.info({ target: nextAppUrl }, 'Dashboard proxy enabled');
}

// Dashboard routes (subscription status, claim availability)
// NOTE: These only match if proxy didn't handle the request (proxy runs first)
app.use('/dashboard', dashboardRouter);
```

Important: The proxy must be BEFORE dashboardRouter. When Next.js is running, it handles /dashboard/*. When Next.js is not running (or in production without NEXT_APP_URL), dashboardRouter handles legacy routes.

4. Add NEXT_APP_URL to the env schema if needed. Check if `src/config/env.ts` exists and add optional env var:
```typescript
// In env schema (if using zod for env validation)
NEXT_APP_URL: z.string().url().optional(),
```
If no env validation exists, the code above uses `process.env.NEXT_APP_URL` directly with fallback.
  </action>
  <verify>
- `grep "http-proxy-middleware" package.json` (dependency added)
- `grep "createProxyMiddleware" src/index.ts` (import added)
- `grep "NEXT_APP_URL" src/index.ts` (config reference exists)
  </verify>
  <done>Proxy middleware installed and mounted in Express before dashboard routes</done>
</task>

<task type="auto">
  <name>Task 2: Modify cookie path for cross-app authentication</name>
  <files>
    src/auth/session.ts
  </files>
  <action>
Modify the refresh token cookie configuration to allow access from both Express and Next.js apps.

Current configuration (line 64-70 in src/auth/session.ts):
```typescript
export const REFRESH_COOKIE_OPTIONS = {
  httpOnly: true,
  secure: env.NODE_ENV === 'production',
  sameSite: 'strict' as const,
  path: '/auth/refresh',  // <-- PROBLEM: Only accessible at /auth/refresh
  maxAge: 30 * 24 * 60 * 60,
};
```

The current `path: '/auth/refresh'` restricts cookie access to only the refresh endpoint. This prevents Next.js middleware from reading the cookie.

**Change 1:** Update REFRESH_COOKIE_OPTIONS:
```typescript
export const REFRESH_COOKIE_OPTIONS = {
  httpOnly: true,
  secure: env.NODE_ENV === 'production',
  sameSite: 'lax' as const,  // Changed from 'strict' to 'lax' for cross-app
  path: '/',                  // Changed from '/auth/refresh' to '/' for cross-app access
  maxAge: 30 * 24 * 60 * 60,
};
```

**Why these changes:**
- `path: '/'` - Cookie accessible on all routes, including /dashboard/*
- `sameSite: 'lax'` - Still secure (prevents CSRF on non-GET) but allows cookie on same-site navigation to dashboard

**Note on existing sessions:** Existing cookies with `path: '/auth/refresh'` will still work for refresh endpoint but won't be accessible in Next.js. Users may need to re-login once. This is acceptable for the feature rollout.

**Add a comment** explaining the choice:
```typescript
// Cookie configuration for refresh token
// path: '/' enables access from both Express and Next.js dashboard
// sameSite: 'lax' allows cookie on same-site navigation while still preventing CSRF on POST
export const REFRESH_COOKIE_NAME = 'trc_refresh';

export const REFRESH_COOKIE_OPTIONS = {
  httpOnly: true,
  secure: env.NODE_ENV === 'production',
  sameSite: 'lax' as const,
  path: '/',
  maxAge: 30 * 24 * 60 * 60, // 30 days in seconds
};
```
  </action>
  <verify>
- `grep "path: '/'" src/auth/session.ts` (path changed to root)
- `grep "sameSite: 'lax'" src/auth/session.ts` (sameSite updated)
  </verify>
  <done>Cookie path changed to '/' for cross-app access, sameSite updated to 'lax'</done>
</task>

<task type="auto">
  <name>Task 3: Test proxy configuration with Express build</name>
  <files></files>
  <action>
Verify the Express app builds and starts with the new proxy configuration.

1. Build the TypeScript:
```bash
npm run build
```

2. Check for any TypeScript errors related to the proxy middleware.

If there are type errors for http-proxy-middleware:
- Install types: `npm install -D @types/http-proxy-middleware` (though v3.x usually includes types)
- Or use type assertion if needed

3. Verify the import works:
```bash
grep -A5 "import.*createProxyMiddleware" src/index.ts
```

Expected: Clean build with no errors.

Note: Full integration testing (Express + Next.js together) will be done after Plan 31-03 when Next.js auth middleware is complete. This task just verifies Express starts with the proxy code.
  </action>
  <verify>
- `npm run build` completes without errors
- `ls dist/index.js` (compiled output exists)
  </verify>
  <done>Express builds successfully with proxy middleware configured</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds for Express app
2. `grep "createProxyMiddleware" src/index.ts` shows proxy import
3. `grep "path: '/'" src/auth/session.ts` shows updated cookie path
4. `grep "sameSite: 'lax'" src/auth/session.ts` shows updated sameSite
</verification>

<success_criteria>
- http-proxy-middleware installed in Express package.json
- Proxy mounted before dashboardRouter in src/index.ts
- Cookie path changed from '/auth/refresh' to '/'
- Cookie sameSite changed from 'strict' to 'lax'
- Express app builds without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-nextjs-frontend/31-02-SUMMARY.md`
</output>
