---
phase: 32-member-dashboard-pages
plan: 04
type: execute
wave: 2
depends_on: ["32-03"]
files_modified:
  - dashboard/src/lib/api.ts
  - dashboard/src/hooks/useBenchmarks.ts
  - dashboard/src/components/benchmarks/ComparisonBar.tsx
  - dashboard/src/components/benchmarks/MetricComparisonCard.tsx
  - dashboard/src/components/benchmarks/KAnonymityGate.tsx
  - dashboard/src/components/benchmarks/index.ts
  - dashboard/src/app/dashboard/benchmarks/results/page.tsx
autonomous: true

must_haves:
  truths:
    - "Member can view benchmark results with comparison charts"
    - "Results show their value vs peer median/average"
    - "Categories with < 5 submissions show blurred preview with unlock message"
    - "Segment filters allow filtering by company size/industry"
  artifacts:
    - path: "dashboard/src/components/benchmarks/ComparisonBar.tsx"
      provides: "Horizontal bar chart comparing member vs peers"
      exports: ["ComparisonBar"]
    - path: "dashboard/src/components/benchmarks/KAnonymityGate.tsx"
      provides: "Blurred preview component for insufficient data"
      exports: ["KAnonymityGate"]
    - path: "dashboard/src/app/dashboard/benchmarks/results/page.tsx"
      provides: "Benchmark results visualization page"
      min_lines: 100
  key_links:
    - from: "dashboard/src/app/dashboard/benchmarks/results/page.tsx"
      to: "/api/benchmarks/aggregates/:category"
      via: "useAggregates hook"
      pattern: "useAggregates\\("
    - from: "ComparisonBar"
      to: "recharts"
      via: "BarChart component"
      pattern: "from 'recharts'"
---

<objective>
Build the benchmark results page with Recharts visualizations and k-anonymity UI.

Purpose: Members can see how their submitted data compares to peer aggregates using visual charts. Categories without enough data show a compelling blurred preview.

Output: /dashboard/benchmarks/results page with comparison charts, segment filters, and k-anonymity gate.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-member-dashboard-pages/32-CONTEXT.md
@.planning/phases/32-member-dashboard-pages/32-RESEARCH.md

# Existing files
@dashboard/src/lib/api.ts
@src/routes/benchmarks.ts
@src/benchmarks/service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update API client and create aggregates hook</name>
  <files>
    dashboard/src/lib/api.ts
    dashboard/src/hooks/useBenchmarks.ts
  </files>
  <action>
1. Update dashboard/src/lib/api.ts benchmarksApi:
   - Ensure getResults method exists (already there, verify signature):
     ```typescript
     getResults: (category: string, filters?: Record<string, string>) => {
       const params = new URLSearchParams(filters);
       return apiFetch<AggregatesResponse>(`/api/benchmarks/aggregates/${category}?${params}`);
     },
     ```
   - Add AggregatesResponse interface:
     ```typescript
     export interface FieldAggregate {
       field: string;
       median: number;
       average: number;
       p25: number;
       p75: number;
       min: number;
       max: number;
       count: number;
       yourValue?: number;  // Included if member has submitted
     }

     export interface AggregatesResponse {
       category: string;
       available: FieldAggregate[];
       insufficient: { field: string; count: number; needed: number }[];
       filters: {
         companySize?: string;
         industry?: string;
       };
     }
     ```

2. Update dashboard/src/hooks/useBenchmarks.ts:
   - Add useAggregates hook:
     ```typescript
     export function useAggregates(
       category: BenchmarkCategory,
       filters?: { companySize?: string; industry?: string }
     ) {
       return useQuery({
         queryKey: ['benchmarks', 'aggregates', category, filters],
         queryFn: () => benchmarksApi.getResults(category, {
           ...(filters?.companySize && { companySize: filters.companySize }),
           ...(filters?.industry && { industry: filters.industry }),
         }),
         staleTime: 5 * 60_000, // 5 minutes
       });
     }
     ```
  </action>
  <verify>
    - AggregatesResponse interface defined
    - useAggregates hook accepts category and optional filters
    - No TypeScript errors
  </verify>
  <done>Aggregates API types and hook created</done>
</task>

<task type="auto">
  <name>Task 2: Create chart and k-anonymity components</name>
  <files>
    dashboard/src/components/benchmarks/ComparisonBar.tsx
    dashboard/src/components/benchmarks/MetricComparisonCard.tsx
    dashboard/src/components/benchmarks/KAnonymityGate.tsx
    dashboard/src/components/benchmarks/index.ts
  </files>
  <action>
1. Create dashboard/src/components/benchmarks/ComparisonBar.tsx:
   - Port from Chris's app with pixel theme colors
   - Use Recharts BarChart with horizontal layout
   - Three bars: "You" (gold), "Median" (success green), "Average" (muted)
   - Format values with prefix/suffix ($ for money, % for percentages)
   - Props: label, yourValue, median, average, prefix?, suffix?
   - Use theme colors: var(--gold), var(--success), var(--muted-foreground)
   - Mobile responsive: Use ResponsiveContainer for auto-sizing, reduce bar height on mobile

2. Create dashboard/src/components/benchmarks/MetricComparisonCard.tsx:
   - Port from Chris's app
   - Show metric name, your value, and visual range bar
   - Indicate position relative to median (green if above, orange if below)
   - Props: label, yourValue, median, min, max, prefix?, suffix?, higherIsBetter?
   - Mobile responsive: Stack label and value on small screens

3. Create dashboard/src/components/benchmarks/KAnonymityGate.tsx:
   ```typescript
   'use client';

   import { Lock } from 'lucide-react';
   import { Card, Button } from '@/components/ui';

   interface KAnonymityGateProps {
     needed: number;
     current: number;
     category: string;
     onSubmit?: () => void;
   }

   export function KAnonymityGate({ needed, current, category, onSubmit }: KAnonymityGateProps) {
     const remaining = needed - current;

     return (
       <div className="relative">
         {/* Blurred placeholder chart */}
         <div className="blur-sm opacity-50 pointer-events-none">
           <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
             {[1, 2, 3, 4].map((i) => (
               <Card key={i} className="h-24 sm:h-32 bg-accent" />
             ))}
           </div>
         </div>

         {/* Overlay message */}
         <div className="absolute inset-0 flex items-center justify-center p-4">
           <Card className="p-4 sm:p-6 text-center max-w-md pixel-border border-gold/30">
             <Lock className="mx-auto mb-4 text-gold" size={32} />
             <h3 className="font-semibold text-lg mb-2">
               {remaining} more submission{remaining !== 1 ? 's' : ''} needed
             </h3>
             <p className="text-muted-foreground text-sm mb-4">
               To protect privacy, {category} results require at least {needed} submissions.
               Currently there are {current}.
             </p>
             {onSubmit && (
               <Button onClick={onSubmit} variant="primary" className="w-full sm:w-auto">
                 Submit Your Data
               </Button>
             )}
           </Card>
         </div>
       </div>
     );
   }
   ```

4. Update dashboard/src/components/benchmarks/index.ts:
   - Export ComparisonBar, MetricComparisonCard, KAnonymityGate
  </action>
  <verify>
    - ComparisonBar renders Recharts horizontal bar chart
    - MetricComparisonCard shows visual range with position indicator
    - KAnonymityGate shows blurred preview with clear unlock message
    - Theme colors use CSS variables (gold, success, etc.)
    - All components include responsive classes for mobile
  </verify>
  <done>Chart and k-anonymity components created with pixel theme</done>
</task>

<task type="auto">
  <name>Task 3: Create benchmark results page</name>
  <files>
    dashboard/src/app/dashboard/benchmarks/results/page.tsx
  </files>
  <action>
Create dashboard/src/app/dashboard/benchmarks/results/page.tsx:

```typescript
'use client';

import { useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { GoldCoinsLoader, Card, Button } from '@/components/ui';
import {
  ComparisonBar,
  MetricComparisonCard,
  KAnonymityGate,
} from '@/components/benchmarks';
import { useAggregates, useMySubmissions, BenchmarkCategory } from '@/hooks/useBenchmarks';
import { ChevronLeft, Filter } from 'lucide-react';

const categoryLabels: Record<BenchmarkCategory, string> = {
  COMPENSATION: 'Compensation',
  INFRASTRUCTURE: 'Infrastructure',
  BUSINESS: 'Business Metrics',
  OPERATIONAL: 'Operational',
};

const fieldFormats: Record<string, { prefix?: string; suffix?: string; label: string }> = {
  base_salary: { prefix: '$', label: 'Base Salary' },
  equity_percent: { suffix: '%', label: 'Equity Percentage' },
  bonus_target: { suffix: '%', label: 'Bonus Target' },
  total_comp: { prefix: '$', label: 'Total Compensation' },
  monthly_hosting: { prefix: '$', label: 'Monthly Hosting' },
  tool_count: { label: 'Tool Count' },
  monthly_tooling: { prefix: '$', label: 'Monthly Tooling' },
  annual_revenue: { prefix: '$', label: 'Annual Revenue' },
  growth_rate: { suffix: '%', label: 'Growth Rate' },
  cac: { prefix: '$', label: 'CAC' },
  ltv: { prefix: '$', label: 'LTV' },
  team_size: { label: 'Team Size' },
  eng_percent: { suffix: '%', label: 'Engineering %' },
  remote_percent: { suffix: '%', label: 'Remote %' },
};

export default function BenchmarkResultsPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const categoryParam = searchParams.get('category') as BenchmarkCategory | null;

  const [category, setCategory] = useState<BenchmarkCategory>(categoryParam || 'COMPENSATION');
  const [showFilters, setShowFilters] = useState(false);
  const [filters, setFilters] = useState<{ companySize?: string; industry?: string }>({});

  const { data: submissions } = useMySubmissions();
  const { data: aggregates, isLoading, error } = useAggregates(category, filters);

  const hasSubmitted = submissions?.submissions?.some(
    (s: { category: string }) => s.category === category
  );

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <GoldCoinsLoader />
      </div>
    );
  }

  if (error) {
    return (
      <Card className="p-6 text-center">
        <p className="text-muted-foreground">Failed to load benchmark results</p>
      </Card>
    );
  }

  const hasInsufficientData = !aggregates?.available?.length && aggregates?.insufficient?.length;

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-4">
        <button
          onClick={() => router.push('/dashboard/benchmarks')}
          className="p-2 hover:bg-accent rounded-[8px] transition-colors"
        >
          <ChevronLeft size={20} />
        </button>
        <div>
          <h1 className="text-xl sm:text-2xl font-bold text-foreground">
            {categoryLabels[category]} Results
          </h1>
          <p className="text-muted-foreground text-sm sm:text-base">
            See how you compare to your peers
          </p>
        </div>
      </div>

      {/* Category tabs - horizontal scroll on mobile */}
      <div className="flex gap-2 overflow-x-auto pb-2 -mx-4 px-4 sm:mx-0 sm:px-0">
        {(Object.keys(categoryLabels) as BenchmarkCategory[]).map((cat) => (
          <button
            key={cat}
            onClick={() => setCategory(cat)}
            className={`px-3 sm:px-4 py-2 text-sm font-medium whitespace-nowrap rounded-[8px] transition-colors flex-shrink-0 ${
              category === cat
                ? 'bg-gold/10 text-gold-dark border-2 border-gold/30'
                : 'bg-accent text-muted-foreground hover:text-foreground'
            }`}
          >
            {categoryLabels[cat]}
          </button>
        ))}
      </div>

      {/* Filters (collapsed by default per CONTEXT.md) */}
      <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
        <button
          onClick={() => setShowFilters(!showFilters)}
          className="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground"
        >
          <Filter size={16} />
          {showFilters ? 'Hide Filters' : 'Show Filters'}
        </button>
        {Object.keys(filters).length > 0 && (
          <button
            onClick={() => setFilters({})}
            className="text-sm text-gold-dark hover:underline"
          >
            Clear filters
          </button>
        )}
      </div>

      {showFilters && (
        <Card className="p-4">
          <div className="flex flex-col sm:flex-row gap-4">
            <select
              value={filters.companySize || ''}
              onChange={(e) => setFilters({ ...filters, companySize: e.target.value || undefined })}
              className="px-3 py-2 border border-input bg-background rounded-[8px] w-full sm:w-auto min-h-[44px]"
            >
              <option value="">All Company Sizes</option>
              <option value="1-10">1-10 employees</option>
              <option value="11-50">11-50 employees</option>
              <option value="51-200">51-200 employees</option>
              <option value="201+">201+ employees</option>
            </select>
            <select
              value={filters.industry || ''}
              onChange={(e) => setFilters({ ...filters, industry: e.target.value || undefined })}
              className="px-3 py-2 border border-input bg-background rounded-[8px] w-full sm:w-auto min-h-[44px]"
            >
              <option value="">All Industries</option>
              <option value="saas">SaaS</option>
              <option value="agency">Agency</option>
              <option value="ecommerce">E-commerce</option>
              <option value="services">Services</option>
            </select>
          </div>
        </Card>
      )}

      {/* Results content */}
      {hasInsufficientData ? (
        <KAnonymityGate
          needed={5}
          current={aggregates?.insufficient[0]?.count || 0}
          category={categoryLabels[category]}
          onSubmit={!hasSubmitted ? () => router.push('/dashboard/benchmarks') : undefined}
        />
      ) : (
        <div className="space-y-8">
          {/* Comparison bars */}
          {aggregates?.available?.filter(a => a.yourValue !== undefined).map((field) => {
            const format = fieldFormats[field.field] || { label: field.field };
            return (
              <Card key={field.field} className="p-4 sm:p-6">
                <ComparisonBar
                  label={format.label}
                  yourValue={field.yourValue!}
                  median={field.median}
                  average={field.average}
                  prefix={format.prefix}
                  suffix={format.suffix}
                />
              </Card>
            );
          })}

          {/* Metric comparison cards */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {aggregates?.available?.filter(a => a.yourValue !== undefined).map((field) => {
              const format = fieldFormats[field.field] || { label: field.field };
              return (
                <MetricComparisonCard
                  key={field.field}
                  label={format.label}
                  yourValue={field.yourValue!}
                  median={field.median}
                  min={field.min}
                  max={field.max}
                  prefix={format.prefix}
                  suffix={format.suffix}
                />
              );
            })}
          </div>

          {!hasSubmitted && (
            <Card className="p-6 text-center">
              <p className="text-muted-foreground mb-4">
                Submit your data to see how you compare!
              </p>
              <Button onClick={() => router.push('/dashboard/benchmarks')} className="w-full sm:w-auto">
                Submit Benchmark
              </Button>
            </Card>
          )}
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>
    - cd dashboard && npm run build succeeds
    - Navigate to /dashboard/benchmarks/results
    - Category tabs switch between categories
    - If data available: ComparisonBar charts show your value vs peers
    - If insufficient data: KAnonymityGate shows blurred preview with message
    - Filters panel expands/collapses
    - Filter selections update the displayed data
    - Mobile test at 375px width:
      - Category tabs scroll horizontally
      - Charts resize to fit screen
      - Filter dropdowns are full-width
      - Cards stack to single column
      - Back button and header are readable
  </verify>
  <done>Benchmark results page complete with charts, filters, and k-anonymity gate</done>
</task>

</tasks>

<verification>
1. Navigate to /dashboard/benchmarks/results - page loads
2. Select different category tabs - data changes
3. If you have submitted: see your values compared to peers in bar charts
4. If category has < 5 submissions: see blurred preview with unlock message
5. Click filter button - filter panel appears
6. Select filters - aggregates update based on segment
7. Network tab shows /api/benchmarks/aggregates/:category calls
8. Mobile test at 375px width:
   - Page title and back button visible
   - Category tabs horizontally scrollable
   - Charts render at appropriate size
   - Filter dropdowns are touch-friendly (44px+ height)
   - K-anonymity gate centered and readable
   - Metric cards stack to single column
</verification>

<success_criteria>
- UI-03: Benchmark results page with Recharts visualizations
- UI-11: Mobile responsive - verified at 375px breakpoint
- BENCH-08: ComparisonBar and MetricComparisonCard charts working
- BENCH-06: K-anonymity gate shows when < 5 submissions
- BENCH-09: Segment filters (company size, industry) work
</success_criteria>

<output>
After completion, create `.planning/phases/32-member-dashboard-pages/32-04-SUMMARY.md`
</output>
