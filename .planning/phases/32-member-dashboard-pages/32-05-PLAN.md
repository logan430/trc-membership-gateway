---
phase: 32-member-dashboard-pages
plan: 05
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - dashboard/src/lib/api.ts
  - dashboard/src/hooks/useLeaderboard.ts
  - dashboard/src/components/leaderboard/LeaderboardTable.tsx
  - dashboard/src/components/leaderboard/RankBadge.tsx
  - dashboard/src/components/leaderboard/index.ts
  - dashboard/src/app/dashboard/leaderboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Member can view top 25 members ranked by points"
    - "Member sees their own rank even if outside top 25"
    - "Leaderboard has supportive tone focusing on personal progress"
    - "Loading state shows while data fetches"
  artifacts:
    - path: "dashboard/src/hooks/useLeaderboard.ts"
      provides: "Leaderboard data hook"
      exports: ["useLeaderboard"]
    - path: "dashboard/src/components/leaderboard/LeaderboardTable.tsx"
      provides: "Leaderboard table with pinned member row"
      exports: ["LeaderboardTable"]
    - path: "dashboard/src/app/dashboard/leaderboard/page.tsx"
      provides: "Leaderboard page"
      min_lines: 80
  key_links:
    - from: "dashboard/src/app/dashboard/leaderboard/page.tsx"
      to: "/api/leaderboard"
      via: "useLeaderboard hook"
      pattern: "useLeaderboard\\("
---

<objective>
Build the leaderboard page with supportive tone and member position pinning.

Purpose: Members can see how they rank among peers, with their position always visible. Supportive messaging focuses on personal progress rather than competition.

Output: /dashboard/leaderboard page with top 25 rankings, pinned member row, and "how to earn points" section.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-member-dashboard-pages/32-CONTEXT.md
@.planning/phases/32-member-dashboard-pages/32-RESEARCH.md

# Note: Leaderboard backend API needs to be created or may use points data
# Check if /api/leaderboard exists, otherwise build from points/summary
@src/routes/points.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create leaderboard API endpoint and hook</name>
  <files>
    src/routes/leaderboard.ts
    src/index.ts
    dashboard/src/lib/api.ts
    dashboard/src/hooks/useLeaderboard.ts
  </files>
  <action>
1. Create src/routes/leaderboard.ts (backend API):
   ```typescript
   /**
    * Member-facing leaderboard API
    */
   import { Router } from 'express';
   import { requireAuth, type AuthenticatedRequest } from '../middleware/session.js';
   import { prisma } from '../lib/prisma.js';

   export const leaderboardRouter = Router();

   /**
    * GET /api/leaderboard
    * Returns top 25 members and current member's rank
    */
   leaderboardRouter.get('/', requireAuth, async (req: AuthenticatedRequest, res) => {
     const memberId = req.memberId!;

     // Get top 25 by totalPoints
     const topMembers = await prisma.member.findMany({
       where: {
         totalPoints: { gt: 0 },
         subscriptionStatus: 'ACTIVE',
       },
       orderBy: { totalPoints: 'desc' },
       take: 25,
       select: {
         id: true,
         discordUsername: true,
         totalPoints: true,
         currentStreak: true,
       },
     });

     // Get current member's data
     const currentMember = await prisma.member.findUnique({
       where: { id: memberId },
       select: {
         id: true,
         discordUsername: true,
         totalPoints: true,
         currentStreak: true,
       },
     });

     // Calculate current member's rank
     let currentMemberRank = 0;
     if (currentMember) {
       const membersAbove = await prisma.member.count({
         where: {
           totalPoints: { gt: currentMember.totalPoints },
           subscriptionStatus: 'ACTIVE',
         },
       });
       currentMemberRank = membersAbove + 1;
     }

     // Get total participant count
     const totalParticipants = await prisma.member.count({
       where: {
         totalPoints: { gt: 0 },
         subscriptionStatus: 'ACTIVE',
       },
     });

     res.json({
       topMembers: topMembers.map((m, i) => ({
         ...m,
         rank: i + 1,
         isCurrent: m.id === memberId,
       })),
       currentMember: currentMember ? {
         ...currentMember,
         rank: currentMemberRank,
       } : null,
       totalParticipants,
     });
   });
   ```

2. Register the router in src/index.ts:
   - Import leaderboardRouter
   - Add: app.use('/api/leaderboard', leaderboardRouter);

3. Update dashboard/src/lib/api.ts:
   - Add leaderboardApi:
     ```typescript
     export interface LeaderboardMember {
       id: string;
       discordUsername: string | null;
       totalPoints: number;
       currentStreak: number;
       rank: number;
       isCurrent?: boolean;
     }

     export interface LeaderboardResponse {
       topMembers: LeaderboardMember[];
       currentMember: LeaderboardMember | null;
       totalParticipants: number;
     }

     export const leaderboardApi = {
       get: () => apiFetch<LeaderboardResponse>('/api/leaderboard'),
     };
     ```

4. Create dashboard/src/hooks/useLeaderboard.ts:
   ```typescript
   'use client';

   import { useQuery } from '@tanstack/react-query';
   import { leaderboardApi } from '@/lib/api';

   export function useLeaderboard() {
     return useQuery({
       queryKey: ['leaderboard'],
       queryFn: () => leaderboardApi.get(),
       staleTime: 5 * 60_000, // 5 minutes per JOBS-03
       refetchInterval: 5 * 60_000, // Auto-refresh every 5 minutes
     });
   }
   ```
  </action>
  <verify>
    - src/routes/leaderboard.ts created
    - Router registered in src/index.ts
    - No TypeScript errors in backend: npx tsc --noEmit
    - No TypeScript errors in dashboard: cd dashboard && npx tsc --noEmit
  </verify>
  <done>Leaderboard API endpoint and hook created</done>
</task>

<task type="auto">
  <name>Task 2: Create leaderboard components</name>
  <files>
    dashboard/src/components/leaderboard/LeaderboardTable.tsx
    dashboard/src/components/leaderboard/RankBadge.tsx
    dashboard/src/components/leaderboard/index.ts
  </files>
  <action>
1. Create dashboard/src/components/leaderboard/RankBadge.tsx:
   ```typescript
   import { Trophy, Medal, Award } from 'lucide-react';

   interface RankBadgeProps {
     rank: number;
   }

   export function RankBadge({ rank }: RankBadgeProps) {
     if (rank === 1) {
       return (
         <div className="flex items-center justify-center w-8 h-8 bg-gold/20 rounded-full">
           <Trophy className="text-gold" size={16} />
         </div>
       );
     }
     if (rank === 2) {
       return (
         <div className="flex items-center justify-center w-8 h-8 bg-gray-300/20 rounded-full">
           <Medal className="text-gray-400" size={16} />
         </div>
       );
     }
     if (rank === 3) {
       return (
         <div className="flex items-center justify-center w-8 h-8 bg-amber-600/20 rounded-full">
           <Award className="text-amber-600" size={16} />
         </div>
       );
     }
     return (
       <div className="flex items-center justify-center w-8 h-8">
         <span className="text-sm font-medium text-muted-foreground">#{rank}</span>
       </div>
     );
   }
   ```

2. Create dashboard/src/components/leaderboard/LeaderboardTable.tsx:
   ```typescript
   'use client';

   import { Flame, User } from 'lucide-react';
   import { RankBadge } from './RankBadge';
   import type { LeaderboardMember } from '@/lib/api';

   interface LeaderboardTableProps {
     members: LeaderboardMember[];
     currentMember: LeaderboardMember | null;
   }

   export function LeaderboardTable({ members, currentMember }: LeaderboardTableProps) {
     const memberInTop25 = members.some((m) => m.isCurrent);

     return (
       <div className="relative">
         <div className="border border-border rounded-[8px] overflow-hidden">
           {/* Header */}
           <div className="px-4 py-3 bg-accent border-b border-border grid grid-cols-12 gap-2 text-sm font-medium text-muted-foreground">
             <div className="col-span-1">Rank</div>
             <div className="col-span-7">Member</div>
             <div className="col-span-2 text-right">Streak</div>
             <div className="col-span-2 text-right">Points</div>
           </div>

           {/* Rows */}
           <div className="divide-y divide-border">
             {members.map((member) => (
               <div
                 key={member.id}
                 className={`px-4 py-3 grid grid-cols-12 gap-2 items-center ${
                   member.isCurrent ? 'bg-gold/5' : ''
                 }`}
               >
                 <div className="col-span-1">
                   <RankBadge rank={member.rank} />
                 </div>
                 <div className="col-span-7 flex items-center gap-3">
                   <div className="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
                     <User size={16} className="text-muted-foreground" />
                   </div>
                   <div>
                     <span className="font-medium">
                       {member.discordUsername || 'Anonymous'}
                     </span>
                     {member.isCurrent && (
                       <span className="ml-2 text-xs text-muted-foreground">(You)</span>
                     )}
                   </div>
                 </div>
                 <div className="col-span-2 text-right">
                   {member.currentStreak > 0 && (
                     <span className="inline-flex items-center gap-1 text-sm text-orange-500">
                       <Flame size={14} />
                       {member.currentStreak}
                     </span>
                   )}
                 </div>
                 <div className="col-span-2 text-right">
                   <span className="font-bold">{member.totalPoints.toLocaleString()}</span>
                 </div>
               </div>
             ))}
           </div>
         </div>

         {/* Pinned current member row if outside top 25 */}
         {!memberInTop25 && currentMember && (
           <div className="mt-4 border-2 border-gold/30 rounded-[8px] overflow-hidden pixel-border">
             <div className="px-4 py-3 bg-gold/5 grid grid-cols-12 gap-2 items-center">
               <div className="col-span-1">
                 <RankBadge rank={currentMember.rank} />
               </div>
               <div className="col-span-7 flex items-center gap-3">
                 <div className="w-8 h-8 bg-gold/20 rounded-full flex items-center justify-center">
                   <User size={16} className="text-gold-dark" />
                 </div>
                 <div>
                   <span className="font-medium">
                     {currentMember.discordUsername || 'Anonymous'}
                   </span>
                   <span className="ml-2 text-xs text-muted-foreground">(You)</span>
                 </div>
               </div>
               <div className="col-span-2 text-right">
                 {currentMember.currentStreak > 0 && (
                   <span className="inline-flex items-center gap-1 text-sm text-orange-500">
                     <Flame size={14} />
                     {currentMember.currentStreak}
                   </span>
                 )}
               </div>
               <div className="col-span-2 text-right">
                 <span className="font-bold">{currentMember.totalPoints.toLocaleString()}</span>
               </div>
             </div>
           </div>
         )}
       </div>
     );
   }
   ```

3. Create dashboard/src/components/leaderboard/index.ts:
   - Export LeaderboardTable and RankBadge
  </action>
  <verify>
    - RankBadge shows trophy/medal/award for top 3
    - LeaderboardTable renders member rows with rank, name, streak, points
    - Pinned row appears when member not in top 25
    - Components use pixel theme styling
  </verify>
  <done>Leaderboard components created with pinned member row</done>
</task>

<task type="auto">
  <name>Task 3: Create leaderboard page</name>
  <files>
    dashboard/src/app/dashboard/leaderboard/page.tsx
  </files>
  <action>
Create dashboard/src/app/dashboard/leaderboard/page.tsx:

```typescript
'use client';

import { GoldCoinsLoader, Card } from '@/components/ui';
import { LeaderboardTable } from '@/components/leaderboard';
import { useLeaderboard } from '@/hooks/useLeaderboard';
import { TrendingUp, Coins, Download, MessageSquare } from 'lucide-react';

export default function LeaderboardPage() {
  const { data, isLoading, error } = useLeaderboard();

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <GoldCoinsLoader />
      </div>
    );
  }

  if (error) {
    return (
      <Card className="p-6 text-center">
        <p className="text-muted-foreground">Failed to load leaderboard</p>
      </Card>
    );
  }

  const percentile = data?.currentMember
    ? Math.round((1 - data.currentMember.rank / data.totalParticipants) * 100)
    : 0;

  return (
    <div className="space-y-6">
      {/* Header with supportive messaging */}
      <div>
        <h1 className="text-2xl font-bold text-foreground mb-2">Guild Rankings</h1>
        <p className="text-muted-foreground">
          Track your progress and celebrate the community's achievements.
        </p>
      </div>

      {/* Your progress card - supportive tone per CONTEXT.md */}
      {data?.currentMember && (
        <Card className="p-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-6">
              <div className="text-center">
                <div className="text-4xl font-bold text-gold-dark">
                  #{data.currentMember.rank}
                </div>
                <div className="text-sm text-muted-foreground">Your Rank</div>
              </div>
              <div className="h-12 w-px bg-border" />
              <div>
                <div className="text-lg font-semibold">
                  {data.currentMember.totalPoints.toLocaleString()} points
                </div>
                <div className="text-sm text-muted-foreground">
                  {percentile > 0 && `Top ${100 - percentile}% of the guild`}
                </div>
              </div>
            </div>
            <div className="hidden md:flex items-center gap-2 text-sm text-muted-foreground">
              <TrendingUp size={16} className="text-success" />
              Keep earning to climb the ranks!
            </div>
          </div>
        </Card>
      )}

      {/* Leaderboard table */}
      <div>
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold">Top 25 Members</h2>
          <span className="text-sm text-muted-foreground">
            {data?.totalParticipants || 0} total participants
          </span>
        </div>
        <LeaderboardTable
          members={data?.topMembers || []}
          currentMember={data?.currentMember || null}
        />
      </div>

      {/* How to earn points */}
      <Card>
        <div className="p-4 border-b border-border">
          <h3 className="font-semibold">How to Earn Gold</h3>
        </div>
        <div className="p-4">
          <div className="grid sm:grid-cols-2 gap-4">
            <div className="flex items-center justify-between p-3 bg-accent rounded-[8px]">
              <div className="flex items-center gap-3">
                <Coins size={20} className="text-gold" />
                <span className="text-sm">Submit benchmark data</span>
              </div>
              <span className="font-semibold text-gold-dark">+50</span>
            </div>
            <div className="flex items-center justify-between p-3 bg-accent rounded-[8px]">
              <div className="flex items-center gap-3">
                <Download size={20} className="text-gold" />
                <span className="text-sm">Download a resource</span>
              </div>
              <span className="font-semibold text-gold-dark">+5</span>
            </div>
            <div className="flex items-center justify-between p-3 bg-accent rounded-[8px]">
              <div className="flex items-center gap-3">
                <MessageSquare size={20} className="text-gold" />
                <span className="text-sm">Discord activity (MEE6)</span>
              </div>
              <span className="font-semibold text-gold-dark">+1 / 100 XP</span>
            </div>
            <div className="flex items-center justify-between p-3 bg-accent rounded-[8px]">
              <div className="flex items-center gap-3">
                <TrendingUp size={20} className="text-gold" />
                <span className="text-sm">Complete introduction</span>
              </div>
              <span className="font-semibold text-gold-dark">+25</span>
            </div>
          </div>
        </div>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>
    - cd dashboard && npm run build succeeds
    - Navigate to /dashboard/leaderboard
    - Your rank card shows current position and percentile
    - Top 25 table displays with correct data
    - If rank > 25: pinned row shows at bottom
    - "How to Earn Gold" section displays point values
    - Auto-refresh every 5 minutes (check network tab)
  </verify>
  <done>Leaderboard page complete with supportive messaging and pinned member row</done>
</task>

</tasks>

<verification>
1. Restart Express server (new route added)
2. Navigate to /dashboard/leaderboard
3. Your rank card shows with supportive message
4. Top 25 members display in table
5. If you're outside top 25: your row appears pinned below
6. "How to Earn Gold" shows point actions
7. Network tab: /api/leaderboard called, refetches every 5 min
</verification>

<success_criteria>
- UI-06: Leaderboard page showing rankings
- GAME-09: Top 25 members ranked by total points
- GAME-10: Current member rank shown even if outside top 25
- GAME-13: Current streak shown in leaderboard
- JOBS-03: 5-minute refresh via React Query (client-side)
</success_criteria>

<output>
After completion, create `.planning/phases/32-member-dashboard-pages/32-05-SUMMARY.md`
</output>
