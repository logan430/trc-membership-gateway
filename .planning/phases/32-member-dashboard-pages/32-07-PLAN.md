---
phase: 32-member-dashboard-pages
plan: 07
type: execute
wave: 3
depends_on: ["32-01", "32-06"]
files_modified:
  - dashboard/src/lib/api.ts
  - dashboard/src/hooks/useBilling.ts
  - dashboard/src/app/dashboard/billing/page.tsx
  - dashboard/src/app/dashboard/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Member can view subscription status and payment method"
    - "Member can view invoice history"
    - "Member can access Stripe billing portal"
    - "Navigation works between all dashboard pages"
  artifacts:
    - path: "dashboard/src/hooks/useBilling.ts"
      provides: "Billing data and portal hooks"
      exports: ["useBilling", "useBillingPortal"]
    - path: "dashboard/src/app/dashboard/billing/page.tsx"
      provides: "Billing page with subscription and invoices"
      min_lines: 80
  key_links:
    - from: "dashboard/src/app/dashboard/billing/page.tsx"
      to: "/billing/details"
      via: "useBilling hook"
      pattern: "useBilling\\("
    - from: "useBillingPortal"
      to: "/billing/portal"
      via: "API mutation"
      pattern: "billingApi\\.createPortal"
---

<objective>
Build the billing page with subscription and invoice management, plus final navigation polish.

Purpose: Members can view their subscription status, payment method, invoice history, and access Stripe's billing portal for self-service changes.

Output: /dashboard/billing page with subscription details and Stripe portal link. Complete navigation working between all pages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-member-dashboard-pages/32-CONTEXT.md
@.planning/phases/32-member-dashboard-pages/32-RESEARCH.md

# Existing files
@dashboard/src/lib/api.ts
@src/routes/billing.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing hooks and update API client</name>
  <files>
    dashboard/src/lib/api.ts
    dashboard/src/hooks/useBilling.ts
  </files>
  <action>
1. Update dashboard/src/lib/api.ts:
   - Add billingApi:
     ```typescript
     export interface Invoice {
       id: string;
       date: string;
       amount: number;
       status: string | null;
       pdfUrl: string | null;
       hostedUrl: string | null;
     }

     export interface BillingDetails {
       managedBy?: 'team';
       teamName?: string;
       canManageBilling: boolean;
       subscription: {
         status: string;
         currentPeriodEnd: string | null;
         cancelAtPeriodEnd: boolean;
         planName: string;
       } | null;
       paymentMethod: {
         brand: string;
         last4: string;
         expMonth: number;
         expYear: number;
       } | null;
       invoices: Invoice[];
     }

     export const billingApi = {
       getDetails: () => apiFetch<BillingDetails>('/billing/details'),

       createPortal: () =>
         apiFetch<{ portalUrl: string }>('/billing/portal', {
           method: 'POST',
         }),
     };
     ```

2. Create dashboard/src/hooks/useBilling.ts:
   ```typescript
   'use client';

   import { useQuery, useMutation } from '@tanstack/react-query';
   import { billingApi } from '@/lib/api';

   export function useBilling() {
     return useQuery({
       queryKey: ['billing'],
       queryFn: () => billingApi.getDetails(),
       staleTime: 60_000,
     });
   }

   export function useBillingPortal() {
     return useMutation({
       mutationFn: () => billingApi.createPortal(),
       onSuccess: (data) => {
         // Open Stripe portal in new tab
         window.open(data.portalUrl, '_blank');
       },
     });
   }
   ```
  </action>
  <verify>
    - BillingDetails interface matches backend response
    - billingApi has getDetails and createPortal methods
    - useBilling and useBillingPortal hooks created
    - No TypeScript errors
  </verify>
  <done>Billing hooks and API client methods created</done>
</task>

<task type="auto">
  <name>Task 2: Create billing page</name>
  <files>
    dashboard/src/app/dashboard/billing/page.tsx
  </files>
  <action>
Create dashboard/src/app/dashboard/billing/page.tsx:

```typescript
'use client';

import { GoldCoinsLoader, Card, Button } from '@/components/ui';
import { useBilling, useBillingPortal } from '@/hooks/useBilling';
import {
  CreditCard,
  Calendar,
  FileText,
  ExternalLink,
  AlertCircle,
  CheckCircle,
} from 'lucide-react';

export default function BillingPage() {
  const { data, isLoading, error } = useBilling();
  const portalMutation = useBillingPortal();

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <GoldCoinsLoader />
      </div>
    );
  }

  if (error) {
    return (
      <Card className="p-6 text-center">
        <p className="text-muted-foreground">Failed to load billing details</p>
      </Card>
    );
  }

  // Team member view - billing managed by owner
  if (data?.managedBy === 'team') {
    return (
      <div className="space-y-6 max-w-2xl">
        <div>
          <h1 className="text-2xl font-bold text-foreground mb-2">Billing</h1>
          <p className="text-muted-foreground">
            Your subscription is managed by your team.
          </p>
        </div>

        <Card className="p-6">
          <div className="flex items-start gap-4">
            <div className="p-3 bg-accent rounded-[8px]">
              <CreditCard size={24} className="text-muted-foreground" />
            </div>
            <div>
              <h2 className="font-semibold">Team Subscription</h2>
              <p className="text-muted-foreground text-sm mt-1">
                Billing for your account is managed by <strong>{data.teamName}</strong>.
                Contact your team owner for billing questions.
              </p>
            </div>
          </div>
        </Card>
      </div>
    );
  }

  const formatDate = (dateStr: string | null) => {
    if (!dateStr) return 'N/A';
    return new Date(dateStr).toLocaleDateString('en-US', {
      month: 'long',
      day: 'numeric',
      year: 'numeric',
    });
  };

  const formatAmount = (cents: number) => {
    return `$${(cents / 100).toFixed(2)}`;
  };

  const getStatusBadge = (status: string) => {
    const statusColors: Record<string, string> = {
      active: 'bg-success/10 text-success',
      past_due: 'bg-orange-100 text-orange-600',
      canceled: 'bg-red-100 text-red-600',
      trialing: 'bg-blue-100 text-blue-600',
    };
    return statusColors[status] || 'bg-gray-100 text-gray-600';
  };

  return (
    <div className="space-y-6 max-w-2xl">
      <div>
        <h1 className="text-2xl font-bold text-foreground mb-2">Billing</h1>
        <p className="text-muted-foreground">
          Manage your subscription and payment details.
        </p>
      </div>

      {/* Subscription status */}
      <Card className="p-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="font-semibold">Subscription</h2>
          {data?.subscription && (
            <span
              className={`px-2 py-1 text-xs font-medium rounded-full capitalize ${getStatusBadge(
                data.subscription.status
              )}`}
            >
              {data.subscription.status.replace('_', ' ')}
            </span>
          )}
        </div>

        {data?.subscription ? (
          <div className="space-y-3">
            <div className="flex justify-between">
              <span className="text-muted-foreground">Plan</span>
              <span className="font-medium">{data.subscription.planName}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">
                {data.subscription.cancelAtPeriodEnd ? 'Ends' : 'Renews'}
              </span>
              <span className="font-medium">
                {formatDate(data.subscription.currentPeriodEnd)}
              </span>
            </div>
            {data.subscription.cancelAtPeriodEnd && (
              <div className="flex items-center gap-2 p-3 bg-orange-50 rounded-[8px] text-sm">
                <AlertCircle size={16} className="text-orange-600" />
                <span className="text-orange-700">
                  Your subscription will end on {formatDate(data.subscription.currentPeriodEnd)}
                </span>
              </div>
            )}
          </div>
        ) : (
          <p className="text-muted-foreground">No active subscription</p>
        )}
      </Card>

      {/* Payment method */}
      <Card className="p-6">
        <h2 className="font-semibold mb-4">Payment Method</h2>

        {data?.paymentMethod ? (
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-accent rounded-[8px]">
                <CreditCard size={20} />
              </div>
              <div>
                <p className="font-medium capitalize">
                  {data.paymentMethod.brand} ending in {data.paymentMethod.last4}
                </p>
                <p className="text-sm text-muted-foreground">
                  Expires {data.paymentMethod.expMonth}/{data.paymentMethod.expYear}
                </p>
              </div>
            </div>
          </div>
        ) : (
          <p className="text-muted-foreground">No payment method on file</p>
        )}
      </Card>

      {/* Manage in Stripe button */}
      {data?.canManageBilling && (
        <Button
          onClick={() => portalMutation.mutate()}
          loading={portalMutation.isPending}
          variant="outline"
          className="w-full"
        >
          <ExternalLink size={16} className="mr-2" />
          Manage Billing in Stripe
        </Button>
      )}

      {/* Invoice history */}
      <Card>
        <div className="p-4 border-b border-border">
          <h2 className="font-semibold">Invoice History</h2>
        </div>

        {data?.invoices && data.invoices.length > 0 ? (
          <div className="divide-y divide-border">
            {data.invoices.map((invoice) => (
              <div
                key={invoice.id}
                className="p-4 flex items-center justify-between"
              >
                <div className="flex items-center gap-3">
                  <FileText size={20} className="text-muted-foreground" />
                  <div>
                    <p className="font-medium">{formatDate(invoice.date)}</p>
                    <p className="text-sm text-muted-foreground">
                      {formatAmount(invoice.amount * 100)}
                    </p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <span
                    className={`px-2 py-1 text-xs rounded-full capitalize ${
                      invoice.status === 'paid'
                        ? 'bg-success/10 text-success'
                        : 'bg-gray-100 text-gray-600'
                    }`}
                  >
                    {invoice.status || 'pending'}
                  </span>
                  {invoice.hostedUrl && (
                    <a
                      href={invoice.hostedUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-sm text-gold-dark hover:underline"
                    >
                      View
                    </a>
                  )}
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div className="p-6 text-center text-muted-foreground">
            No invoices yet
          </div>
        )}
      </Card>
    </div>
  );
}
```
  </action>
  <verify>
    - cd dashboard && npm run build succeeds
    - Navigate to /dashboard/billing
    - Subscription status displays with badge
    - Payment method shows card info
    - "Manage Billing" button opens Stripe portal
    - Invoice history lists with status and view links
    - Team member view shows managed-by message
  </verify>
  <done>Billing page created with subscription and invoice display</done>
</task>

<task type="auto">
  <name>Task 3: Final navigation and layout polish</name>
  <files>
    dashboard/src/app/dashboard/layout.tsx
  </files>
  <action>
1. Update dashboard/src/app/dashboard/layout.tsx:
   - Add real gold count from usePointsSummary hook
   - Add real member name from useProfile hook
   - Handle loading state gracefully

   ```typescript
   'use client';

   import { useState } from 'react';
   import { Sidebar, Header } from '@/components/layout';
   import { usePointsSummary } from '@/hooks/usePoints';
   import { useProfile } from '@/hooks/useProfile';

   interface DashboardLayoutProps {
     children: React.ReactNode;
   }

   export default function DashboardLayout({ children }: DashboardLayoutProps) {
     const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

     const { data: points } = usePointsSummary();
     const { data: profile } = useProfile();

     const goldCount = points?.totalPoints ?? 0;
     const memberName = profile?.member?.discordUsername || profile?.member?.email?.split('@')[0] || 'Member';

     return (
       <div className="flex h-screen bg-background">
         {/* Sidebar - hidden on mobile, shown on lg+ */}
         <div className="hidden lg:flex">
           <Sidebar goldCount={goldCount} />
         </div>

         {/* Mobile sidebar overlay */}
         {mobileMenuOpen && (
           <div className="fixed inset-0 z-50 lg:hidden">
             {/* Backdrop */}
             <div
               className="absolute inset-0 bg-foreground/50"
               onClick={() => setMobileMenuOpen(false)}
             />
             {/* Sidebar */}
             <div className="absolute left-0 top-0 h-full w-64 bg-card shadow-lg">
               <Sidebar goldCount={goldCount} />
             </div>
           </div>
         )}

         {/* Main content area */}
         <div className="flex-1 flex flex-col min-w-0">
           <Header
             onMenuClick={() => setMobileMenuOpen(!mobileMenuOpen)}
             memberName={memberName}
           />

           {/* Page content */}
           <main className="flex-1 overflow-y-auto p-6">
             {children}
           </main>
         </div>
       </div>
     );
   }
   ```

2. Verify all navigation links work:
   - Overview (/dashboard)
   - Benchmarks (/dashboard/benchmarks)
   - Benchmarks Results (/dashboard/benchmarks/results)
   - Resources (/dashboard/resources)
   - Leaderboard (/dashboard/leaderboard)
   - Profile (/dashboard/profile)
   - Account (/dashboard/account)
   - Billing (/dashboard/billing)
  </action>
  <verify>
    - cd dashboard && npm run build succeeds
    - Sidebar shows real gold count
    - Header shows real member name
    - All navigation links work (click each in sidebar)
    - Mobile menu opens and closes properly
    - Active page highlighted in sidebar
  </verify>
  <done>Layout updated with real data and all navigation working</done>
</task>

</tasks>

<verification>
1. Start both Express and Next.js servers
2. Login and navigate to /dashboard
3. Sidebar shows real gold count from API
4. Header shows member name
5. Click each sidebar link - all pages load
6. Navigate to /dashboard/billing - shows subscription info
7. Click "Manage Billing" - Stripe portal opens
8. Test mobile view - hamburger menu works
9. All pages show loading states then content
</verification>

<success_criteria>
- UI-09: Billing page (subscription, invoices)
- UI-10: Navigation works between all dashboard pages
- UI-11: Responsive on mobile (verified with menu)
- All sidebar links functional
- Real data displayed in layout (gold count, member name)
</success_criteria>

<output>
After completion, create `.planning/phases/32-member-dashboard-pages/32-07-SUMMARY.md`
</output>
