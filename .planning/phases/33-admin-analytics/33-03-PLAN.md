---
phase: 33-admin-analytics
plan: 03
type: execute
wave: 3
depends_on: ["33-02"]
files_modified:
  - dashboard/src/lib/admin-api.ts
  - dashboard/src/hooks/useAnalytics.ts
  - dashboard/src/components/admin/KpiCard.tsx
  - dashboard/src/components/admin/TimeSeriesChart.tsx
  - dashboard/src/components/admin/ComparisonBarChart.tsx
  - dashboard/src/components/admin/RetentionHeatmap.tsx
  - dashboard/src/components/admin/AtRiskMemberList.tsx
  - dashboard/src/components/admin/DateRangePicker.tsx
  - dashboard/src/components/admin/SegmentFilters.tsx
  - dashboard/src/app/admin/analytics/page.tsx
  - dashboard/src/middleware.ts

autonomous: true

must_haves:
  truths:
    - "Admin can access analytics dashboard at /admin/analytics"
    - "Dashboard shows KPI cards that are clickable to drill into tabs"
    - "Engagement tab shows time-series line chart"
    - "Resources tab shows popular and trending resources"
    - "At-risk section shows churn prediction alerts"
    - "Admin can export data as CSV or JSON from the dashboard"
    - "Data refreshes automatically via polling (ANALYTICS-10)"
  artifacts:
    - path: "dashboard/src/lib/admin-api.ts"
      provides: "Admin analytics API client"
      exports: ["adminApi", "adminAnalyticsApi"]
    - path: "dashboard/src/hooks/useAnalytics.ts"
      provides: "React Query hooks for analytics data"
      exports: ["useOverview", "useEngagement", "useBenchmarkStats", "useResourceStats", "useAtRisk", "useCohorts"]
    - path: "dashboard/src/app/admin/analytics/page.tsx"
      provides: "Admin analytics dashboard page"
      min_lines: 200
    - path: "dashboard/src/components/admin/KpiCard.tsx"
      provides: "Clickable KPI summary card component"
    - path: "dashboard/src/components/admin/TimeSeriesChart.tsx"
      provides: "Line chart for engagement trends"
    - path: "dashboard/src/components/admin/RetentionHeatmap.tsx"
      provides: "Cohort retention heatmap/table"
  key_links:
    - from: "dashboard/src/app/admin/analytics/page.tsx"
      to: "dashboard/src/hooks/useAnalytics.ts"
      via: "React Query hooks"
      pattern: "use(Overview|Engagement|BenchmarkStats)"
    - from: "dashboard/src/hooks/useAnalytics.ts"
      to: "dashboard/src/lib/admin-api.ts"
      via: "API client calls"
      pattern: "adminAnalyticsApi\\."
    - from: "dashboard/src/lib/admin-api.ts"
      to: "/api/admin/analytics"
      via: "Fetch calls"
      pattern: "fetch.*api/admin/analytics"
---

<objective>
Create the admin analytics dashboard frontend with React components, API client, and tabbed interface.

Purpose: Provides admins with a visual interface to analyze member behavior, engagement metrics, benchmark statistics, resource analytics, and churn prediction alerts.

Output: Complete admin analytics page at /admin/analytics with tabbed sections, interactive charts, and export functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-admin-analytics/33-CONTEXT.md
@.planning/phases/33-admin-analytics/33-RESEARCH.md
@.planning/phases/33-admin-analytics/33-01-SUMMARY.md
@.planning/phases/33-admin-analytics/33-02-SUMMARY.md

Key patterns from existing codebase:
- dashboard/src/lib/api.ts: API client pattern with apiFetch
- dashboard/src/hooks/usePoints.ts: React Query hook pattern
- dashboard/src/components/benchmarks/ComparisonBar.tsx: Recharts pattern
- dashboard/src/app/dashboard/layout.tsx: Layout pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Admin API Client and React Query Hooks</name>
  <files>dashboard/src/lib/admin-api.ts, dashboard/src/hooks/useAnalytics.ts, dashboard/src/middleware.ts</files>
  <action>
First, update **dashboard/src/middleware.ts** to allow /admin/* routes. Add to the matcher:

```typescript
export const config = {
  matcher: [
    '/dashboard/:path*',
    '/admin/:path*',  // Add admin routes
  ],
};
```

Note: Admin authentication uses Bearer token from localStorage, not cookies. The middleware validates the member token but admin pages will handle their own auth via localStorage token.

Create **dashboard/src/lib/admin-api.ts**:

```typescript
/**
 * Admin API Client
 *
 * Uses Bearer token from localStorage (admin authentication pattern)
 * Different from member API which uses httpOnly cookies
 */

const TOKEN_KEY = 'adminAccessToken';

class AdminApiError extends Error {
  constructor(
    message: string,
    public status: number
  ) {
    super(message);
    this.name = 'AdminApiError';
  }
}

/**
 * Fetch wrapper for admin API calls
 * Uses Bearer token from localStorage
 */
async function adminFetch<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
  const token = typeof window !== 'undefined' ? localStorage.getItem(TOKEN_KEY) : null;

  if (!token) {
    if (typeof window !== 'undefined') {
      window.location.href = '/app/admin/login';
    }
    throw new AdminApiError('Not authenticated', 401);
  }

  const response = await fetch(endpoint, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`,
      ...options.headers,
    },
  });

  if (response.status === 401) {
    if (typeof window !== 'undefined') {
      localStorage.removeItem(TOKEN_KEY);
      window.location.href = '/app/admin/login';
    }
    throw new AdminApiError('Session expired', 401);
  }

  if (!response.ok) {
    const error = await response.json().catch(() => ({ error: 'Unknown error' }));
    throw new AdminApiError(error.error || 'Request failed', response.status);
  }

  return response.json();
}

// =============================================================================
// Analytics API Types
// =============================================================================

export interface MemberOverview {
  totalMembers: number;
  activeMembers: number;
  inactiveMembers: number;
  newMembers30d: number;
  mrr: number;
}

export interface DailyEngagement {
  date: string;
  benchmarks: number;
  downloads: number;
  discordActivity: number;
  total: number;
}

export interface EngagementTrend {
  data: DailyEngagement[];
  periodStart: string;
  periodEnd: string;
}

export interface EngagementComparison {
  current: EngagementTrend;
  previous: EngagementTrend;
  change: {
    benchmarks: number;
    downloads: number;
    discordActivity: number;
    total: number;
  };
}

export interface CategoryStats {
  category: string;
  submissionCount: number;
  validCount: number;
  flaggedCount: number;
  uniqueMembers: number;
}

export interface BenchmarkStats {
  byCategory: CategoryStats[];
  total: {
    submissions: number;
    validSubmissions: number;
    flaggedSubmissions: number;
    uniqueMembers: number;
  };
}

export interface ResourceStats {
  totalResources: number;
  totalDownloads: number;
  uniqueDownloaders: number;
  downloadsThisPeriod: number;
}

export interface PopularResource {
  id: string;
  title: string;
  type: string;
  downloadCount: number;
  uniqueDownloaders: number;
}

export interface TrendingResource {
  id: string;
  title: string;
  type: string;
  recentDownloads: number;
  previousDownloads: number;
  growthPercent: number;
}

export interface ChurnRiskFactor {
  factor: string;
  points: number;
  description: string;
}

export interface ChurnRiskScore {
  memberId: string;
  email: string;
  discordUsername: string | null;
  score: number;
  riskLevel: 'low' | 'medium' | 'high';
  factors: ChurnRiskFactor[];
  lastActiveAt: string | null;
  subscriptionStatus: string;
}

export interface CohortRow {
  cohort: string;
  month0: number;
  month1: number;
  month2: number;
  month3: number;
  month4: number;
  month5: number;
  month0Pct: number;
  month1Pct: number;
  month2Pct: number;
  month3Pct: number;
  month4Pct: number;
  month5Pct: number;
}

// =============================================================================
// Analytics API Methods
// =============================================================================

export const adminAnalyticsApi = {
  /** Get member overview stats */
  getOverview: () => adminFetch<MemberOverview>('/api/admin/analytics/overview'),

  /** Get engagement trend data */
  getEngagement: (startDate?: string, endDate?: string) => {
    const params = new URLSearchParams();
    if (startDate) params.set('startDate', startDate);
    if (endDate) params.set('endDate', endDate);
    return adminFetch<EngagementTrend>(`/api/admin/analytics/engagement?${params}`);
  },

  /** Get engagement comparison (month-over-month) */
  getEngagementComparison: (startDate?: string, endDate?: string) => {
    const params = new URLSearchParams();
    if (startDate) params.set('startDate', startDate);
    if (endDate) params.set('endDate', endDate);
    return adminFetch<EngagementComparison>(`/api/admin/analytics/engagement/compare?${params}`);
  },

  /** Get benchmark statistics */
  getBenchmarkStats: () => adminFetch<BenchmarkStats>('/api/admin/analytics/benchmarks'),

  /** Get resource statistics */
  getResourceStats: (startDate?: string, endDate?: string) => {
    const params = new URLSearchParams();
    if (startDate) params.set('startDate', startDate);
    if (endDate) params.set('endDate', endDate);
    return adminFetch<ResourceStats>(`/api/admin/analytics/resources?${params}`);
  },

  /** Get popular resources */
  getPopularResources: (limit = 10) =>
    adminFetch<{ resources: PopularResource[] }>(`/api/admin/analytics/resources/popular?limit=${limit}`),

  /** Get trending resources */
  getTrendingResources: (limit = 10) =>
    adminFetch<{ resources: TrendingResource[] }>(`/api/admin/analytics/resources/trending?limit=${limit}`),

  /** Get cohort retention data */
  getCohorts: () => adminFetch<{ cohorts: CohortRow[] }>('/api/admin/analytics/cohorts'),

  /** Get at-risk members */
  getAtRisk: (minScore = 30, limit = 50) =>
    adminFetch<{ members: ChurnRiskScore[]; count: number }>(
      `/api/admin/analytics/at-risk?minScore=${minScore}&limit=${limit}`
    ),

  /** Get single member churn risk */
  getMemberRisk: (memberId: string) => adminFetch<ChurnRiskScore>(`/api/admin/analytics/at-risk/${memberId}`),

  /** Export to CSV - returns URL for download */
  exportCsv: (filters?: Record<string, string>) => {
    const params = new URLSearchParams(filters);
    const token = localStorage.getItem(TOKEN_KEY);
    // Return URL for direct download (browser handles auth via header)
    return `/api/admin/analytics/export/csv?${params}&token=${token}`;
  },

  /** Export to JSON - returns URL for download */
  exportJson: (filters?: Record<string, string>) => {
    const params = new URLSearchParams(filters);
    const token = localStorage.getItem(TOKEN_KEY);
    return `/api/admin/analytics/export/json?${params}&token=${token}`;
  },
};

export { AdminApiError };
```

Create **dashboard/src/hooks/useAnalytics.ts**:

```typescript
'use client';

/**
 * Analytics Data Hooks
 *
 * React Query hooks for admin analytics dashboard.
 * Uses polling (refetchInterval) for real-time updates per ANALYTICS-10.
 */

import { useQuery } from '@tanstack/react-query';
import { adminAnalyticsApi } from '@/lib/admin-api';

// Query key factory
const analyticsKeys = {
  all: ['admin', 'analytics'] as const,
  overview: () => [...analyticsKeys.all, 'overview'] as const,
  engagement: (start?: string, end?: string) => [...analyticsKeys.all, 'engagement', { start, end }] as const,
  engagementCompare: (start?: string, end?: string) => [...analyticsKeys.all, 'engagement', 'compare', { start, end }] as const,
  benchmarks: () => [...analyticsKeys.all, 'benchmarks'] as const,
  resources: (start?: string, end?: string) => [...analyticsKeys.all, 'resources', { start, end }] as const,
  popularResources: (limit: number) => [...analyticsKeys.all, 'resources', 'popular', limit] as const,
  trendingResources: (limit: number) => [...analyticsKeys.all, 'resources', 'trending', limit] as const,
  cohorts: () => [...analyticsKeys.all, 'cohorts'] as const,
  atRisk: (minScore: number, limit: number) => [...analyticsKeys.all, 'at-risk', { minScore, limit }] as const,
};

/**
 * Member overview (total, active, inactive, MRR)
 */
export function useOverview() {
  return useQuery({
    queryKey: analyticsKeys.overview(),
    queryFn: () => adminAnalyticsApi.getOverview(),
    staleTime: 30_000, // 30 seconds
    refetchInterval: 60_000, // Auto-refresh every minute
  });
}

/**
 * Engagement trend data
 */
export function useEngagement(startDate?: string, endDate?: string) {
  return useQuery({
    queryKey: analyticsKeys.engagement(startDate, endDate),
    queryFn: () => adminAnalyticsApi.getEngagement(startDate, endDate),
    staleTime: 30_000,
    refetchInterval: 60_000,
  });
}

/**
 * Engagement comparison (month-over-month)
 */
export function useEngagementComparison(startDate?: string, endDate?: string) {
  return useQuery({
    queryKey: analyticsKeys.engagementCompare(startDate, endDate),
    queryFn: () => adminAnalyticsApi.getEngagementComparison(startDate, endDate),
    staleTime: 30_000,
    refetchInterval: 60_000,
  });
}

/**
 * Benchmark statistics by category
 */
export function useBenchmarkStats() {
  return useQuery({
    queryKey: analyticsKeys.benchmarks(),
    queryFn: () => adminAnalyticsApi.getBenchmarkStats(),
    staleTime: 60_000, // 1 minute
    refetchInterval: 120_000, // 2 minutes
  });
}

/**
 * Resource download statistics
 */
export function useResourceStats(startDate?: string, endDate?: string) {
  return useQuery({
    queryKey: analyticsKeys.resources(startDate, endDate),
    queryFn: () => adminAnalyticsApi.getResourceStats(startDate, endDate),
    staleTime: 30_000,
    refetchInterval: 60_000,
  });
}

/**
 * Popular resources
 */
export function usePopularResources(limit = 10) {
  return useQuery({
    queryKey: analyticsKeys.popularResources(limit),
    queryFn: () => adminAnalyticsApi.getPopularResources(limit),
    staleTime: 60_000,
    refetchInterval: 120_000,
  });
}

/**
 * Trending resources
 */
export function useTrendingResources(limit = 10) {
  return useQuery({
    queryKey: analyticsKeys.trendingResources(limit),
    queryFn: () => adminAnalyticsApi.getTrendingResources(limit),
    staleTime: 60_000,
    refetchInterval: 120_000,
  });
}

/**
 * Cohort retention data
 */
export function useCohorts() {
  return useQuery({
    queryKey: analyticsKeys.cohorts(),
    queryFn: () => adminAnalyticsApi.getCohorts(),
    staleTime: 300_000, // 5 minutes (changes slowly)
    refetchInterval: 300_000,
  });
}

/**
 * At-risk members (churn prediction)
 */
export function useAtRisk(minScore = 30, limit = 50) {
  return useQuery({
    queryKey: analyticsKeys.atRisk(minScore, limit),
    queryFn: () => adminAnalyticsApi.getAtRisk(minScore, limit),
    staleTime: 60_000,
    refetchInterval: 120_000,
  });
}
```
  </action>
  <verify>TypeScript compiles: `cd dashboard && npx tsc --noEmit`</verify>
  <done>Admin API client and React Query hooks created with polling for real-time updates</done>
</task>

<task type="auto">
  <name>Task 2: Create Admin Analytics Components</name>
  <files>dashboard/src/components/admin/KpiCard.tsx, dashboard/src/components/admin/TimeSeriesChart.tsx, dashboard/src/components/admin/ComparisonBarChart.tsx, dashboard/src/components/admin/RetentionHeatmap.tsx, dashboard/src/components/admin/AtRiskMemberList.tsx, dashboard/src/components/admin/DateRangePicker.tsx</files>
  <action>
Create the admin components directory and files.

**dashboard/src/components/admin/KpiCard.tsx**:

```typescript
'use client';

import { ArrowUp, ArrowDown, Minus } from 'lucide-react';
import { Card } from '@/components/ui';

interface KpiCardProps {
  title: string;
  value: number | string;
  change?: number; // Percentage change
  prefix?: string;
  suffix?: string;
  onClick?: () => void;
  isLoading?: boolean;
}

export function KpiCard({
  title,
  value,
  change,
  prefix = '',
  suffix = '',
  onClick,
  isLoading,
}: KpiCardProps) {
  const formatValue = (v: number | string) => {
    if (typeof v === 'string') return v;
    if (prefix === '$') {
      if (v >= 1_000_000) return `${prefix}${(v / 1_000_000).toFixed(1)}M`;
      if (v >= 1_000) return `${prefix}${(v / 1_000).toFixed(0)}K`;
      return `${prefix}${v.toLocaleString()}`;
    }
    return `${prefix}${v.toLocaleString()}${suffix}`;
  };

  const TrendIcon = change === undefined || change === 0
    ? Minus
    : change > 0
      ? ArrowUp
      : ArrowDown;

  return (
    <Card
      className={`p-4 ${onClick ? 'cursor-pointer hover:border-gold transition-colors' : ''}`}
      onClick={onClick}
    >
      <div className="flex flex-col gap-2">
        <span className="text-sm text-muted-foreground">{title}</span>
        {isLoading ? (
          <div className="h-8 w-24 bg-muted animate-pulse rounded" />
        ) : (
          <div className="flex items-end gap-2">
            <span className="text-2xl font-bold text-foreground">
              {formatValue(value)}
            </span>
            {change !== undefined && (
              <div className="flex items-center gap-1 text-sm text-muted-foreground mb-1">
                <TrendIcon className="w-4 h-4" />
                <span>{Math.abs(change)}%</span>
              </div>
            )}
          </div>
        )}
      </div>
    </Card>
  );
}
```

**dashboard/src/components/admin/TimeSeriesChart.tsx**:

```typescript
'use client';

import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from 'recharts';

interface DataPoint {
  date: string;
  [key: string]: number | string;
}

interface TimeSeriesChartProps {
  data: DataPoint[];
  lines: {
    key: string;
    label: string;
    color: string;
  }[];
  height?: number;
  showLegend?: boolean;
}

export function TimeSeriesChart({
  data,
  lines,
  height = 300,
  showLegend = true,
}: TimeSeriesChartProps) {
  // Format date for display
  const formatDate = (date: string) => {
    const d = new Date(date);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  };

  return (
    <div style={{ height }}>
      <ResponsiveContainer width="100%" height="100%">
        <LineChart data={data} margin={{ top: 5, right: 20, left: 10, bottom: 5 }}>
          <XAxis
            dataKey="date"
            tick={{ fontSize: 12, fill: 'var(--muted-foreground)' }}
            tickFormatter={formatDate}
            axisLine={{ stroke: 'var(--border)' }}
            tickLine={false}
          />
          <YAxis
            tick={{ fontSize: 12, fill: 'var(--muted-foreground)' }}
            axisLine={{ stroke: 'var(--border)' }}
            tickLine={false}
          />
          <Tooltip
            contentStyle={{
              backgroundColor: 'var(--card)',
              border: '1px solid var(--border)',
              borderRadius: 8,
            }}
            labelFormatter={formatDate}
          />
          {showLegend && <Legend />}
          {lines.map((line) => (
            <Line
              key={line.key}
              type="monotone"
              dataKey={line.key}
              name={line.label}
              stroke={line.color}
              strokeWidth={2}
              dot={false}
              activeDot={{ r: 4 }}
            />
          ))}
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
}
```

**dashboard/src/components/admin/ComparisonBarChart.tsx**:

```typescript
'use client';

import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  Cell,
} from 'recharts';

interface DataItem {
  name: string;
  value: number;
  color?: string;
}

interface ComparisonBarChartProps {
  data: DataItem[];
  height?: number;
  layout?: 'horizontal' | 'vertical';
  defaultColor?: string;
}

export function ComparisonBarChart({
  data,
  height = 200,
  layout = 'vertical',
  defaultColor = 'var(--gold)',
}: ComparisonBarChartProps) {
  const isVertical = layout === 'vertical';

  return (
    <div style={{ height }}>
      <ResponsiveContainer width="100%" height="100%">
        <BarChart
          data={data}
          layout={isVertical ? 'vertical' : 'horizontal'}
          margin={isVertical ? { top: 5, right: 30, left: 80, bottom: 5 } : { top: 5, right: 20, left: 10, bottom: 30 }}
        >
          {isVertical ? (
            <>
              <XAxis type="number" hide />
              <YAxis
                type="category"
                dataKey="name"
                tick={{ fontSize: 12, fill: 'var(--foreground)' }}
                axisLine={false}
                tickLine={false}
                width={70}
              />
            </>
          ) : (
            <>
              <XAxis
                dataKey="name"
                tick={{ fontSize: 12, fill: 'var(--foreground)' }}
                axisLine={false}
                tickLine={false}
              />
              <YAxis
                type="number"
                tick={{ fontSize: 12, fill: 'var(--muted-foreground)' }}
                axisLine={false}
                tickLine={false}
              />
            </>
          )}
          <Tooltip
            contentStyle={{
              backgroundColor: 'var(--card)',
              border: '1px solid var(--border)',
              borderRadius: 8,
            }}
          />
          <Bar dataKey="value" radius={[4, 4, 4, 4]} barSize={24}>
            {data.map((entry, index) => (
              <Cell key={`cell-${index}`} fill={entry.color || defaultColor} />
            ))}
          </Bar>
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
}
```

**dashboard/src/components/admin/RetentionHeatmap.tsx**:

```typescript
'use client';

import type { CohortRow } from '@/lib/admin-api';

interface RetentionHeatmapProps {
  cohorts: CohortRow[];
  viewMode: 'heatmap' | 'table';
}

export function RetentionHeatmap({ cohorts, viewMode }: RetentionHeatmapProps) {
  // Color scale for heatmap (0-100%)
  const getColor = (pct: number) => {
    if (pct >= 80) return 'bg-green-500/80';
    if (pct >= 60) return 'bg-green-500/60';
    if (pct >= 40) return 'bg-yellow-500/60';
    if (pct >= 20) return 'bg-orange-500/60';
    return 'bg-red-500/40';
  };

  const months = ['M0', 'M1', 'M2', 'M3', 'M4', 'M5'];

  if (viewMode === 'table') {
    return (
      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr className="border-b border-border">
              <th className="text-left py-2 px-3 font-medium text-muted-foreground">Cohort</th>
              <th className="text-left py-2 px-3 font-medium text-muted-foreground">Size</th>
              {months.slice(1).map((m) => (
                <th key={m} className="text-center py-2 px-3 font-medium text-muted-foreground">{m}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {cohorts.map((cohort) => (
              <tr key={cohort.cohort} className="border-b border-border/50">
                <td className="py-2 px-3 font-medium">{cohort.cohort}</td>
                <td className="py-2 px-3">{cohort.month0}</td>
                <td className="text-center py-2 px-3">{cohort.month1Pct}%</td>
                <td className="text-center py-2 px-3">{cohort.month2Pct}%</td>
                <td className="text-center py-2 px-3">{cohort.month3Pct}%</td>
                <td className="text-center py-2 px-3">{cohort.month4Pct}%</td>
                <td className="text-center py-2 px-3">{cohort.month5Pct}%</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    );
  }

  // Heatmap view
  return (
    <div className="overflow-x-auto">
      <table className="w-full text-sm">
        <thead>
          <tr>
            <th className="text-left py-2 px-2 font-medium text-muted-foreground w-20">Cohort</th>
            {months.map((m) => (
              <th key={m} className="text-center py-2 px-2 font-medium text-muted-foreground w-16">{m}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {cohorts.map((cohort) => (
            <tr key={cohort.cohort}>
              <td className="py-1 px-2 font-medium text-xs">{cohort.cohort}</td>
              <td className={`py-1 px-2 text-center text-xs ${getColor(100)}`}>{cohort.month0}</td>
              <td className={`py-1 px-2 text-center text-xs ${getColor(cohort.month1Pct)}`}>{cohort.month1Pct}%</td>
              <td className={`py-1 px-2 text-center text-xs ${getColor(cohort.month2Pct)}`}>{cohort.month2Pct}%</td>
              <td className={`py-1 px-2 text-center text-xs ${getColor(cohort.month3Pct)}`}>{cohort.month3Pct}%</td>
              <td className={`py-1 px-2 text-center text-xs ${getColor(cohort.month4Pct)}`}>{cohort.month4Pct}%</td>
              <td className={`py-1 px-2 text-center text-xs ${getColor(cohort.month5Pct)}`}>{cohort.month5Pct}%</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

**dashboard/src/components/admin/AtRiskMemberList.tsx**:

```typescript
'use client';

import type { ChurnRiskScore } from '@/lib/admin-api';
import { AlertTriangle, User } from 'lucide-react';

interface AtRiskMemberListProps {
  members: ChurnRiskScore[];
  isLoading?: boolean;
}

export function AtRiskMemberList({ members, isLoading }: AtRiskMemberListProps) {
  if (isLoading) {
    return (
      <div className="space-y-3">
        {[1, 2, 3].map((i) => (
          <div key={i} className="h-16 bg-muted animate-pulse rounded-lg" />
        ))}
      </div>
    );
  }

  if (members.length === 0) {
    return (
      <div className="text-center py-8 text-muted-foreground">
        <AlertTriangle className="w-8 h-8 mx-auto mb-2 opacity-50" />
        <p>No at-risk members found</p>
      </div>
    );
  }

  const getRiskBadge = (level: ChurnRiskScore['riskLevel']) => {
    const styles = {
      high: 'bg-red-500/20 text-red-400 border-red-500/30',
      medium: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
      low: 'bg-green-500/20 text-green-400 border-green-500/30',
    };
    return styles[level];
  };

  return (
    <div className="space-y-3">
      {members.map((member) => (
        <div
          key={member.memberId}
          className="flex items-center justify-between p-3 rounded-lg border border-border bg-card hover:border-border/80 transition-colors"
        >
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-full bg-muted flex items-center justify-center">
              <User className="w-5 h-5 text-muted-foreground" />
            </div>
            <div>
              <p className="font-medium text-foreground">
                {member.email || member.discordUsername || 'Unknown'}
              </p>
              <p className="text-xs text-muted-foreground">
                Last active: {member.lastActiveAt
                  ? new Date(member.lastActiveAt).toLocaleDateString()
                  : 'Never'}
              </p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <span className={`text-xs px-2 py-1 rounded-full border ${getRiskBadge(member.riskLevel)}`}>
              {member.score}/100
            </span>
          </div>
        </div>
      ))}
    </div>
  );
}
```

**dashboard/src/components/admin/DateRangePicker.tsx**:

```typescript
'use client';

import { useState } from 'react';
import { Button, Input } from '@/components/ui';

interface DateRangePickerProps {
  startDate: string;
  endDate: string;
  onChange: (start: string, end: string) => void;
}

export function DateRangePicker({ startDate, endDate, onChange }: DateRangePickerProps) {
  const [start, setStart] = useState(startDate);
  const [end, setEnd] = useState(endDate);

  const presets = [
    { label: '7 days', days: 7 },
    { label: '30 days', days: 30 },
    { label: '90 days', days: 90 },
  ];

  const applyPreset = (days: number) => {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - days);

    const startStr = startDate.toISOString().split('T')[0];
    const endStr = endDate.toISOString().split('T')[0];

    setStart(startStr);
    setEnd(endStr);
    onChange(startStr, endStr);
  };

  const handleApply = () => {
    onChange(start, end);
  };

  return (
    <div className="flex flex-wrap items-center gap-2">
      {presets.map((preset) => (
        <Button
          key={preset.days}
          variant="outline"
          size="sm"
          onClick={() => applyPreset(preset.days)}
        >
          {preset.label}
        </Button>
      ))}
      <div className="flex items-center gap-2">
        <Input
          type="date"
          value={start}
          onChange={(e) => setStart(e.target.value)}
          className="w-36 text-sm"
        />
        <span className="text-muted-foreground">to</span>
        <Input
          type="date"
          value={end}
          onChange={(e) => setEnd(e.target.value)}
          className="w-36 text-sm"
        />
        <Button size="sm" onClick={handleApply}>
          Apply
        </Button>
      </div>
    </div>
  );
}
```

Create a barrel export file **dashboard/src/components/admin/index.ts**:

```typescript
export { KpiCard } from './KpiCard';
export { TimeSeriesChart } from './TimeSeriesChart';
export { ComparisonBarChart } from './ComparisonBarChart';
export { RetentionHeatmap } from './RetentionHeatmap';
export { AtRiskMemberList } from './AtRiskMemberList';
export { DateRangePicker } from './DateRangePicker';
```
  </action>
  <verify>TypeScript compiles: `cd dashboard && npx tsc --noEmit`</verify>
  <done>Admin analytics components created: KpiCard, TimeSeriesChart, ComparisonBarChart, RetentionHeatmap, AtRiskMemberList, DateRangePicker</done>
</task>

<task type="auto">
  <name>Task 3: Create Admin Analytics Dashboard Page</name>
  <files>dashboard/src/app/admin/analytics/page.tsx</files>
  <action>
Create the admin analytics page with tabbed sections per CONTEXT.md decisions.

Create directory first: `mkdir -p dashboard/src/app/admin/analytics`

**dashboard/src/app/admin/analytics/page.tsx**:

```typescript
'use client';

/**
 * Admin Analytics Dashboard
 *
 * Tabbed sections: Overview, Members, Engagement, Benchmarks, Resources
 * Per CONTEXT.md: Landing tab is Overview with KPI summary cards + mini-charts
 * ANALYTICS-10: Real-time updates via React Query polling
 */

import { useState } from 'react';
import { Download, Grid3X3, List, RefreshCw } from 'lucide-react';
import { Button, Card } from '@/components/ui';
import {
  KpiCard,
  TimeSeriesChart,
  ComparisonBarChart,
  RetentionHeatmap,
  AtRiskMemberList,
  DateRangePicker,
} from '@/components/admin';
import {
  useOverview,
  useEngagement,
  useEngagementComparison,
  useBenchmarkStats,
  useResourceStats,
  usePopularResources,
  useTrendingResources,
  useCohorts,
  useAtRisk,
} from '@/hooks/useAnalytics';
import { adminAnalyticsApi } from '@/lib/admin-api';

type Tab = 'overview' | 'members' | 'engagement' | 'benchmarks' | 'resources';

export default function AdminAnalyticsPage() {
  const [activeTab, setActiveTab] = useState<Tab>('overview');
  const [retentionView, setRetentionView] = useState<'heatmap' | 'table'>('heatmap');

  // Date range state (default: last 30 days)
  const defaultEnd = new Date().toISOString().split('T')[0];
  const defaultStart = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  const [dateRange, setDateRange] = useState({ start: defaultStart, end: defaultEnd });

  // Data hooks
  const { data: overview, isLoading: loadingOverview } = useOverview();
  const { data: engagement, isLoading: loadingEngagement } = useEngagement(dateRange.start, dateRange.end);
  const { data: comparison } = useEngagementComparison(dateRange.start, dateRange.end);
  const { data: benchmarks, isLoading: loadingBenchmarks } = useBenchmarkStats();
  const { data: resources, isLoading: loadingResources } = useResourceStats(dateRange.start, dateRange.end);
  const { data: popularResources } = usePopularResources(10);
  const { data: trendingResources } = useTrendingResources(10);
  const { data: cohorts, isLoading: loadingCohorts } = useCohorts();
  const { data: atRisk, isLoading: loadingAtRisk } = useAtRisk(30, 20);

  // Export handlers
  const handleExportCsv = () => {
    const url = adminAnalyticsApi.exportCsv();
    window.open(url, '_blank');
  };

  const handleExportJson = () => {
    const url = adminAnalyticsApi.exportJson();
    window.open(url, '_blank');
  };

  const tabs: { id: Tab; label: string }[] = [
    { id: 'overview', label: 'Overview' },
    { id: 'members', label: 'Members' },
    { id: 'engagement', label: 'Engagement' },
    { id: 'benchmarks', label: 'Benchmarks' },
    { id: 'resources', label: 'Resources' },
  ];

  return (
    <div className="min-h-screen bg-background p-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <div>
          <h1 className="text-2xl font-bold text-foreground">Analytics Dashboard</h1>
          <p className="text-muted-foreground">Real-time community insights</p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" size="sm" onClick={handleExportCsv}>
            <Download className="w-4 h-4 mr-2" />
            CSV
          </Button>
          <Button variant="outline" size="sm" onClick={handleExportJson}>
            <Download className="w-4 h-4 mr-2" />
            JSON
          </Button>
        </div>
      </div>

      {/* Tabs */}
      <div className="flex gap-1 mb-6 border-b border-border">
        {tabs.map((tab) => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`px-4 py-2 text-sm font-medium transition-colors border-b-2 -mb-px ${
              activeTab === tab.id
                ? 'border-gold text-gold'
                : 'border-transparent text-muted-foreground hover:text-foreground'
            }`}
          >
            {tab.label}
          </button>
        ))}
      </div>

      {/* Date Range Picker (shared across tabs) */}
      {activeTab !== 'overview' && (
        <div className="mb-6">
          <DateRangePicker
            startDate={dateRange.start}
            endDate={dateRange.end}
            onChange={(start, end) => setDateRange({ start, end })}
          />
        </div>
      )}

      {/* Tab Content */}
      {activeTab === 'overview' && (
        <div className="space-y-6">
          {/* KPI Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <KpiCard
              title="Total Members"
              value={overview?.totalMembers ?? 0}
              onClick={() => setActiveTab('members')}
              isLoading={loadingOverview}
            />
            <KpiCard
              title="Active Members"
              value={overview?.activeMembers ?? 0}
              change={comparison?.change.total}
              onClick={() => setActiveTab('members')}
              isLoading={loadingOverview}
            />
            <KpiCard
              title="MRR"
              value={overview?.mrr ?? 0}
              prefix="$"
              isLoading={loadingOverview}
            />
            <KpiCard
              title="New (30d)"
              value={overview?.newMembers30d ?? 0}
              isLoading={loadingOverview}
            />
          </div>

          {/* Engagement Mini-Chart */}
          <Card className="p-4">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-foreground">Engagement Trend</h3>
              <Button variant="ghost" size="sm" onClick={() => setActiveTab('engagement')}>
                View Details
              </Button>
            </div>
            {engagement?.data && engagement.data.length > 0 ? (
              <TimeSeriesChart
                data={engagement.data}
                lines={[
                  { key: 'total', label: 'Total Activity', color: 'var(--gold)' },
                ]}
                height={200}
                showLegend={false}
              />
            ) : (
              <div className="h-48 flex items-center justify-center text-muted-foreground">
                {loadingEngagement ? 'Loading...' : 'No engagement data'}
              </div>
            )}
          </Card>

          {/* At-Risk Members */}
          <Card className="p-4">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-foreground">At-Risk Members</h3>
              <span className="text-sm text-muted-foreground">
                {atRisk?.count ?? 0} members
              </span>
            </div>
            <AtRiskMemberList members={atRisk?.members ?? []} isLoading={loadingAtRisk} />
          </Card>
        </div>
      )}

      {activeTab === 'members' && (
        <div className="space-y-6">
          {/* Member Stats */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <KpiCard title="Total" value={overview?.totalMembers ?? 0} isLoading={loadingOverview} />
            <KpiCard title="Active" value={overview?.activeMembers ?? 0} isLoading={loadingOverview} />
            <KpiCard title="Inactive" value={overview?.inactiveMembers ?? 0} isLoading={loadingOverview} />
            <KpiCard title="At-Risk" value={atRisk?.count ?? 0} isLoading={loadingAtRisk} />
          </div>

          {/* Cohort Retention */}
          <Card className="p-4">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-foreground">Cohort Retention</h3>
              <div className="flex gap-2">
                <Button
                  variant={retentionView === 'heatmap' ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setRetentionView('heatmap')}
                >
                  <Grid3X3 className="w-4 h-4" />
                </Button>
                <Button
                  variant={retentionView === 'table' ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setRetentionView('table')}
                >
                  <List className="w-4 h-4" />
                </Button>
              </div>
            </div>
            {cohorts?.cohorts && cohorts.cohorts.length > 0 ? (
              <RetentionHeatmap cohorts={cohorts.cohorts} viewMode={retentionView} />
            ) : (
              <div className="h-48 flex items-center justify-center text-muted-foreground">
                {loadingCohorts ? 'Loading...' : 'No cohort data'}
              </div>
            )}
          </Card>

          {/* At-Risk Full List */}
          <Card className="p-4">
            <h3 className="font-semibold text-foreground mb-4">At-Risk Members</h3>
            <AtRiskMemberList members={atRisk?.members ?? []} isLoading={loadingAtRisk} />
          </Card>
        </div>
      )}

      {activeTab === 'engagement' && (
        <div className="space-y-6">
          {/* Engagement Chart */}
          <Card className="p-4">
            <h3 className="font-semibold text-foreground mb-4">Activity Over Time</h3>
            {engagement?.data && engagement.data.length > 0 ? (
              <TimeSeriesChart
                data={engagement.data}
                lines={[
                  { key: 'benchmarks', label: 'Benchmarks', color: 'var(--gold)' },
                  { key: 'downloads', label: 'Downloads', color: 'var(--success)' },
                  { key: 'discordActivity', label: 'Discord', color: 'var(--info)' },
                ]}
                height={350}
              />
            ) : (
              <div className="h-80 flex items-center justify-center text-muted-foreground">
                {loadingEngagement ? 'Loading...' : 'No engagement data'}
              </div>
            )}
          </Card>

          {/* Period Comparison */}
          {comparison && (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <KpiCard
                title="Total Activity"
                value={comparison.current.data.reduce((s, d) => s + d.total, 0)}
                change={comparison.change.total}
              />
              <KpiCard
                title="Benchmarks"
                value={comparison.current.data.reduce((s, d) => s + d.benchmarks, 0)}
                change={comparison.change.benchmarks}
              />
              <KpiCard
                title="Downloads"
                value={comparison.current.data.reduce((s, d) => s + d.downloads, 0)}
                change={comparison.change.downloads}
              />
              <KpiCard
                title="Discord"
                value={comparison.current.data.reduce((s, d) => s + d.discordActivity, 0)}
                change={comparison.change.discordActivity}
              />
            </div>
          )}
        </div>
      )}

      {activeTab === 'benchmarks' && (
        <div className="space-y-6">
          {/* Benchmark Stats */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <KpiCard title="Total Submissions" value={benchmarks?.total.submissions ?? 0} isLoading={loadingBenchmarks} />
            <KpiCard title="Valid" value={benchmarks?.total.validSubmissions ?? 0} isLoading={loadingBenchmarks} />
            <KpiCard title="Flagged" value={benchmarks?.total.flaggedSubmissions ?? 0} isLoading={loadingBenchmarks} />
            <KpiCard title="Unique Members" value={benchmarks?.total.uniqueMembers ?? 0} isLoading={loadingBenchmarks} />
          </div>

          {/* By Category Chart */}
          <Card className="p-4">
            <h3 className="font-semibold text-foreground mb-4">Submissions by Category</h3>
            {benchmarks?.byCategory && benchmarks.byCategory.length > 0 ? (
              <ComparisonBarChart
                data={benchmarks.byCategory.map((c) => ({
                  name: c.category.charAt(0) + c.category.slice(1).toLowerCase(),
                  value: c.submissionCount,
                  color: c.flaggedCount > 0 ? 'var(--warning)' : 'var(--gold)',
                }))}
                layout="horizontal"
                height={250}
              />
            ) : (
              <div className="h-60 flex items-center justify-center text-muted-foreground">
                {loadingBenchmarks ? 'Loading...' : 'No benchmark data'}
              </div>
            )}
          </Card>

          {/* Category Details Table */}
          <Card className="p-4">
            <h3 className="font-semibold text-foreground mb-4">Category Details</h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b border-border">
                    <th className="text-left py-2 px-3 font-medium text-muted-foreground">Category</th>
                    <th className="text-right py-2 px-3 font-medium text-muted-foreground">Submissions</th>
                    <th className="text-right py-2 px-3 font-medium text-muted-foreground">Valid</th>
                    <th className="text-right py-2 px-3 font-medium text-muted-foreground">Flagged</th>
                    <th className="text-right py-2 px-3 font-medium text-muted-foreground">Members</th>
                  </tr>
                </thead>
                <tbody>
                  {benchmarks?.byCategory.map((cat) => (
                    <tr key={cat.category} className="border-b border-border/50">
                      <td className="py-2 px-3 font-medium">{cat.category}</td>
                      <td className="py-2 px-3 text-right">{cat.submissionCount}</td>
                      <td className="py-2 px-3 text-right">{cat.validCount}</td>
                      <td className="py-2 px-3 text-right text-warning">{cat.flaggedCount}</td>
                      <td className="py-2 px-3 text-right">{cat.uniqueMembers}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </Card>
        </div>
      )}

      {activeTab === 'resources' && (
        <div className="space-y-6">
          {/* Resource Stats */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <KpiCard title="Total Resources" value={resources?.totalResources ?? 0} isLoading={loadingResources} />
            <KpiCard title="Total Downloads" value={resources?.totalDownloads ?? 0} isLoading={loadingResources} />
            <KpiCard title="Unique Downloaders" value={resources?.uniqueDownloaders ?? 0} isLoading={loadingResources} />
            <KpiCard title="Downloads (Period)" value={resources?.downloadsThisPeriod ?? 0} isLoading={loadingResources} />
          </div>

          {/* Popular & Trending Side by Side */}
          <div className="grid md:grid-cols-2 gap-6">
            <Card className="p-4">
              <h3 className="font-semibold text-foreground mb-4">Most Popular</h3>
              {popularResources?.resources && popularResources.resources.length > 0 ? (
                <div className="space-y-2">
                  {popularResources.resources.slice(0, 5).map((r, i) => (
                    <div key={r.id} className="flex items-center justify-between py-2 border-b border-border/50 last:border-0">
                      <div className="flex items-center gap-3">
                        <span className="text-muted-foreground w-6">{i + 1}.</span>
                        <div>
                          <p className="font-medium text-foreground text-sm">{r.title}</p>
                          <p className="text-xs text-muted-foreground">{r.type}</p>
                        </div>
                      </div>
                      <span className="text-sm text-muted-foreground">{r.downloadCount} downloads</span>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-muted-foreground">No resources yet</p>
              )}
            </Card>

            <Card className="p-4">
              <h3 className="font-semibold text-foreground mb-4">Trending</h3>
              {trendingResources?.resources && trendingResources.resources.length > 0 ? (
                <div className="space-y-2">
                  {trendingResources.resources.slice(0, 5).map((r, i) => (
                    <div key={r.id} className="flex items-center justify-between py-2 border-b border-border/50 last:border-0">
                      <div className="flex items-center gap-3">
                        <span className="text-muted-foreground w-6">{i + 1}.</span>
                        <div>
                          <p className="font-medium text-foreground text-sm">{r.title}</p>
                          <p className="text-xs text-muted-foreground">{r.recentDownloads} this week</p>
                        </div>
                      </div>
                      <span className={`text-sm ${r.growthPercent > 0 ? 'text-success' : 'text-muted-foreground'}`}>
                        {r.growthPercent > 0 ? '+' : ''}{r.growthPercent}%
                      </span>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-muted-foreground">No trending resources</p>
              )}
            </Card>
          </div>
        </div>
      )}
    </div>
  );
}
```

Note: The page uses 'use client' directive for React hooks. Admin authentication is handled by the admin-api.ts client which checks localStorage for the admin token.
  </action>
  <verify>TypeScript compiles: `cd dashboard && npx tsc --noEmit`. Page loads at /admin/analytics without errors.</verify>
  <done>Admin analytics dashboard page created with all 5 tabs, interactive charts, and export functionality</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd dashboard && npx tsc --noEmit` passes without errors
2. `npm run build` in dashboard directory succeeds
3. Navigate to http://localhost:4000/admin/analytics shows the dashboard
4. All 5 tabs render correctly (Overview, Members, Engagement, Benchmarks, Resources)
5. KPI cards show data and are clickable
6. Charts render with Recharts
7. Export buttons trigger CSV/JSON download
8. Data auto-refreshes (check Network tab for periodic requests)
</verification>

<success_criteria>
- [ ] dashboard/src/lib/admin-api.ts exports adminAnalyticsApi
- [ ] dashboard/src/hooks/useAnalytics.ts exports all analytics hooks
- [ ] dashboard/src/components/admin/ has all 6 components
- [ ] dashboard/src/app/admin/analytics/page.tsx renders tabbed dashboard
- [ ] Real-time updates via refetchInterval (ANALYTICS-10)
- [ ] Export buttons download CSV/JSON (ANALYTICS-08)
- [ ] KPI cards clickable to drill into tabs (per CONTEXT.md)
- [ ] Cohort retention toggles between heatmap and table (per CONTEXT.md)
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/33-admin-analytics/33-03-SUMMARY.md`
</output>
