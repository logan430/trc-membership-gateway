---
phase: 39-coolify-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.prod.yml
autonomous: false

user_setup:
  - service: coolify
    why: "Container hosting platform"
    prerequisites:
      - task: "Coolify server provisioned and accessible"
        note: "User must have Coolify instance running on a VPS"
      - task: "SSH access to Coolify server"
        note: "Needed for firewall verification"
    dashboard_config:
      - task: "Create new project"
        location: "Coolify Dashboard -> Projects -> Add New"
      - task: "Add Docker Compose resource"
        location: "Project -> Add New Resource -> Docker Compose"
      - task: "Configure all environment variables"
        location: "Resource -> Environment Variables"

must_haves:
  truths:
    - "docker-compose.prod.yml exists and is valid for Coolify deployment"
    - "Coolify project exists with Docker Compose resource"
    - "All required environment variables are configured in Coolify"
    - "Both containers build successfully on Coolify"
  artifacts:
    - path: "docker-compose.prod.yml"
      provides: "Production Docker Compose for Coolify"
      contains: "traefik.enable=true"
  key_links:
    - from: "Coolify"
      to: "GitHub repository"
      via: "Git connection"
      description: "Coolify pulls code from repository"
---

<objective>
Create production Docker Compose configuration and set up Coolify project with environment variables.

Purpose: Coolify needs a production-optimized docker-compose.prod.yml that differs from local development (no ports exposed, Traefik labels for routing). The user creates the Coolify project and configures all environment variables.

Output: Coolify project with both containers building successfully.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/DEPLOY-STACK.md
@.planning/research/DEPLOY-PITFALLS.md
@docker-compose.yml
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create production Docker Compose for Coolify</name>
  <files>docker-compose.prod.yml</files>
  <action>
Create docker-compose.prod.yml optimized for Coolify deployment:

1. Copy docker-compose.yml as starting point
2. Remove version field (deprecated in Compose v2)
3. Remove custom network name (let Coolify manage networking)
4. Remove ports mapping for nextjs (internal only - not exposed via Traefik)
5. Keep ports mapping for express BUT change to just expose (no host binding since Traefik handles routing)
6. Add Traefik labels to express service:
   - traefik.enable=true
   - NOTE: Domain-specific labels will be added by Coolify automatically
7. Remove env_file reference (Coolify injects variables directly)
8. Update environment section for express to reference variables with ${} syntax (Coolify substitution)
9. Keep healthcheck configurations unchanged
10. Keep depends_on with service_healthy condition

Key differences from local docker-compose.yml:
- No ports exposed to host (Traefik routes traffic)
- No custom network (Coolify creates one automatically)
- Traefik label on express service only
- Environment variables use ${VAR} syntax for Coolify injection
  </action>
  <verify>
Validate the file:
- File exists at docker-compose.prod.yml
- Contains traefik.enable=true label on express service
- Does NOT contain ports mapping for nextjs
- Does NOT contain version field
- Contains healthcheck blocks for both services
  </verify>
  <done>docker-compose.prod.yml exists and is properly configured for Coolify deployment with Traefik routing.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Create Coolify project and configure environment</name>
  <what-to-do>
User creates Coolify project and Docker Compose resource.

**Prerequisites:**
- Coolify instance running on VPS
- GitHub repository accessible
- All production environment variable values ready

**Step 1: Create Project**
1. Log in to Coolify dashboard
2. Click "Projects" in sidebar
3. Click "+ Add" to create new project
4. Name it "TRC Membership Gateway" (or similar)

**Step 2: Add Docker Compose Resource**
1. In the new project, click "+ Add New Resource"
2. Select "Docker Compose"
3. Connect your GitHub repository
4. Set Docker Compose file path: `docker-compose.prod.yml`
5. Click "Save"

**Step 3: Configure Environment Variables**
In the resource settings, add ALL required environment variables.

**Required Variables (deployment will fail without these):**

| Variable | Value Source | Example |
|----------|--------------|---------|
| `DATABASE_URL` | Supabase Dashboard | `postgresql://postgres.[ref]:[pw]@aws-0-[region].pooler.supabase.com:6543/postgres?pgbouncer=true` |
| `DIRECT_URL` | Supabase Dashboard | Same as DATABASE_URL but port 5432 |
| `JWT_SECRET` | Generate: `openssl rand -hex 32` | 64-character hex string |
| `STRIPE_SECRET_KEY` | Stripe Dashboard | `sk_test_...` or `sk_live_...` |
| `STRIPE_WEBHOOK_SECRET` | Stripe Dashboard (after creating webhook) | `whsec_...` |
| `DISCORD_CLIENT_ID` | Discord Dev Portal | Your OAuth2 Client ID |
| `DISCORD_CLIENT_SECRET` | Discord Dev Portal | Your OAuth2 Client Secret |
| `DISCORD_BOT_TOKEN` | Discord Dev Portal | Your Bot Token |
| `DISCORD_GUILD_ID` | Discord (Developer Mode) | Your Server ID |
| `DISCORD_INTRODUCTIONS_CHANNEL_ID` | Discord (Developer Mode) | Channel ID |
| `APP_URL` | Your domain | `https://yourdomain.com` |

**Optional Variables (set later or use defaults):**

| Variable | Default | Notes |
|----------|---------|-------|
| `EMAIL_PROVIDER` | `console` | Set to `resend` for production emails |
| `RESEND_API_KEY` | - | Required if EMAIL_PROVIDER=resend |
| `SENTRY_DSN` | - | For error monitoring |
| `SUPABASE_URL` | - | For resource uploads |
| `SUPABASE_SERVICE_ROLE_KEY` | - | For resource uploads |

**Important:** Mark sensitive values (JWT_SECRET, all _KEY, _SECRET, _TOKEN variables) as "Secret" in Coolify.

**Step 4: Verify Configuration**
1. Double-check DATABASE_URL uses port 6543 (pooler) and includes `?pgbouncer=true`
2. Verify APP_URL matches your intended domain (with https://)
3. Ensure JWT_SECRET is at least 32 characters
  </what-to-do>
  <resume-signal>Type "configured" when Coolify project is created and all environment variables are set, or describe any issues.</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify containers build successfully</name>
  <what-built>Coolify project with Docker Compose configuration and environment variables.</what-built>
  <how-to-verify>
**Trigger First Build:**
1. In Coolify, go to your Docker Compose resource
2. Click "Deploy" or "Redeploy" button
3. Watch the build logs

**Expected Build Behavior:**
1. Coolify clones the repository
2. Builds Next.js container (~2-5 minutes):
   - Should see "Creating an optimized production build"
   - Should see "Finalizing page optimization"
   - Should NOT see TypeScript or build errors
3. Builds Express container (~2-3 minutes):
   - Should see "npm run build" completing
   - Should see "prisma generate" completing
   - Should NOT see argon2 compilation errors

**Success Indicators:**
- Both containers show "Running" status
- No error messages in build logs
- Coolify shows green checkmarks for both services

**Common Build Issues:**
- "Cannot find module" -> Missing dependency or build step issue
- "ENOENT prisma" -> Prisma schema not copied to container
- "Error: P1001" -> Database connection in build (acceptable, connects at runtime)
- Build timeout -> Server may need more RAM (4GB+ recommended)

**If Build Fails:**
1. Check build logs for specific error
2. Common fixes:
   - Memory issues: Increase server RAM or enable swap
   - Missing env var: Mark DATABASE_URL as build variable
   - Git access: Verify repository permissions
  </how-to-verify>
  <resume-signal>Type "builds-pass" if both containers built successfully, or describe the build error.</resume-signal>
</task>

</tasks>

<verification>
- [ ] docker-compose.prod.yml exists in repository root
- [ ] File contains Traefik labels for express service
- [ ] Coolify project exists with Docker Compose resource
- [ ] All required environment variables configured
- [ ] Both containers (express and nextjs) build successfully
- [ ] Containers show "Running" status in Coolify
</verification>

<success_criteria>
INFRA-06 satisfied: Both containers build successfully on Coolify. Project is ready for domain/SSL configuration in Plan 39-02.
</success_criteria>

<output>
After completion, create `.planning/phases/39-coolify-deployment/39-01-SUMMARY.md`
</output>
