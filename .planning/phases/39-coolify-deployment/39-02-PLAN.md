---
phase: 39-coolify-deployment
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified: []
autonomous: false

user_setup:
  - service: dns-provider
    why: "Domain DNS management"
    prerequisites:
      - task: "Domain registered and DNS access"
        note: "User must have access to DNS records for their domain"
    dashboard_config:
      - task: "Create A record pointing to Coolify server IP"
        location: "DNS Provider Dashboard (Cloudflare, Namecheap, Route53, etc.)"
  - service: coolify
    why: "Domain and SSL configuration"
    dashboard_config:
      - task: "Add domain to application"
        location: "Coolify -> Resource -> Domains"

must_haves:
  truths:
    - "DNS A record points domain to Coolify server IP"
    - "SSL certificate is issued by Let's Encrypt"
    - "HTTPS works for the domain"
    - "HTTP requests redirect to HTTPS"
    - "Application health checks pass"
  artifacts: []
  key_links:
    - from: "Domain"
      to: "Coolify Server IP"
      via: "DNS A Record"
      description: "DNS resolution directs traffic to Coolify"
    - from: "Coolify/Traefik"
      to: "Let's Encrypt"
      via: "ACME challenge"
      description: "SSL certificate issuance"
---

<objective>
Configure DNS, add domain in Coolify, and verify SSL certificate issuance.

Purpose: The application needs a custom domain with HTTPS for production. Stripe webhooks require HTTPS endpoints, and Discord OAuth requires exact domain matching. This plan completes the deployment by making the application publicly accessible.

Output: Application accessible via https://[domain] with valid SSL certificate.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/DEPLOY-ARCHITECTURE.md
@.planning/research/DEPLOY-PITFALLS.md
@.planning/phases/39-coolify-deployment/39-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Configure DNS A record</name>
  <what-to-do>
**Pre-requisites:**
- Know your Coolify server's public IP address
- Have access to your domain's DNS management

**Get Coolify Server IP:**
1. In Coolify Dashboard, go to "Servers"
2. Click on your server
3. Note the IP address shown (e.g., 123.45.67.89)

**Configure DNS:**
1. Log in to your DNS provider (Cloudflare, Namecheap, Route53, GoDaddy, etc.)
2. Navigate to DNS settings for your domain
3. Create a new A record:
   - **Type:** A
   - **Name:** @ (or leave blank for root domain)
   - **Value:** Your Coolify server IP
   - **TTL:** 300 (5 minutes) or Auto
   - **Proxy:** OFF (if using Cloudflare, use "DNS only" mode initially)

**If using a subdomain (e.g., app.yourdomain.com):**
   - **Name:** app (or your preferred subdomain)
   - **Value:** Your Coolify server IP

**If using Cloudflare:**
- Set proxy to "DNS only" (grey cloud) for initial setup
- This allows Let's Encrypt HTTP-01 challenge to work
- You can enable Cloudflare proxy later after SSL is issued

**Verify DNS Propagation:**
Wait 2-5 minutes, then verify DNS is working:
- Use https://dnschecker.org
- Enter your domain
- Confirm the A record shows your Coolify server IP globally

**Firewall Check:**
Ensure your Coolify server allows incoming traffic on ports 80 and 443:
```bash
# SSH to your Coolify server and check:
sudo ufw status
# Should show 80 and 443 ALLOW
```
If ports are blocked, open them:
```bash
sudo ufw allow 80
sudo ufw allow 443
```
  </what-to-do>
  <resume-signal>Type "dns-configured" when DNS A record is set and propagation verified, or describe any issues.</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Add domain in Coolify and verify SSL</name>
  <what-to-do>
**Add Domain in Coolify:**
1. Go to your Docker Compose resource in Coolify
2. Click on "Domains" or find the domain configuration section
3. Add your domain: `yourdomain.com` (or `app.yourdomain.com` if using subdomain)
4. Ensure HTTPS is enabled (should be by default)
5. Click Save

**Wait for SSL Certificate:**
1. Coolify automatically requests a Let's Encrypt certificate
2. This uses the HTTP-01 challenge (requires port 80 accessible)
3. Wait 1-2 minutes for certificate issuance
4. Check the certificate status in Coolify (should show "Valid" or green indicator)

**If Certificate Fails:**
Common issues and fixes:

| Issue | Solution |
|-------|----------|
| "DNS not propagated" | Wait longer, verify with dnschecker.org |
| "Connection refused" | Ensure port 80 is open on server firewall |
| "Rate limited" | Let's Encrypt allows 5 certificates per domain per week - wait or use staging |
| "Challenge failed" | If using Cloudflare proxy, disable it (DNS only mode) |

**Verify in Coolify Logs:**
1. Go to your application in Coolify
2. Check the "Logs" section
3. Look for Traefik/ACME logs showing certificate request
4. Successful message: "Certificate obtained successfully" or similar

**Verify HTTPS Works:**
After certificate is issued:
```bash
# Test HTTPS directly
curl -I https://yourdomain.com/health

# Expected response:
# HTTP/2 200
# (or 301/302 redirect to login)
```
  </what-to-do>
  <resume-signal>Type "ssl-issued" when SSL certificate is successfully issued and HTTPS works, or describe the error.</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Final deployment verification</name>
  <what-built>Complete Coolify deployment with custom domain and SSL.</what-built>
  <how-to-verify>
**Verification Checklist:**

**1. HTTPS Access:**
- [ ] Open https://yourdomain.com in browser
- [ ] Browser shows secure padlock (no certificate warnings)
- [ ] Page loads (login page or dashboard)

**2. HTTP Redirect:**
- [ ] Open http://yourdomain.com (no 's')
- [ ] Should automatically redirect to https://yourdomain.com
- [ ] Verify with: `curl -I http://yourdomain.com`
- [ ] Expected: `HTTP/1.1 301` or `308` with `Location: https://...`

**3. Health Checks:**
```bash
# Express health endpoint
curl https://yourdomain.com/health
# Expected: {"status":"healthy",...} or {"status":"degraded",...}

# Test a public page loads
curl -I https://yourdomain.com/login
# Expected: HTTP/2 200
```

**4. Container Status in Coolify:**
- [ ] Express container shows "Running" and "Healthy"
- [ ] Next.js container shows "Running" and "Healthy"
- [ ] No restart loops in container logs

**5. Quick Functional Test:**
- [ ] Navigate to https://yourdomain.com/login
- [ ] Page renders with medieval theme styling
- [ ] No console errors about failed requests
- [ ] Static assets (CSS, JS) load correctly

**If Issues Occur:**

| Symptom | Likely Cause | Fix |
|---------|--------------|-----|
| 502 Bad Gateway | Container not running | Check Coolify container status, redeploy |
| Certificate warning | SSL not issued | Check port 80, DNS, Coolify ACME logs |
| Page loads but broken CSS | Static files not serving | Check Next.js build, proxy configuration |
| Health returns degraded | Database not connected | Verify DATABASE_URL in Coolify env vars |
| Connection timeout | Firewall or DNS | Verify ports 80/443 open, DNS propagated |
  </how-to-verify>
  <resume-signal>Type "deployed" if all checks pass, or describe which verification failed.</resume-signal>
</task>

</tasks>

<verification>
- [ ] DNS A record points domain to Coolify server IP
- [ ] SSL certificate issued successfully (no browser warnings)
- [ ] HTTP redirects to HTTPS automatically
- [ ] https://[domain]/health returns 200 with JSON response
- [ ] Application pages load correctly with styling
- [ ] Both containers show healthy status in Coolify
</verification>

<success_criteria>
Phase 39 complete when:
- DOMAIN-01: Custom domain configured in Coolify
- DOMAIN-02: DNS A record points to Coolify server IP
- DOMAIN-03: SSL certificate issued via Let's Encrypt
- DOMAIN-04: HTTP redirects to HTTPS
- DOMAIN-05: Application accessible via https://[domain]

Application is now deployed and publicly accessible. Ready for Phase 40 (Database Production Setup).
</success_criteria>

<output>
After completion, create `.planning/phases/39-coolify-deployment/39-02-SUMMARY.md`
</output>
