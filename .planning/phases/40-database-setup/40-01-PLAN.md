---
phase: 40-database-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.prod.yml
autonomous: false

user_setup:
  - service: supabase
    why: "Production database for the membership gateway"
    env_vars:
      - name: DATABASE_URL
        source: "Supabase Dashboard -> Project Settings -> Database -> Connection string -> URI (Transaction/Session pooler, port 6543). Append ?pgbouncer=true"
      - name: DIRECT_URL
        source: "Supabase Dashboard -> Project Settings -> Database -> Connection string -> URI (Session pooler, port 5432). No pgbouncer param."
    dashboard_config:
      - task: "Ensure production Supabase project exists (free tier pauses after 1 week inactivity; Pro plan recommended at $25/month)"
        location: "Supabase Dashboard -> Project Settings"

must_haves:
  truths:
    - "Express container connects to production Supabase database on startup"
    - "All 25 Prisma migrations applied successfully to production database"
    - "Health endpoint shows database=true after deployment"
    - "App functions (login page loads, API responds) with production database"
  artifacts:
    - path: "docker-compose.prod.yml"
      provides: "Production compose with DIRECT_URL passthrough"
      contains: "DIRECT_URL"
  key_links:
    - from: "Express container env"
      to: "Supabase production database"
      via: "DATABASE_URL connection string"
      pattern: "pooler\\.supabase\\.com:6543"
    - from: "prisma.config.ts"
      to: "Supabase direct connection"
      via: "DIRECT_URL env var"
      pattern: "directUrl.*DIRECT_URL"
---

<objective>
Configure the production Supabase database connection in Coolify and run all 25 Prisma migrations against the fresh production database.

Purpose: The app is deployed on Coolify but currently has no database. This plan connects it to a production Supabase instance and applies the full schema so the app can store and retrieve real data.

Output: Production database with complete schema (all 25 migrations applied), Express container healthy and connected.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-database-setup/40-RESEARCH.md
@prisma.config.ts
@docker-compose.prod.yml
@src/config/env.ts
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Set production database env vars in Coolify</name>
  <action>
The user must set DATABASE_URL and DIRECT_URL in the Coolify application environment.

The user needs a production Supabase project. If using the existing dev project, it should be upgraded to Pro ($25/month) to avoid 1-week inactivity pauses. If creating a new project, the user gets the connection strings from the new project dashboard.

**Connection string formats:**

DATABASE_URL (pooler, for runtime):
```
postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres?pgbouncer=true
```

DIRECT_URL (direct, for migrations):
```
postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres
```

**Set via Coolify API:**

```bash
# Set DATABASE_URL
curl -X PATCH http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/envs \
  -H "Authorization: Bearer $COOLIFY_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "key": "DATABASE_URL",
    "value": "<pooler-connection-string>",
    "is_build_time": false,
    "is_preview": false
  }'

# Set DIRECT_URL
curl -X PATCH http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/envs \
  -H "Authorization: Bearer $COOLIFY_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "key": "DIRECT_URL",
    "value": "<direct-connection-string>",
    "is_build_time": false,
    "is_preview": false
  }'
```

Or set them via the Coolify web UI at http://82.180.160.120:8000 -> Application -> Environment Variables.

**IMPORTANT:** Do NOT set these to empty strings. If a value is not ready, leave the variable completely unset. Empty strings cause Zod `.url().optional()` validation crashes (learned in Phase 39).
  </action>
  <resume-signal>Type "env vars set" once DATABASE_URL and DIRECT_URL are configured in Coolify, or provide the connection strings and Claude will set them via the API.</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Redeploy app and run migrations via SSH + docker exec</name>
  <files>docker-compose.prod.yml</files>
  <action>
**Step 1: Verify DIRECT_URL is passed through to the Express container.**

Check if `docker-compose.prod.yml` passes DIRECT_URL to the Express container. Currently, only NODE_ENV, PORT, and NEXT_APP_URL are hardcoded in the `environment:` section. Since Coolify injects all env vars via its env_file mechanism, DIRECT_URL should already be available inside the container. Verify this understanding is correct by reading the compose file.

If the Coolify env_file injection does NOT pass DIRECT_URL (because it is only listed in the compose `environment:` block for hardcoded overrides), then no compose changes are needed -- Coolify's env injection covers all variables set in the Coolify UI.

**Step 2: Trigger a redeploy on Coolify** so the containers pick up the new DATABASE_URL and DIRECT_URL env vars.

```bash
curl -X GET http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/restart \
  -H "Authorization: Bearer $COOLIFY_TOKEN"
```

Wait for containers to come back healthy (check via Coolify API or SSH).

**Step 3: SSH into Coolify server and find the Express container name.**

```bash
ssh root@82.180.160.120
docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}" | grep -i express
```

The container name follows Coolify's pattern, likely something like `wcssogsgc00o8ocwcg4c0c00-express-1`.

**Step 4: Verify database connectivity from inside the container.**

```bash
docker exec <express-container> node -e "
  const pg = require('pg');
  const pool = new pg.Pool({ connectionString: process.env.DATABASE_URL });
  pool.query('SELECT 1 as connected').then(r => { console.log('DB connected:', r.rows[0]); pool.end(); }).catch(e => { console.error('DB error:', e.message); pool.end(); process.exit(1); });
"
```

**Step 5: Run Prisma migrations.**

```bash
docker exec <express-container> npx prisma migrate deploy
```

Expected output: 25 migrations applied successfully. Prisma creates the `_prisma_migrations` tracking table and applies all migrations in order.

**Step 6: Verify migration status.**

```bash
docker exec <express-container> npx prisma migrate status
```

Expected: "Database schema is up to date!"

**IMPORTANT:**
- Use `prisma migrate deploy` (NOT `prisma migrate dev` -- dev is destructive in production)
- The `prisma.config.ts` file automatically uses DIRECT_URL for migrations (port 5432, no pooler)
- If migrations fail with "prepared statement already exists", DIRECT_URL is wrong (likely pointing to pooler port 6543 instead of 5432)
  </action>
  <verify>
1. `docker exec <container> npx prisma migrate status` shows "Database schema is up to date!"
2. `curl https://app.therevenuecouncil.com/health` returns JSON with `database: true`
3. No Zod validation errors in container logs: `docker logs <express-container> --tail 50`
  </verify>
  <done>All 25 Prisma migrations applied to production Supabase database. Express container connects successfully. Health endpoint reports database=true.</done>
</task>

</tasks>

<verification>
1. `curl https://app.therevenuecouncil.com/health` returns 200 with `{"status":"ok","database":true,...}`
2. `docker exec <container> npx prisma migrate status` shows all 25 migrations applied
3. Express container logs show successful startup with no database errors
</verification>

<success_criteria>
- Production Supabase database accessible from Coolify containers
- All 25 Prisma migrations run successfully (schema fully applied)
- Health endpoint confirms database=true
- No Zod validation crashes from env var issues
</success_criteria>

<output>
After completion, create `.planning/phases/40-database-setup/40-01-SUMMARY.md`
</output>
