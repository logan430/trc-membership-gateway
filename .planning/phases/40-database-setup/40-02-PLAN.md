---
phase: 40-database-setup
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - scripts/seed-production.ts
autonomous: false

user_setup:
  - service: admin-credentials
    why: "Production admin account for dashboard access"
    env_vars:
      - name: ADMIN_SEED_EMAIL
        source: "User chooses production admin email address"
      - name: ADMIN_SEED_PASSWORD
        source: "User chooses strong admin password (8+ characters per Zod schema)"

must_haves:
  truths:
    - "Admin can log into the dashboard at https://app.therevenuecouncil.com/admin/login"
    - "Point configs exist with correct values (50, 5, 1, 25 points)"
    - "Feature flags exist and are set to production-appropriate defaults"
    - "Email templates exist for all 10 notification types"
  artifacts:
    - path: "scripts/seed-production.ts"
      provides: "Production-safe seed script using env vars for credentials"
      min_lines: 50
  key_links:
    - from: "scripts/seed-production.ts"
      to: "Admin table"
      via: "prisma.admin.upsert with hashed password"
      pattern: "prisma\\.admin\\.upsert"
    - from: "scripts/seed-production.ts"
      to: "FeatureFlag table"
      via: "seedDefaultFlags()"
      pattern: "seedDefaultFlags"
    - from: "scripts/seed-production.ts"
      to: "PointConfig table"
      via: "seedDefaultPointConfigs()"
      pattern: "seedDefaultPointConfigs"
    - from: "scripts/seed-production.ts"
      to: "EmailTemplate table"
      via: "DEFAULT_TEMPLATES with createMany skipDuplicates"
      pattern: "DEFAULT_TEMPLATES"
---

<objective>
Create a production seed script and run it to populate the admin account, point configs, feature flags, and email templates in the production database.

Purpose: The production database has the schema (from Plan 01) but no operational data. Without seed data, nobody can log into admin, the points system has no config, feature flags are missing, and email notifications have no templates.

Output: Production database populated with all operational seed data. Admin can log in. All system configs active.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-database-setup/40-RESEARCH.md
@.planning/phases/40-database-setup/40-01-SUMMARY.md
@scripts/seed-test-data.ts
@src/lib/feature-flags.ts
@src/points/config.ts
@src/email/template-fetcher.ts
@src/lib/password.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create production seed script</name>
  <files>scripts/seed-production.ts</files>
  <action>
Create `scripts/seed-production.ts` modeled on `scripts/seed-test-data.ts` but for production use.

The script must:

1. **Read admin credentials from env vars** (`ADMIN_SEED_EMAIL` and `ADMIN_SEED_PASSWORD`). These already exist in the Zod schema at `src/config/env.ts` lines 53-54 but are optional. The script should read them directly from `process.env` (not through the Zod-parsed env object, since the seed script runs standalone and does not import the full env config).

2. **Create admin account** using `prisma.admin.upsert`:
   - `where: { email }` so it is idempotent
   - Hash password using `hashPassword()` from `src/lib/password.ts` (uses argon2)
   - Set role to `SUPER_ADMIN`
   - Log the created admin email (but NOT the password)

3. **Seed feature flags** by calling `seedDefaultFlags()` from `src/lib/feature-flags.ts`:
   - This uses `createMany` + `skipDuplicates` (idempotent)
   - Seeds 8 flags: require_introduction, send_claim_reminders, send_billing_emails, send_invite_emails, auto_fix_reconciliation, enable_magic_links, enable_team_signups, maintenance_mode

4. **Seed point configs** by calling `seedDefaultPointConfigs()` from `src/points/config.ts`:
   - This uses `createMany` + `skipDuplicates` (idempotent)
   - Seeds 4 configs: benchmark_submission (50), resource_download (5), discord_activity (1), intro_completed (25)
   - NOTE: Point configs are also auto-seeded on Express startup, but running them here ensures they exist before the first request.

5. **Seed email templates** using `DEFAULT_TEMPLATES` from `src/email/template-fetcher.ts`:
   - Use `prisma.emailTemplate.createMany({ data: DEFAULT_TEMPLATES, skipDuplicates: true })`
   - Seeds 10 templates: welcome, claim_reminder, claim_reminder_cheeky, payment_failure, payment_recovered, payment_recovered_debtor, seat_invite, reconciliation_report, password_reset, password_reset_confirmation

**Database connection pattern** (same as seed-test-data.ts):
```typescript
import { PrismaClient } from '@prisma/client';
import { PrismaPg } from '@prisma/adapter-pg';
import pg from 'pg';
import 'dotenv/config';

const pool = new pg.Pool({ connectionString: process.env.DATABASE_URL });
const adapter = new PrismaPg(pool);
const prisma = new PrismaClient({ adapter });
```

**Import paths** (use .js extensions for ESM compatibility):
- `import { hashPassword } from '../src/lib/password.js';`
- `import { seedDefaultFlags } from '../src/lib/feature-flags.js';`
- `import { seedDefaultPointConfigs } from '../src/points/config.js';`
- `import { DEFAULT_TEMPLATES } from '../src/email/template-fetcher.js';`

**IMPORTANT:** The feature-flags and points-config modules import `prisma` from `src/lib/prisma.ts` internally. Since the seed script creates its own PrismaClient, the `seedDefaultFlags()` and `seedDefaultPointConfigs()` functions will use their own internal prisma instance (which reads DATABASE_URL from env). This is fine -- both will connect to the same database. However, if this causes issues (e.g., the internal prisma singleton fails to initialize due to missing non-database env vars like STRIPE_SECRET_KEY), then inline the seed logic directly in the script using the local prisma instance instead of calling the imported functions.

**Fallback approach if imports fail:** Copy the flag definitions and point config arrays directly into the seed script and use the local prisma client:
```typescript
await prisma.featureFlag.createMany({ data: FLAGS, skipDuplicates: true });
await prisma.pointConfig.createMany({ data: CONFIGS, skipDuplicates: true });
await prisma.emailTemplate.createMany({ data: TEMPLATES, skipDuplicates: true });
```

The script should exit with code 0 on success, code 1 on failure. Always disconnect prisma and end the pool in the finally block.

Do NOT create any test member accounts. This is production -- only operational data.
  </action>
  <verify>
1. `npx tsx scripts/seed-production.ts` runs locally against a test database (or verify TypeScript compiles: `npx tsc --noEmit scripts/seed-production.ts` -- this may not work due to import paths, so just verify the file structure is correct by reading it)
2. Script has all 4 seed operations: admin, flags, configs, templates
3. Script reads ADMIN_SEED_EMAIL and ADMIN_SEED_PASSWORD from process.env
4. Script uses upsert for admin (idempotent) and createMany+skipDuplicates for bulk data (idempotent)
  </verify>
  <done>scripts/seed-production.ts exists with production-safe seeding of admin account, feature flags, point configs, and email templates. No test data.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Set admin credentials in Coolify env vars</name>
  <action>
The user must set ADMIN_SEED_EMAIL and ADMIN_SEED_PASSWORD in Coolify so the seed script can create the admin account.

**Set via Coolify API:**

```bash
# Set admin email
curl -X PATCH http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/envs \
  -H "Authorization: Bearer $COOLIFY_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "key": "ADMIN_SEED_EMAIL",
    "value": "<your-admin-email>",
    "is_build_time": false,
    "is_preview": false
  }'

# Set admin password (must be 8+ characters)
curl -X PATCH http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/envs \
  -H "Authorization: Bearer $COOLIFY_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "key": "ADMIN_SEED_PASSWORD",
    "value": "<your-strong-password>",
    "is_build_time": false,
    "is_preview": false
  }'
```

Or set via Coolify web UI at http://82.180.160.120:8000 -> Application -> Environment Variables.

These env vars are defined as optional in the Zod schema (`src/config/env.ts` lines 53-54), so the app will not crash without them -- they are only used by the seed script.
  </action>
  <resume-signal>Type "credentials set" once ADMIN_SEED_EMAIL and ADMIN_SEED_PASSWORD are configured in Coolify, or provide the values and Claude will set them via the API.</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Deploy seed script and run via SSH + docker exec</name>
  <files>scripts/seed-production.ts</files>
  <action>
**Step 1: Commit and push the seed script** so it is available in the deployed container.

```bash
git add scripts/seed-production.ts
git commit -m "feat(40): add production seed script for admin, flags, configs, templates"
git push origin main
```

**Step 2: Trigger a redeploy on Coolify** so the container includes the new script and picks up the ADMIN_SEED_EMAIL / ADMIN_SEED_PASSWORD env vars.

```bash
curl -X GET http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/restart \
  -H "Authorization: Bearer $COOLIFY_TOKEN"
```

Wait for containers to come back healthy.

**Step 3: SSH into Coolify server and find the Express container.**

```bash
ssh root@82.180.160.120
docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}" | grep -i express
```

**Step 4: Verify tsx is available in the container.**

```bash
docker exec <express-container> npx tsx --version
```

If tsx is NOT available, fall back to running the script via `node` with the compiled output, or use `npx ts-node --esm scripts/seed-production.ts`. The research indicates tsx should be available since the Dockerfile copies full node_modules from the builder stage.

**Step 5: Run the production seed script.**

```bash
docker exec -e ADMIN_SEED_EMAIL="$ADMIN_SEED_EMAIL" -e ADMIN_SEED_PASSWORD="$ADMIN_SEED_PASSWORD" <express-container> npx tsx scripts/seed-production.ts
```

Note: If ADMIN_SEED_EMAIL and ADMIN_SEED_PASSWORD are already set as container env vars (via Coolify), the `-e` flags are not needed:

```bash
docker exec <express-container> npx tsx scripts/seed-production.ts
```

Expected output:
```
Starting production seed...

--- Seeding Admin ---
  Admin created/updated: <admin-email>

--- Seeding Feature Flags ---
  Feature flags seeded (8 flags)

--- Seeding Point Configs ---
  Point configs seeded (4 configs)

--- Seeding Email Templates ---
  Email templates seeded (10 templates)

Production seed complete!
```

**Step 6: Verify the seed data by testing admin login.**

```bash
# Test admin login endpoint
curl -X POST https://app.therevenuecouncil.com/admin/login \
  -H "Content-Type: application/json" \
  -d '{"email":"<admin-email>","password":"<admin-password>"}'
```

Should return 200 with a JWT token.

**Step 7: Verify seed data counts via admin API** (using the token from step 6).

```bash
# Check feature flags
curl https://app.therevenuecouncil.com/admin/config/feature-flags \
  -H "Authorization: Bearer <admin-token>"

# Check point configs
curl https://app.therevenuecouncil.com/api/admin/points-config \
  -H "Authorization: Bearer <admin-token>"
```

Both should return arrays with the seeded data.

**If the seed script fails** due to import issues with `seedDefaultFlags()` or `seedDefaultPointConfigs()` (because their internal prisma imports trigger full env validation), update the script to inline the seed data arrays and use the local prisma client directly. Then re-commit, re-push, re-deploy, and re-run.
  </action>
  <verify>
1. Admin login at `POST https://app.therevenuecouncil.com/admin/login` returns 200 with JWT
2. Feature flags endpoint returns 8 flags
3. Point configs endpoint returns 4 configs (benchmark_submission=50, resource_download=5, discord_activity=1, intro_completed=25)
4. Admin can access https://app.therevenuecouncil.com/admin/login in browser and log in successfully
  </verify>
  <done>Production database fully seeded: admin account accessible, 8 feature flags active, 4 point configs set, 10 email templates loaded. Admin can log into the dashboard.</done>
</task>

</tasks>

<verification>
1. Admin login works: `POST /admin/login` with seeded credentials returns 200 + JWT
2. Feature flags: `GET /admin/config/feature-flags` returns 8 flags with correct defaults
3. Point configs: `GET /api/admin/points-config` returns 4 configs with correct point values
4. Email templates: All 10 templates exist (verify via admin dashboard or database query)
5. Health check: `GET /health` still returns `database: true`
</verification>

<success_criteria>
- Admin account created with user-chosen credentials (NOT test credentials)
- 4 point configs seeded: benchmark_submission (50), resource_download (5), discord_activity (1), intro_completed (25)
- 8 feature flags seeded with production-appropriate defaults
- 10 email templates seeded for all notification types
- Admin can log into dashboard at https://app.therevenuecouncil.com/admin/login
</success_criteria>

<output>
After completion, create `.planning/phases/40-database-setup/40-02-SUMMARY.md`
</output>
