---
phase: 41-stripe-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []  # No codebase files modified -- this plan configures external services (Stripe Dashboard, Coolify env vars)
autonomous: false

user_setup:
  - service: stripe
    why: "Webhook configuration and API credentials for production"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key (test mode toggle ON)"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> endpoint -> Signing secret -> Reveal"
      - name: STRIPE_INDIVIDUAL_PRICE_ID
        source: "Stripe Dashboard -> Products -> Individual Monthly -> Pricing section -> price_... ID"
    dashboard_config:
      - task: "Create webhook endpoint"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint"
      - task: "Configure billing portal"
        location: "Stripe Dashboard -> Settings -> Billing -> Customer portal"

must_haves:
  truths:
    - "Stripe webhook endpoint exists in Dashboard pointing to production URL"
    - "Webhook signature verification passes when Stripe sends events"
    - "STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, STRIPE_INDIVIDUAL_PRICE_ID are set in Coolify"
    - "App health endpoint returns 200 after Stripe configuration applied"
  artifacts:
    - path: "Stripe Dashboard webhook endpoint"
      provides: "Production webhook delivery"
      contains: "https://app.therevenuecouncil.com/webhooks/stripe"
    - path: "Coolify env vars"
      provides: "Runtime Stripe configuration"
      contains: "STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, STRIPE_INDIVIDUAL_PRICE_ID"
  key_links:
    - from: "Stripe Dashboard webhook endpoint"
      to: "Express /webhooks/stripe route"
      via: "HTTPS POST from Stripe to production URL"
      pattern: "webhooks/stripe"
    - from: "STRIPE_WEBHOOK_SECRET env var"
      to: "stripe.webhooks.constructEvent()"
      via: "Signature verification in src/webhooks/stripe.ts"
      pattern: "constructEvent.*STRIPE_WEBHOOK_SECRET"
---

<objective>
Configure Stripe webhook endpoint in Dashboard pointing to production URL, set all Stripe env vars in Coolify, and verify webhook signature verification works.

Purpose: The Stripe code is fully deployed but needs production configuration -- webhook endpoint URL, signing secret, API key, and price ID. Without these, no payment processing works.
Output: Working webhook endpoint that receives and verifies Stripe events at https://app.therevenuecouncil.com/webhooks/stripe
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-stripe-integration/41-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify prerequisites and check existing Stripe env vars</name>
  <files><!-- No codebase files modified. This task reads external service state: Coolify API env vars, production health endpoint. --></files>
  <action>
  Verify the production environment is ready for Stripe configuration:

  1. Confirm SSL works: `curl -s -o /dev/null -w "%{http_code}" https://app.therevenuecouncil.com/health` should return 200
  2. Confirm health endpoint details: `curl -s https://app.therevenuecouncil.com/health` and check the JSON response
  3. Check if Stripe env vars are already set in Coolify by querying existing env vars:
     ```bash
     curl -s http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/envs \
       -H "Authorization: Bearer $COOLIFY_TOKEN" | jq '.[] | select(.key | startswith("STRIPE"))'
     ```
  4. Check if APP_URL is set to `https://app.therevenuecouncil.com` (required for checkout redirect URLs):
     ```bash
     curl -s http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/envs \
       -H "Authorization: Bearer $COOLIFY_TOKEN" | jq '.[] | select(.key == "APP_URL")'
     ```

  Report findings: which Stripe env vars exist, which are missing, and whether APP_URL is correct.

  NOTE: The COOLIFY_TOKEN may not be in the current shell environment. If the curl to Coolify fails with 401, ask the user to provide the token. Check STATE.md and prior summaries for how it was used in Phase 39/40.
  </action>
  <verify>
  - SSL health check returns 200
  - Report shows which Stripe env vars are present/missing
  - APP_URL value confirmed
  </verify>
  <done>Complete inventory of Stripe env var status and production readiness confirmed.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: User configures Stripe Dashboard and provides credentials</name>
  <action>The following must be done in the Stripe Dashboard by the user. Claude cannot access the Stripe Dashboard.</action>
  <instructions>
  Complete these steps in the Stripe Dashboard (https://dashboard.stripe.com):

  **Step 1: Ensure you are in TEST MODE** (toggle at top-right of Dashboard should show "Test mode")

  **Step 2: Create webhook endpoint**
  1. Go to Developers -> Webhooks (https://dashboard.stripe.com/test/webhooks)
  2. Click "Add endpoint"
  3. Set Endpoint URL: `https://app.therevenuecouncil.com/webhooks/stripe`
  4. Under "Select events to listen to", add these 6 events:
     - `checkout.session.completed`
     - `customer.subscription.created`
     - `customer.subscription.updated`
     - `customer.subscription.deleted`
     - `invoice.payment_failed`
     - `invoice.paid`
  5. Click "Add endpoint"

  **Step 3: Get webhook signing secret**
  1. Click the newly created endpoint to view it
  2. Under "Signing secret", click "Reveal"
  3. Copy the `whsec_...` value

  **Step 4: Verify/create Individual product**
  1. Go to Products (https://dashboard.stripe.com/test/products)
  2. If no "Individual Monthly" product exists, create one:
     - Name: "Individual Monthly" (or your preferred name)
     - Add a recurring price (monthly)
  3. Click into the product and copy the `price_...` ID from the Pricing section

  **Step 5: Get API secret key**
  1. Go to Developers -> API keys (https://dashboard.stripe.com/test/apikeys)
  2. Copy the Secret key (`sk_test_...`)

  **Step 6: Configure Billing Portal**
  1. Go to Settings -> Billing -> Customer portal (https://dashboard.stripe.com/test/settings/billing/portal)
  2. Enable: Allow customers to update payment methods
  3. Enable: Allow customers to cancel subscriptions
  4. Set default return URL: `https://app.therevenuecouncil.com/app/dashboard`
  5. Save

  **Provide to Claude:**
  - STRIPE_SECRET_KEY: `sk_test_...`
  - STRIPE_WEBHOOK_SECRET: `whsec_...`
  - STRIPE_INDIVIDUAL_PRICE_ID: `price_...`
  </instructions>
  <resume-signal>Provide the three values: STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, and STRIPE_INDIVIDUAL_PRICE_ID</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Set Stripe env vars in Coolify, redeploy, and verify webhook</name>
  <files><!-- No codebase files modified. This task sets env vars via Coolify REST API and verifies production health. --></files>
  <action>
  Using the credentials provided by the user, set env vars in Coolify and verify:

  1. Set STRIPE_SECRET_KEY via Coolify API:
     ```bash
     curl -X PATCH http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/envs \
       -H "Authorization: Bearer $COOLIFY_TOKEN" \
       -H "Content-Type: application/json" \
       -d '{"key": "STRIPE_SECRET_KEY", "value": "USER_PROVIDED_VALUE", "is_build_time": false, "is_preview": false}'
     ```

  2. Set STRIPE_WEBHOOK_SECRET via Coolify API (same pattern as above)

  3. Set STRIPE_INDIVIDUAL_PRICE_ID via Coolify API (same pattern as above)

  4. Trigger a redeploy so the app picks up the new env vars:
     ```bash
     curl -X POST http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/restart \
       -H "Authorization: Bearer $COOLIFY_TOKEN"
     ```

  5. Wait for app to come back up (poll health endpoint every 15 seconds, up to 5 minutes):
     ```bash
     for i in {1..20}; do
       sleep 15
       STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://app.therevenuecouncil.com/health 2>/dev/null)
       if [ "$STATUS" = "200" ]; then echo "App is up"; break; fi
       echo "Waiting... ($i/20)"
     done
     ```

  6. Verify the app started correctly by checking health:
     ```bash
     curl -s https://app.therevenuecouncil.com/health | jq .
     ```
     Health endpoint must return 200. If it does not, check Coolify logs for Zod validation errors caused by empty/malformed env vars.

  7. Ask the user to send a test webhook from Stripe Dashboard:
     - Go to Webhooks -> the endpoint -> "Send test webhook"
     - Select event: `checkout.session.completed`
     - Click "Send test webhook"

  8. After user confirms test webhook was sent, check production logs for the event:
     ```bash
     ssh root@82.180.160.120 "docker logs \$(docker ps --format '{{.Names}}' | grep express | head -1) --tail 50 2>&1" | grep -i "webhook\|stripe\|event"
     ```
     If SSH is not available, ask user to check Coolify logs in the Dashboard.

  IMPORTANT: Do NOT set env vars to empty strings. If the user hasn't provided a value, skip that env var entirely. Empty strings will cause Zod validation crashes.

  NOTE on Coolify API: If the env var already exists, the PATCH may need to be an update rather than create. Check the Coolify API response. If it returns a conflict, try using the PUT method or include the existing UUID.
  </action>
  <verify>
  - All 3 env vars set in Coolify (confirmed via GET /envs query)
  - App restarts successfully (health returns 200)
  - Test webhook event received (visible in logs or Stripe Dashboard shows 200 response)
  </verify>
  <done>
  Stripe env vars configured in production. Webhook endpoint receives events and signature verification passes. Requirements covered: STRIPE-01 (endpoint URL configured), STRIPE-02 (signature verification works).
  </done>
</task>

</tasks>

<verification>
- `curl -s https://app.therevenuecouncil.com/health` returns 200 with `database: true`
- Coolify env vars query shows STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, STRIPE_INDIVIDUAL_PRICE_ID all set
- Stripe Dashboard shows test webhook delivered successfully (200 response)
</verification>

<success_criteria>
1. Webhook endpoint `https://app.therevenuecouncil.com/webhooks/stripe` exists in Stripe Dashboard (test mode) with 6 events configured
2. STRIPE_SECRET_KEY (sk_test_...), STRIPE_WEBHOOK_SECRET (whsec_...), and STRIPE_INDIVIDUAL_PRICE_ID (price_...) set in Coolify
3. App running with new env vars (health check passes)
4. Test webhook from Dashboard received and verified (200 response, visible in logs)
5. Billing portal configured in Stripe Dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/41-stripe-integration/41-01-SUMMARY.md`
</output>
