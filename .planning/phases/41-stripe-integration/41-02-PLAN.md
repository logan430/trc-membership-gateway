---
phase: 41-stripe-integration
plan: 02
type: execute
wave: 2
depends_on: ["41-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "checkout.session.completed webhook fires when a test user completes checkout"
    - "Member subscriptionStatus changes to ACTIVE after checkout completion"
    - "invoice.payment_failed webhook triggers grace period handling"
    - "Billing portal opens and returns user back to the app"
    - "Test mode checkout completes full lifecycle: signup -> payment -> active member"
  artifacts:
    - path: "Stripe Dashboard webhook logs"
      provides: "Evidence of successful webhook delivery"
      contains: "checkout.session.completed with 200 response"
    - path: "Production database"
      provides: "Member record with ACTIVE status"
      contains: "subscriptionStatus = ACTIVE, stripeCustomerId populated"
  key_links:
    - from: "Stripe Checkout page"
      to: "checkout.session.completed webhook"
      via: "Stripe fires event on successful payment"
      pattern: "checkout.session.completed"
    - from: "checkout.session.completed handler"
      to: "Member.subscriptionStatus = ACTIVE"
      via: "processStripeEvent in src/webhooks/stripe.ts"
      pattern: "subscriptionStatus.*ACTIVE"
    - from: "Billing portal session"
      to: "Return URL redirect"
      via: "stripe.billingPortal.sessions.create with return_url"
      pattern: "billingPortal.*sessions.*create"
---

<objective>
Test the complete Stripe checkout flow end-to-end in test mode: sign up a test user, complete Stripe checkout with a test card, verify the webhook fires and processes correctly, and test the billing portal.

Purpose: Configuration from 41-01 is verified by actually running the flows. This confirms webhooks fire, member status updates, and billing portal works -- covering STRIPE-03 through STRIPE-07.
Output: Verified end-to-end Stripe test mode flow with evidence (webhook logs, database state, billing portal redirect).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-stripe-integration/41-RESEARCH.md
@.planning/phases/41-stripe-integration/41-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: User completes test checkout flow while Claude monitors</name>
  <what-built>Stripe webhook endpoint and env vars configured in 41-01. Now we need to verify the actual checkout flow works end-to-end.</what-built>
  <how-to-verify>
  Complete these steps in your browser:

  **Step 1: Sign up a test account**
  1. Go to `https://app.therevenuecouncil.com/signup`
  2. Create a new account with a test email (e.g., `stripetest@example.com`)
  3. Use any password you like
  4. Confirm the account is created (you should be logged in or redirected)

  **Step 2: Initiate checkout**
  1. Navigate to the dashboard or billing page
  2. Click the button to subscribe / start checkout
  3. You should be redirected to a Stripe Checkout page

  **Step 3: Complete payment with test card**
  1. On the Stripe Checkout page, use test card: `4242 4242 4242 4242`
  2. Expiry: any future date (e.g., `12/34`)
  3. CVC: any 3 digits (e.g., `123`)
  4. Name: any name
  5. Click "Subscribe" or "Pay"
  6. You should be redirected back to `https://app.therevenuecouncil.com/dashboard?checkout=success`

  **Step 4: Verify webhook in Stripe Dashboard**
  1. Go to Stripe Dashboard -> Developers -> Webhooks -> your endpoint
  2. Check "Recent deliveries" -- you should see a `checkout.session.completed` event with HTTP status 200

  **Report back:**
  - Did signup work?
  - Did checkout redirect to Stripe?
  - Did payment with test card succeed?
  - Did you get redirected back to the dashboard?
  - Does the Stripe webhook log show a 200 response for checkout.session.completed?
  </how-to-verify>
  <resume-signal>Describe what happened at each step, or report any errors encountered</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Verify webhook processing and member status in database</name>
  <files></files>
  <action>
  After the user confirms the checkout completed, verify the backend processed everything correctly:

  1. Check production logs for the webhook event:
     ```bash
     ssh root@82.180.160.120 "docker logs \$(docker ps --format '{{.Names}}' | grep express | head -1) --tail 100 2>&1" | grep -i "webhook\|checkout\|stripe\|ACTIVE\|subscription"
     ```
     If SSH is not available, ask the user to check Coolify logs.

  2. Verify the member's subscription status in the database. Query via the admin API:
     ```bash
     # First, get an admin JWT token
     ADMIN_TOKEN=$(curl -s -X POST https://app.therevenuecouncil.com/admin/auth/login \
       -H "Content-Type: application/json" \
       -d '{"email":"logan@callamarketer.ca","password":"ADMIN_PASSWORD"}' | jq -r '.token')

     # Then check the members list for the test user
     curl -s https://app.therevenuecouncil.com/api/admin/members \
       -H "Authorization: Bearer $ADMIN_TOKEN" | jq '.members[] | select(.email == "stripetest@example.com") | {email, subscriptionStatus, stripeCustomerId, subscriptionId}'
     ```

     NOTE: The admin password may not be known to Claude. If the admin API call fails with 401, ask the user to check the member status via the admin dashboard at `https://app.therevenuecouncil.com/admin/members`.

  3. Verify these fields on the test member:
     - `subscriptionStatus` should be `ACTIVE`
     - `stripeCustomerId` should be populated (starts with `cus_`)
     - `subscriptionId` should be populated (starts with `sub_`)

  4. Check that the StripeEvent was recorded (idempotency protection):
     If admin API has an endpoint for this, query it. Otherwise, note that the checkout.session.completed event should be logged in the StripeEvent table -- this ensures replay protection is working.

  5. If any issues found:
     - Check Stripe Dashboard webhook logs for error responses
     - Check app logs for error messages
     - Report specific errors to the user with remediation steps
  </action>
  <verify>
  - Production logs show checkout.session.completed event received and processed
  - Test member has subscriptionStatus = ACTIVE
  - Test member has stripeCustomerId and subscriptionId populated
  </verify>
  <done>
  checkout.session.completed webhook verified: fires on checkout completion, processes correctly, and updates member to ACTIVE status. Requirements covered: STRIPE-03 (checkout.session.completed processes correctly), STRIPE-07 (test mode checkout completes successfully).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: User tests billing portal and payment failure handling</name>
  <what-built>Checkout flow verified. Now testing billing portal redirect and optionally payment failure webhook.</what-built>
  <how-to-verify>
  **Part A: Test Billing Portal (STRIPE-06)**
  1. Log in as the test user at `https://app.therevenuecouncil.com/login`
  2. Navigate to the billing page or dashboard
  3. Click "Manage Billing" (or similar button that opens the Stripe billing portal)
  4. You should be redirected to the Stripe Customer Portal
  5. Verify you can see subscription details and payment method
  6. Click "Back to [site]" or close the portal -- you should return to `https://app.therevenuecouncil.com/app/dashboard`

  **Part B: Verify invoice.paid webhook (STRIPE-04)**
  1. In Stripe Dashboard -> Webhooks -> your endpoint -> Recent deliveries
  2. Look for an `invoice.paid` event (this should have fired automatically when the subscription was created)
  3. Confirm it shows HTTP 200 response

  **Part C: Test payment failure (STRIPE-05) -- OPTIONAL**
  If you want to verify payment failure handling:
  1. In Stripe Dashboard -> Customers -> find the test customer
  2. Update their payment method to the declining test card: `4000 0000 0000 0341`
  3. Or, in Stripe Dashboard, manually create a test invoice for the customer and attempt to charge the declining card
  4. Check webhook logs for `invoice.payment_failed` event with 200 response

  Alternatively, you can skip Part C and verify payment failure handling in Phase 43 E2E testing.

  **Report back:**
  - Did the billing portal open correctly?
  - Could you see subscription details in the portal?
  - Did returning from the portal redirect to the correct URL?
  - Was an `invoice.paid` event visible in webhook logs with 200 status?
  - (Optional) Did invoice.payment_failed fire and return 200?
  </how-to-verify>
  <resume-signal>Report results for billing portal test and webhook verification. Note if payment failure test was skipped (will be covered in Phase 43).</resume-signal>
</task>

</tasks>

<verification>
- Stripe Dashboard webhook logs show checkout.session.completed with 200 response
- Stripe Dashboard webhook logs show invoice.paid with 200 response
- Test member in database has subscriptionStatus = ACTIVE, stripeCustomerId populated
- Billing portal opens from the app and returns user back to correct URL
- (Optional) invoice.payment_failed webhook returns 200 if tested
</verification>

<success_criteria>
1. STRIPE-03: checkout.session.completed fires and creates active member -- verified via database and webhook logs
2. STRIPE-04: invoice.paid (payment_succeeded) webhook processes with 200 -- verified via Stripe Dashboard
3. STRIPE-05: invoice.payment_failed triggers grace period -- verified via test or deferred to Phase 43
4. STRIPE-06: Billing portal opens correctly and redirects back to app
5. STRIPE-07: Complete test mode flow works: signup -> checkout (test card 4242...) -> active member -> billing portal
</success_criteria>

<output>
After completion, create `.planning/phases/41-stripe-integration/41-02-SUMMARY.md`
</output>
