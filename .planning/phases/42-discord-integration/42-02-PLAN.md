---
phase: 42-discord-integration
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified: []  # No codebase files modified -- this plan is user configuration + end-to-end verification
autonomous: false

user_setup:
  - service: discord
    why: "OAuth redirect URI and bot permissions for production"
    dashboard_config:
      - task: "Add production OAuth redirect URI"
        location: "Discord Developer Portal -> Applications -> [app] -> OAuth2 -> Redirects -> Add: https://app.therevenuecouncil.com/auth/callback"
      - task: "Verify privileged intents enabled"
        location: "Discord Developer Portal -> Applications -> [app] -> Bot -> Privileged Gateway Intents -> SERVER MEMBERS INTENT + MESSAGE CONTENT INTENT"
      - task: "Verify bot role hierarchy in Discord server"
        location: "Discord Server Settings -> Roles -> Drag bot role ABOVE Squire, Knight, Lord, Debtor roles"
      - task: "Create permanent invite link (if not already done)"
        location: "Discord Server -> Invite People -> Edit invite link -> Set to Never expire"

must_haves:
  truths:
    - "Member can complete /claim/discord OAuth flow and have discordId saved to database"
    - "Bot assigns Squire role to member after successful Discord claim"
    - "Bot detects 100+ char introduction message and promotes Squire to Knight/Lord"
    - "Bot is online and health check shows discord=true"
    - "Discord Developer Portal has production redirect URI registered"
  artifacts:
    - path: "Discord Developer Portal OAuth2 Redirects"
      provides: "Production redirect URI registration"
      contains: "https://app.therevenuecouncil.com/auth/callback"
    - path: "Production database member record"
      provides: "Discord linking verification"
      contains: "discordId, discordUsername populated after claim"
  key_links:
    - from: "/claim/discord"
      to: "Discord OAuth"
      via: "redirect_uri parameter"
      pattern: "app.therevenuecouncil.com/auth/callback"
    - from: "/auth/callback"
      to: "/claim/callback"
      via: "claim_state cookie detection (Plan 01 fix)"
      pattern: "claim_state.*redirect.*claim/callback"
    - from: "Discord claim success"
      to: "assignRoleAsync"
      via: "fire-and-forget role assignment"
      pattern: "assignRoleAsync.*SQUIRE"
    - from: "Introduction message"
      to: "swapRoleAsync"
      via: "messageCreate event handler"
      pattern: "swapRoleAsync.*Knight|Lord"
---

<objective>
Configure Discord Developer Portal for production and verify the complete Discord integration end-to-end: OAuth claim flow, bot role assignment, and introduction detection.

Purpose: Plan 01 fixed the callback routing bug and configured Coolify env vars. This plan ensures the Discord Developer Portal is configured with the production redirect URI and then verifies the entire Discord member lifecycle works: claim Discord -> get Squire role -> post introduction -> get promoted to Knight/Lord.

Output: Fully verified Discord integration with production configuration confirmed working.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-discord-integration/42-RESEARCH.md
@.planning/phases/42-discord-integration/42-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Configure Discord Developer Portal and server settings</name>
  <action>
The user must configure the Discord Developer Portal and server settings. These require browser access to Discord's web interface which Claude cannot automate.

**Discord Developer Portal (https://discord.com/developers/applications):**

1. Select the application (Client ID: 1462619474921390173)
2. Go to "OAuth2" in left sidebar
3. Under "Redirects", click "Add Redirect"
4. Enter EXACTLY: `https://app.therevenuecouncil.com/auth/callback`
   - No trailing slash
   - Must be https
   - Keep the existing localhost redirect for development
5. Click "Save Changes"
6. Go to "Bot" in left sidebar
7. Under "Privileged Gateway Intents", verify BOTH are enabled:
   - SERVER MEMBERS INTENT (toggle ON)
   - MESSAGE CONTENT INTENT (toggle ON)
8. Save if any changes made

**Discord Server Settings:**

9. Open Discord server settings -> Roles
10. Verify the bot's role is positioned ABOVE these roles in the hierarchy:
    - Squire (gray)
    - Knight (blue)
    - Lord (gold)
    - Debtor (red)
    If the bot role is below any of these, drag it above them
11. If DISCORD_INVITE_URL was not set in Plan 01:
    - Create a permanent (non-expiring) invite link
    - Provide it so it can be set in Coolify
  </action>
  <resume-signal>Type "configured" when all Discord Developer Portal and server settings are complete. If you also have a Discord invite URL to set, provide it (e.g., "configured, invite: https://discord.gg/XXXXX").</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Verify Discord integration end-to-end</name>
  <files></files>
  <action>
After the user confirms Discord Developer Portal is configured, verify the complete Discord integration.

**Step 1: Verify health check**
```bash
curl -s https://app.therevenuecouncil.com/health | jq .
```
Expected: `discord: true`

**Step 2: If user provided a DISCORD_INVITE_URL, set it in Coolify now**
```bash
curl -X PATCH http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/envs \
  -H "Authorization: Bearer $COOLIFY_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"key": "DISCORD_INVITE_URL", "value": "USER_PROVIDED_URL", "is_build_time": false, "is_preview": false}'
```
Then restart the app.

**Step 3: Test OAuth claim flow**

Find a test member with active subscription but no discordId:
```bash
# Query via Supabase or Coolify logs
curl -s https://app.therevenuecouncil.com/health | jq .
```

The claim flow test requires a browser. Instruct the user:
1. Log in as a member with active subscription at https://app.therevenuecouncil.com/login
2. Navigate to https://app.therevenuecouncil.com/claim/discord
3. Should redirect to Discord authorization page
4. Authorize the application
5. Should redirect back to the Discord invite URL (or /dashboard if invite URL not set)
6. NOT an /auth/error page -- if that appears, the callback fix from Plan 01 is not working

**Step 4: Verify database update after claim**

Check that the member's discordId was saved. Use Coolify container logs:
```bash
# Check recent logs for claim activity
curl -s http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/logs \
  -H "Authorization: Bearer $COOLIFY_TOKEN" | grep -i "discord claim\|claim successful\|assignRole"
```

Or check directly via the admin API/dashboard if available.

**Step 5: Verify Squire role assigned**

After the claim, check in Discord that the test member received the Squire role. Check logs for role assignment:
```bash
# Check logs for role assignment
curl -s http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/logs \
  -H "Authorization: Bearer $COOLIFY_TOKEN" | grep -i "role\|squire"
```

**Step 6: Test introduction detection**

Instruct the user:
1. In the Discord server, post a message in #introductions that is 100+ characters
2. The bot should detect the message and:
   - Remove Squire role
   - Add Knight role (if team member) or Lord role (if individual/owner)
   - Send a welcome DM
   - Set introCompleted=true in database

Check logs for introduction detection:
```bash
curl -s http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/logs \
  -H "Authorization: Bearer $COOLIFY_TOKEN" | grep -i "introduction\|intro\|knight\|lord\|promoted"
```

**Step 7: Verify final state**

Confirm:
- Member has discordId and discordUsername in database
- Member has Knight or Lord role in Discord (not Squire)
- introCompleted = true in database
- Bot is still online (health check discord=true)

**If any step fails:**
- OAuth redirect fails -> Check Developer Portal redirect URI matches EXACTLY
- invalid_state error -> Plan 01 fix not deployed, check Coolify rebuild completed
- Role assignment fails -> Bot role hierarchy issue (user must fix in Discord)
- Introduction not detected -> Check MESSAGE CONTENT INTENT is enabled in Developer Portal
  </action>
  <verify>
```bash
# Health check still healthy
curl -s https://app.therevenuecouncil.com/health | jq .

# Check for successful claim and role operations in logs
curl -s http://82.180.160.120:8000/api/v1/applications/wcssogsgc00o8ocwcg4c0c00/logs \
  -H "Authorization: Bearer $COOLIFY_TOKEN" | grep -i "claim successful\|role\|introduction"
```
  </verify>
  <done>
OAuth claim flow completes successfully (member gets discordId saved). Bot assigns Squire role on claim. Introduction detection promotes Squire to Knight/Lord. Health check shows discord=true. Complete Discord member lifecycle verified.
  </done>
</task>

</tasks>

<verification>
1. Health check: `curl -s https://app.therevenuecouncil.com/health | jq .` shows discord=true
2. OAuth claim flow: User navigated /claim/discord, authorized on Discord, was redirected back without errors
3. Database: Test member has discordId and discordUsername populated
4. Squire role: Test member received Squire role in Discord after claim
5. Introduction: Test member posted 100+ chars in #introductions, was promoted to Knight/Lord
6. Logs: No errors related to Discord, roles, or OAuth in production logs
</verification>

<success_criteria>
- Discord Developer Portal has production redirect URI registered
- OAuth claim flow works end-to-end without invalid_state errors
- Bot assigns Squire role when member claims Discord
- Introduction detection works and promotes member to Knight/Lord
- Health check confirms discord=true throughout
</success_criteria>

<output>
After completion, create `.planning/phases/42-discord-integration/42-02-SUMMARY.md`
</output>
