// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum SubscriptionStatus {
  NONE
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELLED
}

enum SeatTier {
  INDIVIDUAL    // Individual subscription (no team)
  OWNER         // Company owner seat (access to owners-only channels)
  TEAM_MEMBER   // Company team seat (standard member access)
}

// ============================================
// CORE MODELS
// ============================================

model Member {
  id                  String             @id @default(cuid())

  // Discord identity (linked via OAuth)
  discordId           String?            @unique
  discordUsername     String?
  discordAvatar       String?

  // Stripe identity
  stripeCustomerId    String?            @unique
  email               String?            @unique

  // Authentication (null for magic-link-only users)
  passwordHash        String?

  // CRM-ready fields (captured during intro or checkout)
  firstName           String?
  lastName            String?
  company             String?
  jobTitle            String?
  linkedInUrl         String?
  referralSource      String?

  // Subscription state (cached from Stripe webhooks)
  subscriptionStatus  SubscriptionStatus @default(NONE)
  seatTier            SeatTier?
  currentPeriodEnd    DateTime?

  // Onboarding state
  introCompleted      Boolean            @default(false)
  introCompletedAt    DateTime?
  introMessageId      String?            // Discord message ID of introduction
  lastGuidanceDmAt    DateTime?          // Rate-limiting for too-short intro guidance DMs

  // Team membership (for company seats)
  team                Team?              @relation(fields: [teamId], references: [id])
  teamId              String?
  isTeamAdmin         Boolean            @default(false)
  isPrimaryOwner      Boolean            @default(false)  // Cannot be revoked by other org members

  // Billing failure tracking
  paymentFailedAt           DateTime?  // When first payment failure detected
  gracePeriodEndsAt         DateTime?  // 48 hours after paymentFailedAt
  debtorStateEndsAt         DateTime?  // 30 days after entering debtor state
  previousRole              String?    // 'Knight' or 'Lord' for restoration
  isInDebtorState           Boolean    @default(false)
  sentBillingNotifications  String[]   @default([])  // Track which notifications sent

  // Audit timestamps
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  @@index([teamId])
  @@index([subscriptionStatus])
}

model Team {
  id                    String             @id @default(cuid())
  name                  String

  // Stripe billing (team subscription)
  stripeCustomerId      String             @unique
  stripeSubscriptionId  String?            @unique
  subscriptionStatus    SubscriptionStatus @default(NONE)

  // Seat allocation
  ownerSeatCount        Int                @default(0)  // Paid owner seats
  teamSeatCount         Int                @default(0)  // Paid team seats

  // Relationships
  members               Member[]
  pendingInvites        PendingInvite[]

  // Billing failure tracking
  paymentFailedAt       DateTime?  // When first payment failure detected
  gracePeriodEndsAt     DateTime?  // 48 hours after paymentFailedAt
  debtorStateEndsAt     DateTime?  // 30 days after entering debtor state

  // Audit timestamps
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
}

model PendingInvite {
  id          String    @id @default(cuid())

  // Team relationship
  team        Team      @relation(fields: [teamId], references: [id])
  teamId      String

  // Invite details
  seatTier    SeatTier  // OWNER or TEAM_MEMBER
  token       String    @unique
  createdBy   String    // Member ID who created the invite
  inviteeEmail String?  // Optional: email to send invite to (admin can still share link manually)

  // Tracking
  acceptedAt  DateTime?
  acceptedBy  String?   // Member ID who accepted

  // Audit timestamps
  createdAt   DateTime  @default(now())

  @@index([teamId])
  @@index([token])
}

// ============================================
// OPERATIONAL MODELS
// ============================================

model StripeEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique  // Stripe event ID for idempotency
  type        String             // e.g., "checkout.session.completed"
  processedAt DateTime @default(now())
  payload     Json?              // Optional: store full event for debugging

  @@index([eventId])
  @@index([type])
  @@index([processedAt])
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String             // e.g., "ROLE_ASSIGNED", "SUBSCRIPTION_CREATED"
  entityType  String             // e.g., "Member", "Team"
  entityId    String
  details     Json?
  performedBy String?            // Member ID or "system"
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

model ReconciliationRun {
  id                String   @id @default(cuid())
  startedAt         DateTime @default(now())
  completedAt       DateTime?

  // Counts
  membersChecked    Int      @default(0)
  teamsChecked      Int      @default(0)
  issuesFound       Int      @default(0)
  issuesFixed       Int      @default(0)

  // Mode
  autoFixEnabled    Boolean  @default(false)
  isVerificationRun Boolean  @default(false)
  triggeredBy       String   // 'scheduled' | 'manual' | 'verification'

  // Results stored as JSON
  issues            Json     @default("[]")

  @@index([startedAt])
}
