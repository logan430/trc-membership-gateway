// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum SubscriptionStatus {
  NONE
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELLED
}

enum SeatTier {
  INDIVIDUAL // Individual subscription (no team)
  OWNER // Company owner seat (access to owners-only channels)
  TEAM_MEMBER // Company team seat (standard member access)
}

enum AdminRole {
  ADMIN // Member management only
  SUPER_ADMIN // Full access including admin management + system config
}

// ============================================
// V2.0 ENUMS
// ============================================

enum BenchmarkCategory {
  COMPENSATION
  INFRASTRUCTURE
  BUSINESS
  OPERATIONAL
}

enum ResourceStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
}

enum ResourceType {
  TEMPLATE
  SOP
  PLAYBOOK
  COURSE
  VIDEO
}

enum DiscordActivityType {
  MESSAGE
  REACTION_GIVEN
  REACTION_RECEIVED
}

// ============================================
// CORE MODELS
// ============================================

model Member {
  id String @id @default(cuid())

  // Discord identity (linked via OAuth)
  discordId       String? @unique
  discordUsername String?
  discordAvatar   String?

  // Stripe identity
  stripeCustomerId String? @unique
  email            String? @unique

  // Authentication (null for magic-link-only users)
  passwordHash String?

  // CRM-ready fields (captured during intro or checkout)
  firstName      String?
  lastName       String?
  company        String?
  jobTitle       String?
  linkedInUrl    String?
  referralSource String?

  // Subscription state (cached from Stripe webhooks)
  subscriptionStatus SubscriptionStatus @default(NONE)
  seatTier           SeatTier?
  currentPeriodEnd   DateTime?

  // Onboarding state
  introCompleted   Boolean   @default(false)
  introCompletedAt DateTime?
  introMessageId   String? // Discord message ID of introduction
  lastGuidanceDmAt DateTime? // Rate-limiting for too-short intro guidance DMs

  // Team membership (for company seats)
  team           Team?   @relation(fields: [teamId], references: [id])
  teamId         String?
  isTeamAdmin    Boolean @default(false)
  isPrimaryOwner Boolean @default(false) // Cannot be revoked by other org members

  // Billing failure tracking
  paymentFailedAt          DateTime? // When first payment failure detected
  gracePeriodEndsAt        DateTime? // 48 hours after paymentFailedAt
  debtorStateEndsAt        DateTime? // 30 days after entering debtor state
  previousRole             String? // 'Knight' or 'Lord' for restoration
  isInDebtorState          Boolean   @default(false)
  sentBillingNotifications String[]  @default([]) // Track which notifications sent

  // Audit timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Gamification (v2.0 - DB-06)
  totalPoints   Int       @default(0)
  currentStreak Int       @default(0)
  lastActiveAt  DateTime?

  // Relationships (v2.0)
  benchmarkSubmissions BenchmarkSubmission[]
  resourceDownloads    ResourceDownload[]
  pointTransactions    PointTransaction[]
  discordActivities    DiscordActivity[]

  @@index([teamId])
  @@index([subscriptionStatus])
  @@index([totalPoints(sort: Desc)]) // Leaderboard queries
}

model Team {
  id   String @id @default(cuid())
  name String

  // Stripe billing (team subscription)
  stripeCustomerId     String             @unique
  stripeSubscriptionId String?            @unique
  subscriptionStatus   SubscriptionStatus @default(NONE)

  // Seat allocation
  ownerSeatCount Int @default(0) // Paid owner seats
  teamSeatCount  Int @default(0) // Paid team seats

  // Relationships
  members        Member[]
  pendingInvites PendingInvite[]

  // Billing failure tracking
  paymentFailedAt   DateTime? // When first payment failure detected
  gracePeriodEndsAt DateTime? // 48 hours after paymentFailedAt
  debtorStateEndsAt DateTime? // 30 days after entering debtor state

  // Audit timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PendingInvite {
  id String @id @default(cuid())

  // Team relationship
  team   Team   @relation(fields: [teamId], references: [id])
  teamId String

  // Invite details
  seatTier     SeatTier // OWNER or TEAM_MEMBER
  token        String   @unique
  createdBy    String // Member ID who created the invite
  inviteeEmail String? // Optional: email to send invite to (admin can still share link manually)

  // Tracking
  acceptedAt DateTime?
  acceptedBy String? // Member ID who accepted

  // Audit timestamps
  createdAt DateTime @default(now())

  @@index([teamId])
  @@index([token])
}

// ============================================
// OPERATIONAL MODELS
// ============================================

model StripeEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique // Stripe event ID for idempotency
  type        String // e.g., "checkout.session.completed"
  processedAt DateTime @default(now())
  payload     Json? // Optional: store full event for debugging

  @@index([eventId])
  @@index([type])
  @@index([processedAt])
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String // e.g., "ROLE_ASSIGNED", "SUBSCRIPTION_CREATED"
  entityType  String // e.g., "Member", "Team"
  entityId    String
  details     Json?
  performedBy String? // Member ID or "system"
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

model ReconciliationRun {
  id          String    @id @default(cuid())
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  // Counts
  membersChecked Int @default(0)
  teamsChecked   Int @default(0)
  issuesFound    Int @default(0)
  issuesFixed    Int @default(0)

  // Mode
  autoFixEnabled    Boolean @default(false)
  isVerificationRun Boolean @default(false)
  triggeredBy       String // 'scheduled' | 'manual' | 'verification'

  // Results stored as JSON
  issues Json @default("[]")

  @@index([startedAt])
}

// ============================================
// ADMIN MODELS
// ============================================

model Admin {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  role         AdminRole @default(ADMIN)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  createdBy    String? // Admin ID who created this admin, null for seed admin

  @@index([email])
}

model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  enabled     Boolean  @default(false)
  description String?
  category    String   @default("general") // general, billing, discord, email
  updatedAt   DateTime @updatedAt
  updatedBy   String? // Admin ID

  @@index([key])
}

model PointConfig {
  id          String   @id @default(cuid())
  action      String   @unique // "benchmark_submission", "resource_download", etc.
  points      Int // Point value for this action
  enabled     Boolean  @default(true) // Toggle per action
  label       String // Human-readable: "Benchmark Submission"
  description String? // Optional admin notes
  updatedAt   DateTime @updatedAt
  updatedBy   String? // Admin ID who last updated

  @@index([action])
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String   @unique // e.g., "welcome", "claim_reminder", "payment_failure"
  subject   String
  body      String // Plain text with {{variable}} placeholders
  updatedAt DateTime @updatedAt
  updatedBy String? // Admin ID
}

// ============================================
// V2.0 MODELS
// ============================================

// DB-01: BenchmarkSubmission
model BenchmarkSubmission {
  id          String            @id @default(cuid())
  memberId    String
  category    BenchmarkCategory
  data        Json // JSONB for flexible schema per category
  isValid     Boolean           @default(true)
  submittedAt DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, category]) // One submission per category per member
  @@index([category])
  @@index([memberId])
  @@index([data(ops: JsonbPathOps)], type: Gin) // DB-08: GIN index for JSONB queries
}

// DB-02: ResourceTag (admin-managed tag list)
model ResourceTag {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  createdBy String? // Admin ID who created the tag

  @@index([name])
}

// DB-02: Resource
model Resource {
  id             String         @id @default(cuid())
  title          String
  description    String
  type           ResourceType
  tags           String[]       @default([]) // Flat tags array
  status         ResourceStatus @default(DRAFT)
  publishAt      DateTime? // For scheduled publishing
  storagePath    String? // Supabase Storage path (not URL)
  thumbnailUrl   String?
  isFeatured     Boolean        @default(false)
  downloadCount  Int            @default(0) // Denormalized for fast sorting
  uploadedBy     String? // Admin ID who uploaded (internal tracking)
  author         String? // Public attribution
  fileSize       Int?
  mimeType       String?
  deletedAt      DateTime? // Soft delete
  currentVersion Int            @default(1)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  downloads ResourceDownload[]
  versions  ResourceVersion[]

  @@index([type])
  @@index([isFeatured])
  @@index([status])
  @@index([tags], type: Gin) // GIN index for fast array queries
}

// DB-02: ResourceVersion (version history)
model ResourceVersion {
  id          String   @id @default(cuid())
  resourceId  String
  version     Int
  storagePath String
  fileSize    Int?
  changelog   String? // Optional version notes
  uploadedBy  String
  createdAt   DateTime @default(now())

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([resourceId, version])
  @@index([resourceId])
}

// DB-03: ResourceDownload
model ResourceDownload {
  id           String   @id @default(cuid())
  memberId     String
  resourceId   String
  downloadedAt DateTime @default(now())

  member   Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([resourceId])
  @@index([downloadedAt])
}

// DB-04: PointTransaction (immutable ledger)
model PointTransaction {
  id        String   @id @default(cuid())
  memberId  String
  action    String // "benchmark_submission", "resource_download", "discord_activity", "intro_completed", "admin_adjustment"
  points    Int // Can be negative for admin adjustments
  metadata  Json? // Context: { category: "COMPENSATION" }, { resourceId: "..." }, { reason: "..." }
  createdAt DateTime @default(now())

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([action])
  @@index([createdAt])
}

// DB-05: DiscordActivity
model DiscordActivity {
  id           String              @id @default(cuid())
  memberId     String
  discordId    String
  activityType DiscordActivityType
  xpDelta      Int? // MEE6 XP gained since last sync
  xpTotal      Int? // Total MEE6 XP at sync time
  syncedAt     DateTime            @default(now())

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([discordId])
  @@index([syncedAt])
}
