/**
 * Optional malware scanning via ClamAV.
 * SEC-04: Scan uploaded files for malware.
 *
 * Requires ClamAV daemon running. Disabled by default.
 * Enable via ENABLE_MALWARE_SCAN=true and CLAMAV_HOST env vars.
 */
import { env } from '../config/env.js';
import { logger } from '../index.js';
import type { MalwareScanResult } from './types.js';

// Lazy-loaded clamscan instance
let clamInstance: any = null;

/**
 * Check if malware scanning is enabled and available.
 */
export function isMalwareScanEnabled(): boolean {
  return env.ENABLE_MALWARE_SCAN === 'true' && !!env.CLAMAV_HOST;
}

/**
 * Initialize ClamAV client (lazy, once).
 */
async function getClamClient(): Promise<any> {
  if (clamInstance) return clamInstance;

  if (!isMalwareScanEnabled()) {
    return null;
  }

  try {
    // Dynamic import - clamscan is optional dependency
    const NodeClam = (await import('clamscan')).default;

    clamInstance = await new NodeClam().init({
      clamdscan: {
        host: env.CLAMAV_HOST,
        port: env.CLAMAV_PORT || 3310,
        timeout: 60000, // 60 second timeout for large files
        localFallback: false,
      },
      preference: 'clamdscan',
    });

    logger.info({ host: env.CLAMAV_HOST, port: env.CLAMAV_PORT }, 'ClamAV client initialized');
    return clamInstance;
  } catch (error) {
    logger.error({ error }, 'Failed to initialize ClamAV client - malware scanning disabled');
    return null;
  }
}

/**
 * Scan a file buffer for malware.
 * Returns clean: true if no malware detected or scanning disabled.
 *
 * @param buffer - File content as Buffer
 * @param filename - Original filename (for logging)
 * @returns Scan result
 */
export async function scanForMalware(buffer: Buffer, filename: string): Promise<MalwareScanResult> {
  if (!isMalwareScanEnabled()) {
    return { clean: true, scanned: false };
  }

  const clam = await getClamClient();
  if (!clam) {
    logger.warn({ filename }, 'ClamAV unavailable - skipping malware scan');
    return { clean: true, scanned: false };
  }

  try {
    // Scan the buffer directly
    const { isInfected, viruses } = await clam.scanBuffer(buffer);

    if (isInfected) {
      const threat = viruses?.join(', ') || 'Unknown threat';
      logger.warn({ filename, threat }, 'Malware detected in uploaded file');
      return { clean: false, threat, scanned: true };
    }

    logger.info({ filename }, 'File passed malware scan');
    return { clean: true, scanned: true };
  } catch (error) {
    logger.error({ error, filename }, 'Malware scan failed');
    // Fail open with warning - don't block uploads if scanner errors
    // Change to fail closed (return clean: false) for stricter security
    return { clean: true, scanned: false };
  }
}
